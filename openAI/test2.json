{"prompt": "diff --git a/deps.edn b/deps.edn index c367f9a7..54e38584 100644 --- a/deps.edn +++ b/deps.edn @@ -26,7 +26,7 @@ babashka/fs {:local/root \"fs\"} babashka/babashka.core {:local/root \"babashka.core\"} borkdude/graal.locking {:mvn/version \"0.0.2\"}, - org.clojure/core.async {:mvn/version \"1.6.673\"}, + org.clojure/core.async {:mvn/version \"1.5.648\"}, org.clojure/tools.cli {:mvn/version \"1.0.214\"}, org.clojure/data.csv {:mvn/version \"1.0.0\"}, cheshire/cheshire {:mvn/version \"5.11.0\"} diff --git a/project.clj b/project.clj index c8872421..e16928c4 100644 --- a/project.clj +++ b/project.clj @@ -27,7 +27,7 @@ [borkdude/sci.impl.reflector \"0.0.1\"] [org.babashka/sci.impl.types \"0.0.2\"] [org.babashka/babashka.impl.reify \"0.1.3\"] - [org.clojure/core.async \"1.6.673\"] + [org.clojure/core.async \"1.5.648\"] [org.clojure/test.check \"1.1.1\"] [com.github.clj-easy/graal-build-time \"0.1.0\"] [rewrite-clj/rewrite-clj \"1.1.45\"] diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index c367f9a7..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -26,7 +26,7 @@ babashka/fs {:local/root \"fs\"} babashka/babashka.core {:local/root \"babashka.core\"} borkdude/graal.locking {:mvn/version \"0.0.2\"}, - org.clojure/core.async {:mvn/version \"1.6.673\"}, + org.clojure/core.async {:mvn/version \"1.5.648\"}, org.clojure/tools.cli {:mvn/version \"1.0.214\"}, org.clojure/data.csv {:mvn/version \"1.0.0\"}, cheshire/cheshire {:mvn/version \"5.11.0\"} @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd ", "completion": "Bump core.async to 673 "}
{"prompt": "diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea ", "completion": "deps.clj 1.11.1.1182 "}
{"prompt": "diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea ", "completion": "Link pod registry to Pods section in README (#1411) In the `Pods` section we were pointing to a place with a slightly outdated list of projects. This patch adds the correct link to the pod registry. "}
{"prompt": "diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea ", "completion": "Graalvm 22.3.0 (#1408) "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index 4e564e6f..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,34 +7,31 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac -GRAALVM_FILENAME=\"graalvm-ce-java19-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" +GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" pushd \"$INSTALL_DIR\" >/dev/null -if ! [ -d \"graalvm-ce-java19-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -LO \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - ls -la - tar xzvf \"$GRAALVM_FILENAME\" - ls -la \"graalvm-ce-java19-$GRAALVM_VERSION\" +if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness ", "completion": "Send text over the wire "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index 4e564e6f..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,34 +7,31 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac -GRAALVM_FILENAME=\"graalvm-ce-java19-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" +GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" pushd \"$INSTALL_DIR\" >/dev/null -if ! [ -d \"graalvm-ce-java19-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -LO \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - ls -la - tar xzvf \"$GRAALVM_FILENAME\" - ls -la \"graalvm-ce-java19-$GRAALVM_VERSION\" +if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index ebeea14a..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data) \"utf-8\")] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data) \"utf-8\")))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "fix windows build, hopefully "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index 4e564e6f..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,34 +7,31 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac -GRAALVM_FILENAME=\"graalvm-ce-java19-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" +GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" pushd \"$INSTALL_DIR\" >/dev/null -if ! [ -d \"graalvm-ce-java19-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -LO \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - ls -la - tar xzvf \"$GRAALVM_FILENAME\" - ls -la \"graalvm-ce-java19-$GRAALVM_VERSION\" +if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "macos "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index 2f133a40..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,35 +7,31 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac -GRAALVM_FILENAME=\"graalvm-ce-java19-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" +GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" pushd \"$INSTALL_DIR\" >/dev/null -if ! [ -d \"graalvm-ce-java19-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -LO \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - ls -la - tar xzvf \"$GRAALVM_FILENAME\" - ls -la \"graalvm-ce-java19-$GRAALVM_VERSION\" - \"graalvm-ce-java19-$GRAALVM_VERSION\"/bin/gu install native-image +if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "wip "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index 1af53c37..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,21 +7,21 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" @@ -29,13 +29,9 @@ GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VER pushd \"$INSTALL_DIR\" >/dev/null if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -LO \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - ls -la - tar xzvf \"$GRAALVM_FILENAME\" - ls -la \"graalvm-ce-java11-$GRAALVM_VERSION\" - \"graalvm-ce-java11-$GRAALVM_VERSION\"/bin/gu install native-image + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "debug "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index d7f64d36..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,21 +7,21 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" @@ -29,12 +29,9 @@ GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VER pushd \"$INSTALL_DIR\" >/dev/null if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -LO \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - ls -la - tar xzvf \"$GRAALVM_FILENAME\" - ls -la \"graalvm-ce-java11-$GRAALVM_VERSION\" + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "logg "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index f285024f..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,21 +7,21 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" @@ -29,12 +29,9 @@ GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VER pushd \"$INSTALL_DIR\" >/dev/null if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -LO \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - ls -la - ls -la \"graalvm-ce-java11-$GRAALVM_VERSION\" - tar xzf \"$GRAALVM_FILENAME\" + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "log "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index 42f0eb27..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,21 +7,21 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" @@ -29,10 +29,9 @@ GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VER pushd \"$INSTALL_DIR\" >/dev/null if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -LO \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - tar xzf \"$GRAALVM_FILENAME\" + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "log "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/script/compile.bat b/script/compile.bat index 78a1be3e..56d3396c 100644 --- a/script/compile.bat +++ b/script/compile.bat @@ -29,7 +29,6 @@ call %GRAALVM_HOME%binnative-image.cmd ^ \"-H:+ReportExceptionStackTraces\" ^ \"--verbose\" ^ \"--no-fallback\" ^ - \"--enable-preview\" ^ \"%BABASHKA_XMX%\" if %errorlevel% neq 0 exit /b %errorlevel% diff --git a/script/install-graalvm b/script/install-graalvm index 1f2b267e..19d43c5a 100755 --- a/script/install-graalvm +++ b/script/install-graalvm @@ -7,21 +7,21 @@ INSTALL_DIR=\"${1:-$HOME}\" GRAALVM_VERSION=\"${GRAALVM_VERSION:-21.2.0}\" case \"$BABASHKA_PLATFORM\" in - macos) - GRAALVM_PLATFORM=\"darwin\" - ;; - linux) - GRAALVM_PLATFORM=\"linux\" - ;; + macos) + GRAALVM_PLATFORM=\"darwin\" + ;; + linux) + GRAALVM_PLATFORM=\"linux\" + ;; esac case \"${BABASHKA_ARCH:-}\" in - aarch64) - GRAALVM_ARCH=\"aarch64\" - ;; - *) - GRAALVM_ARCH=\"amd64\" - ;; + aarch64) + GRAALVM_ARCH=\"aarch64\" + ;; + *) + GRAALVM_ARCH=\"amd64\" + ;; esac GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION.tar.gz\" @@ -29,10 +29,9 @@ GRAALVM_FILENAME=\"graalvm-ce-java11-$GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VER pushd \"$INSTALL_DIR\" >/dev/null if ! [ -d \"graalvm-ce-java11-$GRAALVM_VERSION\" ]; then - echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" - echo \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" - tar xzf \"$GRAALVM_FILENAME\" + echo \"Downloading GraalVM $GRAALVM_PLATFORM-$GRAALVM_ARCH-$GRAALVM_VERSION on '$PWD'...\" + curl -O -sL \"https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-$GRAALVM_VERSION/$GRAALVM_FILENAME\" + tar xzf \"$GRAALVM_FILENAME\" fi popd >/dev/null diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "print link "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 32c7e4bd..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java19-22.3.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java19-22.3.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java19-22.3.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 19b0cb89..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -6,7 +6,7 @@ task: env: LEIN_ROOT: \"true\" GRAALVM_VERSION: \"22.3.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java19-22.3.0/Contents/Home + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.portal/vs-code.edn b/.portal/vs-code.edn deleted file mode 100644 index 90c32986..00000000 --- a/.portal/vs-code.edn +++ /dev/null @@ -1 +0,0 @@ -{:host \"localhost\", :port 51379} No newline at end of file diff --git a/Dockerfile b/Dockerfile index aa958100..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -15,14 +15,14 @@ RUN if [ \"${TARGETARCH}\" = \"\" ] || [ \"${TARGETARCH}\" = \"amd64\" ]; then export GRAALVM_ARCH=aarch64; fi && echo \"Installing GraalVM for ${GRAALVM_ARCH}\" && - curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - tar -xzf graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && - rm graalvm-ce-java19-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz + curl -sLO https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAALVM_VERSION}/graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + tar -xzf graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz && + rm graalvm-ce-java11-linux-${GRAALVM_ARCH}-${GRAALVM_VERSION}.tar.gz ARG BABASHKA_XMX=\"-J-Xmx4500m\" -ENV GRAALVM_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}\" -ENV JAVA_HOME=\"/opt/graalvm-ce-java19-${GRAALVM_VERSION}/bin\" +ENV GRAALVM_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}\" +ENV JAVA_HOME=\"/opt/graalvm-ce-java11-${GRAALVM_VERSION}/bin\" ENV PATH=\"$JAVA_HOME:$PATH\" ENV BABASHKA_XMX=$BABASHKA_XMX diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 37cc8fdb..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java19-22.3.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java19-windows-amd64-22.3.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 4887ebb7..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java19-22.3.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java19-22.3.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java19-22.3.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 24d050a6..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java19-22.3.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/resources/META-INF/babashka/deps.edn b/resources/META-INF/babashka/deps.edn index 54e38584..8cc78c93 100644 --- a/resources/META-INF/babashka/deps.edn +++ b/resources/META-INF/babashka/deps.edn @@ -156,9 +156,7 @@ :git/sha \"ca115fe00a0abf3a2f78452ab309c3aa4c00fc4e\" :deps/manifest :deps} lambdaisland/uri {:git/url \"https://github.com/lambdaisland/uri\" - :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\" - :deps/manifest :deps} - clj-commons/fs {:mvn/version \"1.6.310\"}} + :git/sha \"ac4f1f9c8e4f45a088db1c6383ce2191c973987c\"}} :classpath-overrides {org.clojure/clojure nil org.clojure/spec.alpha nil}} :clj-nvd diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index 9aa93f19..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -11,7 +11,7 @@ ;; GraalVM Community Edition 19.3.2 based on OpenJDK 8u252 ;; GraalVM Community Edition 19.3.2 based on OpenJDK 11.0.7 ;; -;; Currently we use GraalVM java19-20.1.0 +;; Currently we use GraalVM java11-20.1.0 (ns bump-graal-version (:require [clojure.string :as str] @@ -31,8 +31,8 @@ \"\" \"./bump_graal_version.clj -g 19.3.2 (the new version)\" \"or\" - \"./bump_graal_version.clj -g 19.3.2 --java java19\" - \"(for GraalVM java19-19.3.2)\" + \"./bump_graal_version.clj -g 19.3.2 --java java11\" + \"(for GraalVM java11-19.3.2)\" \"\"] (str/join newline)))) @@ -55,7 +55,7 @@ ;; ;; We could have them as environment variables (def current-graal-version \"22.3.0\") -(def current-java-version \"java19\") +(def current-java-version \"java11\") (def cl-options [[\"-g\" \"--graal VERSION\" \"graal version\"] diff --git a/script/compile b/script/compile index b698f978..17b7dc76 100755 --- a/script/compile +++ b/script/compile @@ -55,8 +55,7 @@ args=(\"-jar\" \"$BABASHKA_JAR\" \"--no-fallback\" \"--native-image-info\" # --trace-class-initialization=jdk.internal.net.http.common.DebugLogger,jdk.internal.net.http.websocket.WebSocketImpl,jdk.internal.net.http.common.Utils - \"$BABASHKA_XMX\" - \"--enable-preview\") + \"$BABASHKA_XMX\") BABASHKA_STATIC=${BABASHKA_STATIC:-} BABASHKA_MUSL=${BABASHKA_MUSL:-} diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index 03d6fcc7..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -47,8 +47,7 @@ {:name \"sleep\"} {:name \"start\"} {:name \"toString\"} - {:name \"yield\"} - {:name \"ofVirtual\"}]} + {:name \"yield\"}]} java.net.URL {:allPublicConstructors true :allPublicFields true @@ -402,7 +401,6 @@ java.util.concurrent.ThreadPoolExecutor$CallerRunsPolicy java.util.concurrent.ThreadPoolExecutor$DiscardOldestPolicy java.util.concurrent.ThreadPoolExecutor$DiscardPolicy - java.util.concurrent.ExecutorService java.util.concurrent.ScheduledExecutorService java.util.concurrent.Future java.util.concurrent.FutureTask @@ -626,8 +624,6 @@ java.util.concurrent.Future (instance? java.util.concurrent.ScheduledExecutorService v) java.util.concurrent.ScheduledExecutorService - (instance? java.util.concurrent.ExecutorService v) - java.util.concurrent.ExecutorService (instance? java.util.Iterator v) java.util.Iterator ;; keep commas for merge friendliness diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "jvm19 "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 90dab434..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -114,7 +114,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (defn unix [shorted? static? musl? arch executor-conf resource-class graalvm-home platform] (let [env {:LEIN_ROOT \"true\" - :GRAALVM_VERSION \"22.2.0\" + :GRAALVM_VERSION \"22.3.0\" :GRAALVM_HOME graalvm-home :BABASHKA_PLATFORM (if (= \"mac\" platform) \"macos\" @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.2.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.2.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.2.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 91a7a8e3..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -5,8 +5,8 @@ task: skip: \"changesIncludeOnly('logo/*', '**.md')\" env: LEIN_ROOT: \"true\" - GRAALVM_VERSION: \"22.2.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.2.0/Contents/Home + GRAALVM_VERSION: \"22.3.0\" + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml index d1bb7dc5..66e1f6ef 100644 --- a/.github/workflows/build.yml +++ b/.github/workflows/build.yml @@ -102,7 +102,7 @@ jobs: runs-on: ${{ matrix.os }} env: LEIN_ROOT: \"true\" - GRAALVM_VERSION: \"22.2.0\" + GRAALVM_VERSION: \"22.3.0\" BABASHKA_PLATFORM: ${{ matrix.name }} # used in release script BABASHKA_TEST_ENV: native BABASHKA_XMX: \"-J-Xmx6500m\" @@ -126,7 +126,7 @@ jobs: if: \"matrix.static == false\" uses: graalvm/setup-graalvm@v1 with: - version: '22.2.0' + version: '22.3.0' java-version: '11' components: 'native-image' github-token: ${{ secrets.GITHUB_TOKEN }} @@ -135,7 +135,7 @@ jobs: if: \"matrix.static == true\" uses: graalvm/setup-graalvm@v1 with: - version: '22.2.0' + version: '22.3.0' java-version: '11' components: 'native-image' native-image-musl: true diff --git a/Dockerfile b/Dockerfile index 13ee10fa..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -5,7 +5,7 @@ RUN apt update RUN apt install --no-install-recommends -yy build-essential zlib1g-dev WORKDIR \"/opt\" -ENV GRAALVM_VERSION=\"22.2.0\" +ENV GRAALVM_VERSION=\"22.3.0\" ARG TARGETARCH ENV BABASHKA_ARCH=${TARGETARCH} ENV GRAALVM_ARCH=${TARGETARCH} diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 7ad68110..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.2.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.2.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.2.0/graalvm-ce-java11-windows-amd64-22.2.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 2b5fa2e1..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.2.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.2.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.2.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.2.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 3f1ecd49..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.2.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index f8178f6e..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -54,7 +54,7 @@ ;; OR ;; ;; We could have them as environment variables -(def current-graal-version \"22.2.0\") +(def current-graal-version \"22.3.0\") (def current-java-version \"java11\") (def cl-options diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "changelog "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 90dab434..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -114,7 +114,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (defn unix [shorted? static? musl? arch executor-conf resource-class graalvm-home platform] (let [env {:LEIN_ROOT \"true\" - :GRAALVM_VERSION \"22.2.0\" + :GRAALVM_VERSION \"22.3.0\" :GRAALVM_HOME graalvm-home :BABASHKA_PLATFORM (if (= \"mac\" platform) \"macos\" @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.2.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.2.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.2.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 91a7a8e3..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -5,8 +5,8 @@ task: skip: \"changesIncludeOnly('logo/*', '**.md')\" env: LEIN_ROOT: \"true\" - GRAALVM_VERSION: \"22.2.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.2.0/Contents/Home + GRAALVM_VERSION: \"22.3.0\" + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml index d1bb7dc5..66e1f6ef 100644 --- a/.github/workflows/build.yml +++ b/.github/workflows/build.yml @@ -102,7 +102,7 @@ jobs: runs-on: ${{ matrix.os }} env: LEIN_ROOT: \"true\" - GRAALVM_VERSION: \"22.2.0\" + GRAALVM_VERSION: \"22.3.0\" BABASHKA_PLATFORM: ${{ matrix.name }} # used in release script BABASHKA_TEST_ENV: native BABASHKA_XMX: \"-J-Xmx6500m\" @@ -126,7 +126,7 @@ jobs: if: \"matrix.static == false\" uses: graalvm/setup-graalvm@v1 with: - version: '22.2.0' + version: '22.3.0' java-version: '11' components: 'native-image' github-token: ${{ secrets.GITHUB_TOKEN }} @@ -135,7 +135,7 @@ jobs: if: \"matrix.static == true\" uses: graalvm/setup-graalvm@v1 with: - version: '22.2.0' + version: '22.3.0' java-version: '11' components: 'native-image' native-image-musl: true diff --git a/CHANGELOG.md b/CHANGELOG.md index 14018e1f..cc31ebf2 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -10,6 +10,7 @@ A preview of the next release can be installed from - Fix [#1401](https://github.com/babashka/babashka/issues/1401): mutation of `deftype` field should be visible in protocol method - Fix [#1405](https://github.com/babashka/babashka/issues/1405): drop name metadata from conditionally defined var - [#602](https://github.com/babashka/babashka/issues/602): add lib tests for clj-commons/fs ([@bobisageek](https://github.com/bobisageek)) +- Add `java.net.URLConnection` class ## 1.0.164 (2022-10-17) diff --git a/Dockerfile b/Dockerfile index 13ee10fa..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -5,7 +5,7 @@ RUN apt update RUN apt install --no-install-recommends -yy build-essential zlib1g-dev WORKDIR \"/opt\" -ENV GRAALVM_VERSION=\"22.2.0\" +ENV GRAALVM_VERSION=\"22.3.0\" ARG TARGETARCH ENV BABASHKA_ARCH=${TARGETARCH} ENV GRAALVM_ARCH=${TARGETARCH} diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 7ad68110..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.2.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.2.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.2.0/graalvm-ce-java11-windows-amd64-22.2.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 2b5fa2e1..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.2.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.2.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.2.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.2.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 3f1ecd49..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.2.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index f8178f6e..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -54,7 +54,7 @@ ;; OR ;; ;; We could have them as environment variables -(def current-graal-version \"22.2.0\") +(def current-graal-version \"22.3.0\") (def current-java-version \"java11\") (def cl-options diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "Add java.net.URLConnection "}
{"prompt": "diff --git a/.circleci/script/short_ci.clj b/.circleci/script/short_ci.clj index 90dab434..b977f773 100644 --- a/.circleci/script/short_ci.clj +++ b/.circleci/script/short_ci.clj @@ -114,7 +114,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (defn unix [shorted? static? musl? arch executor-conf resource-class graalvm-home platform] (let [env {:LEIN_ROOT \"true\" - :GRAALVM_VERSION \"22.2.0\" + :GRAALVM_VERSION \"22.3.0\" :GRAALVM_HOME graalvm-home :BABASHKA_PLATFORM (if (= \"mac\" platform) \"macos\" @@ -168,7 +168,7 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl {:persist_to_workspace {:root \"/tmp\" :paths [\"release\"]}} {:save_cache - {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.2.0\"] + {:paths [\"~/.m2\" \"~/graalvm-ce-java11-22.3.0\"] :key cache-key}} {:store_artifacts {:path \"/tmp/release\" :destination \"release\"}} @@ -180,8 +180,8 @@ java -jar \"$jar\" --config .build/bb.edn --deps-root . release-artifact \"$refl (let [docker-executor-conf {:docker [{:image \"circleci/clojure:openjdk-11-lein-2.9.8-bullseye\"}]} machine-executor-conf {:machine {:image \"ubuntu-2004:202111-01\"}} mac-executor-conf {:macos {:xcode \"14.0.0\"}} - linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.2.0\" - mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.2.0/Contents/Home\"] + linux-graalvm-home \"/home/circleci/graalvm-ce-java11-22.3.0\" + mac-graalvm-home \"/Users/distiller/graalvm-ce-java11-22.3.0/Contents/Home\"] (ordered-map :version 2.1 :commands diff --git a/.cirrus.yml b/.cirrus.yml index 91a7a8e3..aa61cb30 100644 --- a/.cirrus.yml +++ b/.cirrus.yml @@ -5,8 +5,8 @@ task: skip: \"changesIncludeOnly('logo/*', '**.md')\" env: LEIN_ROOT: \"true\" - GRAALVM_VERSION: \"22.2.0\" - GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.2.0/Contents/Home + GRAALVM_VERSION: \"22.3.0\" + GRAALVM_HOME: ${HOME}/graalvm-ce-java11-22.3.0/Contents/Home BABASHKA_PLATFORM: macos # used in release script BABASHKA_ARCH: aarch64 BABASHKA_TEST_ENV: native diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml index d1bb7dc5..66e1f6ef 100644 --- a/.github/workflows/build.yml +++ b/.github/workflows/build.yml @@ -102,7 +102,7 @@ jobs: runs-on: ${{ matrix.os }} env: LEIN_ROOT: \"true\" - GRAALVM_VERSION: \"22.2.0\" + GRAALVM_VERSION: \"22.3.0\" BABASHKA_PLATFORM: ${{ matrix.name }} # used in release script BABASHKA_TEST_ENV: native BABASHKA_XMX: \"-J-Xmx6500m\" @@ -126,7 +126,7 @@ jobs: if: \"matrix.static == false\" uses: graalvm/setup-graalvm@v1 with: - version: '22.2.0' + version: '22.3.0' java-version: '11' components: 'native-image' github-token: ${{ secrets.GITHUB_TOKEN }} @@ -135,7 +135,7 @@ jobs: if: \"matrix.static == true\" uses: graalvm/setup-graalvm@v1 with: - version: '22.2.0' + version: '22.3.0' java-version: '11' components: 'native-image' native-image-musl: true diff --git a/CHANGELOG.md b/CHANGELOG.md index 14018e1f..cc31ebf2 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -10,6 +10,7 @@ A preview of the next release can be installed from - Fix [#1401](https://github.com/babashka/babashka/issues/1401): mutation of `deftype` field should be visible in protocol method - Fix [#1405](https://github.com/babashka/babashka/issues/1405): drop name metadata from conditionally defined var - [#602](https://github.com/babashka/babashka/issues/602): add lib tests for clj-commons/fs ([@bobisageek](https://github.com/bobisageek)) +- Add `java.net.URLConnection` class ## 1.0.164 (2022-10-17) diff --git a/Dockerfile b/Dockerfile index 13ee10fa..573142ce 100644 --- a/Dockerfile +++ b/Dockerfile @@ -5,7 +5,7 @@ RUN apt update RUN apt install --no-install-recommends -yy build-essential zlib1g-dev WORKDIR \"/opt\" -ENV GRAALVM_VERSION=\"22.2.0\" +ENV GRAALVM_VERSION=\"22.3.0\" ARG TARGETARCH ENV BABASHKA_ARCH=${TARGETARCH} ENV GRAALVM_ARCH=${TARGETARCH} diff --git a/README.md b/README.md index 418f2036..032f8893 100644 --- a/README.md +++ b/README.md @@ -355,7 +355,7 @@ Pods are programs that can be used as a Clojure library by babashka. Documentation is available in the [pod library repo](https://github.com/babashka/pods). -A list of available pods can be found [here](doc/projects.md#pods). +A list of available pods can be found in the [pod registry](https://github.com/babashka/pod-registry). ## Differences with Clojure diff --git a/appveyor.yml b/appveyor.yml index 7ad68110..7e60e61c 100644 --- a/appveyor.yml +++ b/appveyor.yml @@ -7,8 +7,8 @@ image: Visual Studio 2017 clone_folder: C:projectsbabashka  environment: - GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.2.0 - JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.2.0 + GRAALVM_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 + JAVA_HOME: C:projectsbabashkagraalvmgraalvm-ce-java11-22.3.0 BABASHKA_XMX: \"-J-Xmx5g\"  skip_commits: @@ -38,7 +38,7 @@ clone_script:  build_script: - cmd: >- - powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.2.0/graalvm-ce-java11-windows-amd64-22.2.0.zip', 'graalvm.zip') }\" + powershell -Command \"if (Test-Path('graalvm')) { return } else { (New-Object Net.WebClient).DownloadFile('https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.0/graalvm-ce-java11-windows-amd64-22.3.0.zip', 'graalvm.zip') }\"  powershell -Command \"if (Test-Path('graalvm')) { return } else { Expand-Archive graalvm.zip graalvm }\"  diff --git a/deps.clj b/deps.clj index 9cc85f5e..0765bdab 160000 --- a/deps.clj +++ b/deps.clj @@ -1 +1 @@ -Subproject commit 9cc85f5e0c00c63a333af415a6a24730da424aa7 +Subproject commit 0765bdabb35522beb653693c18f7266b400d9d3b diff --git a/doc/build.md b/doc/build.md index 2b5fa2e1..4de497e0 100644 --- a/doc/build.md +++ b/doc/build.md @@ -3,24 +3,24 @@ ## Prerequisites - Install [lein](https://leiningen.org/) for producing uberjars -- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.2.0*. +- Download [GraalVM](https://www.graalvm.org/downloads/). Currently we use *java11-22.3.0*. - For Windows, installing Visual Studio 2019 with the \"Desktop development with C++\" workload is recommended. - Set `$GRAALVM_HOME` to the GraalVM distribution directory. On macOS this can look like: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.2.0/Contents/Home + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0/Contents/Home ``` On linux: ``` shell - export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.2.0 + export GRAALVM_HOME=~/Downloads/graalvm-ce-java11-22.3.0 ``` On Windows, from the [Visual Studio 2019 x64 Native Tools Command Prompt](https://github.com/oracle/graal/issues/2116#issuecomment-590470806) or `cmd.exe` (not Powershell): ``` - set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.2.0 + set GRAALVM_HOME=%USERPROFILE%Downloadsgraalvm-ce-java11-22.3.0 ``` If you are not running from the x64 Native Tools Command Prompt, you will need to set additional environment variables using: ``` diff --git a/doc/dev.md b/doc/dev.md index 3f1ecd49..dac50075 100644 --- a/doc/dev.md +++ b/doc/dev.md @@ -37,7 +37,7 @@ reasons: ## Requirements -You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.2.0. +You need [lein](https://leiningen.org/) for running JVM tests and/or producing uberjars. For building binaries you need GraalVM. Currently we use java11-22.3.0. ## Clone repository diff --git a/sci b/sci index 09b269c2..674897d4 160000 --- a/sci +++ b/sci @@ -1 +1 @@ -Subproject commit 09b269c242db8af20edde575b1827a2b86027411 +Subproject commit 674897d4378049126bbd24ad4d537df9f619e9ea diff --git a/script/bump_graal_version.clj b/script/bump_graal_version.clj index f8178f6e..191c8e01 100755 --- a/script/bump_graal_version.clj +++ b/script/bump_graal_version.clj @@ -54,7 +54,7 @@ ;; OR ;; ;; We could have them as environment variables -(def current-graal-version \"22.2.0\") +(def current-graal-version \"22.3.0\") (def current-java-version \"java11\") (def cl-options diff --git a/src/babashka/impl/classes.clj b/src/babashka/impl/classes.clj index f9340772..dcbd5217 100644 --- a/src/babashka/impl/classes.clj +++ b/src/babashka/impl/classes.clj @@ -301,7 +301,8 @@ java.net.SocketException java.net.UnknownHostException java.net.URI - ;; java.net.URL, see below + ;; java.net.URL, see custom map + java.net.URLConnection java.net.URLEncoder java.net.URLDecoder ~@(when features/java-nio? diff --git a/test/babashka/crypto_test.clj b/test/babashka/crypto_test.clj index 08549691..48503f69 100644 --- a/test/babashka/crypto_test.clj +++ b/test/babashka/crypto_test.clj @@ -17,7 +17,10 @@ (deftest hmac-sha-256-test (let [key-s \"some-key\" data \"some-data\" - expected-sha (String. (hmac-sha-256 (.getBytes key-s) data))] + expected-sha (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")] + (prn expected-sha) (is (= expected-sha (bb '(do (ns net (:import (javax.crypto Mac) (javax.crypto.spec SecretKeySpec))) @@ -28,4 +31,6 @@ (.doFinal mac (.getBytes data \"UTF-8\")))) (let [key-s \"some-key\" data \"some-data\"] - (String. (hmac-sha-256 (.getBytes key-s) data))))))))) + (String. (.encode (java.util.Base64/getEncoder) + (hmac-sha-256 (.getBytes key-s) data)) + \"utf-8\")))))))) ", "completion": "Add fs lib test (#1406) "}
{"prompt": "diff --git a/test/infrastructure/docker/LICENSE b/test/infrastructure/docker/LICENSE deleted file mode 100644 index 261eeb9e9..000000000 --- a/test/infrastructure/docker/LICENSE +++ /dev/null @@ -1,201 +0,0 @@ - Apache License - Version 2.0, January 2004 - http://www.apache.org/licenses/ - - TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION - - 1. Definitions. - - \"License\" shall mean the terms and conditions for use, reproduction, - and distribution as defined by Sections 1 through 9 of this document. - - \"Licensor\" shall mean the copyright owner or entity authorized by - the copyright owner that is granting the License. - - \"Legal Entity\" shall mean the union of the acting entity and all - other entities that control, are controlled by, or are under common - control with that entity. For the purposes of this definition, - \"control\" means (i) the power, direct or indirect, to cause the - direction or management of such entity, whether by contract or - otherwise, or (ii) ownership of fifty percent (50%) or more of the - outstanding shares, or (iii) beneficial ownership of such entity. - - \"You\" (or \"Your\") shall mean an individual or Legal Entity - exercising permissions granted by this License. - - \"Source\" form shall mean the preferred form for making modifications, - including but not limited to software source code, documentation - source, and configuration files. - - \"Object\" form shall mean any form resulting from mechanical - transformation or translation of a Source form, including but - not limited to compiled object code, generated documentation, - and conversions to other media types. - - \"Work\" shall mean the work of authorship, whether in Source or - Object form, made available under the License, as indicated by a - copyright notice that is included in or attached to the work - (an example is provided in the Appendix below). - - \"Derivative Works\" shall mean any work, whether in Source or Object - form, that is based on (or derived from) the Work and for which the - editorial revisions, annotations, elaborations, or other modifications - represent, as a whole, an original work of authorship. For the purposes - of this License, Derivative Works shall not include works that remain - separable from, or merely link (or bind by name) to the interfaces of, - the Work and Derivative Works thereof. - - \"Contribution\" shall mean any work of authorship, including - the original version of the Work and any modifications or additions - to that Work or Derivative Works thereof, that is intentionally - submitted to Licensor for inclusion in the Work by the copyright owner - or by an individual or Legal Entity authorized to submit on behalf of - the copyright owner. For the purposes of this definition, \"submitted\" - means any form of electronic, verbal, or written communication sent - to the Licensor or its representatives, including but not limited to - communication on electronic mailing lists, source code control systems, - and issue tracking systems that are managed by, or on behalf of, the - Licensor for the purpose of discussing and improving the Work, but - excluding communication that is conspicuously marked or otherwise - designated in writing by the copyright owner as \"Not a Contribution.\" - - \"Contributor\" shall mean Licensor and any individual or Legal Entity - on behalf of whom a Contribution has been received by Licensor and - subsequently incorporated within the Work. - - 2. Grant of Copyright License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - copyright license to reproduce, prepare Derivative Works of, - publicly display, publicly perform, sublicense, and distribute the - Work and such Derivative Works in Source or Object form. - - 3. Grant of Patent License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - (except as stated in this section) patent license to make, have made, - use, offer to sell, sell, import, and otherwise transfer the Work, - where such license applies only to those patent claims licensable - by such Contributor that are necessarily infringed by their - Contribution(s) alone or by combination of their Contribution(s) - with the Work to which such Contribution(s) was submitted. If You - institute patent litigation against any entity (including a - cross-claim or counterclaim in a lawsuit) alleging that the Work - or a Contribution incorporated within the Work constitutes direct - or contributory patent infringement, then any patent licenses - granted to You under this License for that Work shall terminate - as of the date such litigation is filed. - - 4. Redistribution. You may reproduce and distribute copies of the - Work or Derivative Works thereof in any medium, with or without - modifications, and in Source or Object form, provided that You - meet the following conditions: - - (a) You must give any other recipients of the Work or - Derivative Works a copy of this License; and - - (b) You must cause any modified files to carry prominent notices - stating that You changed the files; and - - (c) You must retain, in the Source form of any Derivative Works - that You distribute, all copyright, patent, trademark, and - attribution notices from the Source form of the Work, - excluding those notices that do not pertain to any part of - the Derivative Works; and - - (d) If the Work includes a \"NOTICE\" text file as part of its - distribution, then any Derivative Works that You distribute must - include a readable copy of the attribution notices contained - within such NOTICE file, excluding those notices that do not - pertain to any part of the Derivative Works, in at least one - of the following places: within a NOTICE text file distributed - as part of the Derivative Works; within the Source form or - documentation, if provided along with the Derivative Works; or, - within a display generated by the Derivative Works, if and - wherever such third-party notices normally appear. The contents - of the NOTICE file are for informational purposes only and - do not modify the License. You may add Your own attribution - notices within Derivative Works that You distribute, alongside - or as an addendum to the NOTICE text from the Work, provided - that such additional attribution notices cannot be construed - as modifying the License. - - You may add Your own copyright statement to Your modifications and - may provide additional or different license terms and conditions - for use, reproduction, or distribution of Your modifications, or - for any such Derivative Works as a whole, provided Your use, - reproduction, and distribution of the Work otherwise complies with - the conditions stated in this License. - - 5. Submission of Contributions. Unless You explicitly state otherwise, - any Contribution intentionally submitted for inclusion in the Work - by You to the Licensor shall be under the terms and conditions of - this License, without any additional terms or conditions. - Notwithstanding the above, nothing herein shall supersede or modify - the terms of any separate license agreement you may have executed - with Licensor regarding such Contributions. - - 6. Trademarks. This License does not grant permission to use the trade - names, trademarks, service marks, or product names of the Licensor, - except as required for reasonable and customary use in describing the - origin of the Work and reproducing the content of the NOTICE file. - - 7. Disclaimer of Warranty. Unless required by applicable law or - agreed to in writing, Licensor provides the Work (and each - Contributor provides its Contributions) on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or - implied, including, without limitation, any warranties or conditions - of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A - PARTICULAR PURPOSE. You are solely responsible for determining the - appropriateness of using or redistributing the Work and assume any - risks associated with Your exercise of permissions under this License. - - 8. Limitation of Liability. In no event and under no legal theory, - whether in tort (including negligence), contract, or otherwise, - unless required by applicable law (such as deliberate and grossly - negligent acts) or agreed to in writing, shall any Contributor be - liable to You for damages, including any direct, indirect, special, - incidental, or consequential damages of any character arising as a - result of this License or out of the use or inability to use the - Work (including but not limited to damages for loss of goodwill, - work stoppage, computer failure or malfunction, or any and all - other commercial damages or losses), even if such Contributor - has been advised of the possibility of such damages. - - 9. Accepting Warranty or Additional Liability. While redistributing - the Work or Derivative Works thereof, You may choose to offer, - and charge a fee for, acceptance of support, warranty, indemnity, - or other liability obligations and/or rights consistent with this - License. However, in accepting such obligations, You may act only - on Your own behalf and on Your sole responsibility, not on behalf - of any other Contributor, and only if You agree to indemnify, - defend, and hold each Contributor harmless for any liability - incurred by, or claims asserted against, such Contributor by reason - of your accepting any such warranty or additional liability. - - END OF TERMS AND CONDITIONS - - APPENDIX: How to apply the Apache License to your work. - - To apply the Apache License to your work, attach the following - boilerplate notice, with the fields enclosed by brackets \"[]\" - replaced with your own identifying information. (Don't include - the brackets!) The text should be enclosed in the appropriate - comment syntax for the file format. We also recommend that a - file or class name and description of purpose be included on the - same \"printed page\" as the copyright notice for easier - identification within third-party archives. - - Copyright [yyyy] [name of copyright owner] - - Licensed under the Apache License, Version 2.0 (the \"License\"); - you may not use this file except in compliance with the License. - You may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 - - Unless required by applicable law or agreed to in writing, software - distributed under the License is distributed on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the License for the specific language governing permissions and - limitations under the License. ", "completion": "Merge pull request #7454 from oscr/golangci-prefix-path 🌱 Set golangci-lint path-prefix when linting test and hack/tools "}
{"prompt": "diff --git a/test/infrastructure/docker/LICENSE b/test/infrastructure/docker/LICENSE deleted file mode 100644 index 261eeb9e9..000000000 --- a/test/infrastructure/docker/LICENSE +++ /dev/null @@ -1,201 +0,0 @@ - Apache License - Version 2.0, January 2004 - http://www.apache.org/licenses/ - - TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION - - 1. Definitions. - - \"License\" shall mean the terms and conditions for use, reproduction, - and distribution as defined by Sections 1 through 9 of this document. - - \"Licensor\" shall mean the copyright owner or entity authorized by - the copyright owner that is granting the License. - - \"Legal Entity\" shall mean the union of the acting entity and all - other entities that control, are controlled by, or are under common - control with that entity. For the purposes of this definition, - \"control\" means (i) the power, direct or indirect, to cause the - direction or management of such entity, whether by contract or - otherwise, or (ii) ownership of fifty percent (50%) or more of the - outstanding shares, or (iii) beneficial ownership of such entity. - - \"You\" (or \"Your\") shall mean an individual or Legal Entity - exercising permissions granted by this License. - - \"Source\" form shall mean the preferred form for making modifications, - including but not limited to software source code, documentation - source, and configuration files. - - \"Object\" form shall mean any form resulting from mechanical - transformation or translation of a Source form, including but - not limited to compiled object code, generated documentation, - and conversions to other media types. - - \"Work\" shall mean the work of authorship, whether in Source or - Object form, made available under the License, as indicated by a - copyright notice that is included in or attached to the work - (an example is provided in the Appendix below). - - \"Derivative Works\" shall mean any work, whether in Source or Object - form, that is based on (or derived from) the Work and for which the - editorial revisions, annotations, elaborations, or other modifications - represent, as a whole, an original work of authorship. For the purposes - of this License, Derivative Works shall not include works that remain - separable from, or merely link (or bind by name) to the interfaces of, - the Work and Derivative Works thereof. - - \"Contribution\" shall mean any work of authorship, including - the original version of the Work and any modifications or additions - to that Work or Derivative Works thereof, that is intentionally - submitted to Licensor for inclusion in the Work by the copyright owner - or by an individual or Legal Entity authorized to submit on behalf of - the copyright owner. For the purposes of this definition, \"submitted\" - means any form of electronic, verbal, or written communication sent - to the Licensor or its representatives, including but not limited to - communication on electronic mailing lists, source code control systems, - and issue tracking systems that are managed by, or on behalf of, the - Licensor for the purpose of discussing and improving the Work, but - excluding communication that is conspicuously marked or otherwise - designated in writing by the copyright owner as \"Not a Contribution.\" - - \"Contributor\" shall mean Licensor and any individual or Legal Entity - on behalf of whom a Contribution has been received by Licensor and - subsequently incorporated within the Work. - - 2. Grant of Copyright License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - copyright license to reproduce, prepare Derivative Works of, - publicly display, publicly perform, sublicense, and distribute the - Work and such Derivative Works in Source or Object form. - - 3. Grant of Patent License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - (except as stated in this section) patent license to make, have made, - use, offer to sell, sell, import, and otherwise transfer the Work, - where such license applies only to those patent claims licensable - by such Contributor that are necessarily infringed by their - Contribution(s) alone or by combination of their Contribution(s) - with the Work to which such Contribution(s) was submitted. If You - institute patent litigation against any entity (including a - cross-claim or counterclaim in a lawsuit) alleging that the Work - or a Contribution incorporated within the Work constitutes direct - or contributory patent infringement, then any patent licenses - granted to You under this License for that Work shall terminate - as of the date such litigation is filed. - - 4. Redistribution. You may reproduce and distribute copies of the - Work or Derivative Works thereof in any medium, with or without - modifications, and in Source or Object form, provided that You - meet the following conditions: - - (a) You must give any other recipients of the Work or - Derivative Works a copy of this License; and - - (b) You must cause any modified files to carry prominent notices - stating that You changed the files; and - - (c) You must retain, in the Source form of any Derivative Works - that You distribute, all copyright, patent, trademark, and - attribution notices from the Source form of the Work, - excluding those notices that do not pertain to any part of - the Derivative Works; and - - (d) If the Work includes a \"NOTICE\" text file as part of its - distribution, then any Derivative Works that You distribute must - include a readable copy of the attribution notices contained - within such NOTICE file, excluding those notices that do not - pertain to any part of the Derivative Works, in at least one - of the following places: within a NOTICE text file distributed - as part of the Derivative Works; within the Source form or - documentation, if provided along with the Derivative Works; or, - within a display generated by the Derivative Works, if and - wherever such third-party notices normally appear. The contents - of the NOTICE file are for informational purposes only and - do not modify the License. You may add Your own attribution - notices within Derivative Works that You distribute, alongside - or as an addendum to the NOTICE text from the Work, provided - that such additional attribution notices cannot be construed - as modifying the License. - - You may add Your own copyright statement to Your modifications and - may provide additional or different license terms and conditions - for use, reproduction, or distribution of Your modifications, or - for any such Derivative Works as a whole, provided Your use, - reproduction, and distribution of the Work otherwise complies with - the conditions stated in this License. - - 5. Submission of Contributions. Unless You explicitly state otherwise, - any Contribution intentionally submitted for inclusion in the Work - by You to the Licensor shall be under the terms and conditions of - this License, without any additional terms or conditions. - Notwithstanding the above, nothing herein shall supersede or modify - the terms of any separate license agreement you may have executed - with Licensor regarding such Contributions. - - 6. Trademarks. This License does not grant permission to use the trade - names, trademarks, service marks, or product names of the Licensor, - except as required for reasonable and customary use in describing the - origin of the Work and reproducing the content of the NOTICE file. - - 7. Disclaimer of Warranty. Unless required by applicable law or - agreed to in writing, Licensor provides the Work (and each - Contributor provides its Contributions) on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or - implied, including, without limitation, any warranties or conditions - of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A - PARTICULAR PURPOSE. You are solely responsible for determining the - appropriateness of using or redistributing the Work and assume any - risks associated with Your exercise of permissions under this License. - - 8. Limitation of Liability. In no event and under no legal theory, - whether in tort (including negligence), contract, or otherwise, - unless required by applicable law (such as deliberate and grossly - negligent acts) or agreed to in writing, shall any Contributor be - liable to You for damages, including any direct, indirect, special, - incidental, or consequential damages of any character arising as a - result of this License or out of the use or inability to use the - Work (including but not limited to damages for loss of goodwill, - work stoppage, computer failure or malfunction, or any and all - other commercial damages or losses), even if such Contributor - has been advised of the possibility of such damages. - - 9. Accepting Warranty or Additional Liability. While redistributing - the Work or Derivative Works thereof, You may choose to offer, - and charge a fee for, acceptance of support, warranty, indemnity, - or other liability obligations and/or rights consistent with this - License. However, in accepting such obligations, You may act only - on Your own behalf and on Your sole responsibility, not on behalf - of any other Contributor, and only if You agree to indemnify, - defend, and hold each Contributor harmless for any liability - incurred by, or claims asserted against, such Contributor by reason - of your accepting any such warranty or additional liability. - - END OF TERMS AND CONDITIONS - - APPENDIX: How to apply the Apache License to your work. - - To apply the Apache License to your work, attach the following - boilerplate notice, with the fields enclosed by brackets \"[]\" - replaced with your own identifying information. (Don't include - the brackets!) The text should be enclosed in the appropriate - comment syntax for the file format. We also recommend that a - file or class name and description of purpose be included on the - same \"printed page\" as the copyright notice for easier - identification within third-party archives. - - Copyright [yyyy] [name of copyright owner] - - Licensed under the Apache License, Version 2.0 (the \"License\"); - you may not use this file except in compliance with the License. - You may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 - - Unless required by applicable law or agreed to in writing, software - distributed under the License is distributed on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the License for the specific language governing permissions and - limitations under the License. ", "completion": "Set golangci-lint path-prefix when linting test and hack/tools "}
{"prompt": "diff --git a/Makefile b/Makefile index 05cab73c6..f4ba19a9f 100644 --- a/Makefile +++ b/Makefile @@ -542,8 +542,8 @@ generate-diagrams: ## Generate diagrams for *.plantuml files .PHONY: lint lint: $(GOLANGCI_LINT) ## Lint the codebase $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TEST_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TOOLS_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TEST_DIR); $(GOLANGCI_LINT) run --path-prefix $(TEST_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TOOLS_DIR); $(GOLANGCI_LINT) run --path-prefix $(TOOLS_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) ./scripts/ci-lint-dockerfiles.sh $(HADOLINT_VER) $(HADOLINT_FAILURE_THRESHOLD) .PHONY: lint-dockerfiles diff --git a/test/infrastructure/docker/LICENSE b/test/infrastructure/docker/LICENSE deleted file mode 100644 index 261eeb9e9..000000000 --- a/test/infrastructure/docker/LICENSE +++ /dev/null @@ -1,201 +0,0 @@ - Apache License - Version 2.0, January 2004 - http://www.apache.org/licenses/ - - TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION - - 1. Definitions. - - \"License\" shall mean the terms and conditions for use, reproduction, - and distribution as defined by Sections 1 through 9 of this document. - - \"Licensor\" shall mean the copyright owner or entity authorized by - the copyright owner that is granting the License. - - \"Legal Entity\" shall mean the union of the acting entity and all - other entities that control, are controlled by, or are under common - control with that entity. For the purposes of this definition, - \"control\" means (i) the power, direct or indirect, to cause the - direction or management of such entity, whether by contract or - otherwise, or (ii) ownership of fifty percent (50%) or more of the - outstanding shares, or (iii) beneficial ownership of such entity. - - \"You\" (or \"Your\") shall mean an individual or Legal Entity - exercising permissions granted by this License. - - \"Source\" form shall mean the preferred form for making modifications, - including but not limited to software source code, documentation - source, and configuration files. - - \"Object\" form shall mean any form resulting from mechanical - transformation or translation of a Source form, including but - not limited to compiled object code, generated documentation, - and conversions to other media types. - - \"Work\" shall mean the work of authorship, whether in Source or - Object form, made available under the License, as indicated by a - copyright notice that is included in or attached to the work - (an example is provided in the Appendix below). - - \"Derivative Works\" shall mean any work, whether in Source or Object - form, that is based on (or derived from) the Work and for which the - editorial revisions, annotations, elaborations, or other modifications - represent, as a whole, an original work of authorship. For the purposes - of this License, Derivative Works shall not include works that remain - separable from, or merely link (or bind by name) to the interfaces of, - the Work and Derivative Works thereof. - - \"Contribution\" shall mean any work of authorship, including - the original version of the Work and any modifications or additions - to that Work or Derivative Works thereof, that is intentionally - submitted to Licensor for inclusion in the Work by the copyright owner - or by an individual or Legal Entity authorized to submit on behalf of - the copyright owner. For the purposes of this definition, \"submitted\" - means any form of electronic, verbal, or written communication sent - to the Licensor or its representatives, including but not limited to - communication on electronic mailing lists, source code control systems, - and issue tracking systems that are managed by, or on behalf of, the - Licensor for the purpose of discussing and improving the Work, but - excluding communication that is conspicuously marked or otherwise - designated in writing by the copyright owner as \"Not a Contribution.\" - - \"Contributor\" shall mean Licensor and any individual or Legal Entity - on behalf of whom a Contribution has been received by Licensor and - subsequently incorporated within the Work. - - 2. Grant of Copyright License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - copyright license to reproduce, prepare Derivative Works of, - publicly display, publicly perform, sublicense, and distribute the - Work and such Derivative Works in Source or Object form. - - 3. Grant of Patent License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - (except as stated in this section) patent license to make, have made, - use, offer to sell, sell, import, and otherwise transfer the Work, - where such license applies only to those patent claims licensable - by such Contributor that are necessarily infringed by their - Contribution(s) alone or by combination of their Contribution(s) - with the Work to which such Contribution(s) was submitted. If You - institute patent litigation against any entity (including a - cross-claim or counterclaim in a lawsuit) alleging that the Work - or a Contribution incorporated within the Work constitutes direct - or contributory patent infringement, then any patent licenses - granted to You under this License for that Work shall terminate - as of the date such litigation is filed. - - 4. Redistribution. You may reproduce and distribute copies of the - Work or Derivative Works thereof in any medium, with or without - modifications, and in Source or Object form, provided that You - meet the following conditions: - - (a) You must give any other recipients of the Work or - Derivative Works a copy of this License; and - - (b) You must cause any modified files to carry prominent notices - stating that You changed the files; and - - (c) You must retain, in the Source form of any Derivative Works - that You distribute, all copyright, patent, trademark, and - attribution notices from the Source form of the Work, - excluding those notices that do not pertain to any part of - the Derivative Works; and - - (d) If the Work includes a \"NOTICE\" text file as part of its - distribution, then any Derivative Works that You distribute must - include a readable copy of the attribution notices contained - within such NOTICE file, excluding those notices that do not - pertain to any part of the Derivative Works, in at least one - of the following places: within a NOTICE text file distributed - as part of the Derivative Works; within the Source form or - documentation, if provided along with the Derivative Works; or, - within a display generated by the Derivative Works, if and - wherever such third-party notices normally appear. The contents - of the NOTICE file are for informational purposes only and - do not modify the License. You may add Your own attribution - notices within Derivative Works that You distribute, alongside - or as an addendum to the NOTICE text from the Work, provided - that such additional attribution notices cannot be construed - as modifying the License. - - You may add Your own copyright statement to Your modifications and - may provide additional or different license terms and conditions - for use, reproduction, or distribution of Your modifications, or - for any such Derivative Works as a whole, provided Your use, - reproduction, and distribution of the Work otherwise complies with - the conditions stated in this License. - - 5. Submission of Contributions. Unless You explicitly state otherwise, - any Contribution intentionally submitted for inclusion in the Work - by You to the Licensor shall be under the terms and conditions of - this License, without any additional terms or conditions. - Notwithstanding the above, nothing herein shall supersede or modify - the terms of any separate license agreement you may have executed - with Licensor regarding such Contributions. - - 6. Trademarks. This License does not grant permission to use the trade - names, trademarks, service marks, or product names of the Licensor, - except as required for reasonable and customary use in describing the - origin of the Work and reproducing the content of the NOTICE file. - - 7. Disclaimer of Warranty. Unless required by applicable law or - agreed to in writing, Licensor provides the Work (and each - Contributor provides its Contributions) on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or - implied, including, without limitation, any warranties or conditions - of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A - PARTICULAR PURPOSE. You are solely responsible for determining the - appropriateness of using or redistributing the Work and assume any - risks associated with Your exercise of permissions under this License. - - 8. Limitation of Liability. In no event and under no legal theory, - whether in tort (including negligence), contract, or otherwise, - unless required by applicable law (such as deliberate and grossly - negligent acts) or agreed to in writing, shall any Contributor be - liable to You for damages, including any direct, indirect, special, - incidental, or consequential damages of any character arising as a - result of this License or out of the use or inability to use the - Work (including but not limited to damages for loss of goodwill, - work stoppage, computer failure or malfunction, or any and all - other commercial damages or losses), even if such Contributor - has been advised of the possibility of such damages. - - 9. Accepting Warranty or Additional Liability. While redistributing - the Work or Derivative Works thereof, You may choose to offer, - and charge a fee for, acceptance of support, warranty, indemnity, - or other liability obligations and/or rights consistent with this - License. However, in accepting such obligations, You may act only - on Your own behalf and on Your sole responsibility, not on behalf - of any other Contributor, and only if You agree to indemnify, - defend, and hold each Contributor harmless for any liability - incurred by, or claims asserted against, such Contributor by reason - of your accepting any such warranty or additional liability. - - END OF TERMS AND CONDITIONS - - APPENDIX: How to apply the Apache License to your work. - - To apply the Apache License to your work, attach the following - boilerplate notice, with the fields enclosed by brackets \"[]\" - replaced with your own identifying information. (Don't include - the brackets!) The text should be enclosed in the appropriate - comment syntax for the file format. We also recommend that a - file or class name and description of purpose be included on the - same \"printed page\" as the copyright notice for easier - identification within third-party archives. - - Copyright [yyyy] [name of copyright owner] - - Licensed under the Apache License, Version 2.0 (the \"License\"); - you may not use this file except in compliance with the License. - You may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 - - Unless required by applicable law or agreed to in writing, software - distributed under the License is distributed on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the License for the specific language governing permissions and - limitations under the License. ", "completion": "Merge pull request #7451 from kubernetes-sigs/dependabot/github_actions/golangci/golangci-lint-action-3.3.0 :seedling: Bump golangci/golangci-lint-action from 3.2.0 to 3.3.0 "}
{"prompt": "diff --git a/Makefile b/Makefile index 05cab73c6..f4ba19a9f 100644 --- a/Makefile +++ b/Makefile @@ -542,8 +542,8 @@ generate-diagrams: ## Generate diagrams for *.plantuml files .PHONY: lint lint: $(GOLANGCI_LINT) ## Lint the codebase $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TEST_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TOOLS_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TEST_DIR); $(GOLANGCI_LINT) run --path-prefix $(TEST_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TOOLS_DIR); $(GOLANGCI_LINT) run --path-prefix $(TOOLS_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) ./scripts/ci-lint-dockerfiles.sh $(HADOLINT_VER) $(HADOLINT_FAILURE_THRESHOLD) .PHONY: lint-dockerfiles diff --git a/test/infrastructure/docker/LICENSE b/test/infrastructure/docker/LICENSE deleted file mode 100644 index 261eeb9e9..000000000 --- a/test/infrastructure/docker/LICENSE +++ /dev/null @@ -1,201 +0,0 @@ - Apache License - Version 2.0, January 2004 - http://www.apache.org/licenses/ - - TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION - - 1. Definitions. - - \"License\" shall mean the terms and conditions for use, reproduction, - and distribution as defined by Sections 1 through 9 of this document. - - \"Licensor\" shall mean the copyright owner or entity authorized by - the copyright owner that is granting the License. - - \"Legal Entity\" shall mean the union of the acting entity and all - other entities that control, are controlled by, or are under common - control with that entity. For the purposes of this definition, - \"control\" means (i) the power, direct or indirect, to cause the - direction or management of such entity, whether by contract or - otherwise, or (ii) ownership of fifty percent (50%) or more of the - outstanding shares, or (iii) beneficial ownership of such entity. - - \"You\" (or \"Your\") shall mean an individual or Legal Entity - exercising permissions granted by this License. - - \"Source\" form shall mean the preferred form for making modifications, - including but not limited to software source code, documentation - source, and configuration files. - - \"Object\" form shall mean any form resulting from mechanical - transformation or translation of a Source form, including but - not limited to compiled object code, generated documentation, - and conversions to other media types. - - \"Work\" shall mean the work of authorship, whether in Source or - Object form, made available under the License, as indicated by a - copyright notice that is included in or attached to the work - (an example is provided in the Appendix below). - - \"Derivative Works\" shall mean any work, whether in Source or Object - form, that is based on (or derived from) the Work and for which the - editorial revisions, annotations, elaborations, or other modifications - represent, as a whole, an original work of authorship. For the purposes - of this License, Derivative Works shall not include works that remain - separable from, or merely link (or bind by name) to the interfaces of, - the Work and Derivative Works thereof. - - \"Contribution\" shall mean any work of authorship, including - the original version of the Work and any modifications or additions - to that Work or Derivative Works thereof, that is intentionally - submitted to Licensor for inclusion in the Work by the copyright owner - or by an individual or Legal Entity authorized to submit on behalf of - the copyright owner. For the purposes of this definition, \"submitted\" - means any form of electronic, verbal, or written communication sent - to the Licensor or its representatives, including but not limited to - communication on electronic mailing lists, source code control systems, - and issue tracking systems that are managed by, or on behalf of, the - Licensor for the purpose of discussing and improving the Work, but - excluding communication that is conspicuously marked or otherwise - designated in writing by the copyright owner as \"Not a Contribution.\" - - \"Contributor\" shall mean Licensor and any individual or Legal Entity - on behalf of whom a Contribution has been received by Licensor and - subsequently incorporated within the Work. - - 2. Grant of Copyright License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - copyright license to reproduce, prepare Derivative Works of, - publicly display, publicly perform, sublicense, and distribute the - Work and such Derivative Works in Source or Object form. - - 3. Grant of Patent License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - (except as stated in this section) patent license to make, have made, - use, offer to sell, sell, import, and otherwise transfer the Work, - where such license applies only to those patent claims licensable - by such Contributor that are necessarily infringed by their - Contribution(s) alone or by combination of their Contribution(s) - with the Work to which such Contribution(s) was submitted. If You - institute patent litigation against any entity (including a - cross-claim or counterclaim in a lawsuit) alleging that the Work - or a Contribution incorporated within the Work constitutes direct - or contributory patent infringement, then any patent licenses - granted to You under this License for that Work shall terminate - as of the date such litigation is filed. - - 4. Redistribution. You may reproduce and distribute copies of the - Work or Derivative Works thereof in any medium, with or without - modifications, and in Source or Object form, provided that You - meet the following conditions: - - (a) You must give any other recipients of the Work or - Derivative Works a copy of this License; and - - (b) You must cause any modified files to carry prominent notices - stating that You changed the files; and - - (c) You must retain, in the Source form of any Derivative Works - that You distribute, all copyright, patent, trademark, and - attribution notices from the Source form of the Work, - excluding those notices that do not pertain to any part of - the Derivative Works; and - - (d) If the Work includes a \"NOTICE\" text file as part of its - distribution, then any Derivative Works that You distribute must - include a readable copy of the attribution notices contained - within such NOTICE file, excluding those notices that do not - pertain to any part of the Derivative Works, in at least one - of the following places: within a NOTICE text file distributed - as part of the Derivative Works; within the Source form or - documentation, if provided along with the Derivative Works; or, - within a display generated by the Derivative Works, if and - wherever such third-party notices normally appear. The contents - of the NOTICE file are for informational purposes only and - do not modify the License. You may add Your own attribution - notices within Derivative Works that You distribute, alongside - or as an addendum to the NOTICE text from the Work, provided - that such additional attribution notices cannot be construed - as modifying the License. - - You may add Your own copyright statement to Your modifications and - may provide additional or different license terms and conditions - for use, reproduction, or distribution of Your modifications, or - for any such Derivative Works as a whole, provided Your use, - reproduction, and distribution of the Work otherwise complies with - the conditions stated in this License. - - 5. Submission of Contributions. Unless You explicitly state otherwise, - any Contribution intentionally submitted for inclusion in the Work - by You to the Licensor shall be under the terms and conditions of - this License, without any additional terms or conditions. - Notwithstanding the above, nothing herein shall supersede or modify - the terms of any separate license agreement you may have executed - with Licensor regarding such Contributions. - - 6. Trademarks. This License does not grant permission to use the trade - names, trademarks, service marks, or product names of the Licensor, - except as required for reasonable and customary use in describing the - origin of the Work and reproducing the content of the NOTICE file. - - 7. Disclaimer of Warranty. Unless required by applicable law or - agreed to in writing, Licensor provides the Work (and each - Contributor provides its Contributions) on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or - implied, including, without limitation, any warranties or conditions - of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A - PARTICULAR PURPOSE. You are solely responsible for determining the - appropriateness of using or redistributing the Work and assume any - risks associated with Your exercise of permissions under this License. - - 8. Limitation of Liability. In no event and under no legal theory, - whether in tort (including negligence), contract, or otherwise, - unless required by applicable law (such as deliberate and grossly - negligent acts) or agreed to in writing, shall any Contributor be - liable to You for damages, including any direct, indirect, special, - incidental, or consequential damages of any character arising as a - result of this License or out of the use or inability to use the - Work (including but not limited to damages for loss of goodwill, - work stoppage, computer failure or malfunction, or any and all - other commercial damages or losses), even if such Contributor - has been advised of the possibility of such damages. - - 9. Accepting Warranty or Additional Liability. While redistributing - the Work or Derivative Works thereof, You may choose to offer, - and charge a fee for, acceptance of support, warranty, indemnity, - or other liability obligations and/or rights consistent with this - License. However, in accepting such obligations, You may act only - on Your own behalf and on Your sole responsibility, not on behalf - of any other Contributor, and only if You agree to indemnify, - defend, and hold each Contributor harmless for any liability - incurred by, or claims asserted against, such Contributor by reason - of your accepting any such warranty or additional liability. - - END OF TERMS AND CONDITIONS - - APPENDIX: How to apply the Apache License to your work. - - To apply the Apache License to your work, attach the following - boilerplate notice, with the fields enclosed by brackets \"[]\" - replaced with your own identifying information. (Don't include - the brackets!) The text should be enclosed in the appropriate - comment syntax for the file format. We also recommend that a - file or class name and description of purpose be included on the - same \"printed page\" as the copyright notice for easier - identification within third-party archives. - - Copyright [yyyy] [name of copyright owner] - - Licensed under the Apache License, Version 2.0 (the \"License\"); - you may not use this file except in compliance with the License. - You may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 - - Unless required by applicable law or agreed to in writing, software - distributed under the License is distributed on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the License for the specific language governing permissions and - limitations under the License. ", "completion": ":seedling: Bump golangci/golangci-lint-action from 3.2.0 to 3.3.0 Bumps [golangci/golangci-lint-action](https://github.com/golangci/golangci-lint-action) from 3.2.0 to 3.3.0. - [Release notes](https://github.com/golangci/golangci-lint-action/releases) - [Commits](https://github.com/golangci/golangci-lint-action/compare/v3.2.0...v3.3.0) --- updated-dependencies: - dependency-name: golangci/golangci-lint-action dependency-type: direct:production update-type: version-update:semver-minor ... Signed-off-by: dependabot[bot] <support@github.com> "}
{"prompt": "diff --git a/.github/workflows/golangci-lint.yml b/.github/workflows/golangci-lint.yml index 84959a00e..264dbb685 100644 --- a/.github/workflows/golangci-lint.yml +++ b/.github/workflows/golangci-lint.yml @@ -23,7 +23,7 @@ jobs: with: go-version: 1.19 - name: golangci-lint - uses: golangci/golangci-lint-action@v3.2.0 + uses: golangci/golangci-lint-action@v3.3.0 with: version: v1.50.0 working-directory: ${{matrix.working-directory}} diff --git a/Makefile b/Makefile index 05cab73c6..f4ba19a9f 100644 --- a/Makefile +++ b/Makefile @@ -542,8 +542,8 @@ generate-diagrams: ## Generate diagrams for *.plantuml files .PHONY: lint lint: $(GOLANGCI_LINT) ## Lint the codebase $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TEST_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TOOLS_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TEST_DIR); $(GOLANGCI_LINT) run --path-prefix $(TEST_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TOOLS_DIR); $(GOLANGCI_LINT) run --path-prefix $(TOOLS_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) ./scripts/ci-lint-dockerfiles.sh $(HADOLINT_VER) $(HADOLINT_FAILURE_THRESHOLD) .PHONY: lint-dockerfiles diff --git a/test/infrastructure/docker/LICENSE b/test/infrastructure/docker/LICENSE deleted file mode 100644 index 261eeb9e9..000000000 --- a/test/infrastructure/docker/LICENSE +++ /dev/null @@ -1,201 +0,0 @@ - Apache License - Version 2.0, January 2004 - http://www.apache.org/licenses/ - - TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION - - 1. Definitions. - - \"License\" shall mean the terms and conditions for use, reproduction, - and distribution as defined by Sections 1 through 9 of this document. - - \"Licensor\" shall mean the copyright owner or entity authorized by - the copyright owner that is granting the License. - - \"Legal Entity\" shall mean the union of the acting entity and all - other entities that control, are controlled by, or are under common - control with that entity. For the purposes of this definition, - \"control\" means (i) the power, direct or indirect, to cause the - direction or management of such entity, whether by contract or - otherwise, or (ii) ownership of fifty percent (50%) or more of the - outstanding shares, or (iii) beneficial ownership of such entity. - - \"You\" (or \"Your\") shall mean an individual or Legal Entity - exercising permissions granted by this License. - - \"Source\" form shall mean the preferred form for making modifications, - including but not limited to software source code, documentation - source, and configuration files. - - \"Object\" form shall mean any form resulting from mechanical - transformation or translation of a Source form, including but - not limited to compiled object code, generated documentation, - and conversions to other media types. - - \"Work\" shall mean the work of authorship, whether in Source or - Object form, made available under the License, as indicated by a - copyright notice that is included in or attached to the work - (an example is provided in the Appendix below). - - \"Derivative Works\" shall mean any work, whether in Source or Object - form, that is based on (or derived from) the Work and for which the - editorial revisions, annotations, elaborations, or other modifications - represent, as a whole, an original work of authorship. For the purposes - of this License, Derivative Works shall not include works that remain - separable from, or merely link (or bind by name) to the interfaces of, - the Work and Derivative Works thereof. - - \"Contribution\" shall mean any work of authorship, including - the original version of the Work and any modifications or additions - to that Work or Derivative Works thereof, that is intentionally - submitted to Licensor for inclusion in the Work by the copyright owner - or by an individual or Legal Entity authorized to submit on behalf of - the copyright owner. For the purposes of this definition, \"submitted\" - means any form of electronic, verbal, or written communication sent - to the Licensor or its representatives, including but not limited to - communication on electronic mailing lists, source code control systems, - and issue tracking systems that are managed by, or on behalf of, the - Licensor for the purpose of discussing and improving the Work, but - excluding communication that is conspicuously marked or otherwise - designated in writing by the copyright owner as \"Not a Contribution.\" - - \"Contributor\" shall mean Licensor and any individual or Legal Entity - on behalf of whom a Contribution has been received by Licensor and - subsequently incorporated within the Work. - - 2. Grant of Copyright License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - copyright license to reproduce, prepare Derivative Works of, - publicly display, publicly perform, sublicense, and distribute the - Work and such Derivative Works in Source or Object form. - - 3. Grant of Patent License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - (except as stated in this section) patent license to make, have made, - use, offer to sell, sell, import, and otherwise transfer the Work, - where such license applies only to those patent claims licensable - by such Contributor that are necessarily infringed by their - Contribution(s) alone or by combination of their Contribution(s) - with the Work to which such Contribution(s) was submitted. If You - institute patent litigation against any entity (including a - cross-claim or counterclaim in a lawsuit) alleging that the Work - or a Contribution incorporated within the Work constitutes direct - or contributory patent infringement, then any patent licenses - granted to You under this License for that Work shall terminate - as of the date such litigation is filed. - - 4. Redistribution. You may reproduce and distribute copies of the - Work or Derivative Works thereof in any medium, with or without - modifications, and in Source or Object form, provided that You - meet the following conditions: - - (a) You must give any other recipients of the Work or - Derivative Works a copy of this License; and - - (b) You must cause any modified files to carry prominent notices - stating that You changed the files; and - - (c) You must retain, in the Source form of any Derivative Works - that You distribute, all copyright, patent, trademark, and - attribution notices from the Source form of the Work, - excluding those notices that do not pertain to any part of - the Derivative Works; and - - (d) If the Work includes a \"NOTICE\" text file as part of its - distribution, then any Derivative Works that You distribute must - include a readable copy of the attribution notices contained - within such NOTICE file, excluding those notices that do not - pertain to any part of the Derivative Works, in at least one - of the following places: within a NOTICE text file distributed - as part of the Derivative Works; within the Source form or - documentation, if provided along with the Derivative Works; or, - within a display generated by the Derivative Works, if and - wherever such third-party notices normally appear. The contents - of the NOTICE file are for informational purposes only and - do not modify the License. You may add Your own attribution - notices within Derivative Works that You distribute, alongside - or as an addendum to the NOTICE text from the Work, provided - that such additional attribution notices cannot be construed - as modifying the License. - - You may add Your own copyright statement to Your modifications and - may provide additional or different license terms and conditions - for use, reproduction, or distribution of Your modifications, or - for any such Derivative Works as a whole, provided Your use, - reproduction, and distribution of the Work otherwise complies with - the conditions stated in this License. - - 5. Submission of Contributions. Unless You explicitly state otherwise, - any Contribution intentionally submitted for inclusion in the Work - by You to the Licensor shall be under the terms and conditions of - this License, without any additional terms or conditions. - Notwithstanding the above, nothing herein shall supersede or modify - the terms of any separate license agreement you may have executed - with Licensor regarding such Contributions. - - 6. Trademarks. This License does not grant permission to use the trade - names, trademarks, service marks, or product names of the Licensor, - except as required for reasonable and customary use in describing the - origin of the Work and reproducing the content of the NOTICE file. - - 7. Disclaimer of Warranty. Unless required by applicable law or - agreed to in writing, Licensor provides the Work (and each - Contributor provides its Contributions) on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or - implied, including, without limitation, any warranties or conditions - of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A - PARTICULAR PURPOSE. You are solely responsible for determining the - appropriateness of using or redistributing the Work and assume any - risks associated with Your exercise of permissions under this License. - - 8. Limitation of Liability. In no event and under no legal theory, - whether in tort (including negligence), contract, or otherwise, - unless required by applicable law (such as deliberate and grossly - negligent acts) or agreed to in writing, shall any Contributor be - liable to You for damages, including any direct, indirect, special, - incidental, or consequential damages of any character arising as a - result of this License or out of the use or inability to use the - Work (including but not limited to damages for loss of goodwill, - work stoppage, computer failure or malfunction, or any and all - other commercial damages or losses), even if such Contributor - has been advised of the possibility of such damages. - - 9. Accepting Warranty or Additional Liability. While redistributing - the Work or Derivative Works thereof, You may choose to offer, - and charge a fee for, acceptance of support, warranty, indemnity, - or other liability obligations and/or rights consistent with this - License. However, in accepting such obligations, You may act only - on Your own behalf and on Your sole responsibility, not on behalf - of any other Contributor, and only if You agree to indemnify, - defend, and hold each Contributor harmless for any liability - incurred by, or claims asserted against, such Contributor by reason - of your accepting any such warranty or additional liability. - - END OF TERMS AND CONDITIONS - - APPENDIX: How to apply the Apache License to your work. - - To apply the Apache License to your work, attach the following - boilerplate notice, with the fields enclosed by brackets \"[]\" - replaced with your own identifying information. (Don't include - the brackets!) The text should be enclosed in the appropriate - comment syntax for the file format. We also recommend that a - file or class name and description of purpose be included on the - same \"printed page\" as the copyright notice for easier - identification within third-party archives. - - Copyright [yyyy] [name of copyright owner] - - Licensed under the Apache License, Version 2.0 (the \"License\"); - you may not use this file except in compliance with the License. - You may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 - - Unless required by applicable law or agreed to in writing, software - distributed under the License is distributed on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the License for the specific language governing permissions and - limitations under the License. ", "completion": "Merge pull request #7442 from oscr/enable-recommended-revive-checks ✨ golangci-lint enable most recommended revive checks and fix findings "}
{"prompt": "diff --git a/.github/workflows/golangci-lint.yml b/.github/workflows/golangci-lint.yml index 84959a00e..264dbb685 100644 --- a/.github/workflows/golangci-lint.yml +++ b/.github/workflows/golangci-lint.yml @@ -23,7 +23,7 @@ jobs: with: go-version: 1.19 - name: golangci-lint - uses: golangci/golangci-lint-action@v3.2.0 + uses: golangci/golangci-lint-action@v3.3.0 with: version: v1.50.0 working-directory: ${{matrix.working-directory}} diff --git a/.golangci.yml b/.golangci.yml index 09232b0cd..903ee75b5 100644 --- a/.golangci.yml +++ b/.golangci.yml @@ -152,6 +152,38 @@ linters-settings: allow-unused: false allow-leading-space: false require-specific: true + revive: + rules: + # The following rules are recommended https://github.com/mgechev/revive#recommended-configuration + - name: blank-imports + - name: context-as-argument + - name: context-keys-type + - name: dot-imports + - name: error-return + - name: error-strings + - name: error-naming + - name: exported + #- name: if-return # TODO This is a recommended rule with many findings which may require it's own pr. + - name: increment-decrement + - name: var-naming + - name: var-declaration + - name: package-comments + - name: range + - name: receiver-naming + - name: time-naming + - name: unexported-return + - name: indent-error-flow + - name: errorf + - name: empty-block + - name: superfluous-else + #- name: unused-parameter # TODO This is a recommended rule with many findings which may require it's own pr. + - name: unreachable-code + - name: redefines-builtin-id + # + # Rules in addition to the recommended configuration above. + # + - name: bool-literal-in-expr + - name: constant-logical-expr gosec: excludes: - G307 # Deferring unsafe method \"Close\" on type \"*os.File\" diff --git a/Makefile b/Makefile index 05cab73c6..f4ba19a9f 100644 --- a/Makefile +++ b/Makefile @@ -542,8 +542,8 @@ generate-diagrams: ## Generate diagrams for *.plantuml files .PHONY: lint lint: $(GOLANGCI_LINT) ## Lint the codebase $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TEST_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TOOLS_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TEST_DIR); $(GOLANGCI_LINT) run --path-prefix $(TEST_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TOOLS_DIR); $(GOLANGCI_LINT) run --path-prefix $(TOOLS_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) ./scripts/ci-lint-dockerfiles.sh $(HADOLINT_VER) $(HADOLINT_FAILURE_THRESHOLD) .PHONY: lint-dockerfiles diff --git a/exp/addons/internal/controllers/clusterresourceset_controller_test.go b/exp/addons/internal/controllers/clusterresourceset_controller_test.go index 3ad985a49..3a14392ae 100644 --- a/exp/addons/internal/controllers/clusterresourceset_controller_test.go +++ b/exp/addons/internal/controllers/clusterresourceset_controller_test.go @@ -188,7 +188,7 @@ metadata: return false } - if binding.Spec.Bindings[0].Resources[0].Applied != true || binding.Spec.Bindings[0].Resources[1].Applied != true { + if !binding.Spec.Bindings[0].Resources[0].Applied || !binding.Spec.Bindings[0].Resources[1].Applied { return false } diff --git a/internal/controllers/machine/machine_controller_test.go b/internal/controllers/machine/machine_controller_test.go index 203e81747..0f4ac9b27 100644 --- a/internal/controllers/machine/machine_controller_test.go +++ b/internal/controllers/machine/machine_controller_test.go @@ -282,7 +282,7 @@ func TestMachine_Reconcile(t *testing.T) { if err := env.Get(ctx, key, machine); err != nil { return false } - if conditions.Has(machine, clusterv1.InfrastructureReadyCondition) != true { + if !conditions.Has(machine, clusterv1.InfrastructureReadyCondition) { return false } readyCondition := conditions.Get(machine, clusterv1.ReadyCondition) diff --git a/test/infrastructure/docker/LICENSE b/test/infrastructure/docker/LICENSE deleted file mode 100644 index 261eeb9e9..000000000 --- a/test/infrastructure/docker/LICENSE +++ /dev/null @@ -1,201 +0,0 @@ - Apache License - Version 2.0, January 2004 - http://www.apache.org/licenses/ - - TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION - - 1. Definitions. - - \"License\" shall mean the terms and conditions for use, reproduction, - and distribution as defined by Sections 1 through 9 of this document. - - \"Licensor\" shall mean the copyright owner or entity authorized by - the copyright owner that is granting the License. - - \"Legal Entity\" shall mean the union of the acting entity and all - other entities that control, are controlled by, or are under common - control with that entity. For the purposes of this definition, - \"control\" means (i) the power, direct or indirect, to cause the - direction or management of such entity, whether by contract or - otherwise, or (ii) ownership of fifty percent (50%) or more of the - outstanding shares, or (iii) beneficial ownership of such entity. - - \"You\" (or \"Your\") shall mean an individual or Legal Entity - exercising permissions granted by this License. - - \"Source\" form shall mean the preferred form for making modifications, - including but not limited to software source code, documentation - source, and configuration files. - - \"Object\" form shall mean any form resulting from mechanical - transformation or translation of a Source form, including but - not limited to compiled object code, generated documentation, - and conversions to other media types. - - \"Work\" shall mean the work of authorship, whether in Source or - Object form, made available under the License, as indicated by a - copyright notice that is included in or attached to the work - (an example is provided in the Appendix below). - - \"Derivative Works\" shall mean any work, whether in Source or Object - form, that is based on (or derived from) the Work and for which the - editorial revisions, annotations, elaborations, or other modifications - represent, as a whole, an original work of authorship. For the purposes - of this License, Derivative Works shall not include works that remain - separable from, or merely link (or bind by name) to the interfaces of, - the Work and Derivative Works thereof. - - \"Contribution\" shall mean any work of authorship, including - the original version of the Work and any modifications or additions - to that Work or Derivative Works thereof, that is intentionally - submitted to Licensor for inclusion in the Work by the copyright owner - or by an individual or Legal Entity authorized to submit on behalf of - the copyright owner. For the purposes of this definition, \"submitted\" - means any form of electronic, verbal, or written communication sent - to the Licensor or its representatives, including but not limited to - communication on electronic mailing lists, source code control systems, - and issue tracking systems that are managed by, or on behalf of, the - Licensor for the purpose of discussing and improving the Work, but - excluding communication that is conspicuously marked or otherwise - designated in writing by the copyright owner as \"Not a Contribution.\" - - \"Contributor\" shall mean Licensor and any individual or Legal Entity - on behalf of whom a Contribution has been received by Licensor and - subsequently incorporated within the Work. - - 2. Grant of Copyright License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - copyright license to reproduce, prepare Derivative Works of, - publicly display, publicly perform, sublicense, and distribute the - Work and such Derivative Works in Source or Object form. - - 3. Grant of Patent License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - (except as stated in this section) patent license to make, have made, - use, offer to sell, sell, import, and otherwise transfer the Work, - where such license applies only to those patent claims licensable - by such Contributor that are necessarily infringed by their - Contribution(s) alone or by combination of their Contribution(s) - with the Work to which such Contribution(s) was submitted. If You - institute patent litigation against any entity (including a - cross-claim or counterclaim in a lawsuit) alleging that the Work - or a Contribution incorporated within the Work constitutes direct - or contributory patent infringement, then any patent licenses - granted to You under this License for that Work shall terminate - as of the date such litigation is filed. - - 4. Redistribution. You may reproduce and distribute copies of the - Work or Derivative Works thereof in any medium, with or without - modifications, and in Source or Object form, provided that You - meet the following conditions: - - (a) You must give any other recipients of the Work or - Derivative Works a copy of this License; and - - (b) You must cause any modified files to carry prominent notices - stating that You changed the files; and - - (c) You must retain, in the Source form of any Derivative Works - that You distribute, all copyright, patent, trademark, and - attribution notices from the Source form of the Work, - excluding those notices that do not pertain to any part of - the Derivative Works; and - - (d) If the Work includes a \"NOTICE\" text file as part of its - distribution, then any Derivative Works that You distribute must - include a readable copy of the attribution notices contained - within such NOTICE file, excluding those notices that do not - pertain to any part of the Derivative Works, in at least one - of the following places: within a NOTICE text file distributed - as part of the Derivative Works; within the Source form or - documentation, if provided along with the Derivative Works; or, - within a display generated by the Derivative Works, if and - wherever such third-party notices normally appear. The contents - of the NOTICE file are for informational purposes only and - do not modify the License. You may add Your own attribution - notices within Derivative Works that You distribute, alongside - or as an addendum to the NOTICE text from the Work, provided - that such additional attribution notices cannot be construed - as modifying the License. - - You may add Your own copyright statement to Your modifications and - may provide additional or different license terms and conditions - for use, reproduction, or distribution of Your modifications, or - for any such Derivative Works as a whole, provided Your use, - reproduction, and distribution of the Work otherwise complies with - the conditions stated in this License. - - 5. Submission of Contributions. Unless You explicitly state otherwise, - any Contribution intentionally submitted for inclusion in the Work - by You to the Licensor shall be under the terms and conditions of - this License, without any additional terms or conditions. - Notwithstanding the above, nothing herein shall supersede or modify - the terms of any separate license agreement you may have executed - with Licensor regarding such Contributions. - - 6. Trademarks. This License does not grant permission to use the trade - names, trademarks, service marks, or product names of the Licensor, - except as required for reasonable and customary use in describing the - origin of the Work and reproducing the content of the NOTICE file. - - 7. Disclaimer of Warranty. Unless required by applicable law or - agreed to in writing, Licensor provides the Work (and each - Contributor provides its Contributions) on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or - implied, including, without limitation, any warranties or conditions - of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A - PARTICULAR PURPOSE. You are solely responsible for determining the - appropriateness of using or redistributing the Work and assume any - risks associated with Your exercise of permissions under this License. - - 8. Limitation of Liability. In no event and under no legal theory, - whether in tort (including negligence), contract, or otherwise, - unless required by applicable law (such as deliberate and grossly - negligent acts) or agreed to in writing, shall any Contributor be - liable to You for damages, including any direct, indirect, special, - incidental, or consequential damages of any character arising as a - result of this License or out of the use or inability to use the - Work (including but not limited to damages for loss of goodwill, - work stoppage, computer failure or malfunction, or any and all - other commercial damages or losses), even if such Contributor - has been advised of the possibility of such damages. - - 9. Accepting Warranty or Additional Liability. While redistributing - the Work or Derivative Works thereof, You may choose to offer, - and charge a fee for, acceptance of support, warranty, indemnity, - or other liability obligations and/or rights consistent with this - License. However, in accepting such obligations, You may act only - on Your own behalf and on Your sole responsibility, not on behalf - of any other Contributor, and only if You agree to indemnify, - defend, and hold each Contributor harmless for any liability - incurred by, or claims asserted against, such Contributor by reason - of your accepting any such warranty or additional liability. - - END OF TERMS AND CONDITIONS - - APPENDIX: How to apply the Apache License to your work. - - To apply the Apache License to your work, attach the following - boilerplate notice, with the fields enclosed by brackets \"[]\" - replaced with your own identifying information. (Don't include - the brackets!) The text should be enclosed in the appropriate - comment syntax for the file format. We also recommend that a - file or class name and description of purpose be included on the - same \"printed page\" as the copyright notice for easier - identification within third-party archives. - - Copyright [yyyy] [name of copyright owner] - - Licensed under the Apache License, Version 2.0 (the \"License\"); - you may not use this file except in compliance with the License. - You may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 - - Unless required by applicable law or agreed to in writing, software - distributed under the License is distributed on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the License for the specific language governing permissions and - limitations under the License. diff --git a/util/patch/patch_test.go b/util/patch/patch_test.go index b300b024d..65ad72671 100644 --- a/util/patch/patch_test.go +++ b/util/patch/patch_test.go @@ -627,7 +627,7 @@ func TestPatchHelper(t *testing.T) { return false } - return objAfter.Spec.Paused == true && + return objAfter.Spec.Paused && reflect.DeepEqual(obj.Spec.InfrastructureRef, objAfter.Spec.InfrastructureRef) }, timeout).Should(BeTrue()) }) diff --git a/util/version/version.go b/util/version/version.go index dcf85fdad..277ed6105 100644 --- a/util/version/version.go +++ b/util/version/version.go @@ -104,9 +104,8 @@ func newBuildIdentifiers(ids []string) buildIdentifiers { func (v buildIdentifiers) compare(o buildIdentifiers) int { i := 0 for ; i < len(v) && i < len(o); i++ { - if comp := v[i].compare(o[i]); comp == 0 { - continue - } else { + comp := v[i].compare(o[i]) + if comp != 0 { return comp } } ", "completion": "Merge pull request #7328 from Jont828/controller-docs 📖 Update optional fields in docs for Machine and Cluster controllers "}
{"prompt": "diff --git a/.github/workflows/golangci-lint.yml b/.github/workflows/golangci-lint.yml index 84959a00e..264dbb685 100644 --- a/.github/workflows/golangci-lint.yml +++ b/.github/workflows/golangci-lint.yml @@ -23,7 +23,7 @@ jobs: with: go-version: 1.19 - name: golangci-lint - uses: golangci/golangci-lint-action@v3.2.0 + uses: golangci/golangci-lint-action@v3.3.0 with: version: v1.50.0 working-directory: ${{matrix.working-directory}} diff --git a/Makefile b/Makefile index 05cab73c6..f4ba19a9f 100644 --- a/Makefile +++ b/Makefile @@ -542,8 +542,8 @@ generate-diagrams: ## Generate diagrams for *.plantuml files .PHONY: lint lint: $(GOLANGCI_LINT) ## Lint the codebase $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TEST_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) - cd $(TOOLS_DIR); $(GOLANGCI_LINT) run -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TEST_DIR); $(GOLANGCI_LINT) run --path-prefix $(TEST_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) + cd $(TOOLS_DIR); $(GOLANGCI_LINT) run --path-prefix $(TOOLS_DIR) -v $(GOLANGCI_LINT_EXTRA_ARGS) ./scripts/ci-lint-dockerfiles.sh $(HADOLINT_VER) $(HADOLINT_FAILURE_THRESHOLD) .PHONY: lint-dockerfiles diff --git a/docs/book/src/developer/architecture/controllers/cluster.md b/docs/book/src/developer/architecture/controllers/cluster.md index 4cf263a41..22f939447 100644 --- a/docs/book/src/developer/architecture/controllers/cluster.md +++ b/docs/book/src/developer/architecture/controllers/cluster.md @@ -44,6 +44,11 @@ The `status` object **may** define several fields that do not affect functionali CONTRIBUTING.md Dockerfile LICENSE Makefile OWNERS OWNERS_ALIASES PROJECT README.md REVIEWING.md SECURITY_CONTACTS Tiltfile api bootstrap cloudbuild-nightly.yaml cloudbuild.yaml cmd code-of-conduct.md config controllers controlplane docs errors exp feature go.mod go.sum hack internal logos main.go metadata.yaml netlify.toml scripts test util version webhooks `failureReason` - is a string that explains why a fatal error has occurred, if possible. CONTRIBUTING.md Dockerfile LICENSE Makefile OWNERS OWNERS_ALIASES PROJECT README.md REVIEWING.md SECURITY_CONTACTS Tiltfile api bootstrap cloudbuild-nightly.yaml cloudbuild.yaml cmd code-of-conduct.md config controllers controlplane docs errors exp feature go.mod go.sum hack internal logos main.go metadata.yaml netlify.toml scripts test util version webhooks `failureMessage` - is a string that holds the message contained by the error. +* `failureDomains` - is a `FailureDomains` type indicating the failure domains that machines should be placed in. `FailureDomains` +is a map, defined as `map[string]FailureDomainSpec`. A unique key must be used for each `FailureDomainSpec`. +`FailureDomainSpec` is defined as: + - `controlPlane` (bool): indicates if failure domain is appropriate for running control plane instances. + - `attributes` (`map[string]string`): arbitrary attributes for users to apply to a failure domain. Example: ```yaml diff --git a/docs/book/src/developer/architecture/controllers/machine.md b/docs/book/src/developer/architecture/controllers/machine.md index f4d974a19..60a235f16 100644 --- a/docs/book/src/developer/architecture/controllers/machine.md +++ b/docs/book/src/developer/architecture/controllers/machine.md @@ -81,6 +81,12 @@ The `spec` object **must** at least one field defined: CONTRIBUTING.md Dockerfile LICENSE Makefile OWNERS OWNERS_ALIASES PROJECT README.md REVIEWING.md SECURITY_CONTACTS Tiltfile api bootstrap cloudbuild-nightly.yaml cloudbuild.yaml cmd code-of-conduct.md config controllers controlplane docs errors exp feature go.mod go.sum hack internal logos main.go metadata.yaml netlify.toml scripts test util version webhooks `providerID` - a cloud provider ID identifying the machine. +#### Optional `spec` fields + +The `spec` object **may** define several fields that do not affect functionality if missing: + +* `failureDomain` - is a string identifying the failure domain the instance is running in. + #### Required `status` fields The `status` object **must** at least one field defined: @@ -93,6 +99,11 @@ The `status` object **may** define several fields that do not affect functionali CONTRIBUTING.md Dockerfile LICENSE Makefile OWNERS OWNERS_ALIASES PROJECT README.md REVIEWING.md SECURITY_CONTACTS Tiltfile api bootstrap cloudbuild-nightly.yaml cloudbuild.yaml cmd code-of-conduct.md config controllers controlplane docs errors exp feature go.mod go.sum hack internal logos main.go metadata.yaml netlify.toml scripts test util version webhooks `failureReason` - is a string that explains why a fatal error has occurred, if possible. CONTRIBUTING.md Dockerfile LICENSE Makefile OWNERS OWNERS_ALIASES PROJECT README.md REVIEWING.md SECURITY_CONTACTS Tiltfile api bootstrap cloudbuild-nightly.yaml cloudbuild.yaml cmd code-of-conduct.md config controllers controlplane docs errors exp feature go.mod go.sum hack internal logos main.go metadata.yaml netlify.toml scripts test util version webhooks `failureMessage` - is a string that holds the message contained by the error. +* `addresses` - is a `MachineAddresses` (a list of `MachineAddress`) which represents host names, external IP addresses, internal IP addresses, +external DNS names, and/or internal DNS names for the provider's machine instance. `MachineAddress` is +defined as: + - `type` (string): one of `Hostname`, `ExternalIP`, `InternalIP`, `ExternalDNS`, `InternalDNS` + - `address` (string) Example: ```yaml diff --git a/docs/book/src/developer/providers/cluster-infrastructure.md b/docs/book/src/developer/providers/cluster-infrastructure.md index a99d4c79c..907ca246f 100644 --- a/docs/book/src/developer/providers/cluster-infrastructure.md +++ b/docs/book/src/developer/providers/cluster-infrastructure.md @@ -30,7 +30,7 @@ A cluster infrastructure provider must define an API type for \"infrastructure cl meant to be suitable for programmatic interpretation 2. `failureMessage` (string): indicates there is a fatal problem reconciling the provider's infrastructure; meant to be a more descriptive value than `failureReason` - 3. `failureDomains` (`failureDomains`): the failure domains that machines should be placed in. `failureDomains` + 3. `failureDomains` (`FailureDomains`): the failure domains that machines should be placed in. `FailureDomains` is a map, defined as `map[string]FailureDomainSpec`. A unique key must be used for each `FailureDomainSpec`. `FailureDomainSpec` is defined as: - `controlPlane` (bool): indicates if failure domain is appropriate for running control plane instances. diff --git a/docs/book/src/developer/providers/machine-infrastructure.md b/docs/book/src/developer/providers/machine-infrastructure.md index 4a20e9fd8..db4cae023 100644 --- a/docs/book/src/developer/providers/machine-infrastructure.md +++ b/docs/book/src/developer/providers/machine-infrastructure.md @@ -37,11 +37,11 @@ A machine infrastructure provider must define an API type for \"infrastructure ma meant to be suitable for programmatic interpretation 2. `failureMessage` (string): indicates there is a fatal problem reconciling the provider's infrastructure; meant to be a more descriptive value than `failureReason` - 3. `addresses` (`MachineAddress`): a list of the host names, external IP addresses, internal IP addresses, + 3. `addresses` (`MachineAddresses`): a list of the host names, external IP addresses, internal IP addresses, external DNS names, and/or internal DNS names for the provider's machine instance. `MachineAddress` is defined as: - - `type` (string): one of `Hostname`, `ExternalIP`, `InternalIP`, `ExternalDNS`, `InternalDNS` - - `address` (string) + - `type` (string): one of `Hostname`, `ExternalIP`, `InternalIP`, `ExternalDNS`, `InternalDNS` + - `address` (string) 7. Should have a conditions field with the following: 1. A Ready condition to represent the overall operational state of the component. It can be based on the summary of more detailed conditions existing on the same object, e.g. instanceReady, SecurityGroupsReady conditions. diff --git a/test/infrastructure/docker/LICENSE b/test/infrastructure/docker/LICENSE deleted file mode 100644 index 261eeb9e9..000000000 --- a/test/infrastructure/docker/LICENSE +++ /dev/null @@ -1,201 +0,0 @@ - Apache License - Version 2.0, January 2004 - http://www.apache.org/licenses/ - - TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION - - 1. Definitions. - - \"License\" shall mean the terms and conditions for use, reproduction, - and distribution as defined by Sections 1 through 9 of this document. - - \"Licensor\" shall mean the copyright owner or entity authorized by - the copyright owner that is granting the License. - - \"Legal Entity\" shall mean the union of the acting entity and all - other entities that control, are controlled by, or are under common - control with that entity. For the purposes of this definition, - \"control\" means (i) the power, direct or indirect, to cause the - direction or management of such entity, whether by contract or - otherwise, or (ii) ownership of fifty percent (50%) or more of the - outstanding shares, or (iii) beneficial ownership of such entity. - - \"You\" (or \"Your\") shall mean an individual or Legal Entity - exercising permissions granted by this License. - - \"Source\" form shall mean the preferred form for making modifications, - including but not limited to software source code, documentation - source, and configuration files. - - \"Object\" form shall mean any form resulting from mechanical - transformation or translation of a Source form, including but - not limited to compiled object code, generated documentation, - and conversions to other media types. - - \"Work\" shall mean the work of authorship, whether in Source or - Object form, made available under the License, as indicated by a - copyright notice that is included in or attached to the work - (an example is provided in the Appendix below). - - \"Derivative Works\" shall mean any work, whether in Source or Object - form, that is based on (or derived from) the Work and for which the - editorial revisions, annotations, elaborations, or other modifications - represent, as a whole, an original work of authorship. For the purposes - of this License, Derivative Works shall not include works that remain - separable from, or merely link (or bind by name) to the interfaces of, - the Work and Derivative Works thereof. - - \"Contribution\" shall mean any work of authorship, including - the original version of the Work and any modifications or additions - to that Work or Derivative Works thereof, that is intentionally - submitted to Licensor for inclusion in the Work by the copyright owner - or by an individual or Legal Entity authorized to submit on behalf of - the copyright owner. For the purposes of this definition, \"submitted\" - means any form of electronic, verbal, or written communication sent - to the Licensor or its representatives, including but not limited to - communication on electronic mailing lists, source code control systems, - and issue tracking systems that are managed by, or on behalf of, the - Licensor for the purpose of discussing and improving the Work, but - excluding communication that is conspicuously marked or otherwise - designated in writing by the copyright owner as \"Not a Contribution.\" - - \"Contributor\" shall mean Licensor and any individual or Legal Entity - on behalf of whom a Contribution has been received by Licensor and - subsequently incorporated within the Work. - - 2. Grant of Copyright License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - copyright license to reproduce, prepare Derivative Works of, - publicly display, publicly perform, sublicense, and distribute the - Work and such Derivative Works in Source or Object form. - - 3. Grant of Patent License. Subject to the terms and conditions of - this License, each Contributor hereby grants to You a perpetual, - worldwide, non-exclusive, no-charge, royalty-free, irrevocable - (except as stated in this section) patent license to make, have made, - use, offer to sell, sell, import, and otherwise transfer the Work, - where such license applies only to those patent claims licensable - by such Contributor that are necessarily infringed by their - Contribution(s) alone or by combination of their Contribution(s) - with the Work to which such Contribution(s) was submitted. If You - institute patent litigation against any entity (including a - cross-claim or counterclaim in a lawsuit) alleging that the Work - or a Contribution incorporated within the Work constitutes direct - or contributory patent infringement, then any patent licenses - granted to You under this License for that Work shall terminate - as of the date such litigation is filed. - - 4. Redistribution. You may reproduce and distribute copies of the - Work or Derivative Works thereof in any medium, with or without - modifications, and in Source or Object form, provided that You - meet the following conditions: - - (a) You must give any other recipients of the Work or - Derivative Works a copy of this License; and - - (b) You must cause any modified files to carry prominent notices - stating that You changed the files; and - - (c) You must retain, in the Source form of any Derivative Works - that You distribute, all copyright, patent, trademark, and - attribution notices from the Source form of the Work, - excluding those notices that do not pertain to any part of - the Derivative Works; and - - (d) If the Work includes a \"NOTICE\" text file as part of its - distribution, then any Derivative Works that You distribute must - include a readable copy of the attribution notices contained - within such NOTICE file, excluding those notices that do not - pertain to any part of the Derivative Works, in at least one - of the following places: within a NOTICE text file distributed - as part of the Derivative Works; within the Source form or - documentation, if provided along with the Derivative Works; or, - within a display generated by the Derivative Works, if and - wherever such third-party notices normally appear. The contents - of the NOTICE file are for informational purposes only and - do not modify the License. You may add Your own attribution - notices within Derivative Works that You distribute, alongside - or as an addendum to the NOTICE text from the Work, provided - that such additional attribution notices cannot be construed - as modifying the License. - - You may add Your own copyright statement to Your modifications and - may provide additional or different license terms and conditions - for use, reproduction, or distribution of Your modifications, or - for any such Derivative Works as a whole, provided Your use, - reproduction, and distribution of the Work otherwise complies with - the conditions stated in this License. - - 5. Submission of Contributions. Unless You explicitly state otherwise, - any Contribution intentionally submitted for inclusion in the Work - by You to the Licensor shall be under the terms and conditions of - this License, without any additional terms or conditions. - Notwithstanding the above, nothing herein shall supersede or modify - the terms of any separate license agreement you may have executed - with Licensor regarding such Contributions. - - 6. Trademarks. This License does not grant permission to use the trade - names, trademarks, service marks, or product names of the Licensor, - except as required for reasonable and customary use in describing the - origin of the Work and reproducing the content of the NOTICE file. - - 7. Disclaimer of Warranty. Unless required by applicable law or - agreed to in writing, Licensor provides the Work (and each - Contributor provides its Contributions) on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or - implied, including, without limitation, any warranties or conditions - of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A - PARTICULAR PURPOSE. You are solely responsible for determining the - appropriateness of using or redistributing the Work and assume any - risks associated with Your exercise of permissions under this License. - - 8. Limitation of Liability. In no event and under no legal theory, - whether in tort (including negligence), contract, or otherwise, - unless required by applicable law (such as deliberate and grossly - negligent acts) or agreed to in writing, shall any Contributor be - liable to You for damages, including any direct, indirect, special, - incidental, or consequential damages of any character arising as a - result of this License or out of the use or inability to use the - Work (including but not limited to damages for loss of goodwill, - work stoppage, computer failure or malfunction, or any and all - other commercial damages or losses), even if such Contributor - has been advised of the possibility of such damages. - - 9. Accepting Warranty or Additional Liability. While redistributing - the Work or Derivative Works thereof, You may choose to offer, - and charge a fee for, acceptance of support, warranty, indemnity, - or other liability obligations and/or rights consistent with this - License. However, in accepting such obligations, You may act only - on Your own behalf and on Your sole responsibility, not on behalf - of any other Contributor, and only if You agree to indemnify, - defend, and hold each Contributor harmless for any liability - incurred by, or claims asserted against, such Contributor by reason - of your accepting any such warranty or additional liability. - - END OF TERMS AND CONDITIONS - - APPENDIX: How to apply the Apache License to your work. - - To apply the Apache License to your work, attach the following - boilerplate notice, with the fields enclosed by brackets \"[]\" - replaced with your own identifying information. (Don't include - the brackets!) The text should be enclosed in the appropriate - comment syntax for the file format. We also recommend that a - file or class name and description of purpose be included on the - same \"printed page\" as the copyright notice for easier - identification within third-party archives. - - Copyright [yyyy] [name of copyright owner] - - Licensed under the Apache License, Version 2.0 (the \"License\"); - you may not use this file except in compliance with the License. - You may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 - - Unless required by applicable law or agreed to in writing, software - distributed under the License is distributed on an \"AS IS\" BASIS, - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the License for the specific language governing permissions and - limitations under the License. ", "completion": "golangci-lint enable most recommended revive checks and fix findings "}
{"prompt": "diff --git a/package.json b/package.json index f6a71f6..9160138 100644 --- a/package.json +++ b/package.json @@ -1,7 +1,7 @@ { \"name\": \"jsencrypt\", \"type\": \"module\", - \"version\": \"3.2.1\", + \"version\": \"3.3.0\", \"description\": \"A Javascript library to perform OpenSSL RSA Encryption, Decryption, and Key Generation.\", \"main\": \"bin/jsencrypt.js\", \"module\": \"lib/index.js\", @@ -11,10 +11,10 @@ \"devDependencies\": { \"@types/expect\": \"^24.3.0\", \"@types/mocha\": \"^10.0.0\", - \"@types/node\": \"^18.7.21\", + \"@types/node\": \"^18.11.4\", \"chai\": \"^4.3.6\", \"dirty-chai\": \"^2.0.1\", - \"fs-jetpack\": \"^5.0.0\", + \"fs-jetpack\": \"^5.1.0\", \"mocha\": \"^10.0.0\", \"process\": \"^0.11.10\", \"ts-mocha\": \"^10.0.0\", @@ -50,6 +50,10 @@ { \"name\": \"Julio\", \"url\": \"https://github.com/jmgaya\" + }, + { + \"name\": \"Taehyun Hwang\", + \"url\": \"https://github.com/HwangTaehyun\" } ], \"homepage\": \"http://www.travistidwell.com/jsencrypt\", diff --git a/yarn.lock b/yarn.lock index 5aa9b3d..b751797 100644 --- a/yarn.lock +++ b/yarn.lock @@ -201,11 +201,16 @@ resolved \"https://registry.yarnpkg.com/@types/mocha/-/mocha-10.0.0.tgz#3d9018c575f0e3f7386c1de80ee66cc21fbb7a52\" integrity sha512-rADY+HtTOA52l9VZWtgQfn4p+UDVM2eDVkMZT1I6syp0YKxW2F9v+0pbRZLsvskhQv/vMb6ZfCay81GHbz5SHg== -\"@types/node@*\", \"@types/node@^18.7.21\": +\"@types/node@*\": version \"18.11.0\" resolved \"https://registry.yarnpkg.com/@types/node/-/node-18.11.0.tgz#f38c7139247a1d619f6cc6f27b072606af7c289d\" integrity sha512-IOXCvVRToe7e0ny7HpT/X9Rb2RYtElG1a+VshjwT00HxrM2dWBApHQoqsI6WiY7Q03vdf2bCrIGzVrkF/5t10w== +\"@types/node@^18.11.4\": + version \"18.11.4\" + resolved \"https://registry.yarnpkg.com/@types/node/-/node-18.11.4.tgz#7017a52e18dfaad32f55eebd539993014441949c\" + integrity sha512-BxcJpBu8D3kv/GZkx/gSMz6VnTJREBj/4lbzYOQueUOELkt8WrO6zAcSPmp9uRPEW/d+lUO8QK0W2xnS1hEU0A== + \"@types/stack-utils@^2.0.0\": version \"2.0.1\" resolved \"https://registry.yarnpkg.com/@types/stack-utils/-/stack-utils-2.0.1.tgz#20f18294f797f2209b5f65c8e3b5c8e8261d127c\" @@ -832,10 +837,10 @@ flat@^5.0.2: resolved \"https://registry.yarnpkg.com/flat/-/flat-5.0.2.tgz#8ca6fe332069ffa9d324c327198c598259ceb241\" integrity sha512-b6suED+5/3rTpUBdG1gupIl8MPFCAMA0QXwmljLhvCUKcUvdE4gWky9zpuGCcXHOsz4J9wPGNWq6OKpmIzz3hQ== -fs-jetpack@^5.0.0: - version \"5.0.0\" - resolved \"https://registry.yarnpkg.com/fs-jetpack/-/fs-jetpack-5.0.0.tgz#020bde38f9d4a5422fc663b7934ac8abdc64a885\" - integrity sha512-0f9QoIbfAq/DuafAQisvsHJmLnJB2D53d9FXIu0UZPUg4Kzocez1+AinToPON6JD/C60kDlye121puiR5ivfdg== +fs-jetpack@^5.1.0: + version \"5.1.0\" + resolved \"https://registry.yarnpkg.com/fs-jetpack/-/fs-jetpack-5.1.0.tgz#dcd34d709b69007c9dc2420a6f2b9e8f986cff0d\" + integrity sha512-Xn4fDhLydXkuzepZVsr02jakLlmoARPy+YWIclo4kh0GyNGUHnTqeH/w/qIsVn50dFxtp8otPL2t/HcPJBbxUA== dependencies: minimatch \"^5.1.0\" ", "completion": "Merge pull request #266 from HwangTaehyun/master Fix test/index.html broken issue "}
{"prompt": "diff --git a/package.json b/package.json index f6a71f6..9160138 100644 --- a/package.json +++ b/package.json @@ -1,7 +1,7 @@ { \"name\": \"jsencrypt\", \"type\": \"module\", - \"version\": \"3.2.1\", + \"version\": \"3.3.0\", \"description\": \"A Javascript library to perform OpenSSL RSA Encryption, Decryption, and Key Generation.\", \"main\": \"bin/jsencrypt.js\", \"module\": \"lib/index.js\", @@ -11,10 +11,10 @@ \"devDependencies\": { \"@types/expect\": \"^24.3.0\", \"@types/mocha\": \"^10.0.0\", - \"@types/node\": \"^18.7.21\", + \"@types/node\": \"^18.11.4\", \"chai\": \"^4.3.6\", \"dirty-chai\": \"^2.0.1\", - \"fs-jetpack\": \"^5.0.0\", + \"fs-jetpack\": \"^5.1.0\", \"mocha\": \"^10.0.0\", \"process\": \"^0.11.10\", \"ts-mocha\": \"^10.0.0\", @@ -50,6 +50,10 @@ { \"name\": \"Julio\", \"url\": \"https://github.com/jmgaya\" + }, + { + \"name\": \"Taehyun Hwang\", + \"url\": \"https://github.com/HwangTaehyun\" } ], \"homepage\": \"http://www.travistidwell.com/jsencrypt\", diff --git a/yarn.lock b/yarn.lock index 5aa9b3d..b751797 100644 --- a/yarn.lock +++ b/yarn.lock @@ -201,11 +201,16 @@ resolved \"https://registry.yarnpkg.com/@types/mocha/-/mocha-10.0.0.tgz#3d9018c575f0e3f7386c1de80ee66cc21fbb7a52\" integrity sha512-rADY+HtTOA52l9VZWtgQfn4p+UDVM2eDVkMZT1I6syp0YKxW2F9v+0pbRZLsvskhQv/vMb6ZfCay81GHbz5SHg== -\"@types/node@*\", \"@types/node@^18.7.21\": +\"@types/node@*\": version \"18.11.0\" resolved \"https://registry.yarnpkg.com/@types/node/-/node-18.11.0.tgz#f38c7139247a1d619f6cc6f27b072606af7c289d\" integrity sha512-IOXCvVRToe7e0ny7HpT/X9Rb2RYtElG1a+VshjwT00HxrM2dWBApHQoqsI6WiY7Q03vdf2bCrIGzVrkF/5t10w== +\"@types/node@^18.11.4\": + version \"18.11.4\" + resolved \"https://registry.yarnpkg.com/@types/node/-/node-18.11.4.tgz#7017a52e18dfaad32f55eebd539993014441949c\" + integrity sha512-BxcJpBu8D3kv/GZkx/gSMz6VnTJREBj/4lbzYOQueUOELkt8WrO6zAcSPmp9uRPEW/d+lUO8QK0W2xnS1hEU0A== + \"@types/stack-utils@^2.0.0\": version \"2.0.1\" resolved \"https://registry.yarnpkg.com/@types/stack-utils/-/stack-utils-2.0.1.tgz#20f18294f797f2209b5f65c8e3b5c8e8261d127c\" @@ -832,10 +837,10 @@ flat@^5.0.2: resolved \"https://registry.yarnpkg.com/flat/-/flat-5.0.2.tgz#8ca6fe332069ffa9d324c327198c598259ceb241\" integrity sha512-b6suED+5/3rTpUBdG1gupIl8MPFCAMA0QXwmljLhvCUKcUvdE4gWky9zpuGCcXHOsz4J9wPGNWq6OKpmIzz3hQ== -fs-jetpack@^5.0.0: - version \"5.0.0\" - resolved \"https://registry.yarnpkg.com/fs-jetpack/-/fs-jetpack-5.0.0.tgz#020bde38f9d4a5422fc663b7934ac8abdc64a885\" - integrity sha512-0f9QoIbfAq/DuafAQisvsHJmLnJB2D53d9FXIu0UZPUg4Kzocez1+AinToPON6JD/C60kDlye121puiR5ivfdg== +fs-jetpack@^5.1.0: + version \"5.1.0\" + resolved \"https://registry.yarnpkg.com/fs-jetpack/-/fs-jetpack-5.1.0.tgz#dcd34d709b69007c9dc2420a6f2b9e8f986cff0d\" + integrity sha512-Xn4fDhLydXkuzepZVsr02jakLlmoARPy+YWIclo4kh0GyNGUHnTqeH/w/qIsVn50dFxtp8otPL2t/HcPJBbxUA== dependencies: minimatch \"^5.1.0\" ", "completion": "Add build:test script to build script "}
{"prompt": "diff --git a/package.json b/package.json index f6f2732..9160138 100644 --- a/package.json +++ b/package.json @@ -1,7 +1,7 @@ { \"name\": \"jsencrypt\", \"type\": \"module\", - \"version\": \"3.2.1\", + \"version\": \"3.3.0\", \"description\": \"A Javascript library to perform OpenSSL RSA Encryption, Decryption, and Key Generation.\", \"main\": \"bin/jsencrypt.js\", \"module\": \"lib/index.js\", @@ -11,10 +11,10 @@ \"devDependencies\": { \"@types/expect\": \"^24.3.0\", \"@types/mocha\": \"^10.0.0\", - \"@types/node\": \"^18.7.21\", + \"@types/node\": \"^18.11.4\", \"chai\": \"^4.3.6\", \"dirty-chai\": \"^2.0.1\", - \"fs-jetpack\": \"^5.0.0\", + \"fs-jetpack\": \"^5.1.0\", \"mocha\": \"^10.0.0\", \"process\": \"^0.11.10\", \"ts-mocha\": \"^10.0.0\", @@ -32,7 +32,7 @@ \"build:dev\": \"tsc && tsc --project tsconfig-def.json && webpack\", \"build:test\": \"tsc && tsc --project tsconfig-def.json && webpack --config webpack.test.js\", \"build:prod\": \"tsc && tsc --project tsconfig-def.json && webpack --config webpack.prod.js\", - \"build\": \"npm run build:dev && npm run build:prod\", + \"build\": \"npm run build:dev && npm run build:test && npm run build:prod\", \"serve\": \"bundle exec jekyll server --config _config.build.yml\", \"test\": \"ts-mocha test/test.rsa.js\" }, @@ -50,6 +50,10 @@ { \"name\": \"Julio\", \"url\": \"https://github.com/jmgaya\" + }, + { + \"name\": \"Taehyun Hwang\", + \"url\": \"https://github.com/HwangTaehyun\" } ], \"homepage\": \"http://www.travistidwell.com/jsencrypt\", diff --git a/yarn.lock b/yarn.lock index 5aa9b3d..b751797 100644 --- a/yarn.lock +++ b/yarn.lock @@ -201,11 +201,16 @@ resolved \"https://registry.yarnpkg.com/@types/mocha/-/mocha-10.0.0.tgz#3d9018c575f0e3f7386c1de80ee66cc21fbb7a52\" integrity sha512-rADY+HtTOA52l9VZWtgQfn4p+UDVM2eDVkMZT1I6syp0YKxW2F9v+0pbRZLsvskhQv/vMb6ZfCay81GHbz5SHg== -\"@types/node@*\", \"@types/node@^18.7.21\": +\"@types/node@*\": version \"18.11.0\" resolved \"https://registry.yarnpkg.com/@types/node/-/node-18.11.0.tgz#f38c7139247a1d619f6cc6f27b072606af7c289d\" integrity sha512-IOXCvVRToe7e0ny7HpT/X9Rb2RYtElG1a+VshjwT00HxrM2dWBApHQoqsI6WiY7Q03vdf2bCrIGzVrkF/5t10w== +\"@types/node@^18.11.4\": + version \"18.11.4\" + resolved \"https://registry.yarnpkg.com/@types/node/-/node-18.11.4.tgz#7017a52e18dfaad32f55eebd539993014441949c\" + integrity sha512-BxcJpBu8D3kv/GZkx/gSMz6VnTJREBj/4lbzYOQueUOELkt8WrO6zAcSPmp9uRPEW/d+lUO8QK0W2xnS1hEU0A== + \"@types/stack-utils@^2.0.0\": version \"2.0.1\" resolved \"https://registry.yarnpkg.com/@types/stack-utils/-/stack-utils-2.0.1.tgz#20f18294f797f2209b5f65c8e3b5c8e8261d127c\" @@ -832,10 +837,10 @@ flat@^5.0.2: resolved \"https://registry.yarnpkg.com/flat/-/flat-5.0.2.tgz#8ca6fe332069ffa9d324c327198c598259ceb241\" integrity sha512-b6suED+5/3rTpUBdG1gupIl8MPFCAMA0QXwmljLhvCUKcUvdE4gWky9zpuGCcXHOsz4J9wPGNWq6OKpmIzz3hQ== -fs-jetpack@^5.0.0: - version \"5.0.0\" - resolved \"https://registry.yarnpkg.com/fs-jetpack/-/fs-jetpack-5.0.0.tgz#020bde38f9d4a5422fc663b7934ac8abdc64a885\" - integrity sha512-0f9QoIbfAq/DuafAQisvsHJmLnJB2D53d9FXIu0UZPUg4Kzocez1+AinToPON6JD/C60kDlye121puiR5ivfdg== +fs-jetpack@^5.1.0: + version \"5.1.0\" + resolved \"https://registry.yarnpkg.com/fs-jetpack/-/fs-jetpack-5.1.0.tgz#dcd34d709b69007c9dc2420a6f2b9e8f986cff0d\" + integrity sha512-Xn4fDhLydXkuzepZVsr02jakLlmoARPy+YWIclo4kh0GyNGUHnTqeH/w/qIsVn50dFxtp8otPL2t/HcPJBbxUA== dependencies: minimatch \"^5.1.0\" ", "completion": "Change test.rsa.js to test.rsa.bundle.js "}
{"prompt": "diff --git a/package.json b/package.json index f6f2732..9160138 100644 --- a/package.json +++ b/package.json @@ -1,7 +1,7 @@ { \"name\": \"jsencrypt\", \"type\": \"module\", - \"version\": \"3.2.1\", + \"version\": \"3.3.0\", \"description\": \"A Javascript library to perform OpenSSL RSA Encryption, Decryption, and Key Generation.\", \"main\": \"bin/jsencrypt.js\", \"module\": \"lib/index.js\", @@ -11,10 +11,10 @@ \"devDependencies\": { \"@types/expect\": \"^24.3.0\", \"@types/mocha\": \"^10.0.0\", - \"@types/node\": \"^18.7.21\", + \"@types/node\": \"^18.11.4\", \"chai\": \"^4.3.6\", \"dirty-chai\": \"^2.0.1\", - \"fs-jetpack\": \"^5.0.0\", + \"fs-jetpack\": \"^5.1.0\", \"mocha\": \"^10.0.0\", \"process\": \"^0.11.10\", \"ts-mocha\": \"^10.0.0\", @@ -32,7 +32,7 @@ \"build:dev\": \"tsc && tsc --project tsconfig-def.json && webpack\", \"build:test\": \"tsc && tsc --project tsconfig-def.json && webpack --config webpack.test.js\", \"build:prod\": \"tsc && tsc --project tsconfig-def.json && webpack --config webpack.prod.js\", - \"build\": \"npm run build:dev && npm run build:prod\", + \"build\": \"npm run build:dev && npm run build:test && npm run build:prod\", \"serve\": \"bundle exec jekyll server --config _config.build.yml\", \"test\": \"ts-mocha test/test.rsa.js\" }, @@ -50,6 +50,10 @@ { \"name\": \"Julio\", \"url\": \"https://github.com/jmgaya\" + }, + { + \"name\": \"Taehyun Hwang\", + \"url\": \"https://github.com/HwangTaehyun\" } ], \"homepage\": \"http://www.travistidwell.com/jsencrypt\", diff --git a/test/index.html b/test/index.html index 2b92eb3..3a1b178 100644 --- a/test/index.html +++ b/test/index.html @@ -2,13 +2,16 @@ title: Testing JSEncrypt layout: default --- -<link href=\"test/libs/mocha.css\" rel=\"stylesheet\" type=\"text/css\"> + +<link href=\"test/libs/mocha.css\" rel=\"stylesheet\" type=\"text/css\" /> <div id=\"mocha\"></div> <script type=\"text/javascript\" src=\"test/libs/index.js\"></script> <script type=\"text/javascript\" src=\"test/libs/mocha.js\"></script> -<script>mocha.setup('bdd')</script> -<script type=\"text/javascript\" src=\"test/test.rsa.js\"></script> <script> - mocha.checkLeaks(); - mocha.run(); + mocha.setup(\"bdd\"); +</script> +<script type=\"text/javascript\" src=\"test/test.rsa.bundle.js\"></script> +<script> + mocha.checkLeaks(); + mocha.run(); </script> diff --git a/yarn.lock b/yarn.lock index 5aa9b3d..b751797 100644 --- a/yarn.lock +++ b/yarn.lock @@ -201,11 +201,16 @@ resolved \"https://registry.yarnpkg.com/@types/mocha/-/mocha-10.0.0.tgz#3d9018c575f0e3f7386c1de80ee66cc21fbb7a52\" integrity sha512-rADY+HtTOA52l9VZWtgQfn4p+UDVM2eDVkMZT1I6syp0YKxW2F9v+0pbRZLsvskhQv/vMb6ZfCay81GHbz5SHg== -\"@types/node@*\", \"@types/node@^18.7.21\": +\"@types/node@*\": version \"18.11.0\" resolved \"https://registry.yarnpkg.com/@types/node/-/node-18.11.0.tgz#f38c7139247a1d619f6cc6f27b072606af7c289d\" integrity sha512-IOXCvVRToe7e0ny7HpT/X9Rb2RYtElG1a+VshjwT00HxrM2dWBApHQoqsI6WiY7Q03vdf2bCrIGzVrkF/5t10w== +\"@types/node@^18.11.4\": + version \"18.11.4\" + resolved \"https://registry.yarnpkg.com/@types/node/-/node-18.11.4.tgz#7017a52e18dfaad32f55eebd539993014441949c\" + integrity sha512-BxcJpBu8D3kv/GZkx/gSMz6VnTJREBj/4lbzYOQueUOELkt8WrO6zAcSPmp9uRPEW/d+lUO8QK0W2xnS1hEU0A== + \"@types/stack-utils@^2.0.0\": version \"2.0.1\" resolved \"https://registry.yarnpkg.com/@types/stack-utils/-/stack-utils-2.0.1.tgz#20f18294f797f2209b5f65c8e3b5c8e8261d127c\" @@ -832,10 +837,10 @@ flat@^5.0.2: resolved \"https://registry.yarnpkg.com/flat/-/flat-5.0.2.tgz#8ca6fe332069ffa9d324c327198c598259ceb241\" integrity sha512-b6suED+5/3rTpUBdG1gupIl8MPFCAMA0QXwmljLhvCUKcUvdE4gWky9zpuGCcXHOsz4J9wPGNWq6OKpmIzz3hQ== -fs-jetpack@^5.0.0: - version \"5.0.0\" - resolved \"https://registry.yarnpkg.com/fs-jetpack/-/fs-jetpack-5.0.0.tgz#020bde38f9d4a5422fc663b7934ac8abdc64a885\" - integrity sha512-0f9QoIbfAq/DuafAQisvsHJmLnJB2D53d9FXIu0UZPUg4Kzocez1+AinToPON6JD/C60kDlye121puiR5ivfdg== +fs-jetpack@^5.1.0: + version \"5.1.0\" + resolved \"https://registry.yarnpkg.com/fs-jetpack/-/fs-jetpack-5.1.0.tgz#dcd34d709b69007c9dc2420a6f2b9e8f986cff0d\" + integrity sha512-Xn4fDhLydXkuzepZVsr02jakLlmoARPy+YWIclo4kh0GyNGUHnTqeH/w/qIsVn50dFxtp8otPL2t/HcPJBbxUA== dependencies: minimatch \"^5.1.0\" ", "completion": "Change test.rsa.js not to use key file "}
{"prompt": "diff --git a/examples/code_browser.py b/examples/code_browser.py index 678e8396..90303a5d 100644 --- a/examples/code_browser.py +++ b/examples/code_browser.py @@ -11,8 +11,6 @@ import sys from rich.syntax import Syntax from rich.traceback import Traceback - -from textual import events from textual.app import App, ComposeResult from textual.containers import Container, Vertical from textual.reactive import var @@ -32,7 +30,7 @@ class CodeBrowser(App): def watch_show_tree(self, show_tree: bool) -> None: \"\"\"Called when show_tree is modified.\"\"\" - self.set_class(show_tree, \"-show-tree\") + self.set_class(show_tree, \"-show-tree\") def compose(self) -> ComposeResult: \"\"\"Compose our UI.\"\"\" @@ -44,9 +42,6 @@ class CodeBrowser(App): ) yield Footer() - def on_mount(self, event: events.Mount) -> None: - self.query_one(DirectoryTree).focus() - def on_directory_tree_file_click(self, event: DirectoryTree.FileClick) -> None: \"\"\"Called when the user click a file in the directory tree.\"\"\" code_view = self.query_one(\"#code\", Static) ", "completion": "Focus the directory tree "}
{"prompt": "diff --git a/.github/workflows/pythonpackage.yml b/.github/workflows/pythonpackage.yml index ad5e23f6..ee439baf 100644 --- a/.github/workflows/pythonpackage.yml +++ b/.github/workflows/pythonpackage.yml @@ -8,7 +8,7 @@ jobs: strategy: matrix: os: [ubuntu-latest, macos-latest, windows-latest] - python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\", \"3.11\"] + python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\"] defaults: run: shell: bash @@ -20,9 +20,9 @@ jobs: python-version: ${{ matrix.python-version }} architecture: x64 - name: Install and configure Poetry - uses: snok/install-poetry@v1.3.3 + uses: snok/install-poetry@v1.1.6 with: - version: 1.2.2 + version: 1.1.6 virtualenvs-in-project: true - name: Install dependencies run: poetry install --extras \"dev\" diff --git a/src/textual/app.py b/src/textual/app.py index 0f1282c6..43f1bd56 100644 --- a/src/textual/app.py +++ b/src/textual/app.py @@ -641,7 +641,6 @@ class App(Generic[ReturnType], DOMNode): await asyncio.sleep(0.02) await app._animator.wait_for_idle() - await asyncio.sleep(0.05) if screenshot: self._screenshot = self.export_screenshot( ", "completion": "Add small delay before screenshot is taken "}
{"prompt": "diff --git a/.github/workflows/pythonpackage.yml b/.github/workflows/pythonpackage.yml index ad5e23f6..ee439baf 100644 --- a/.github/workflows/pythonpackage.yml +++ b/.github/workflows/pythonpackage.yml @@ -8,7 +8,7 @@ jobs: strategy: matrix: os: [ubuntu-latest, macos-latest, windows-latest] - python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\", \"3.11\"] + python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\"] defaults: run: shell: bash @@ -20,9 +20,9 @@ jobs: python-version: ${{ matrix.python-version }} architecture: x64 - name: Install and configure Poetry - uses: snok/install-poetry@v1.3.3 + uses: snok/install-poetry@v1.1.6 with: - version: 1.2.2 + version: 1.1.6 virtualenvs-in-project: true - name: Install dependencies run: poetry install --extras \"dev\" ", "completion": "Python 3.11 CI "}
{"prompt": "diff --git a/.github/workflows/pythonpackage.yml b/.github/workflows/pythonpackage.yml index 99cdc0db..ee439baf 100644 --- a/.github/workflows/pythonpackage.yml +++ b/.github/workflows/pythonpackage.yml @@ -8,7 +8,7 @@ jobs: strategy: matrix: os: [ubuntu-latest, macos-latest, windows-latest] - python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\", \"3.11-rc.2\"] + python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\"] defaults: run: shell: bash @@ -20,9 +20,9 @@ jobs: python-version: ${{ matrix.python-version }} architecture: x64 - name: Install and configure Poetry - uses: snok/install-poetry@v1.3.3 + uses: snok/install-poetry@v1.1.6 with: - version: 1.2.2 + version: 1.1.6 virtualenvs-in-project: true - name: Install dependencies run: poetry install --extras \"dev\" ", "completion": "Revert build action to 3.11-rc.2 until Darwin build ready "}
{"prompt": "diff --git a/.github/workflows/pythonpackage.yml b/.github/workflows/pythonpackage.yml index ad5e23f6..ee439baf 100644 --- a/.github/workflows/pythonpackage.yml +++ b/.github/workflows/pythonpackage.yml @@ -8,7 +8,7 @@ jobs: strategy: matrix: os: [ubuntu-latest, macos-latest, windows-latest] - python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\", \"3.11\"] + python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\"] defaults: run: shell: bash @@ -20,9 +20,9 @@ jobs: python-version: ${{ matrix.python-version }} architecture: x64 - name: Install and configure Poetry - uses: snok/install-poetry@v1.3.3 + uses: snok/install-poetry@v1.1.6 with: - version: 1.2.2 + version: 1.1.6 virtualenvs-in-project: true - name: Install dependencies run: poetry install --extras \"dev\" ", "completion": "Fix GitHub action install-poetry version "}
{"prompt": "diff --git a/.github/workflows/pythonpackage.yml b/.github/workflows/pythonpackage.yml index 5ac2288c..ee439baf 100644 --- a/.github/workflows/pythonpackage.yml +++ b/.github/workflows/pythonpackage.yml @@ -8,7 +8,7 @@ jobs: strategy: matrix: os: [ubuntu-latest, macos-latest, windows-latest] - python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\", \"3.11\"] + python-version: [\"3.7\", \"3.8\", \"3.9\", \"3.10\"] defaults: run: shell: bash @@ -22,7 +22,7 @@ jobs: - name: Install and configure Poetry uses: snok/install-poetry@v1.1.6 with: - version: 1.3.3 + version: 1.1.6 virtualenvs-in-project: true - name: Install dependencies run: poetry install --extras \"dev\" ", "completion": "Add Python 3.11 to CI, update install-poetry action "}
{"prompt": "diff --git a/.github/workflows/comment.yml b/.github/workflows/comment.yml index b7a4c7f4..7191f183 100644 --- a/.github/workflows/comment.yml +++ b/.github/workflows/comment.yml @@ -15,6 +15,4 @@ jobs: body: | Did we solve your problem? - Consider buying the Textualize developers a [coffee](https://ko-fi.com/textualize) to say thanks. - - &ndash; [Textualize](https://twitter.com/textualizeio) + Glad we could help! diff --git a/CHANGELOG.md b/CHANGELOG.md index 32fe8eab..ad4f0949 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -5,6 +5,12 @@ All notable changes to this project will be documented in this file. The format is based on [Keep a Changelog](http://keepachangelog.com/) and this project adheres to [Semantic Versioning](http://semver.org/). +## [0.2.2] - Unreleased + +### Changed + +- DOMQuery now raises InvalidQueryFormat in response to invalid query strings, rather than cryptic CSS error + ## [0.2.1] - 2022-10-23 ### Changed diff --git a/docs/guide/input.md b/docs/guide/input.md index 968e19c7..5052a5dd 100644 --- a/docs/guide/input.md +++ b/docs/guide/input.md @@ -78,7 +78,7 @@ The following example shows how focus works in practice. ```{.textual path=\"docs/examples/guide/input/key03.py\", press=\"tab,H,e,l,l,o,tab,W,o,r,l,d,!,_\"} ``` -The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that thw widget has focus. Key events will be sent to the focused widget only. +The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that the widget has focus. Key events will be sent to the focused widget only. !!! tip diff --git a/docs/tutorial.md b/docs/tutorial.md index 7a69c787..7fa4486c 100644 --- a/docs/tutorial.md +++ b/docs/tutorial.md @@ -430,7 +430,7 @@ The Stopwatch app creates widgets when it starts via the `compose` method. We wi Let's use these methods to implement adding and removing stopwatches to our app. -```python title=\"stopwatch.py\" hl_lines=\"78-79 88-92 94-98\" +```python title=\"stopwatch.py\" hl_lines=\"78-79 86 88-92 94-98\" --8<-- \"docs/examples/tutorial/stopwatch.py\" ``` diff --git a/examples/calculator.py b/examples/calculator.py index 60d982f9..e42273fe 100644 --- a/examples/calculator.py +++ b/examples/calculator.py @@ -28,7 +28,8 @@ class CalculatorApp(App): \"plus_minus_sign\": \"plus-minus\", \"percent_sign\": \"percent\", \"equals_sign\": \"equals\", - \"enter\": \"equals\", + \"minus\": \"minus\", + \"plus\": \"plus\", } def watch_numbers(self, value: str) -> None: @@ -80,7 +81,6 @@ class CalculatorApp(App): self.query_one(f\"#{button_id}\", Button).press() except NoMatches: pass - self.set_focus(None) key = event.key if key.isdecimal(): @@ -89,7 +89,9 @@ class CalculatorApp(App): press(\"c\") press(\"ac\") else: - press(self.NAME_MAP.get(key, key)) + button_id = self.NAME_MAP.get(key) + if button_id is not None: + press(self.NAME_MAP.get(key, key)) def on_button_pressed(self, event: Button.Pressed) -> None: \"\"\"Called when a button is pressed.\"\"\" diff --git a/examples/five_by_five.py b/examples/five_by_five.py index 84a50d63..20bbea80 100644 --- a/examples/five_by_five.py +++ b/examples/five_by_five.py @@ -24,8 +24,8 @@ from rich.markdown import Markdown class Help(Screen): \"\"\"The help screen for the application.\"\"\" - #: Bindings for the help screen. BINDINGS = [(\"escape,space,q,question_mark\", \"pop_screen\", \"Close\")] + \"\"\"Bindings for the help screen.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game's help. @@ -39,8 +39,8 @@ class Help(Screen): class WinnerMessage(Static): \"\"\"Widget to tell the user they have won.\"\"\" - #: The minimum number of moves you can solve the puzzle in. MIN_MOVES: Final = 14 + \"\"\"int: The minimum number of moves you can solve the puzzle in.\"\"\" @staticmethod def _plural(value: int) -> str: @@ -78,11 +78,11 @@ class GameHeader(Widget): and the count of how many cells are turned on (``#progress``). \"\"\" - #: Keep track of how many moves the player has made. moves = reactive(0) + \"\"\"int: Keep track of how many moves the player has made.\"\"\" - #: Keep track of how many cells are filled. filled = reactive(0) + \"\"\"int: Keep track of how many cells are filled.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game header. @@ -159,10 +159,9 @@ class GameGrid(Widget): class Game(Screen): \"\"\"Main 5x5 game grid screen.\"\"\" - #: The size of the game grid. Clue's in the name really. - SIZE = 5 + SIZE: Final = 5 + \"\"\"The size of the game grid. Clue's in the name really.\"\"\" - #: The bindings for the main game grid. BINDINGS = [ Binding(\"n\", \"new_game\", \"New Game\"), Binding(\"question_mark\", \"push_screen('help')\", \"Help\", key_display=\"?\"), @@ -173,6 +172,7 @@ class Game(Screen): Binding(\"right,d,l\", \"navigate(0,1)\", \"Move Right\", False), Binding(\"space\", \"move\", \"Toggle\", False), ] + \"\"\"The bindings for the main game grid.\"\"\" @property def filled_cells(self) -> DOMQuery[GameCell]: @@ -308,17 +308,17 @@ class Game(Screen): class FiveByFive(App[None]): \"\"\"Main 5x5 application class.\"\"\" - #: The name of the stylesheet for the app. CSS_PATH = \"five_by_five.css\" + \"\"\"The name of the stylesheet for the app.\"\"\" - #: The pre-loaded screens for the application. SCREENS = {\"help\": Help()} + \"\"\"The pre-loaded screens for the application.\"\"\" - #: App-level bindings. BINDINGS = [(\"ctrl+d\", \"toggle_dark\", \"Toggle Dark Mode\")] + \"\"\"App-level bindings.\"\"\" - # Set the title TITLE = \"5x5 -- A little annoying puzzle\" + \"\"\"The title of the application.\"\"\" def on_mount(self) -> None: \"\"\"Set up the application on startup.\"\"\" diff --git a/src/textual/css/query.py b/src/textual/css/query.py index 93addb6f..e0d58820 100644 --- a/src/textual/css/query.py +++ b/src/textual/css/query.py @@ -20,7 +20,7 @@ from typing import cast, Generic, TYPE_CHECKING, Iterator, TypeVar, overload import rich.repr -from .errors import DeclarationError +from .errors import DeclarationError, TokenError from .match import match from .model import SelectorSet from .parse import parse_declarations, parse_selectors @@ -34,6 +34,10 @@ class QueryError(Exception): \"\"\"Base class for a query related error.\"\"\" +class InvalidQueryFormat(QueryError): + \"\"\"Query did not parse correctly.\"\"\" + + class NoMatches(QueryError): \"\"\"No nodes matched the query.\"\"\" @@ -72,9 +76,17 @@ class DOMQuery(Generic[QueryType]): parent._excludes.copy() if parent else [] ) if filter is not None: - self._filters.append(parse_selectors(filter)) + try: + self._filters.append(parse_selectors(filter)) + except TokenError: + # TODO: More helpful errors + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") + if exclude is not None: - self._excludes.append(parse_selectors(exclude)) + try: + self._excludes.append(parse_selectors(exclude)) + except TokenError: + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") @property def node(self) -> DOMNode: diff --git a/tests/test_arrange.py b/tests/test_arrange.py index 580d68e0..f66f0195 100644 --- a/tests/test_arrange.py +++ b/tests/test_arrange.py @@ -1,3 +1,5 @@ +import pytest + from textual._arrange import arrange, TOP_Z from textual._layout import WidgetPlacement from textual.geometry import Region, Size, Spacing @@ -91,3 +93,9 @@ def test_arrange_dock_bottom(): ] assert widgets == {child, header} assert spacing == Spacing(0, 0, 1, 0) + +def test_arrange_dock_badly(): + child = Widget(id=\"child\") + child.styles.dock = \"nowhere\" + with pytest.raises(AssertionError): + _ = arrange( Widget(), [child], Size(80, 24), Size(80, 24)) diff --git a/tests/test_binding.py b/tests/test_binding.py index d2d61ac1..620fbc03 100644 --- a/tests/test_binding.py +++ b/tests/test_binding.py @@ -1,6 +1,8 @@ +from string import ascii_lowercase + import pytest -from textual.binding import Bindings, Binding +from textual.binding import Bindings, Binding, BindingError, NoBinding BINDING1 = Binding(\"a,b\", action=\"action1\", description=\"description1\") BINDING2 = Binding(\"c\", action=\"action2\", description=\"description2\") @@ -14,14 +16,14 @@ def bindings(): def test_bindings_get_key(bindings): assert bindings.get_key(\"b\") == Binding(\"b\", action=\"action1\", description=\"description1\") assert bindings.get_key(\"c\") == BINDING2 - + with pytest.raises(NoBinding): + bindings.get_key(\"control+meta+alt+shift+super+hyper+t\") def test_bindings_merge_simple(bindings): left = Bindings([BINDING1]) right = Bindings([BINDING2]) assert Bindings.merge([left, right]).keys == bindings.keys - def test_bindings_merge_overlap(): left = Bindings([BINDING1]) another_binding = Binding(\"a\", action=\"another_action\", description=\"another_description\") @@ -29,3 +31,20 @@ def test_bindings_merge_overlap(): \"a\": another_binding, \"b\": Binding(\"b\", action=\"action1\", description=\"description1\"), } + +def test_bad_binding_tuple(): + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\"),)) + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\", \"description\",\"too much\"),)) + +def test_binding_from_tuples(): + assert Bindings((( BINDING2.key, BINDING2.action, BINDING2.description),)).get_key(\"c\") == BINDING2 + +def test_shown(): + bindings = Bindings([ + Binding( + key, action=f\"action_{key}\", description=f\"Emits {key}\",show=bool(ord(key)%2) + ) for key in ascii_lowercase + ]) + assert len(bindings.shown_keys)==(len(ascii_lowercase)/2) diff --git a/tests/test_cache.py b/tests/test_cache.py index e81b7e06..aedcbfc4 100644 --- a/tests/test_cache.py +++ b/tests/test_cache.py @@ -61,6 +61,25 @@ def test_lru_cache_get(): assert \"egg\" not in cache assert \"eggegg\" in cache +def test_lru_cache_maxsize(): + cache = LRUCache(3) + + # Be sure that maxsize reports what we gave above. + assert cache.maxsize == 3, \"Incorrect cache maxsize\" + + # Now resize the cache by setting maxsize. + cache.maxsize = 30 + + # Check that it's reporting that back. + assert cache.maxsize == 30, \"Incorrect cache maxsize after setting it\" + + # Add more than maxsize items to the cache and be sure + for spam in range(cache.maxsize+10): + cache[f\"spam{spam}\"] = spam + + # Finally, check the cache is the max size we set. + assert len(cache) == 30, \"Cache grew too large given maxsize\" + def test_lru_cache_mapping(): \"\"\"Test cache values can be set and read back.\"\"\" diff --git a/tests/test_geometry.py b/tests/test_geometry.py index 02cac2fa..6b9cd07b 100644 --- a/tests/test_geometry.py +++ b/tests/test_geometry.py @@ -295,6 +295,10 @@ def test_size_sub(): Size(1, 2) - \"foo\" +def test_size_line_range(): + assert Size(20, 0).line_range == range(0) + assert Size(0, 20).line_range == range(20) + def test_region_x_extents(): assert Region(5, 10, 20, 30).column_span == (5, 25) diff --git a/tests/test_path.py b/tests/test_path.py new file mode 100644 index 00000000..77b4f3d8 --- /dev/null +++ b/tests/test_path.py @@ -0,0 +1,43 @@ +from typing import Type +from pathlib import Path + +from textual.app import App + +class RelativePathObjectApp(App[None]): + + CSS_PATH = Path(\"test.css\") + +class RelativePathStrApp(App[None]): + + CSS_PATH = \"test.css\" + +class AbsolutePathObjectApp(App[None]): + + CSS_PATH = Path(\"/tmp/test.css\") + +class AbsolutePathStrApp(App[None]): + + CSS_PATH = \"/tmp/test.css\" + +def path_tester(obj_type: Type[App[None]], str_type: Type[App[None]], intended_result: Path) -> None: + assert isinstance(obj_type().css_path,Path), ( + \"CSS_PATH didn't stay as an object\" + ) + assert isinstance(str_type().css_path,Path), ( + \"CSS_PATH wasn't converted from str to Path\" + ) + assert obj_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == obj_type().css_path, ( + \"CSS_PATH str to Path conversion gave a different result\" + ) + +def test_relative_path(): + path_tester(RelativePathObjectApp, RelativePathStrApp, ((Path(__file__).absolute().parent ) / \"test.css\").absolute()) + +def test_absolute_path(): + path_tester(AbsolutePathObjectApp, AbsolutePathStrApp, Path(\"/tmp/test.css\").absolute()) diff --git a/tests/test_query.py b/tests/test_query.py index be610804..373d8d0e 100644 --- a/tests/test_query.py +++ b/tests/test_query.py @@ -1,4 +1,7 @@ +import pytest + from textual.widget import Widget +from textual.css.query import InvalidQueryFormat def test_query(): @@ -78,3 +81,16 @@ def test_query(): assert list(app.query(\"#widget1, #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1 , #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1, #widget2, App\")) == [app, widget1, widget2] + + +def test_invalid_query(): + class App(Widget): + pass + + app = App() + + with pytest.raises(InvalidQueryFormat): + app.query(\"#3\") + + with pytest.raises(InvalidQueryFormat): + app.query(\"#foo\").exclude(\"#2\") ", "completion": "Check some more widget state "}
{"prompt": "diff --git a/.github/workflows/comment.yml b/.github/workflows/comment.yml index b7a4c7f4..7191f183 100644 --- a/.github/workflows/comment.yml +++ b/.github/workflows/comment.yml @@ -15,6 +15,4 @@ jobs: body: | Did we solve your problem? - Consider buying the Textualize developers a [coffee](https://ko-fi.com/textualize) to say thanks. - - &ndash; [Textualize](https://twitter.com/textualizeio) + Glad we could help! diff --git a/CHANGELOG.md b/CHANGELOG.md index 32fe8eab..ad4f0949 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -5,6 +5,12 @@ All notable changes to this project will be documented in this file. The format is based on [Keep a Changelog](http://keepachangelog.com/) and this project adheres to [Semantic Versioning](http://semver.org/). +## [0.2.2] - Unreleased + +### Changed + +- DOMQuery now raises InvalidQueryFormat in response to invalid query strings, rather than cryptic CSS error + ## [0.2.1] - 2022-10-23 ### Changed diff --git a/docs/guide/input.md b/docs/guide/input.md index 968e19c7..5052a5dd 100644 --- a/docs/guide/input.md +++ b/docs/guide/input.md @@ -78,7 +78,7 @@ The following example shows how focus works in practice. ```{.textual path=\"docs/examples/guide/input/key03.py\", press=\"tab,H,e,l,l,o,tab,W,o,r,l,d,!,_\"} ``` -The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that thw widget has focus. Key events will be sent to the focused widget only. +The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that the widget has focus. Key events will be sent to the focused widget only. !!! tip diff --git a/docs/tutorial.md b/docs/tutorial.md index 7a69c787..7fa4486c 100644 --- a/docs/tutorial.md +++ b/docs/tutorial.md @@ -430,7 +430,7 @@ The Stopwatch app creates widgets when it starts via the `compose` method. We wi Let's use these methods to implement adding and removing stopwatches to our app. -```python title=\"stopwatch.py\" hl_lines=\"78-79 88-92 94-98\" +```python title=\"stopwatch.py\" hl_lines=\"78-79 86 88-92 94-98\" --8<-- \"docs/examples/tutorial/stopwatch.py\" ``` diff --git a/examples/calculator.py b/examples/calculator.py index 60d982f9..e42273fe 100644 --- a/examples/calculator.py +++ b/examples/calculator.py @@ -28,7 +28,8 @@ class CalculatorApp(App): \"plus_minus_sign\": \"plus-minus\", \"percent_sign\": \"percent\", \"equals_sign\": \"equals\", - \"enter\": \"equals\", + \"minus\": \"minus\", + \"plus\": \"plus\", } def watch_numbers(self, value: str) -> None: @@ -80,7 +81,6 @@ class CalculatorApp(App): self.query_one(f\"#{button_id}\", Button).press() except NoMatches: pass - self.set_focus(None) key = event.key if key.isdecimal(): @@ -89,7 +89,9 @@ class CalculatorApp(App): press(\"c\") press(\"ac\") else: - press(self.NAME_MAP.get(key, key)) + button_id = self.NAME_MAP.get(key) + if button_id is not None: + press(self.NAME_MAP.get(key, key)) def on_button_pressed(self, event: Button.Pressed) -> None: \"\"\"Called when a button is pressed.\"\"\" diff --git a/examples/five_by_five.py b/examples/five_by_five.py index 84a50d63..20bbea80 100644 --- a/examples/five_by_five.py +++ b/examples/five_by_five.py @@ -24,8 +24,8 @@ from rich.markdown import Markdown class Help(Screen): \"\"\"The help screen for the application.\"\"\" - #: Bindings for the help screen. BINDINGS = [(\"escape,space,q,question_mark\", \"pop_screen\", \"Close\")] + \"\"\"Bindings for the help screen.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game's help. @@ -39,8 +39,8 @@ class Help(Screen): class WinnerMessage(Static): \"\"\"Widget to tell the user they have won.\"\"\" - #: The minimum number of moves you can solve the puzzle in. MIN_MOVES: Final = 14 + \"\"\"int: The minimum number of moves you can solve the puzzle in.\"\"\" @staticmethod def _plural(value: int) -> str: @@ -78,11 +78,11 @@ class GameHeader(Widget): and the count of how many cells are turned on (``#progress``). \"\"\" - #: Keep track of how many moves the player has made. moves = reactive(0) + \"\"\"int: Keep track of how many moves the player has made.\"\"\" - #: Keep track of how many cells are filled. filled = reactive(0) + \"\"\"int: Keep track of how many cells are filled.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game header. @@ -159,10 +159,9 @@ class GameGrid(Widget): class Game(Screen): \"\"\"Main 5x5 game grid screen.\"\"\" - #: The size of the game grid. Clue's in the name really. - SIZE = 5 + SIZE: Final = 5 + \"\"\"The size of the game grid. Clue's in the name really.\"\"\" - #: The bindings for the main game grid. BINDINGS = [ Binding(\"n\", \"new_game\", \"New Game\"), Binding(\"question_mark\", \"push_screen('help')\", \"Help\", key_display=\"?\"), @@ -173,6 +172,7 @@ class Game(Screen): Binding(\"right,d,l\", \"navigate(0,1)\", \"Move Right\", False), Binding(\"space\", \"move\", \"Toggle\", False), ] + \"\"\"The bindings for the main game grid.\"\"\" @property def filled_cells(self) -> DOMQuery[GameCell]: @@ -308,17 +308,17 @@ class Game(Screen): class FiveByFive(App[None]): \"\"\"Main 5x5 application class.\"\"\" - #: The name of the stylesheet for the app. CSS_PATH = \"five_by_five.css\" + \"\"\"The name of the stylesheet for the app.\"\"\" - #: The pre-loaded screens for the application. SCREENS = {\"help\": Help()} + \"\"\"The pre-loaded screens for the application.\"\"\" - #: App-level bindings. BINDINGS = [(\"ctrl+d\", \"toggle_dark\", \"Toggle Dark Mode\")] + \"\"\"App-level bindings.\"\"\" - # Set the title TITLE = \"5x5 -- A little annoying puzzle\" + \"\"\"The title of the application.\"\"\" def on_mount(self) -> None: \"\"\"Set up the application on startup.\"\"\" diff --git a/src/textual/css/query.py b/src/textual/css/query.py index 93addb6f..e0d58820 100644 --- a/src/textual/css/query.py +++ b/src/textual/css/query.py @@ -20,7 +20,7 @@ from typing import cast, Generic, TYPE_CHECKING, Iterator, TypeVar, overload import rich.repr -from .errors import DeclarationError +from .errors import DeclarationError, TokenError from .match import match from .model import SelectorSet from .parse import parse_declarations, parse_selectors @@ -34,6 +34,10 @@ class QueryError(Exception): \"\"\"Base class for a query related error.\"\"\" +class InvalidQueryFormat(QueryError): + \"\"\"Query did not parse correctly.\"\"\" + + class NoMatches(QueryError): \"\"\"No nodes matched the query.\"\"\" @@ -72,9 +76,17 @@ class DOMQuery(Generic[QueryType]): parent._excludes.copy() if parent else [] ) if filter is not None: - self._filters.append(parse_selectors(filter)) + try: + self._filters.append(parse_selectors(filter)) + except TokenError: + # TODO: More helpful errors + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") + if exclude is not None: - self._excludes.append(parse_selectors(exclude)) + try: + self._excludes.append(parse_selectors(exclude)) + except TokenError: + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") @property def node(self) -> DOMNode: diff --git a/tests/snapshot_tests/test_snapshots.py b/tests/snapshot_tests/test_snapshots.py index cbc12b51..2f04c931 100644 --- a/tests/snapshot_tests/test_snapshots.py +++ b/tests/snapshot_tests/test_snapshots.py @@ -3,7 +3,7 @@ from pathlib import Path, PurePosixPath import pytest from textual.app import App -from textual.widgets import Input +from textual.widgets import Input, Button # --- Layout related stuff --- @@ -69,12 +69,17 @@ def test_input_and_focus(snap_compare): input: Input = app.query_one(Input) assert input.value == \"Darren\" assert input.cursor_position == 6 + assert input.view_position == 0 def test_buttons_render(snap_compare): # Testing button rendering. We press tab to focus the first button too. assert snap_compare(\"docs/examples/widgets/button.py\", press=[\"tab\"]) + app = snap_compare.app + button: Button = app.query_one(Button) + assert app.focused is button + def test_datatable_render(snap_compare): press = [\"tab\", \"down\", \"down\", \"right\", \"up\", \"left\"] diff --git a/tests/test_arrange.py b/tests/test_arrange.py index 580d68e0..f66f0195 100644 --- a/tests/test_arrange.py +++ b/tests/test_arrange.py @@ -1,3 +1,5 @@ +import pytest + from textual._arrange import arrange, TOP_Z from textual._layout import WidgetPlacement from textual.geometry import Region, Size, Spacing @@ -91,3 +93,9 @@ def test_arrange_dock_bottom(): ] assert widgets == {child, header} assert spacing == Spacing(0, 0, 1, 0) + +def test_arrange_dock_badly(): + child = Widget(id=\"child\") + child.styles.dock = \"nowhere\" + with pytest.raises(AssertionError): + _ = arrange( Widget(), [child], Size(80, 24), Size(80, 24)) diff --git a/tests/test_binding.py b/tests/test_binding.py index d2d61ac1..620fbc03 100644 --- a/tests/test_binding.py +++ b/tests/test_binding.py @@ -1,6 +1,8 @@ +from string import ascii_lowercase + import pytest -from textual.binding import Bindings, Binding +from textual.binding import Bindings, Binding, BindingError, NoBinding BINDING1 = Binding(\"a,b\", action=\"action1\", description=\"description1\") BINDING2 = Binding(\"c\", action=\"action2\", description=\"description2\") @@ -14,14 +16,14 @@ def bindings(): def test_bindings_get_key(bindings): assert bindings.get_key(\"b\") == Binding(\"b\", action=\"action1\", description=\"description1\") assert bindings.get_key(\"c\") == BINDING2 - + with pytest.raises(NoBinding): + bindings.get_key(\"control+meta+alt+shift+super+hyper+t\") def test_bindings_merge_simple(bindings): left = Bindings([BINDING1]) right = Bindings([BINDING2]) assert Bindings.merge([left, right]).keys == bindings.keys - def test_bindings_merge_overlap(): left = Bindings([BINDING1]) another_binding = Binding(\"a\", action=\"another_action\", description=\"another_description\") @@ -29,3 +31,20 @@ def test_bindings_merge_overlap(): \"a\": another_binding, \"b\": Binding(\"b\", action=\"action1\", description=\"description1\"), } + +def test_bad_binding_tuple(): + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\"),)) + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\", \"description\",\"too much\"),)) + +def test_binding_from_tuples(): + assert Bindings((( BINDING2.key, BINDING2.action, BINDING2.description),)).get_key(\"c\") == BINDING2 + +def test_shown(): + bindings = Bindings([ + Binding( + key, action=f\"action_{key}\", description=f\"Emits {key}\",show=bool(ord(key)%2) + ) for key in ascii_lowercase + ]) + assert len(bindings.shown_keys)==(len(ascii_lowercase)/2) diff --git a/tests/test_cache.py b/tests/test_cache.py index e81b7e06..aedcbfc4 100644 --- a/tests/test_cache.py +++ b/tests/test_cache.py @@ -61,6 +61,25 @@ def test_lru_cache_get(): assert \"egg\" not in cache assert \"eggegg\" in cache +def test_lru_cache_maxsize(): + cache = LRUCache(3) + + # Be sure that maxsize reports what we gave above. + assert cache.maxsize == 3, \"Incorrect cache maxsize\" + + # Now resize the cache by setting maxsize. + cache.maxsize = 30 + + # Check that it's reporting that back. + assert cache.maxsize == 30, \"Incorrect cache maxsize after setting it\" + + # Add more than maxsize items to the cache and be sure + for spam in range(cache.maxsize+10): + cache[f\"spam{spam}\"] = spam + + # Finally, check the cache is the max size we set. + assert len(cache) == 30, \"Cache grew too large given maxsize\" + def test_lru_cache_mapping(): \"\"\"Test cache values can be set and read back.\"\"\" diff --git a/tests/test_geometry.py b/tests/test_geometry.py index 02cac2fa..6b9cd07b 100644 --- a/tests/test_geometry.py +++ b/tests/test_geometry.py @@ -295,6 +295,10 @@ def test_size_sub(): Size(1, 2) - \"foo\" +def test_size_line_range(): + assert Size(20, 0).line_range == range(0) + assert Size(0, 20).line_range == range(20) + def test_region_x_extents(): assert Region(5, 10, 20, 30).column_span == (5, 25) diff --git a/tests/test_path.py b/tests/test_path.py new file mode 100644 index 00000000..77b4f3d8 --- /dev/null +++ b/tests/test_path.py @@ -0,0 +1,43 @@ +from typing import Type +from pathlib import Path + +from textual.app import App + +class RelativePathObjectApp(App[None]): + + CSS_PATH = Path(\"test.css\") + +class RelativePathStrApp(App[None]): + + CSS_PATH = \"test.css\" + +class AbsolutePathObjectApp(App[None]): + + CSS_PATH = Path(\"/tmp/test.css\") + +class AbsolutePathStrApp(App[None]): + + CSS_PATH = \"/tmp/test.css\" + +def path_tester(obj_type: Type[App[None]], str_type: Type[App[None]], intended_result: Path) -> None: + assert isinstance(obj_type().css_path,Path), ( + \"CSS_PATH didn't stay as an object\" + ) + assert isinstance(str_type().css_path,Path), ( + \"CSS_PATH wasn't converted from str to Path\" + ) + assert obj_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == obj_type().css_path, ( + \"CSS_PATH str to Path conversion gave a different result\" + ) + +def test_relative_path(): + path_tester(RelativePathObjectApp, RelativePathStrApp, ((Path(__file__).absolute().parent ) / \"test.css\").absolute()) + +def test_absolute_path(): + path_tester(AbsolutePathObjectApp, AbsolutePathStrApp, Path(\"/tmp/test.css\").absolute()) diff --git a/tests/test_query.py b/tests/test_query.py index be610804..373d8d0e 100644 --- a/tests/test_query.py +++ b/tests/test_query.py @@ -1,4 +1,7 @@ +import pytest + from textual.widget import Widget +from textual.css.query import InvalidQueryFormat def test_query(): @@ -78,3 +81,16 @@ def test_query(): assert list(app.query(\"#widget1, #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1 , #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1, #widget2, App\")) == [app, widget1, widget2] + + +def test_invalid_query(): + class App(Widget): + pass + + app = App() + + with pytest.raises(InvalidQueryFormat): + app.query(\"#3\") + + with pytest.raises(InvalidQueryFormat): + app.query(\"#foo\").exclude(\"#2\") ", "completion": "Remove unused snapshot "}
{"prompt": "diff --git a/.github/workflows/comment.yml b/.github/workflows/comment.yml index b7a4c7f4..7191f183 100644 --- a/.github/workflows/comment.yml +++ b/.github/workflows/comment.yml @@ -15,6 +15,4 @@ jobs: body: | Did we solve your problem? - Consider buying the Textualize developers a [coffee](https://ko-fi.com/textualize) to say thanks. - - &ndash; [Textualize](https://twitter.com/textualizeio) + Glad we could help! diff --git a/CHANGELOG.md b/CHANGELOG.md index 32fe8eab..ad4f0949 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -5,6 +5,12 @@ All notable changes to this project will be documented in this file. The format is based on [Keep a Changelog](http://keepachangelog.com/) and this project adheres to [Semantic Versioning](http://semver.org/). +## [0.2.2] - Unreleased + +### Changed + +- DOMQuery now raises InvalidQueryFormat in response to invalid query strings, rather than cryptic CSS error + ## [0.2.1] - 2022-10-23 ### Changed diff --git a/docs/guide/input.md b/docs/guide/input.md index 968e19c7..5052a5dd 100644 --- a/docs/guide/input.md +++ b/docs/guide/input.md @@ -78,7 +78,7 @@ The following example shows how focus works in practice. ```{.textual path=\"docs/examples/guide/input/key03.py\", press=\"tab,H,e,l,l,o,tab,W,o,r,l,d,!,_\"} ``` -The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that thw widget has focus. Key events will be sent to the focused widget only. +The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that the widget has focus. Key events will be sent to the focused widget only. !!! tip diff --git a/docs/tutorial.md b/docs/tutorial.md index 7a69c787..7fa4486c 100644 --- a/docs/tutorial.md +++ b/docs/tutorial.md @@ -430,7 +430,7 @@ The Stopwatch app creates widgets when it starts via the `compose` method. We wi Let's use these methods to implement adding and removing stopwatches to our app. -```python title=\"stopwatch.py\" hl_lines=\"78-79 88-92 94-98\" +```python title=\"stopwatch.py\" hl_lines=\"78-79 86 88-92 94-98\" --8<-- \"docs/examples/tutorial/stopwatch.py\" ``` diff --git a/examples/calculator.py b/examples/calculator.py index 60d982f9..e42273fe 100644 --- a/examples/calculator.py +++ b/examples/calculator.py @@ -28,7 +28,8 @@ class CalculatorApp(App): \"plus_minus_sign\": \"plus-minus\", \"percent_sign\": \"percent\", \"equals_sign\": \"equals\", - \"enter\": \"equals\", + \"minus\": \"minus\", + \"plus\": \"plus\", } def watch_numbers(self, value: str) -> None: @@ -80,7 +81,6 @@ class CalculatorApp(App): self.query_one(f\"#{button_id}\", Button).press() except NoMatches: pass - self.set_focus(None) key = event.key if key.isdecimal(): @@ -89,7 +89,9 @@ class CalculatorApp(App): press(\"c\") press(\"ac\") else: - press(self.NAME_MAP.get(key, key)) + button_id = self.NAME_MAP.get(key) + if button_id is not None: + press(self.NAME_MAP.get(key, key)) def on_button_pressed(self, event: Button.Pressed) -> None: \"\"\"Called when a button is pressed.\"\"\" diff --git a/examples/five_by_five.py b/examples/five_by_five.py index 84a50d63..20bbea80 100644 --- a/examples/five_by_five.py +++ b/examples/five_by_five.py @@ -24,8 +24,8 @@ from rich.markdown import Markdown class Help(Screen): \"\"\"The help screen for the application.\"\"\" - #: Bindings for the help screen. BINDINGS = [(\"escape,space,q,question_mark\", \"pop_screen\", \"Close\")] + \"\"\"Bindings for the help screen.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game's help. @@ -39,8 +39,8 @@ class Help(Screen): class WinnerMessage(Static): \"\"\"Widget to tell the user they have won.\"\"\" - #: The minimum number of moves you can solve the puzzle in. MIN_MOVES: Final = 14 + \"\"\"int: The minimum number of moves you can solve the puzzle in.\"\"\" @staticmethod def _plural(value: int) -> str: @@ -78,11 +78,11 @@ class GameHeader(Widget): and the count of how many cells are turned on (``#progress``). \"\"\" - #: Keep track of how many moves the player has made. moves = reactive(0) + \"\"\"int: Keep track of how many moves the player has made.\"\"\" - #: Keep track of how many cells are filled. filled = reactive(0) + \"\"\"int: Keep track of how many cells are filled.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game header. @@ -159,10 +159,9 @@ class GameGrid(Widget): class Game(Screen): \"\"\"Main 5x5 game grid screen.\"\"\" - #: The size of the game grid. Clue's in the name really. - SIZE = 5 + SIZE: Final = 5 + \"\"\"The size of the game grid. Clue's in the name really.\"\"\" - #: The bindings for the main game grid. BINDINGS = [ Binding(\"n\", \"new_game\", \"New Game\"), Binding(\"question_mark\", \"push_screen('help')\", \"Help\", key_display=\"?\"), @@ -173,6 +172,7 @@ class Game(Screen): Binding(\"right,d,l\", \"navigate(0,1)\", \"Move Right\", False), Binding(\"space\", \"move\", \"Toggle\", False), ] + \"\"\"The bindings for the main game grid.\"\"\" @property def filled_cells(self) -> DOMQuery[GameCell]: @@ -308,17 +308,17 @@ class Game(Screen): class FiveByFive(App[None]): \"\"\"Main 5x5 application class.\"\"\" - #: The name of the stylesheet for the app. CSS_PATH = \"five_by_five.css\" + \"\"\"The name of the stylesheet for the app.\"\"\" - #: The pre-loaded screens for the application. SCREENS = {\"help\": Help()} + \"\"\"The pre-loaded screens for the application.\"\"\" - #: App-level bindings. BINDINGS = [(\"ctrl+d\", \"toggle_dark\", \"Toggle Dark Mode\")] + \"\"\"App-level bindings.\"\"\" - # Set the title TITLE = \"5x5 -- A little annoying puzzle\" + \"\"\"The title of the application.\"\"\" def on_mount(self) -> None: \"\"\"Set up the application on startup.\"\"\" diff --git a/src/textual/css/query.py b/src/textual/css/query.py index 93addb6f..e0d58820 100644 --- a/src/textual/css/query.py +++ b/src/textual/css/query.py @@ -20,7 +20,7 @@ from typing import cast, Generic, TYPE_CHECKING, Iterator, TypeVar, overload import rich.repr -from .errors import DeclarationError +from .errors import DeclarationError, TokenError from .match import match from .model import SelectorSet from .parse import parse_declarations, parse_selectors @@ -34,6 +34,10 @@ class QueryError(Exception): \"\"\"Base class for a query related error.\"\"\" +class InvalidQueryFormat(QueryError): + \"\"\"Query did not parse correctly.\"\"\" + + class NoMatches(QueryError): \"\"\"No nodes matched the query.\"\"\" @@ -72,9 +76,17 @@ class DOMQuery(Generic[QueryType]): parent._excludes.copy() if parent else [] ) if filter is not None: - self._filters.append(parse_selectors(filter)) + try: + self._filters.append(parse_selectors(filter)) + except TokenError: + # TODO: More helpful errors + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") + if exclude is not None: - self._excludes.append(parse_selectors(exclude)) + try: + self._excludes.append(parse_selectors(exclude)) + except TokenError: + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") @property def node(self) -> DOMNode: diff --git a/tests/snapshot_tests/test_snapshots.py b/tests/snapshot_tests/test_snapshots.py index d68bb5c2..2f04c931 100644 --- a/tests/snapshot_tests/test_snapshots.py +++ b/tests/snapshot_tests/test_snapshots.py @@ -1,9 +1,9 @@ -from pathlib import Path +from pathlib import Path, PurePosixPath import pytest from textual.app import App -from textual.widgets import Input +from textual.widgets import Input, Button # --- Layout related stuff --- @@ -69,12 +69,17 @@ def test_input_and_focus(snap_compare): input: Input = app.query_one(Input) assert input.value == \"Darren\" assert input.cursor_position == 6 + assert input.view_position == 0 def test_buttons_render(snap_compare): # Testing button rendering. We press tab to focus the first button too. assert snap_compare(\"docs/examples/widgets/button.py\", press=[\"tab\"]) + app = snap_compare.app + button: Button = app.query_one(Button) + assert app.focused is button + def test_datatable_render(snap_compare): press = [\"tab\", \"down\", \"down\", \"right\", \"up\", \"left\"] @@ -94,7 +99,7 @@ def test_header_render(snap_compare): # If any of these change, something has likely broken, so snapshot each of them. PATHS = [ - str(path) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" + str(PurePosixPath(path)) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" ] diff --git a/tests/test_arrange.py b/tests/test_arrange.py index 580d68e0..f66f0195 100644 --- a/tests/test_arrange.py +++ b/tests/test_arrange.py @@ -1,3 +1,5 @@ +import pytest + from textual._arrange import arrange, TOP_Z from textual._layout import WidgetPlacement from textual.geometry import Region, Size, Spacing @@ -91,3 +93,9 @@ def test_arrange_dock_bottom(): ] assert widgets == {child, header} assert spacing == Spacing(0, 0, 1, 0) + +def test_arrange_dock_badly(): + child = Widget(id=\"child\") + child.styles.dock = \"nowhere\" + with pytest.raises(AssertionError): + _ = arrange( Widget(), [child], Size(80, 24), Size(80, 24)) diff --git a/tests/test_binding.py b/tests/test_binding.py index d2d61ac1..620fbc03 100644 --- a/tests/test_binding.py +++ b/tests/test_binding.py @@ -1,6 +1,8 @@ +from string import ascii_lowercase + import pytest -from textual.binding import Bindings, Binding +from textual.binding import Bindings, Binding, BindingError, NoBinding BINDING1 = Binding(\"a,b\", action=\"action1\", description=\"description1\") BINDING2 = Binding(\"c\", action=\"action2\", description=\"description2\") @@ -14,14 +16,14 @@ def bindings(): def test_bindings_get_key(bindings): assert bindings.get_key(\"b\") == Binding(\"b\", action=\"action1\", description=\"description1\") assert bindings.get_key(\"c\") == BINDING2 - + with pytest.raises(NoBinding): + bindings.get_key(\"control+meta+alt+shift+super+hyper+t\") def test_bindings_merge_simple(bindings): left = Bindings([BINDING1]) right = Bindings([BINDING2]) assert Bindings.merge([left, right]).keys == bindings.keys - def test_bindings_merge_overlap(): left = Bindings([BINDING1]) another_binding = Binding(\"a\", action=\"another_action\", description=\"another_description\") @@ -29,3 +31,20 @@ def test_bindings_merge_overlap(): \"a\": another_binding, \"b\": Binding(\"b\", action=\"action1\", description=\"description1\"), } + +def test_bad_binding_tuple(): + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\"),)) + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\", \"description\",\"too much\"),)) + +def test_binding_from_tuples(): + assert Bindings((( BINDING2.key, BINDING2.action, BINDING2.description),)).get_key(\"c\") == BINDING2 + +def test_shown(): + bindings = Bindings([ + Binding( + key, action=f\"action_{key}\", description=f\"Emits {key}\",show=bool(ord(key)%2) + ) for key in ascii_lowercase + ]) + assert len(bindings.shown_keys)==(len(ascii_lowercase)/2) diff --git a/tests/test_cache.py b/tests/test_cache.py index e81b7e06..aedcbfc4 100644 --- a/tests/test_cache.py +++ b/tests/test_cache.py @@ -61,6 +61,25 @@ def test_lru_cache_get(): assert \"egg\" not in cache assert \"eggegg\" in cache +def test_lru_cache_maxsize(): + cache = LRUCache(3) + + # Be sure that maxsize reports what we gave above. + assert cache.maxsize == 3, \"Incorrect cache maxsize\" + + # Now resize the cache by setting maxsize. + cache.maxsize = 30 + + # Check that it's reporting that back. + assert cache.maxsize == 30, \"Incorrect cache maxsize after setting it\" + + # Add more than maxsize items to the cache and be sure + for spam in range(cache.maxsize+10): + cache[f\"spam{spam}\"] = spam + + # Finally, check the cache is the max size we set. + assert len(cache) == 30, \"Cache grew too large given maxsize\" + def test_lru_cache_mapping(): \"\"\"Test cache values can be set and read back.\"\"\" diff --git a/tests/test_geometry.py b/tests/test_geometry.py index 02cac2fa..6b9cd07b 100644 --- a/tests/test_geometry.py +++ b/tests/test_geometry.py @@ -295,6 +295,10 @@ def test_size_sub(): Size(1, 2) - \"foo\" +def test_size_line_range(): + assert Size(20, 0).line_range == range(0) + assert Size(0, 20).line_range == range(20) + def test_region_x_extents(): assert Region(5, 10, 20, 30).column_span == (5, 25) diff --git a/tests/test_path.py b/tests/test_path.py new file mode 100644 index 00000000..77b4f3d8 --- /dev/null +++ b/tests/test_path.py @@ -0,0 +1,43 @@ +from typing import Type +from pathlib import Path + +from textual.app import App + +class RelativePathObjectApp(App[None]): + + CSS_PATH = Path(\"test.css\") + +class RelativePathStrApp(App[None]): + + CSS_PATH = \"test.css\" + +class AbsolutePathObjectApp(App[None]): + + CSS_PATH = Path(\"/tmp/test.css\") + +class AbsolutePathStrApp(App[None]): + + CSS_PATH = \"/tmp/test.css\" + +def path_tester(obj_type: Type[App[None]], str_type: Type[App[None]], intended_result: Path) -> None: + assert isinstance(obj_type().css_path,Path), ( + \"CSS_PATH didn't stay as an object\" + ) + assert isinstance(str_type().css_path,Path), ( + \"CSS_PATH wasn't converted from str to Path\" + ) + assert obj_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == obj_type().css_path, ( + \"CSS_PATH str to Path conversion gave a different result\" + ) + +def test_relative_path(): + path_tester(RelativePathObjectApp, RelativePathStrApp, ((Path(__file__).absolute().parent ) / \"test.css\").absolute()) + +def test_absolute_path(): + path_tester(AbsolutePathObjectApp, AbsolutePathStrApp, Path(\"/tmp/test.css\").absolute()) diff --git a/tests/test_query.py b/tests/test_query.py index be610804..373d8d0e 100644 --- a/tests/test_query.py +++ b/tests/test_query.py @@ -1,4 +1,7 @@ +import pytest + from textual.widget import Widget +from textual.css.query import InvalidQueryFormat def test_query(): @@ -78,3 +81,16 @@ def test_query(): assert list(app.query(\"#widget1, #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1 , #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1, #widget2, App\")) == [app, widget1, widget2] + + +def test_invalid_query(): + class App(Widget): + pass + + app = App() + + with pytest.raises(InvalidQueryFormat): + app.query(\"#3\") + + with pytest.raises(InvalidQueryFormat): + app.query(\"#foo\").exclude(\"#2\") ", "completion": "Additional sleep after tabbing to guard vs races "}
{"prompt": "diff --git a/.github/workflows/comment.yml b/.github/workflows/comment.yml index b7a4c7f4..7191f183 100644 --- a/.github/workflows/comment.yml +++ b/.github/workflows/comment.yml @@ -15,6 +15,4 @@ jobs: body: | Did we solve your problem? - Consider buying the Textualize developers a [coffee](https://ko-fi.com/textualize) to say thanks. - - &ndash; [Textualize](https://twitter.com/textualizeio) + Glad we could help! diff --git a/CHANGELOG.md b/CHANGELOG.md index 32fe8eab..ad4f0949 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -5,6 +5,12 @@ All notable changes to this project will be documented in this file. The format is based on [Keep a Changelog](http://keepachangelog.com/) and this project adheres to [Semantic Versioning](http://semver.org/). +## [0.2.2] - Unreleased + +### Changed + +- DOMQuery now raises InvalidQueryFormat in response to invalid query strings, rather than cryptic CSS error + ## [0.2.1] - 2022-10-23 ### Changed diff --git a/docs/guide/input.md b/docs/guide/input.md index 968e19c7..5052a5dd 100644 --- a/docs/guide/input.md +++ b/docs/guide/input.md @@ -78,7 +78,7 @@ The following example shows how focus works in practice. ```{.textual path=\"docs/examples/guide/input/key03.py\", press=\"tab,H,e,l,l,o,tab,W,o,r,l,d,!,_\"} ``` -The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that thw widget has focus. Key events will be sent to the focused widget only. +The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that the widget has focus. Key events will be sent to the focused widget only. !!! tip diff --git a/docs/tutorial.md b/docs/tutorial.md index 7a69c787..7fa4486c 100644 --- a/docs/tutorial.md +++ b/docs/tutorial.md @@ -430,7 +430,7 @@ The Stopwatch app creates widgets when it starts via the `compose` method. We wi Let's use these methods to implement adding and removing stopwatches to our app. -```python title=\"stopwatch.py\" hl_lines=\"78-79 88-92 94-98\" +```python title=\"stopwatch.py\" hl_lines=\"78-79 86 88-92 94-98\" --8<-- \"docs/examples/tutorial/stopwatch.py\" ``` diff --git a/examples/calculator.py b/examples/calculator.py index 60d982f9..e42273fe 100644 --- a/examples/calculator.py +++ b/examples/calculator.py @@ -28,7 +28,8 @@ class CalculatorApp(App): \"plus_minus_sign\": \"plus-minus\", \"percent_sign\": \"percent\", \"equals_sign\": \"equals\", - \"enter\": \"equals\", + \"minus\": \"minus\", + \"plus\": \"plus\", } def watch_numbers(self, value: str) -> None: @@ -80,7 +81,6 @@ class CalculatorApp(App): self.query_one(f\"#{button_id}\", Button).press() except NoMatches: pass - self.set_focus(None) key = event.key if key.isdecimal(): @@ -89,7 +89,9 @@ class CalculatorApp(App): press(\"c\") press(\"ac\") else: - press(self.NAME_MAP.get(key, key)) + button_id = self.NAME_MAP.get(key) + if button_id is not None: + press(self.NAME_MAP.get(key, key)) def on_button_pressed(self, event: Button.Pressed) -> None: \"\"\"Called when a button is pressed.\"\"\" diff --git a/examples/five_by_five.py b/examples/five_by_five.py index 84a50d63..20bbea80 100644 --- a/examples/five_by_five.py +++ b/examples/five_by_five.py @@ -24,8 +24,8 @@ from rich.markdown import Markdown class Help(Screen): \"\"\"The help screen for the application.\"\"\" - #: Bindings for the help screen. BINDINGS = [(\"escape,space,q,question_mark\", \"pop_screen\", \"Close\")] + \"\"\"Bindings for the help screen.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game's help. @@ -39,8 +39,8 @@ class Help(Screen): class WinnerMessage(Static): \"\"\"Widget to tell the user they have won.\"\"\" - #: The minimum number of moves you can solve the puzzle in. MIN_MOVES: Final = 14 + \"\"\"int: The minimum number of moves you can solve the puzzle in.\"\"\" @staticmethod def _plural(value: int) -> str: @@ -78,11 +78,11 @@ class GameHeader(Widget): and the count of how many cells are turned on (``#progress``). \"\"\" - #: Keep track of how many moves the player has made. moves = reactive(0) + \"\"\"int: Keep track of how many moves the player has made.\"\"\" - #: Keep track of how many cells are filled. filled = reactive(0) + \"\"\"int: Keep track of how many cells are filled.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game header. @@ -159,10 +159,9 @@ class GameGrid(Widget): class Game(Screen): \"\"\"Main 5x5 game grid screen.\"\"\" - #: The size of the game grid. Clue's in the name really. - SIZE = 5 + SIZE: Final = 5 + \"\"\"The size of the game grid. Clue's in the name really.\"\"\" - #: The bindings for the main game grid. BINDINGS = [ Binding(\"n\", \"new_game\", \"New Game\"), Binding(\"question_mark\", \"push_screen('help')\", \"Help\", key_display=\"?\"), @@ -173,6 +172,7 @@ class Game(Screen): Binding(\"right,d,l\", \"navigate(0,1)\", \"Move Right\", False), Binding(\"space\", \"move\", \"Toggle\", False), ] + \"\"\"The bindings for the main game grid.\"\"\" @property def filled_cells(self) -> DOMQuery[GameCell]: @@ -308,17 +308,17 @@ class Game(Screen): class FiveByFive(App[None]): \"\"\"Main 5x5 application class.\"\"\" - #: The name of the stylesheet for the app. CSS_PATH = \"five_by_five.css\" + \"\"\"The name of the stylesheet for the app.\"\"\" - #: The pre-loaded screens for the application. SCREENS = {\"help\": Help()} + \"\"\"The pre-loaded screens for the application.\"\"\" - #: App-level bindings. BINDINGS = [(\"ctrl+d\", \"toggle_dark\", \"Toggle Dark Mode\")] + \"\"\"App-level bindings.\"\"\" - # Set the title TITLE = \"5x5 -- A little annoying puzzle\" + \"\"\"The title of the application.\"\"\" def on_mount(self) -> None: \"\"\"Set up the application on startup.\"\"\" diff --git a/src/textual/app.py b/src/textual/app.py index 03e728ac..43f1bd56 100644 --- a/src/textual/app.py +++ b/src/textual/app.py @@ -632,6 +632,12 @@ class App(Generic[ReturnType], DOMNode): print(f\"press {key!r} (char={char!r})\") key_event = events.Key(self, key, char) driver.send_event(key_event) + # TODO: A bit of a fudge - extra sleep after tabbing to help guard against race + # condition between widget-level key handling and app/screen level handling. + # More information here: https://github.com/Textualize/textual/issues/1009 + # This conditional sleep can be removed after that issue is closed. + if key == \"tab\": + await asyncio.sleep(0.05) await asyncio.sleep(0.02) await app._animator.wait_for_idle() diff --git a/src/textual/css/query.py b/src/textual/css/query.py index 93addb6f..e0d58820 100644 --- a/src/textual/css/query.py +++ b/src/textual/css/query.py @@ -20,7 +20,7 @@ from typing import cast, Generic, TYPE_CHECKING, Iterator, TypeVar, overload import rich.repr -from .errors import DeclarationError +from .errors import DeclarationError, TokenError from .match import match from .model import SelectorSet from .parse import parse_declarations, parse_selectors @@ -34,6 +34,10 @@ class QueryError(Exception): \"\"\"Base class for a query related error.\"\"\" +class InvalidQueryFormat(QueryError): + \"\"\"Query did not parse correctly.\"\"\" + + class NoMatches(QueryError): \"\"\"No nodes matched the query.\"\"\" @@ -72,9 +76,17 @@ class DOMQuery(Generic[QueryType]): parent._excludes.copy() if parent else [] ) if filter is not None: - self._filters.append(parse_selectors(filter)) + try: + self._filters.append(parse_selectors(filter)) + except TokenError: + # TODO: More helpful errors + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") + if exclude is not None: - self._excludes.append(parse_selectors(exclude)) + try: + self._excludes.append(parse_selectors(exclude)) + except TokenError: + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") @property def node(self) -> DOMNode: diff --git a/tests/snapshot_tests/test_snapshots.py b/tests/snapshot_tests/test_snapshots.py index 5831e0b7..2f04c931 100644 --- a/tests/snapshot_tests/test_snapshots.py +++ b/tests/snapshot_tests/test_snapshots.py @@ -1,9 +1,9 @@ -from pathlib import Path +from pathlib import Path, PurePosixPath import pytest from textual.app import App -from textual.widgets import Input +from textual.widgets import Input, Button # --- Layout related stuff --- @@ -58,9 +58,9 @@ def test_checkboxes(snap_compare): def test_input_and_focus(snap_compare): press = [ \"tab\", - *list(\"Darren\"), # Focus first input, write \"Darren\" + *\"Darren\", # Focus first input, write \"Darren\" \"tab\", - *list(\"Burns\"), # Tab focus to second input, write \"Burns\" + *\"Burns\", # Tab focus to second input, write \"Burns\" ] assert snap_compare(\"docs/examples/widgets/input.py\", press=press) @@ -69,12 +69,17 @@ def test_input_and_focus(snap_compare): input: Input = app.query_one(Input) assert input.value == \"Darren\" assert input.cursor_position == 6 + assert input.view_position == 0 def test_buttons_render(snap_compare): # Testing button rendering. We press tab to focus the first button too. assert snap_compare(\"docs/examples/widgets/button.py\", press=[\"tab\"]) + app = snap_compare.app + button: Button = app.query_one(Button) + assert app.focused is button + def test_datatable_render(snap_compare): press = [\"tab\", \"down\", \"down\", \"right\", \"up\", \"left\"] @@ -94,7 +99,7 @@ def test_header_render(snap_compare): # If any of these change, something has likely broken, so snapshot each of them. PATHS = [ - str(path) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" + str(PurePosixPath(path)) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" ] diff --git a/tests/test_arrange.py b/tests/test_arrange.py index 580d68e0..f66f0195 100644 --- a/tests/test_arrange.py +++ b/tests/test_arrange.py @@ -1,3 +1,5 @@ +import pytest + from textual._arrange import arrange, TOP_Z from textual._layout import WidgetPlacement from textual.geometry import Region, Size, Spacing @@ -91,3 +93,9 @@ def test_arrange_dock_bottom(): ] assert widgets == {child, header} assert spacing == Spacing(0, 0, 1, 0) + +def test_arrange_dock_badly(): + child = Widget(id=\"child\") + child.styles.dock = \"nowhere\" + with pytest.raises(AssertionError): + _ = arrange( Widget(), [child], Size(80, 24), Size(80, 24)) diff --git a/tests/test_binding.py b/tests/test_binding.py index d2d61ac1..620fbc03 100644 --- a/tests/test_binding.py +++ b/tests/test_binding.py @@ -1,6 +1,8 @@ +from string import ascii_lowercase + import pytest -from textual.binding import Bindings, Binding +from textual.binding import Bindings, Binding, BindingError, NoBinding BINDING1 = Binding(\"a,b\", action=\"action1\", description=\"description1\") BINDING2 = Binding(\"c\", action=\"action2\", description=\"description2\") @@ -14,14 +16,14 @@ def bindings(): def test_bindings_get_key(bindings): assert bindings.get_key(\"b\") == Binding(\"b\", action=\"action1\", description=\"description1\") assert bindings.get_key(\"c\") == BINDING2 - + with pytest.raises(NoBinding): + bindings.get_key(\"control+meta+alt+shift+super+hyper+t\") def test_bindings_merge_simple(bindings): left = Bindings([BINDING1]) right = Bindings([BINDING2]) assert Bindings.merge([left, right]).keys == bindings.keys - def test_bindings_merge_overlap(): left = Bindings([BINDING1]) another_binding = Binding(\"a\", action=\"another_action\", description=\"another_description\") @@ -29,3 +31,20 @@ def test_bindings_merge_overlap(): \"a\": another_binding, \"b\": Binding(\"b\", action=\"action1\", description=\"description1\"), } + +def test_bad_binding_tuple(): + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\"),)) + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\", \"description\",\"too much\"),)) + +def test_binding_from_tuples(): + assert Bindings((( BINDING2.key, BINDING2.action, BINDING2.description),)).get_key(\"c\") == BINDING2 + +def test_shown(): + bindings = Bindings([ + Binding( + key, action=f\"action_{key}\", description=f\"Emits {key}\",show=bool(ord(key)%2) + ) for key in ascii_lowercase + ]) + assert len(bindings.shown_keys)==(len(ascii_lowercase)/2) diff --git a/tests/test_cache.py b/tests/test_cache.py index e81b7e06..aedcbfc4 100644 --- a/tests/test_cache.py +++ b/tests/test_cache.py @@ -61,6 +61,25 @@ def test_lru_cache_get(): assert \"egg\" not in cache assert \"eggegg\" in cache +def test_lru_cache_maxsize(): + cache = LRUCache(3) + + # Be sure that maxsize reports what we gave above. + assert cache.maxsize == 3, \"Incorrect cache maxsize\" + + # Now resize the cache by setting maxsize. + cache.maxsize = 30 + + # Check that it's reporting that back. + assert cache.maxsize == 30, \"Incorrect cache maxsize after setting it\" + + # Add more than maxsize items to the cache and be sure + for spam in range(cache.maxsize+10): + cache[f\"spam{spam}\"] = spam + + # Finally, check the cache is the max size we set. + assert len(cache) == 30, \"Cache grew too large given maxsize\" + def test_lru_cache_mapping(): \"\"\"Test cache values can be set and read back.\"\"\" diff --git a/tests/test_geometry.py b/tests/test_geometry.py index 02cac2fa..6b9cd07b 100644 --- a/tests/test_geometry.py +++ b/tests/test_geometry.py @@ -295,6 +295,10 @@ def test_size_sub(): Size(1, 2) - \"foo\" +def test_size_line_range(): + assert Size(20, 0).line_range == range(0) + assert Size(0, 20).line_range == range(20) + def test_region_x_extents(): assert Region(5, 10, 20, 30).column_span == (5, 25) diff --git a/tests/test_path.py b/tests/test_path.py new file mode 100644 index 00000000..77b4f3d8 --- /dev/null +++ b/tests/test_path.py @@ -0,0 +1,43 @@ +from typing import Type +from pathlib import Path + +from textual.app import App + +class RelativePathObjectApp(App[None]): + + CSS_PATH = Path(\"test.css\") + +class RelativePathStrApp(App[None]): + + CSS_PATH = \"test.css\" + +class AbsolutePathObjectApp(App[None]): + + CSS_PATH = Path(\"/tmp/test.css\") + +class AbsolutePathStrApp(App[None]): + + CSS_PATH = \"/tmp/test.css\" + +def path_tester(obj_type: Type[App[None]], str_type: Type[App[None]], intended_result: Path) -> None: + assert isinstance(obj_type().css_path,Path), ( + \"CSS_PATH didn't stay as an object\" + ) + assert isinstance(str_type().css_path,Path), ( + \"CSS_PATH wasn't converted from str to Path\" + ) + assert obj_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == obj_type().css_path, ( + \"CSS_PATH str to Path conversion gave a different result\" + ) + +def test_relative_path(): + path_tester(RelativePathObjectApp, RelativePathStrApp, ((Path(__file__).absolute().parent ) / \"test.css\").absolute()) + +def test_absolute_path(): + path_tester(AbsolutePathObjectApp, AbsolutePathStrApp, Path(\"/tmp/test.css\").absolute()) diff --git a/tests/test_query.py b/tests/test_query.py index be610804..373d8d0e 100644 --- a/tests/test_query.py +++ b/tests/test_query.py @@ -1,4 +1,7 @@ +import pytest + from textual.widget import Widget +from textual.css.query import InvalidQueryFormat def test_query(): @@ -78,3 +81,16 @@ def test_query(): assert list(app.query(\"#widget1, #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1 , #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1, #widget2, App\")) == [app, widget1, widget2] + + +def test_invalid_query(): + class App(Widget): + pass + + app = App() + + with pytest.raises(InvalidQueryFormat): + app.query(\"#3\") + + with pytest.raises(InvalidQueryFormat): + app.query(\"#foo\").exclude(\"#2\") ", "completion": "Increase sleep between key-presses "}
{"prompt": "diff --git a/.github/workflows/comment.yml b/.github/workflows/comment.yml index b7a4c7f4..7191f183 100644 --- a/.github/workflows/comment.yml +++ b/.github/workflows/comment.yml @@ -15,6 +15,4 @@ jobs: body: | Did we solve your problem? - Consider buying the Textualize developers a [coffee](https://ko-fi.com/textualize) to say thanks. - - &ndash; [Textualize](https://twitter.com/textualizeio) + Glad we could help! diff --git a/CHANGELOG.md b/CHANGELOG.md index 32fe8eab..ad4f0949 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -5,6 +5,12 @@ All notable changes to this project will be documented in this file. The format is based on [Keep a Changelog](http://keepachangelog.com/) and this project adheres to [Semantic Versioning](http://semver.org/). +## [0.2.2] - Unreleased + +### Changed + +- DOMQuery now raises InvalidQueryFormat in response to invalid query strings, rather than cryptic CSS error + ## [0.2.1] - 2022-10-23 ### Changed diff --git a/docs/guide/input.md b/docs/guide/input.md index 968e19c7..5052a5dd 100644 --- a/docs/guide/input.md +++ b/docs/guide/input.md @@ -78,7 +78,7 @@ The following example shows how focus works in practice. ```{.textual path=\"docs/examples/guide/input/key03.py\", press=\"tab,H,e,l,l,o,tab,W,o,r,l,d,!,_\"} ``` -The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that thw widget has focus. Key events will be sent to the focused widget only. +The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that the widget has focus. Key events will be sent to the focused widget only. !!! tip diff --git a/docs/tutorial.md b/docs/tutorial.md index 7a69c787..7fa4486c 100644 --- a/docs/tutorial.md +++ b/docs/tutorial.md @@ -430,7 +430,7 @@ The Stopwatch app creates widgets when it starts via the `compose` method. We wi Let's use these methods to implement adding and removing stopwatches to our app. -```python title=\"stopwatch.py\" hl_lines=\"78-79 88-92 94-98\" +```python title=\"stopwatch.py\" hl_lines=\"78-79 86 88-92 94-98\" --8<-- \"docs/examples/tutorial/stopwatch.py\" ``` diff --git a/examples/calculator.py b/examples/calculator.py index 60d982f9..e42273fe 100644 --- a/examples/calculator.py +++ b/examples/calculator.py @@ -28,7 +28,8 @@ class CalculatorApp(App): \"plus_minus_sign\": \"plus-minus\", \"percent_sign\": \"percent\", \"equals_sign\": \"equals\", - \"enter\": \"equals\", + \"minus\": \"minus\", + \"plus\": \"plus\", } def watch_numbers(self, value: str) -> None: @@ -80,7 +81,6 @@ class CalculatorApp(App): self.query_one(f\"#{button_id}\", Button).press() except NoMatches: pass - self.set_focus(None) key = event.key if key.isdecimal(): @@ -89,7 +89,9 @@ class CalculatorApp(App): press(\"c\") press(\"ac\") else: - press(self.NAME_MAP.get(key, key)) + button_id = self.NAME_MAP.get(key) + if button_id is not None: + press(self.NAME_MAP.get(key, key)) def on_button_pressed(self, event: Button.Pressed) -> None: \"\"\"Called when a button is pressed.\"\"\" diff --git a/examples/five_by_five.py b/examples/five_by_five.py index 84a50d63..20bbea80 100644 --- a/examples/five_by_five.py +++ b/examples/five_by_five.py @@ -24,8 +24,8 @@ from rich.markdown import Markdown class Help(Screen): \"\"\"The help screen for the application.\"\"\" - #: Bindings for the help screen. BINDINGS = [(\"escape,space,q,question_mark\", \"pop_screen\", \"Close\")] + \"\"\"Bindings for the help screen.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game's help. @@ -39,8 +39,8 @@ class Help(Screen): class WinnerMessage(Static): \"\"\"Widget to tell the user they have won.\"\"\" - #: The minimum number of moves you can solve the puzzle in. MIN_MOVES: Final = 14 + \"\"\"int: The minimum number of moves you can solve the puzzle in.\"\"\" @staticmethod def _plural(value: int) -> str: @@ -78,11 +78,11 @@ class GameHeader(Widget): and the count of how many cells are turned on (``#progress``). \"\"\" - #: Keep track of how many moves the player has made. moves = reactive(0) + \"\"\"int: Keep track of how many moves the player has made.\"\"\" - #: Keep track of how many cells are filled. filled = reactive(0) + \"\"\"int: Keep track of how many cells are filled.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game header. @@ -159,10 +159,9 @@ class GameGrid(Widget): class Game(Screen): \"\"\"Main 5x5 game grid screen.\"\"\" - #: The size of the game grid. Clue's in the name really. - SIZE = 5 + SIZE: Final = 5 + \"\"\"The size of the game grid. Clue's in the name really.\"\"\" - #: The bindings for the main game grid. BINDINGS = [ Binding(\"n\", \"new_game\", \"New Game\"), Binding(\"question_mark\", \"push_screen('help')\", \"Help\", key_display=\"?\"), @@ -173,6 +172,7 @@ class Game(Screen): Binding(\"right,d,l\", \"navigate(0,1)\", \"Move Right\", False), Binding(\"space\", \"move\", \"Toggle\", False), ] + \"\"\"The bindings for the main game grid.\"\"\" @property def filled_cells(self) -> DOMQuery[GameCell]: @@ -308,17 +308,17 @@ class Game(Screen): class FiveByFive(App[None]): \"\"\"Main 5x5 application class.\"\"\" - #: The name of the stylesheet for the app. CSS_PATH = \"five_by_five.css\" + \"\"\"The name of the stylesheet for the app.\"\"\" - #: The pre-loaded screens for the application. SCREENS = {\"help\": Help()} + \"\"\"The pre-loaded screens for the application.\"\"\" - #: App-level bindings. BINDINGS = [(\"ctrl+d\", \"toggle_dark\", \"Toggle Dark Mode\")] + \"\"\"App-level bindings.\"\"\" - # Set the title TITLE = \"5x5 -- A little annoying puzzle\" + \"\"\"The title of the application.\"\"\" def on_mount(self) -> None: \"\"\"Set up the application on startup.\"\"\" diff --git a/src/textual/app.py b/src/textual/app.py index c044f615..43f1bd56 100644 --- a/src/textual/app.py +++ b/src/textual/app.py @@ -605,7 +605,7 @@ class App(Generic[ReturnType], DOMNode): assert press driver = app._driver assert driver is not None - await asyncio.sleep(0.01) + await asyncio.sleep(0.02) for key in press: if key == \"_\": print(\"(pause 50ms)\") @@ -632,7 +632,13 @@ class App(Generic[ReturnType], DOMNode): print(f\"press {key!r} (char={char!r})\") key_event = events.Key(self, key, char) driver.send_event(key_event) - await asyncio.sleep(0.01) + # TODO: A bit of a fudge - extra sleep after tabbing to help guard against race + # condition between widget-level key handling and app/screen level handling. + # More information here: https://github.com/Textualize/textual/issues/1009 + # This conditional sleep can be removed after that issue is closed. + if key == \"tab\": + await asyncio.sleep(0.05) + await asyncio.sleep(0.02) await app._animator.wait_for_idle() diff --git a/src/textual/css/query.py b/src/textual/css/query.py index 93addb6f..e0d58820 100644 --- a/src/textual/css/query.py +++ b/src/textual/css/query.py @@ -20,7 +20,7 @@ from typing import cast, Generic, TYPE_CHECKING, Iterator, TypeVar, overload import rich.repr -from .errors import DeclarationError +from .errors import DeclarationError, TokenError from .match import match from .model import SelectorSet from .parse import parse_declarations, parse_selectors @@ -34,6 +34,10 @@ class QueryError(Exception): \"\"\"Base class for a query related error.\"\"\" +class InvalidQueryFormat(QueryError): + \"\"\"Query did not parse correctly.\"\"\" + + class NoMatches(QueryError): \"\"\"No nodes matched the query.\"\"\" @@ -72,9 +76,17 @@ class DOMQuery(Generic[QueryType]): parent._excludes.copy() if parent else [] ) if filter is not None: - self._filters.append(parse_selectors(filter)) + try: + self._filters.append(parse_selectors(filter)) + except TokenError: + # TODO: More helpful errors + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") + if exclude is not None: - self._excludes.append(parse_selectors(exclude)) + try: + self._excludes.append(parse_selectors(exclude)) + except TokenError: + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") @property def node(self) -> DOMNode: diff --git a/tests/snapshot_tests/test_snapshots.py b/tests/snapshot_tests/test_snapshots.py index 5831e0b7..2f04c931 100644 --- a/tests/snapshot_tests/test_snapshots.py +++ b/tests/snapshot_tests/test_snapshots.py @@ -1,9 +1,9 @@ -from pathlib import Path +from pathlib import Path, PurePosixPath import pytest from textual.app import App -from textual.widgets import Input +from textual.widgets import Input, Button # --- Layout related stuff --- @@ -58,9 +58,9 @@ def test_checkboxes(snap_compare): def test_input_and_focus(snap_compare): press = [ \"tab\", - *list(\"Darren\"), # Focus first input, write \"Darren\" + *\"Darren\", # Focus first input, write \"Darren\" \"tab\", - *list(\"Burns\"), # Tab focus to second input, write \"Burns\" + *\"Burns\", # Tab focus to second input, write \"Burns\" ] assert snap_compare(\"docs/examples/widgets/input.py\", press=press) @@ -69,12 +69,17 @@ def test_input_and_focus(snap_compare): input: Input = app.query_one(Input) assert input.value == \"Darren\" assert input.cursor_position == 6 + assert input.view_position == 0 def test_buttons_render(snap_compare): # Testing button rendering. We press tab to focus the first button too. assert snap_compare(\"docs/examples/widgets/button.py\", press=[\"tab\"]) + app = snap_compare.app + button: Button = app.query_one(Button) + assert app.focused is button + def test_datatable_render(snap_compare): press = [\"tab\", \"down\", \"down\", \"right\", \"up\", \"left\"] @@ -94,7 +99,7 @@ def test_header_render(snap_compare): # If any of these change, something has likely broken, so snapshot each of them. PATHS = [ - str(path) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" + str(PurePosixPath(path)) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" ] diff --git a/tests/test_arrange.py b/tests/test_arrange.py index 580d68e0..f66f0195 100644 --- a/tests/test_arrange.py +++ b/tests/test_arrange.py @@ -1,3 +1,5 @@ +import pytest + from textual._arrange import arrange, TOP_Z from textual._layout import WidgetPlacement from textual.geometry import Region, Size, Spacing @@ -91,3 +93,9 @@ def test_arrange_dock_bottom(): ] assert widgets == {child, header} assert spacing == Spacing(0, 0, 1, 0) + +def test_arrange_dock_badly(): + child = Widget(id=\"child\") + child.styles.dock = \"nowhere\" + with pytest.raises(AssertionError): + _ = arrange( Widget(), [child], Size(80, 24), Size(80, 24)) diff --git a/tests/test_binding.py b/tests/test_binding.py index d2d61ac1..620fbc03 100644 --- a/tests/test_binding.py +++ b/tests/test_binding.py @@ -1,6 +1,8 @@ +from string import ascii_lowercase + import pytest -from textual.binding import Bindings, Binding +from textual.binding import Bindings, Binding, BindingError, NoBinding BINDING1 = Binding(\"a,b\", action=\"action1\", description=\"description1\") BINDING2 = Binding(\"c\", action=\"action2\", description=\"description2\") @@ -14,14 +16,14 @@ def bindings(): def test_bindings_get_key(bindings): assert bindings.get_key(\"b\") == Binding(\"b\", action=\"action1\", description=\"description1\") assert bindings.get_key(\"c\") == BINDING2 - + with pytest.raises(NoBinding): + bindings.get_key(\"control+meta+alt+shift+super+hyper+t\") def test_bindings_merge_simple(bindings): left = Bindings([BINDING1]) right = Bindings([BINDING2]) assert Bindings.merge([left, right]).keys == bindings.keys - def test_bindings_merge_overlap(): left = Bindings([BINDING1]) another_binding = Binding(\"a\", action=\"another_action\", description=\"another_description\") @@ -29,3 +31,20 @@ def test_bindings_merge_overlap(): \"a\": another_binding, \"b\": Binding(\"b\", action=\"action1\", description=\"description1\"), } + +def test_bad_binding_tuple(): + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\"),)) + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\", \"description\",\"too much\"),)) + +def test_binding_from_tuples(): + assert Bindings((( BINDING2.key, BINDING2.action, BINDING2.description),)).get_key(\"c\") == BINDING2 + +def test_shown(): + bindings = Bindings([ + Binding( + key, action=f\"action_{key}\", description=f\"Emits {key}\",show=bool(ord(key)%2) + ) for key in ascii_lowercase + ]) + assert len(bindings.shown_keys)==(len(ascii_lowercase)/2) diff --git a/tests/test_cache.py b/tests/test_cache.py index e81b7e06..aedcbfc4 100644 --- a/tests/test_cache.py +++ b/tests/test_cache.py @@ -61,6 +61,25 @@ def test_lru_cache_get(): assert \"egg\" not in cache assert \"eggegg\" in cache +def test_lru_cache_maxsize(): + cache = LRUCache(3) + + # Be sure that maxsize reports what we gave above. + assert cache.maxsize == 3, \"Incorrect cache maxsize\" + + # Now resize the cache by setting maxsize. + cache.maxsize = 30 + + # Check that it's reporting that back. + assert cache.maxsize == 30, \"Incorrect cache maxsize after setting it\" + + # Add more than maxsize items to the cache and be sure + for spam in range(cache.maxsize+10): + cache[f\"spam{spam}\"] = spam + + # Finally, check the cache is the max size we set. + assert len(cache) == 30, \"Cache grew too large given maxsize\" + def test_lru_cache_mapping(): \"\"\"Test cache values can be set and read back.\"\"\" diff --git a/tests/test_geometry.py b/tests/test_geometry.py index 02cac2fa..6b9cd07b 100644 --- a/tests/test_geometry.py +++ b/tests/test_geometry.py @@ -295,6 +295,10 @@ def test_size_sub(): Size(1, 2) - \"foo\" +def test_size_line_range(): + assert Size(20, 0).line_range == range(0) + assert Size(0, 20).line_range == range(20) + def test_region_x_extents(): assert Region(5, 10, 20, 30).column_span == (5, 25) diff --git a/tests/test_path.py b/tests/test_path.py new file mode 100644 index 00000000..77b4f3d8 --- /dev/null +++ b/tests/test_path.py @@ -0,0 +1,43 @@ +from typing import Type +from pathlib import Path + +from textual.app import App + +class RelativePathObjectApp(App[None]): + + CSS_PATH = Path(\"test.css\") + +class RelativePathStrApp(App[None]): + + CSS_PATH = \"test.css\" + +class AbsolutePathObjectApp(App[None]): + + CSS_PATH = Path(\"/tmp/test.css\") + +class AbsolutePathStrApp(App[None]): + + CSS_PATH = \"/tmp/test.css\" + +def path_tester(obj_type: Type[App[None]], str_type: Type[App[None]], intended_result: Path) -> None: + assert isinstance(obj_type().css_path,Path), ( + \"CSS_PATH didn't stay as an object\" + ) + assert isinstance(str_type().css_path,Path), ( + \"CSS_PATH wasn't converted from str to Path\" + ) + assert obj_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == obj_type().css_path, ( + \"CSS_PATH str to Path conversion gave a different result\" + ) + +def test_relative_path(): + path_tester(RelativePathObjectApp, RelativePathStrApp, ((Path(__file__).absolute().parent ) / \"test.css\").absolute()) + +def test_absolute_path(): + path_tester(AbsolutePathObjectApp, AbsolutePathStrApp, Path(\"/tmp/test.css\").absolute()) diff --git a/tests/test_query.py b/tests/test_query.py index be610804..373d8d0e 100644 --- a/tests/test_query.py +++ b/tests/test_query.py @@ -1,4 +1,7 @@ +import pytest + from textual.widget import Widget +from textual.css.query import InvalidQueryFormat def test_query(): @@ -78,3 +81,16 @@ def test_query(): assert list(app.query(\"#widget1, #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1 , #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1, #widget2, App\")) == [app, widget1, widget2] + + +def test_invalid_query(): + class App(Widget): + pass + + app = App() + + with pytest.raises(InvalidQueryFormat): + app.query(\"#3\") + + with pytest.raises(InvalidQueryFormat): + app.query(\"#foo\").exclude(\"#2\") ", "completion": "Fix data-table snapshot "}
{"prompt": "diff --git a/.github/workflows/comment.yml b/.github/workflows/comment.yml index b7a4c7f4..7191f183 100644 --- a/.github/workflows/comment.yml +++ b/.github/workflows/comment.yml @@ -15,6 +15,4 @@ jobs: body: | Did we solve your problem? - Consider buying the Textualize developers a [coffee](https://ko-fi.com/textualize) to say thanks. - - &ndash; [Textualize](https://twitter.com/textualizeio) + Glad we could help! diff --git a/CHANGELOG.md b/CHANGELOG.md index 32fe8eab..ad4f0949 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -5,6 +5,12 @@ All notable changes to this project will be documented in this file. The format is based on [Keep a Changelog](http://keepachangelog.com/) and this project adheres to [Semantic Versioning](http://semver.org/). +## [0.2.2] - Unreleased + +### Changed + +- DOMQuery now raises InvalidQueryFormat in response to invalid query strings, rather than cryptic CSS error + ## [0.2.1] - 2022-10-23 ### Changed diff --git a/docs/examples/widgets/data_table.py b/docs/examples/widgets/data_table.py index f2671dd4..87b2c0ce 100644 --- a/docs/examples/widgets/data_table.py +++ b/docs/examples/widgets/data_table.py @@ -2,7 +2,7 @@ import csv import io from textual.app import App, ComposeResult -from textual.widgets import DataTable, Header +from textual.widgets import DataTable CSV = \"\"\"lane,swimmer,country,time 4,Joseph Schooling,Singapore,50.39 @@ -17,7 +17,6 @@ CSV = \"\"\"lane,swimmer,country,time class TableApp(App): def compose(self) -> ComposeResult: - yield Header() yield DataTable() def on_mount(self) -> None: diff --git a/docs/guide/input.md b/docs/guide/input.md index 968e19c7..5052a5dd 100644 --- a/docs/guide/input.md +++ b/docs/guide/input.md @@ -78,7 +78,7 @@ The following example shows how focus works in practice. ```{.textual path=\"docs/examples/guide/input/key03.py\", press=\"tab,H,e,l,l,o,tab,W,o,r,l,d,!,_\"} ``` -The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that thw widget has focus. Key events will be sent to the focused widget only. +The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that the widget has focus. Key events will be sent to the focused widget only. !!! tip diff --git a/docs/tutorial.md b/docs/tutorial.md index 7a69c787..7fa4486c 100644 --- a/docs/tutorial.md +++ b/docs/tutorial.md @@ -430,7 +430,7 @@ The Stopwatch app creates widgets when it starts via the `compose` method. We wi Let's use these methods to implement adding and removing stopwatches to our app. -```python title=\"stopwatch.py\" hl_lines=\"78-79 88-92 94-98\" +```python title=\"stopwatch.py\" hl_lines=\"78-79 86 88-92 94-98\" --8<-- \"docs/examples/tutorial/stopwatch.py\" ``` diff --git a/examples/calculator.py b/examples/calculator.py index 60d982f9..e42273fe 100644 --- a/examples/calculator.py +++ b/examples/calculator.py @@ -28,7 +28,8 @@ class CalculatorApp(App): \"plus_minus_sign\": \"plus-minus\", \"percent_sign\": \"percent\", \"equals_sign\": \"equals\", - \"enter\": \"equals\", + \"minus\": \"minus\", + \"plus\": \"plus\", } def watch_numbers(self, value: str) -> None: @@ -80,7 +81,6 @@ class CalculatorApp(App): self.query_one(f\"#{button_id}\", Button).press() except NoMatches: pass - self.set_focus(None) key = event.key if key.isdecimal(): @@ -89,7 +89,9 @@ class CalculatorApp(App): press(\"c\") press(\"ac\") else: - press(self.NAME_MAP.get(key, key)) + button_id = self.NAME_MAP.get(key) + if button_id is not None: + press(self.NAME_MAP.get(key, key)) def on_button_pressed(self, event: Button.Pressed) -> None: \"\"\"Called when a button is pressed.\"\"\" diff --git a/examples/five_by_five.py b/examples/five_by_five.py index 84a50d63..20bbea80 100644 --- a/examples/five_by_five.py +++ b/examples/five_by_five.py @@ -24,8 +24,8 @@ from rich.markdown import Markdown class Help(Screen): \"\"\"The help screen for the application.\"\"\" - #: Bindings for the help screen. BINDINGS = [(\"escape,space,q,question_mark\", \"pop_screen\", \"Close\")] + \"\"\"Bindings for the help screen.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game's help. @@ -39,8 +39,8 @@ class Help(Screen): class WinnerMessage(Static): \"\"\"Widget to tell the user they have won.\"\"\" - #: The minimum number of moves you can solve the puzzle in. MIN_MOVES: Final = 14 + \"\"\"int: The minimum number of moves you can solve the puzzle in.\"\"\" @staticmethod def _plural(value: int) -> str: @@ -78,11 +78,11 @@ class GameHeader(Widget): and the count of how many cells are turned on (``#progress``). \"\"\" - #: Keep track of how many moves the player has made. moves = reactive(0) + \"\"\"int: Keep track of how many moves the player has made.\"\"\" - #: Keep track of how many cells are filled. filled = reactive(0) + \"\"\"int: Keep track of how many cells are filled.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game header. @@ -159,10 +159,9 @@ class GameGrid(Widget): class Game(Screen): \"\"\"Main 5x5 game grid screen.\"\"\" - #: The size of the game grid. Clue's in the name really. - SIZE = 5 + SIZE: Final = 5 + \"\"\"The size of the game grid. Clue's in the name really.\"\"\" - #: The bindings for the main game grid. BINDINGS = [ Binding(\"n\", \"new_game\", \"New Game\"), Binding(\"question_mark\", \"push_screen('help')\", \"Help\", key_display=\"?\"), @@ -173,6 +172,7 @@ class Game(Screen): Binding(\"right,d,l\", \"navigate(0,1)\", \"Move Right\", False), Binding(\"space\", \"move\", \"Toggle\", False), ] + \"\"\"The bindings for the main game grid.\"\"\" @property def filled_cells(self) -> DOMQuery[GameCell]: @@ -308,17 +308,17 @@ class Game(Screen): class FiveByFive(App[None]): \"\"\"Main 5x5 application class.\"\"\" - #: The name of the stylesheet for the app. CSS_PATH = \"five_by_five.css\" + \"\"\"The name of the stylesheet for the app.\"\"\" - #: The pre-loaded screens for the application. SCREENS = {\"help\": Help()} + \"\"\"The pre-loaded screens for the application.\"\"\" - #: App-level bindings. BINDINGS = [(\"ctrl+d\", \"toggle_dark\", \"Toggle Dark Mode\")] + \"\"\"App-level bindings.\"\"\" - # Set the title TITLE = \"5x5 -- A little annoying puzzle\" + \"\"\"The title of the application.\"\"\" def on_mount(self) -> None: \"\"\"Set up the application on startup.\"\"\" diff --git a/src/textual/app.py b/src/textual/app.py index c044f615..43f1bd56 100644 --- a/src/textual/app.py +++ b/src/textual/app.py @@ -605,7 +605,7 @@ class App(Generic[ReturnType], DOMNode): assert press driver = app._driver assert driver is not None - await asyncio.sleep(0.01) + await asyncio.sleep(0.02) for key in press: if key == \"_\": print(\"(pause 50ms)\") @@ -632,7 +632,13 @@ class App(Generic[ReturnType], DOMNode): print(f\"press {key!r} (char={char!r})\") key_event = events.Key(self, key, char) driver.send_event(key_event) - await asyncio.sleep(0.01) + # TODO: A bit of a fudge - extra sleep after tabbing to help guard against race + # condition between widget-level key handling and app/screen level handling. + # More information here: https://github.com/Textualize/textual/issues/1009 + # This conditional sleep can be removed after that issue is closed. + if key == \"tab\": + await asyncio.sleep(0.05) + await asyncio.sleep(0.02) await app._animator.wait_for_idle() diff --git a/src/textual/css/query.py b/src/textual/css/query.py index 93addb6f..e0d58820 100644 --- a/src/textual/css/query.py +++ b/src/textual/css/query.py @@ -20,7 +20,7 @@ from typing import cast, Generic, TYPE_CHECKING, Iterator, TypeVar, overload import rich.repr -from .errors import DeclarationError +from .errors import DeclarationError, TokenError from .match import match from .model import SelectorSet from .parse import parse_declarations, parse_selectors @@ -34,6 +34,10 @@ class QueryError(Exception): \"\"\"Base class for a query related error.\"\"\" +class InvalidQueryFormat(QueryError): + \"\"\"Query did not parse correctly.\"\"\" + + class NoMatches(QueryError): \"\"\"No nodes matched the query.\"\"\" @@ -72,9 +76,17 @@ class DOMQuery(Generic[QueryType]): parent._excludes.copy() if parent else [] ) if filter is not None: - self._filters.append(parse_selectors(filter)) + try: + self._filters.append(parse_selectors(filter)) + except TokenError: + # TODO: More helpful errors + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") + if exclude is not None: - self._excludes.append(parse_selectors(exclude)) + try: + self._excludes.append(parse_selectors(exclude)) + except TokenError: + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") @property def node(self) -> DOMNode: diff --git a/tests/snapshot_tests/test_snapshots.py b/tests/snapshot_tests/test_snapshots.py index 71b02371..2f04c931 100644 --- a/tests/snapshot_tests/test_snapshots.py +++ b/tests/snapshot_tests/test_snapshots.py @@ -1,10 +1,12 @@ -from pathlib import Path +from pathlib import Path, PurePosixPath import pytest -# --- Layout related stuff --- -from textual.widgets import Input +from textual.app import App +from textual.widgets import Input, Button + +# --- Layout related stuff --- def test_grid_layout_basic(snap_compare): assert snap_compare(\"docs/examples/guide/layout/grid_layout1.py\") @@ -56,22 +58,28 @@ def test_checkboxes(snap_compare): def test_input_and_focus(snap_compare): press = [ \"tab\", - *list(\"Darren\"), # Focus first input, write \"Darren\" + *\"Darren\", # Focus first input, write \"Darren\" \"tab\", - *list(\"Burns\"), # Tab focus to second input, write \"Burns\" + *\"Burns\", # Tab focus to second input, write \"Burns\" ] assert snap_compare(\"docs/examples/widgets/input.py\", press=press) # Assert that the state of the Input is what we'd expect - input: Input = snap_compare.app.query_one(Input) + app: App = snap_compare.app + input: Input = app.query_one(Input) assert input.value == \"Darren\" assert input.cursor_position == 6 + assert input.view_position == 0 def test_buttons_render(snap_compare): # Testing button rendering. We press tab to focus the first button too. assert snap_compare(\"docs/examples/widgets/button.py\", press=[\"tab\"]) + app = snap_compare.app + button: Button = app.query_one(Button) + assert app.focused is button + def test_datatable_render(snap_compare): press = [\"tab\", \"down\", \"down\", \"right\", \"up\", \"left\"] @@ -91,7 +99,7 @@ def test_header_render(snap_compare): # If any of these change, something has likely broken, so snapshot each of them. PATHS = [ - str(path) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" + str(PurePosixPath(path)) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" ] diff --git a/tests/test_arrange.py b/tests/test_arrange.py index 580d68e0..f66f0195 100644 --- a/tests/test_arrange.py +++ b/tests/test_arrange.py @@ -1,3 +1,5 @@ +import pytest + from textual._arrange import arrange, TOP_Z from textual._layout import WidgetPlacement from textual.geometry import Region, Size, Spacing @@ -91,3 +93,9 @@ def test_arrange_dock_bottom(): ] assert widgets == {child, header} assert spacing == Spacing(0, 0, 1, 0) + +def test_arrange_dock_badly(): + child = Widget(id=\"child\") + child.styles.dock = \"nowhere\" + with pytest.raises(AssertionError): + _ = arrange( Widget(), [child], Size(80, 24), Size(80, 24)) diff --git a/tests/test_binding.py b/tests/test_binding.py index d2d61ac1..620fbc03 100644 --- a/tests/test_binding.py +++ b/tests/test_binding.py @@ -1,6 +1,8 @@ +from string import ascii_lowercase + import pytest -from textual.binding import Bindings, Binding +from textual.binding import Bindings, Binding, BindingError, NoBinding BINDING1 = Binding(\"a,b\", action=\"action1\", description=\"description1\") BINDING2 = Binding(\"c\", action=\"action2\", description=\"description2\") @@ -14,14 +16,14 @@ def bindings(): def test_bindings_get_key(bindings): assert bindings.get_key(\"b\") == Binding(\"b\", action=\"action1\", description=\"description1\") assert bindings.get_key(\"c\") == BINDING2 - + with pytest.raises(NoBinding): + bindings.get_key(\"control+meta+alt+shift+super+hyper+t\") def test_bindings_merge_simple(bindings): left = Bindings([BINDING1]) right = Bindings([BINDING2]) assert Bindings.merge([left, right]).keys == bindings.keys - def test_bindings_merge_overlap(): left = Bindings([BINDING1]) another_binding = Binding(\"a\", action=\"another_action\", description=\"another_description\") @@ -29,3 +31,20 @@ def test_bindings_merge_overlap(): \"a\": another_binding, \"b\": Binding(\"b\", action=\"action1\", description=\"description1\"), } + +def test_bad_binding_tuple(): + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\"),)) + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\", \"description\",\"too much\"),)) + +def test_binding_from_tuples(): + assert Bindings((( BINDING2.key, BINDING2.action, BINDING2.description),)).get_key(\"c\") == BINDING2 + +def test_shown(): + bindings = Bindings([ + Binding( + key, action=f\"action_{key}\", description=f\"Emits {key}\",show=bool(ord(key)%2) + ) for key in ascii_lowercase + ]) + assert len(bindings.shown_keys)==(len(ascii_lowercase)/2) diff --git a/tests/test_cache.py b/tests/test_cache.py index e81b7e06..aedcbfc4 100644 --- a/tests/test_cache.py +++ b/tests/test_cache.py @@ -61,6 +61,25 @@ def test_lru_cache_get(): assert \"egg\" not in cache assert \"eggegg\" in cache +def test_lru_cache_maxsize(): + cache = LRUCache(3) + + # Be sure that maxsize reports what we gave above. + assert cache.maxsize == 3, \"Incorrect cache maxsize\" + + # Now resize the cache by setting maxsize. + cache.maxsize = 30 + + # Check that it's reporting that back. + assert cache.maxsize == 30, \"Incorrect cache maxsize after setting it\" + + # Add more than maxsize items to the cache and be sure + for spam in range(cache.maxsize+10): + cache[f\"spam{spam}\"] = spam + + # Finally, check the cache is the max size we set. + assert len(cache) == 30, \"Cache grew too large given maxsize\" + def test_lru_cache_mapping(): \"\"\"Test cache values can be set and read back.\"\"\" diff --git a/tests/test_geometry.py b/tests/test_geometry.py index 02cac2fa..6b9cd07b 100644 --- a/tests/test_geometry.py +++ b/tests/test_geometry.py @@ -295,6 +295,10 @@ def test_size_sub(): Size(1, 2) - \"foo\" +def test_size_line_range(): + assert Size(20, 0).line_range == range(0) + assert Size(0, 20).line_range == range(20) + def test_region_x_extents(): assert Region(5, 10, 20, 30).column_span == (5, 25) diff --git a/tests/test_path.py b/tests/test_path.py new file mode 100644 index 00000000..77b4f3d8 --- /dev/null +++ b/tests/test_path.py @@ -0,0 +1,43 @@ +from typing import Type +from pathlib import Path + +from textual.app import App + +class RelativePathObjectApp(App[None]): + + CSS_PATH = Path(\"test.css\") + +class RelativePathStrApp(App[None]): + + CSS_PATH = \"test.css\" + +class AbsolutePathObjectApp(App[None]): + + CSS_PATH = Path(\"/tmp/test.css\") + +class AbsolutePathStrApp(App[None]): + + CSS_PATH = \"/tmp/test.css\" + +def path_tester(obj_type: Type[App[None]], str_type: Type[App[None]], intended_result: Path) -> None: + assert isinstance(obj_type().css_path,Path), ( + \"CSS_PATH didn't stay as an object\" + ) + assert isinstance(str_type().css_path,Path), ( + \"CSS_PATH wasn't converted from str to Path\" + ) + assert obj_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == obj_type().css_path, ( + \"CSS_PATH str to Path conversion gave a different result\" + ) + +def test_relative_path(): + path_tester(RelativePathObjectApp, RelativePathStrApp, ((Path(__file__).absolute().parent ) / \"test.css\").absolute()) + +def test_absolute_path(): + path_tester(AbsolutePathObjectApp, AbsolutePathStrApp, Path(\"/tmp/test.css\").absolute()) diff --git a/tests/test_query.py b/tests/test_query.py index be610804..373d8d0e 100644 --- a/tests/test_query.py +++ b/tests/test_query.py @@ -1,4 +1,7 @@ +import pytest + from textual.widget import Widget +from textual.css.query import InvalidQueryFormat def test_query(): @@ -78,3 +81,16 @@ def test_query(): assert list(app.query(\"#widget1, #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1 , #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1, #widget2, App\")) == [app, widget1, widget2] + + +def test_invalid_query(): + class App(Widget): + pass + + app = App() + + with pytest.raises(InvalidQueryFormat): + app.query(\"#3\") + + with pytest.raises(InvalidQueryFormat): + app.query(\"#foo\").exclude(\"#2\") ", "completion": "Remove comments, simplify test "}
{"prompt": "diff --git a/.github/workflows/comment.yml b/.github/workflows/comment.yml index b7a4c7f4..7191f183 100644 --- a/.github/workflows/comment.yml +++ b/.github/workflows/comment.yml @@ -15,6 +15,4 @@ jobs: body: | Did we solve your problem? - Consider buying the Textualize developers a [coffee](https://ko-fi.com/textualize) to say thanks. - - &ndash; [Textualize](https://twitter.com/textualizeio) + Glad we could help! diff --git a/CHANGELOG.md b/CHANGELOG.md index 32fe8eab..ad4f0949 100644 --- a/CHANGELOG.md +++ b/CHANGELOG.md @@ -5,6 +5,12 @@ All notable changes to this project will be documented in this file. The format is based on [Keep a Changelog](http://keepachangelog.com/) and this project adheres to [Semantic Versioning](http://semver.org/). +## [0.2.2] - Unreleased + +### Changed + +- DOMQuery now raises InvalidQueryFormat in response to invalid query strings, rather than cryptic CSS error + ## [0.2.1] - 2022-10-23 ### Changed diff --git a/docs/guide/input.md b/docs/guide/input.md index 968e19c7..5052a5dd 100644 --- a/docs/guide/input.md +++ b/docs/guide/input.md @@ -78,7 +78,7 @@ The following example shows how focus works in practice. ```{.textual path=\"docs/examples/guide/input/key03.py\", press=\"tab,H,e,l,l,o,tab,W,o,r,l,d,!,_\"} ``` -The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that thw widget has focus. Key events will be sent to the focused widget only. +The app splits the screen in to quarters, with a `TextLog` widget in each quarter. If you click any of the text logs, you should see that it is highlighted to show that the widget has focus. Key events will be sent to the focused widget only. !!! tip diff --git a/docs/tutorial.md b/docs/tutorial.md index 7a69c787..7fa4486c 100644 --- a/docs/tutorial.md +++ b/docs/tutorial.md @@ -430,7 +430,7 @@ The Stopwatch app creates widgets when it starts via the `compose` method. We wi Let's use these methods to implement adding and removing stopwatches to our app. -```python title=\"stopwatch.py\" hl_lines=\"78-79 88-92 94-98\" +```python title=\"stopwatch.py\" hl_lines=\"78-79 86 88-92 94-98\" --8<-- \"docs/examples/tutorial/stopwatch.py\" ``` diff --git a/examples/calculator.py b/examples/calculator.py index 60d982f9..e42273fe 100644 --- a/examples/calculator.py +++ b/examples/calculator.py @@ -28,7 +28,8 @@ class CalculatorApp(App): \"plus_minus_sign\": \"plus-minus\", \"percent_sign\": \"percent\", \"equals_sign\": \"equals\", - \"enter\": \"equals\", + \"minus\": \"minus\", + \"plus\": \"plus\", } def watch_numbers(self, value: str) -> None: @@ -80,7 +81,6 @@ class CalculatorApp(App): self.query_one(f\"#{button_id}\", Button).press() except NoMatches: pass - self.set_focus(None) key = event.key if key.isdecimal(): @@ -89,7 +89,9 @@ class CalculatorApp(App): press(\"c\") press(\"ac\") else: - press(self.NAME_MAP.get(key, key)) + button_id = self.NAME_MAP.get(key) + if button_id is not None: + press(self.NAME_MAP.get(key, key)) def on_button_pressed(self, event: Button.Pressed) -> None: \"\"\"Called when a button is pressed.\"\"\" diff --git a/examples/five_by_five.py b/examples/five_by_five.py index 84a50d63..20bbea80 100644 --- a/examples/five_by_five.py +++ b/examples/five_by_five.py @@ -24,8 +24,8 @@ from rich.markdown import Markdown class Help(Screen): \"\"\"The help screen for the application.\"\"\" - #: Bindings for the help screen. BINDINGS = [(\"escape,space,q,question_mark\", \"pop_screen\", \"Close\")] + \"\"\"Bindings for the help screen.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game's help. @@ -39,8 +39,8 @@ class Help(Screen): class WinnerMessage(Static): \"\"\"Widget to tell the user they have won.\"\"\" - #: The minimum number of moves you can solve the puzzle in. MIN_MOVES: Final = 14 + \"\"\"int: The minimum number of moves you can solve the puzzle in.\"\"\" @staticmethod def _plural(value: int) -> str: @@ -78,11 +78,11 @@ class GameHeader(Widget): and the count of how many cells are turned on (``#progress``). \"\"\" - #: Keep track of how many moves the player has made. moves = reactive(0) + \"\"\"int: Keep track of how many moves the player has made.\"\"\" - #: Keep track of how many cells are filled. filled = reactive(0) + \"\"\"int: Keep track of how many cells are filled.\"\"\" def compose(self) -> ComposeResult: \"\"\"Compose the game header. @@ -159,10 +159,9 @@ class GameGrid(Widget): class Game(Screen): \"\"\"Main 5x5 game grid screen.\"\"\" - #: The size of the game grid. Clue's in the name really. - SIZE = 5 + SIZE: Final = 5 + \"\"\"The size of the game grid. Clue's in the name really.\"\"\" - #: The bindings for the main game grid. BINDINGS = [ Binding(\"n\", \"new_game\", \"New Game\"), Binding(\"question_mark\", \"push_screen('help')\", \"Help\", key_display=\"?\"), @@ -173,6 +172,7 @@ class Game(Screen): Binding(\"right,d,l\", \"navigate(0,1)\", \"Move Right\", False), Binding(\"space\", \"move\", \"Toggle\", False), ] + \"\"\"The bindings for the main game grid.\"\"\" @property def filled_cells(self) -> DOMQuery[GameCell]: @@ -308,17 +308,17 @@ class Game(Screen): class FiveByFive(App[None]): \"\"\"Main 5x5 application class.\"\"\" - #: The name of the stylesheet for the app. CSS_PATH = \"five_by_five.css\" + \"\"\"The name of the stylesheet for the app.\"\"\" - #: The pre-loaded screens for the application. SCREENS = {\"help\": Help()} + \"\"\"The pre-loaded screens for the application.\"\"\" - #: App-level bindings. BINDINGS = [(\"ctrl+d\", \"toggle_dark\", \"Toggle Dark Mode\")] + \"\"\"App-level bindings.\"\"\" - # Set the title TITLE = \"5x5 -- A little annoying puzzle\" + \"\"\"The title of the application.\"\"\" def on_mount(self) -> None: \"\"\"Set up the application on startup.\"\"\" diff --git a/src/textual/app.py b/src/textual/app.py index c044f615..43f1bd56 100644 --- a/src/textual/app.py +++ b/src/textual/app.py @@ -605,7 +605,7 @@ class App(Generic[ReturnType], DOMNode): assert press driver = app._driver assert driver is not None - await asyncio.sleep(0.01) + await asyncio.sleep(0.02) for key in press: if key == \"_\": print(\"(pause 50ms)\") @@ -632,7 +632,13 @@ class App(Generic[ReturnType], DOMNode): print(f\"press {key!r} (char={char!r})\") key_event = events.Key(self, key, char) driver.send_event(key_event) - await asyncio.sleep(0.01) + # TODO: A bit of a fudge - extra sleep after tabbing to help guard against race + # condition between widget-level key handling and app/screen level handling. + # More information here: https://github.com/Textualize/textual/issues/1009 + # This conditional sleep can be removed after that issue is closed. + if key == \"tab\": + await asyncio.sleep(0.05) + await asyncio.sleep(0.02) await app._animator.wait_for_idle() diff --git a/src/textual/css/query.py b/src/textual/css/query.py index 93addb6f..e0d58820 100644 --- a/src/textual/css/query.py +++ b/src/textual/css/query.py @@ -20,7 +20,7 @@ from typing import cast, Generic, TYPE_CHECKING, Iterator, TypeVar, overload import rich.repr -from .errors import DeclarationError +from .errors import DeclarationError, TokenError from .match import match from .model import SelectorSet from .parse import parse_declarations, parse_selectors @@ -34,6 +34,10 @@ class QueryError(Exception): \"\"\"Base class for a query related error.\"\"\" +class InvalidQueryFormat(QueryError): + \"\"\"Query did not parse correctly.\"\"\" + + class NoMatches(QueryError): \"\"\"No nodes matched the query.\"\"\" @@ -72,9 +76,17 @@ class DOMQuery(Generic[QueryType]): parent._excludes.copy() if parent else [] ) if filter is not None: - self._filters.append(parse_selectors(filter)) + try: + self._filters.append(parse_selectors(filter)) + except TokenError: + # TODO: More helpful errors + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") + if exclude is not None: - self._excludes.append(parse_selectors(exclude)) + try: + self._excludes.append(parse_selectors(exclude)) + except TokenError: + raise InvalidQueryFormat(f\"Unable to parse filter {filter!r} as query\") @property def node(self) -> DOMNode: diff --git a/tests/snapshot_tests/conftest.py b/tests/snapshot_tests/conftest.py index 79b5584b..0a0f0d55 100644 --- a/tests/snapshot_tests/conftest.py +++ b/tests/snapshot_tests/conftest.py @@ -59,6 +59,7 @@ def snap_compare( \"\"\" node = request.node app = import_app(app_path) + compare.app = app actual_screenshot = take_svg_screenshot( app=app, press=press, diff --git a/tests/snapshot_tests/test_snapshots.py b/tests/snapshot_tests/test_snapshots.py index fb491322..2f04c931 100644 --- a/tests/snapshot_tests/test_snapshots.py +++ b/tests/snapshot_tests/test_snapshots.py @@ -1,7 +1,10 @@ -from pathlib import Path +from pathlib import Path, PurePosixPath import pytest +from textual.app import App +from textual.widgets import Input, Button + # --- Layout related stuff --- @@ -38,13 +41,6 @@ def test_dock_layout_sidebar(snap_compare): # When adding a new widget, ideally we should also create a snapshot test # from these examples which test rendering and simple interactions with it. -# before snapshot test: -# src/textual/widgets/_checkbox.py 47 47 0% 1-126 -# before testing presses in snapshot test: -# src/textual/widgets/_checkbox.py 47 11 77% 83-88, 110, 113, 118, 124-126 -# after testing presses in snapshot test: -# src/textual/widgets/_checkbox.py 47 2 96% 87, 110 - def test_checkboxes(snap_compare): \"\"\"Tests checkboxes but also acts a regression test for using width: auto in a Horizontal layout context.\"\"\" @@ -60,18 +56,31 @@ def test_checkboxes(snap_compare): def test_input_and_focus(snap_compare): - first_field = [\"tab\"] + list(\"Darren\") # Focus first input, write \"Darren\" - second_field = [\"tab\"] + list(\"Burns\") # Tab focus to second input, write \"Burns\" - assert snap_compare(\"docs/examples/widgets/input.py\", press=first_field + second_field) + press = [ + \"tab\", + *\"Darren\", # Focus first input, write \"Darren\" + \"tab\", + *\"Burns\", # Tab focus to second input, write \"Burns\" + ] + assert snap_compare(\"docs/examples/widgets/input.py\", press=press) + + # Assert that the state of the Input is what we'd expect + app: App = snap_compare.app + input: Input = app.query_one(Input) + assert input.value == \"Darren\" + assert input.cursor_position == 6 + assert input.view_position == 0 def test_buttons_render(snap_compare): # Testing button rendering. We press tab to focus the first button too. assert snap_compare(\"docs/examples/widgets/button.py\", press=[\"tab\"]) + app = snap_compare.app + button: Button = app.query_one(Button) + assert app.focused is button + -# src/textual/widgets/_data_table.py 312 312 0% -# src/textual/widgets/_data_table.py 312 85 73% def test_datatable_render(snap_compare): press = [\"tab\", \"down\", \"down\", \"right\", \"up\", \"left\"] assert snap_compare(\"docs/examples/widgets/data_table.py\", press=press) @@ -84,12 +93,13 @@ def test_footer_render(snap_compare): def test_header_render(snap_compare): assert snap_compare(\"docs/examples/widgets/header.py\") + # --- CSS properties --- # We have a canonical example for each CSS property that is shown in their docs. # If any of these change, something has likely broken, so snapshot each of them. PATHS = [ - str(path) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" + str(PurePosixPath(path)) for path in Path(\"docs/examples/styles\").iterdir() if path.suffix == \".py\" ] diff --git a/tests/test_arrange.py b/tests/test_arrange.py index 580d68e0..f66f0195 100644 --- a/tests/test_arrange.py +++ b/tests/test_arrange.py @@ -1,3 +1,5 @@ +import pytest + from textual._arrange import arrange, TOP_Z from textual._layout import WidgetPlacement from textual.geometry import Region, Size, Spacing @@ -91,3 +93,9 @@ def test_arrange_dock_bottom(): ] assert widgets == {child, header} assert spacing == Spacing(0, 0, 1, 0) + +def test_arrange_dock_badly(): + child = Widget(id=\"child\") + child.styles.dock = \"nowhere\" + with pytest.raises(AssertionError): + _ = arrange( Widget(), [child], Size(80, 24), Size(80, 24)) diff --git a/tests/test_binding.py b/tests/test_binding.py index d2d61ac1..620fbc03 100644 --- a/tests/test_binding.py +++ b/tests/test_binding.py @@ -1,6 +1,8 @@ +from string import ascii_lowercase + import pytest -from textual.binding import Bindings, Binding +from textual.binding import Bindings, Binding, BindingError, NoBinding BINDING1 = Binding(\"a,b\", action=\"action1\", description=\"description1\") BINDING2 = Binding(\"c\", action=\"action2\", description=\"description2\") @@ -14,14 +16,14 @@ def bindings(): def test_bindings_get_key(bindings): assert bindings.get_key(\"b\") == Binding(\"b\", action=\"action1\", description=\"description1\") assert bindings.get_key(\"c\") == BINDING2 - + with pytest.raises(NoBinding): + bindings.get_key(\"control+meta+alt+shift+super+hyper+t\") def test_bindings_merge_simple(bindings): left = Bindings([BINDING1]) right = Bindings([BINDING2]) assert Bindings.merge([left, right]).keys == bindings.keys - def test_bindings_merge_overlap(): left = Bindings([BINDING1]) another_binding = Binding(\"a\", action=\"another_action\", description=\"another_description\") @@ -29,3 +31,20 @@ def test_bindings_merge_overlap(): \"a\": another_binding, \"b\": Binding(\"b\", action=\"action1\", description=\"description1\"), } + +def test_bad_binding_tuple(): + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\"),)) + with pytest.raises(BindingError): + _ = Bindings(((\"a\", \"action\", \"description\",\"too much\"),)) + +def test_binding_from_tuples(): + assert Bindings((( BINDING2.key, BINDING2.action, BINDING2.description),)).get_key(\"c\") == BINDING2 + +def test_shown(): + bindings = Bindings([ + Binding( + key, action=f\"action_{key}\", description=f\"Emits {key}\",show=bool(ord(key)%2) + ) for key in ascii_lowercase + ]) + assert len(bindings.shown_keys)==(len(ascii_lowercase)/2) diff --git a/tests/test_cache.py b/tests/test_cache.py index e81b7e06..aedcbfc4 100644 --- a/tests/test_cache.py +++ b/tests/test_cache.py @@ -61,6 +61,25 @@ def test_lru_cache_get(): assert \"egg\" not in cache assert \"eggegg\" in cache +def test_lru_cache_maxsize(): + cache = LRUCache(3) + + # Be sure that maxsize reports what we gave above. + assert cache.maxsize == 3, \"Incorrect cache maxsize\" + + # Now resize the cache by setting maxsize. + cache.maxsize = 30 + + # Check that it's reporting that back. + assert cache.maxsize == 30, \"Incorrect cache maxsize after setting it\" + + # Add more than maxsize items to the cache and be sure + for spam in range(cache.maxsize+10): + cache[f\"spam{spam}\"] = spam + + # Finally, check the cache is the max size we set. + assert len(cache) == 30, \"Cache grew too large given maxsize\" + def test_lru_cache_mapping(): \"\"\"Test cache values can be set and read back.\"\"\" diff --git a/tests/test_geometry.py b/tests/test_geometry.py index 02cac2fa..6b9cd07b 100644 --- a/tests/test_geometry.py +++ b/tests/test_geometry.py @@ -295,6 +295,10 @@ def test_size_sub(): Size(1, 2) - \"foo\" +def test_size_line_range(): + assert Size(20, 0).line_range == range(0) + assert Size(0, 20).line_range == range(20) + def test_region_x_extents(): assert Region(5, 10, 20, 30).column_span == (5, 25) diff --git a/tests/test_path.py b/tests/test_path.py new file mode 100644 index 00000000..77b4f3d8 --- /dev/null +++ b/tests/test_path.py @@ -0,0 +1,43 @@ +from typing import Type +from pathlib import Path + +from textual.app import App + +class RelativePathObjectApp(App[None]): + + CSS_PATH = Path(\"test.css\") + +class RelativePathStrApp(App[None]): + + CSS_PATH = \"test.css\" + +class AbsolutePathObjectApp(App[None]): + + CSS_PATH = Path(\"/tmp/test.css\") + +class AbsolutePathStrApp(App[None]): + + CSS_PATH = \"/tmp/test.css\" + +def path_tester(obj_type: Type[App[None]], str_type: Type[App[None]], intended_result: Path) -> None: + assert isinstance(obj_type().css_path,Path), ( + \"CSS_PATH didn't stay as an object\" + ) + assert isinstance(str_type().css_path,Path), ( + \"CSS_PATH wasn't converted from str to Path\" + ) + assert obj_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == intended_result, ( + \"CSS_PATH doesn't match the intended result.\" + ) + assert str_type().css_path == obj_type().css_path, ( + \"CSS_PATH str to Path conversion gave a different result\" + ) + +def test_relative_path(): + path_tester(RelativePathObjectApp, RelativePathStrApp, ((Path(__file__).absolute().parent ) / \"test.css\").absolute()) + +def test_absolute_path(): + path_tester(AbsolutePathObjectApp, AbsolutePathStrApp, Path(\"/tmp/test.css\").absolute()) diff --git a/tests/test_query.py b/tests/test_query.py index be610804..373d8d0e 100644 --- a/tests/test_query.py +++ b/tests/test_query.py @@ -1,4 +1,7 @@ +import pytest + from textual.widget import Widget +from textual.css.query import InvalidQueryFormat def test_query(): @@ -78,3 +81,16 @@ def test_query(): assert list(app.query(\"#widget1, #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1 , #widget2\")) == [widget1, widget2] assert list(app.query(\"#widget1, #widget2, App\")) == [app, widget1, widget2] + + +def test_invalid_query(): + class App(Widget): + pass + + app = App() + + with pytest.raises(InvalidQueryFormat): + app.query(\"#3\") + + with pytest.raises(InvalidQueryFormat): + app.query(\"#foo\").exclude(\"#2\") ", "completion": "Snapshotting Header widgets "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/crates/turbo-tasks-memory/src/count_hash_set.rs b/crates/turbo-tasks-memory/src/count_hash_set.rs index dbbbd0c9..68616ab8 100644 --- a/crates/turbo-tasks-memory/src/count_hash_set.rs +++ b/crates/turbo-tasks-memory/src/count_hash_set.rs @@ -81,12 +81,12 @@ impl<T: Eq + Hash, H: BuildHasher> CountHashSet<T, H> { } } - /// Returns true when the value has become visible from outside + /// Returns true, when the value has become visible from outside pub fn add(&mut self, item: T) -> bool { self.add_count(item, 1) } - /// Returns true when the value is no longer visible from outside + /// Returns true, when the value is no longer visible from outside pub fn remove_count(&mut self, item: T, count: usize) -> bool { match self.inner.entry(item) { Entry::Occupied(mut e) => { @@ -94,7 +94,7 @@ impl<T: Eq + Hash, H: BuildHasher> CountHashSet<T, H> { let old = *value; *value -= count as isize; if *value > 0 { - // It was and still is positive + // It's was and still is positive false } else if *value == 0 { // It was positive and has become zero diff --git a/crates/turbo-tasks-memory/src/memory_backend.rs b/crates/turbo-tasks-memory/src/memory_backend.rs index fe72b940..8d1d280b 100644 --- a/crates/turbo-tasks-memory/src/memory_backend.rs +++ b/crates/turbo-tasks-memory/src/memory_backend.rs @@ -1,7 +1,7 @@ use std::{ borrow::Cow, cell::RefCell, - collections::{HashSet, VecDeque}, + collections::HashSet, future::Future, pin::Pin, sync::atomic::{AtomicUsize, Ordering}, @@ -521,12 +521,8 @@ pub(crate) enum Job { RemoveFromScopes(HashSet<TaskId>, Vec<TaskScopeId>), RemoveFromScope(HashSet<TaskId>, TaskScopeId), ScheduleWhenDirty(Vec<TaskId>), - /// Add tasks from a scope. Scheduled by `run_add_from_scope_queue` to - /// split off work. - AddToScopeQueue(VecDeque<(TaskId, usize)>, TaskScopeId, bool), - /// Remove tasks from a scope. Scheduled by `run_remove_from_scope_queue` to - /// split off work. - RemoveFromScopeQueue(VecDeque<TaskId>, TaskScopeId), + AddToScopeQueue(Vec<(Vec<TaskId>, usize)>, usize, TaskScopeId, bool), + RemoveFromScopeQueue(Vec<Vec<TaskId>>, usize, TaskScopeId), } impl Job { @@ -553,11 +549,18 @@ impl Job { }) } } - Job::AddToScopeQueue(queue, id, is_optimization_scope) => { - run_add_to_scope_queue(queue, id, is_optimization_scope, backend, turbo_tasks); + Job::AddToScopeQueue(queue, queue_size, id, is_optimization_scope) => { + run_add_to_scope_queue( + queue, + queue_size, + id, + is_optimization_scope, + backend, + turbo_tasks, + ); } - Job::RemoveFromScopeQueue(queue, id) => { - run_remove_from_scope_queue(queue, id, backend, turbo_tasks); + Job::RemoveFromScopeQueue(queue, queue_size, id) => { + run_remove_from_scope_queue(queue, queue_size, id, backend, turbo_tasks); } } } diff --git a/crates/turbo-tasks-memory/src/scope.rs b/crates/turbo-tasks-memory/src/scope.rs index c810afa2..cb8bfb68 100644 --- a/crates/turbo-tasks-memory/src/scope.rs +++ b/crates/turbo-tasks-memory/src/scope.rs @@ -433,15 +433,15 @@ impl TaskScopeState { } } - /// Add a child scope. Returns a [ScopeChildChangeEffect] when the child - /// scope need to have its active counter increased. + /// Add a child scope. Returns true, when the child scope need to have it's + /// active counter increased. #[must_use] pub fn add_child(&mut self, child: TaskScopeId) -> Option<ScopeChildChangeEffect> { self.add_child_count(child, 1) } - /// Add a child scope. Returns a [ScopeChildChangeEffect] when the child - /// scope need to have its active counter increased. + /// Add a child scope. Returns true, when the child scope need to have it's + /// active counter increased. #[must_use] pub fn add_child_count( &mut self, diff --git a/crates/turbo-tasks-memory/src/task.rs b/crates/turbo-tasks-memory/src/task.rs index df25cb07..d81e3640 100644 --- a/crates/turbo-tasks-memory/src/task.rs +++ b/crates/turbo-tasks-memory/src/task.rs @@ -2,7 +2,7 @@ use std::{ borrow::Cow, cell::RefCell, cmp::Ordering, - collections::{HashSet, VecDeque}, + collections::HashSet, fmt::{self, Debug, Display, Formatter, Write}, future::Future, hash::Hash, @@ -157,7 +157,7 @@ struct TaskState { /// dirty, scheduled, in progress state_type: TaskStateType, - /// Children are only modified from execution + /// children are only modified from execution children: HashSet<TaskId>, /// Collectibles are only modified from execution @@ -444,10 +444,10 @@ impl Task { Scheduled => { state.state_type = InProgress; state.executions += 1; - // TODO we need to reconsider the approach of doing scope changes in background + // TODO we need to reconsider the approach of during scope changes in background // since they affect collectibles and need to be computed eagerly to allow // strongly_consistent to work properly. - // We could move this operation to the point when the task execution is + // We could move this operation to the point then the task execution is // finished. if !state.children.is_empty() { let set = take(&mut state.children); @@ -657,70 +657,66 @@ impl Task { depth: usize, backend: &MemoryBackend, turbo_tasks: &dyn TurboTasksBackendApi, - queue: &mut VecDeque<(TaskId, usize)>, - ) { + ) -> Option<Vec<TaskId>> { let mut state = self.state.write(); let TaskState { scopes, children, .. } = &mut *state; match *scopes { TaskScopes::Root(root) => { - if root == id { - // The task is already in the root scope we're trying to add it to. - return; - } - - if let Some(ScopeChildChangeEffect { notify, active }) = - backend.with_scope(id, |scope| scope.state.lock().add_child(root)) - { - drop(state); - if !notify.is_empty() { - turbo_tasks.schedule_notify_tasks_set(&notify); - } - if active { - backend.increase_scope_active(root, turbo_tasks); + if root != id { + if let Some(ScopeChildChangeEffect { notify, active }) = + backend.with_scope(id, |scope| scope.state.lock().add_child(root)) + { + drop(state); + if !notify.is_empty() { + turbo_tasks.schedule_notify_tasks_set(&notify); + } + if active { + backend.increase_scope_active(root, turbo_tasks); + } } } } TaskScopes::Inner(ref mut list, ref mut optimization_counter) => { - if !list.add(id) { - // The task is already in the scope we're trying to add it to. - return; - } - - if depth < usize::BITS as usize { - if is_optimization_scope { - *optimization_counter = - optimization_counter.saturating_sub(children.len() >> depth) - } else { - *optimization_counter += children.len() >> depth; - if *optimization_counter >= 0x10000 { - list.remove(id); - self.make_root_scoped_internal(state, backend, turbo_tasks); - return self.add_to_scope_internal_shallow( - id, - is_optimization_scope, - depth, - backend, - turbo_tasks, - queue, - ); + if list.add(id) { + if depth < usize::BITS as usize { + if is_optimization_scope { + *optimization_counter = + optimization_counter.saturating_sub(children.len() >> depth) + } else { + *optimization_counter += children.len() >> depth; + if *optimization_counter >= 0x10000 { + list.remove(id); + self.make_root_scoped_internal(state, backend, turbo_tasks); + return self.add_to_scope_internal_shallow( + id, + is_optimization_scope, + depth, + backend, + turbo_tasks, + ); + } } } - } + let children = children.iter().copied().collect::<Vec<_>>(); - queue.extend(children.iter().copied().map(|child| (child, depth + 1))); + // add to dirty list of the scope (potentially schedule) + let schedule_self = + self.add_self_to_new_scope(&mut state, id, backend, turbo_tasks); + drop(state); - // add to dirty list of the scope (potentially schedule) - let schedule_self = - self.add_self_to_new_scope(&mut state, id, backend, turbo_tasks); - drop(state); + if schedule_self { + turbo_tasks.schedule(self.id); + } - if schedule_self { - turbo_tasks.schedule(self.id); + if !children.is_empty() { + return Some(children); + } } } } + None } pub(crate) fn add_to_scope_internal( @@ -730,17 +726,21 @@ impl Task { backend: &MemoryBackend, turbo_tasks: &dyn TurboTasksBackendApi, ) { - let mut queue = VecDeque::new(); - self.add_to_scope_internal_shallow( - id, - is_optimization_scope, - 0, - backend, - turbo_tasks, - &mut queue, - ); - - run_add_to_scope_queue(queue, id, is_optimization_scope, backend, turbo_tasks); + if let Some(children) = + self.add_to_scope_internal_shallow(id, is_optimization_scope, 0, backend, turbo_tasks) + { + let queue_size = children.len(); + let queue = vec![(children, 1)]; + + run_add_to_scope_queue( + queue, + queue_size, + id, + is_optimization_scope, + backend, + turbo_tasks, + ); + } } fn add_self_to_new_scope( @@ -838,8 +838,7 @@ impl Task { id: TaskScopeId, backend: &MemoryBackend, turbo_tasks: &dyn TurboTasksBackendApi, - queue: &mut VecDeque<TaskId>, - ) { + ) -> Option<Vec<TaskId>> { let mut state = self.state.write(); match state.scopes { TaskScopes::Root(root) => { @@ -860,11 +859,17 @@ impl Task { TaskScopes::Inner(ref mut set, _) => { if set.remove(id) { self.remove_self_from_scope(&mut state, id, backend, turbo_tasks); - queue.extend(state.children.iter().copied()); + let children = state.children.iter().copied().collect::<Vec<_>>(); drop(state); + + if !children.is_empty() { + return Some(children); + } } } } + + None } fn remove_from_scope_internal( @@ -873,9 +878,12 @@ impl Task { backend: &MemoryBackend, turbo_tasks: &dyn TurboTasksBackendApi, ) { - let mut queue = VecDeque::new(); - self.remove_from_scope_internal_shallow(id, backend, turbo_tasks, &mut queue); - run_remove_from_scope_queue(queue, id, backend, turbo_tasks); + if let Some(children) = self.remove_from_scope_internal_shallow(id, backend, turbo_tasks) { + let queue_size = children.len(); + let queue = vec![children]; + + run_remove_from_scope_queue(queue, queue_size, id, backend, turbo_tasks); + } } pub(crate) fn remove_from_scope( @@ -917,11 +925,20 @@ impl Task { let initial = backend.initial_scope; if set.remove(initial) { self.remove_self_from_scope(&mut state, initial, backend, turbo_tasks); - let children = state.children.iter().copied().collect::<VecDeque<_>>(); + let children = state.children.iter().copied().collect::<Vec<_>>(); drop(state); if !children.is_empty() { - run_remove_from_scope_queue(children, initial, backend, turbo_tasks); + let queue_size = children.len(); + let queue = vec![children]; + + run_remove_from_scope_queue( + queue, + queue_size, + initial, + backend, + turbo_tasks, + ); } } } @@ -1443,54 +1460,81 @@ impl Task { } } -/// Heuristic to decide when to split off work in `run_add_to_scope_queue` and -/// `run_remove_from_scope_queue`. -const SPLIT_OFF_QUEUE_AT: usize = 100; - -/// Adds a list of tasks and their children to a scope, recursively. pub fn run_add_to_scope_queue( - mut queue: VecDeque<(TaskId, usize)>, + mut queue: Vec<(Vec<TaskId>, usize)>, + mut queue_size: usize, id: TaskScopeId, is_optimization_scope: bool, backend: &MemoryBackend, turbo_tasks: &dyn TurboTasksBackendApi, ) { - while let Some((child, depth)) = queue.pop_front() { - backend.with_task(child, |child| { - child.add_to_scope_internal_shallow( - id, - is_optimization_scope, - depth, - backend, - turbo_tasks, - &mut queue, - ); - }); - if queue.len() > SPLIT_OFF_QUEUE_AT { - let split_off_queue = queue.split_off(SPLIT_OFF_QUEUE_AT); + while let Some((children, depth)) = queue.pop() { + queue_size -= children.len(); + for child in children { + backend.with_task(child, |child| { + if let Some(r) = child.add_to_scope_internal_shallow( + id, + is_optimization_scope, + depth, + backend, + turbo_tasks, + ) { + queue_size += r.len(); + queue.push((r, depth + 1)); + } + }) + } + if queue.len() > 4 && queue_size > 100 { + let start_queue_size = queue_size; + let queue_size_goal = queue_size / 2; + let mut split_off_queue = Vec::new(); + while queue.len() > 2 && queue_size > queue_size_goal { + let item = queue.pop().unwrap(); + queue_size -= item.0.len(); + split_off_queue.push(item); + } turbo_tasks.schedule_backend_foreground_job(backend.create_backend_job( - Job::AddToScopeQueue(split_off_queue, id, is_optimization_scope), + Job::AddToScopeQueue( + split_off_queue, + start_queue_size - queue_size, + id, + is_optimization_scope, + ), )); } } } -/// Removes a list of tasks and their children from a scope, recursively. pub fn run_remove_from_scope_queue( - mut queue: VecDeque<TaskId>, + mut queue: Vec<Vec<TaskId>>, + mut queue_size: usize, id: TaskScopeId, backend: &MemoryBackend, turbo_tasks: &dyn TurboTasksBackendApi, ) { - while let Some(child) = queue.pop_front() { - backend.with_task(child, |child| { - child.remove_from_scope_internal_shallow(id, backend, turbo_tasks, &mut queue); - }); - if queue.len() > SPLIT_OFF_QUEUE_AT { - let split_off_queue = queue.split_off(SPLIT_OFF_QUEUE_AT); - turbo_tasks.schedule_backend_background_job( - backend.create_backend_job(Job::RemoveFromScopeQueue(split_off_queue, id)), - ); + while let Some(children) = queue.pop() { + queue_size -= children.len(); + for child in children { + backend.with_task(child, |child| { + if let Some(r) = child.remove_from_scope_internal_shallow(id, backend, turbo_tasks) + { + queue_size += r.len(); + queue.push(r); + } + }) + } + if queue.len() > 4 && queue_size > 100 { + let start_queue_size = queue_size; + let queue_size_goal = queue_size / 2; + let mut split_off_queue = Vec::new(); + while queue.len() > 2 && queue_size > queue_size_goal { + let item = queue.pop().unwrap(); + queue_size -= item.len(); + split_off_queue.push(item); + } + turbo_tasks.schedule_backend_background_job(backend.create_backend_job( + Job::RemoveFromScopeQueue(split_off_queue, start_queue_size - queue_size, id), + )); } } } ", "completion": "Merge branch 'main' into alexkirsz/optimize-add-remove-scope "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml ", "completion": "Add Next.js require hook (#2434) This hook is needed to ensure we properly map compiled modules like `styled-jsx` correctly. x-ref: [slack thread](https://vercel.slack.com/archives/CGU8HUTUH/p1666824437456749?thread_ts=1666819473.031139&cid=CGU8HUTUH) "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; diff --git a/crates/turbopack-core/src/issue/mod.rs b/crates/turbopack-core/src/issue/mod.rs index 108267c4..24f443ca 100644 --- a/crates/turbopack-core/src/issue/mod.rs +++ b/crates/turbopack-core/src/issue/mod.rs @@ -2,7 +2,6 @@ pub mod analyze; pub mod code_gen; pub mod package_json; pub mod resolve; -pub mod unsupported_module; use std::{cmp::Ordering, collections::HashSet, fmt::Display, future::IntoFuture, sync::Arc}; diff --git a/crates/turbopack-core/src/issue/unsupported_module.rs b/crates/turbopack-core/src/issue/unsupported_module.rs deleted file mode 100644 index 1a269534..00000000 --- a/crates/turbopack-core/src/issue/unsupported_module.rs +++ /dev/null @@ -1,43 +0,0 @@ -use anyhow::Result; -use turbo_tasks::primitives::StringVc; -use turbo_tasks_fs::FileSystemPathVc; - -use super::{Issue, IssueSeverity, IssueSeverityVc, IssueVc}; - -#[turbo_tasks::value(shared)] -pub struct UnsupportedModuleIssue { - pub context: FileSystemPathVc, - pub package: String, - pub package_path: Option<String>, -} - -#[turbo_tasks::value_impl] -impl Issue for UnsupportedModuleIssue { - #[turbo_tasks::function] - fn severity(&self) -> IssueSeverityVc { - IssueSeverity::Warning.into() - } - - #[turbo_tasks::function] - fn category(&self) -> StringVc { - StringVc::cell(\"resolve\".to_string()) - } - - #[turbo_tasks::function] - fn title(&self) -> StringVc { - StringVc::cell(\"Unsupported module\".into()) - } - - #[turbo_tasks::function] - fn context(&self) -> FileSystemPathVc { - self.context - } - - #[turbo_tasks::function] - async fn description(&self) -> Result<StringVc> { - Ok(StringVc::cell(match &self.package_path { - Some(path) => format!(\"The module {}{} is not yet supported\", self.package, path), - None => format!(\"The package {} is not yet supported\", self.package), - })) - } -} diff --git a/crates/turbopack/src/lib.rs b/crates/turbopack/src/lib.rs index 43fdb79d..2813d316 100644 --- a/crates/turbopack/src/lib.rs +++ b/crates/turbopack/src/lib.rs @@ -20,7 +20,6 @@ use ecmascript::{ EcmascriptModuleAssetVc, }; use graph::{aggregate, AggregatedGraphNodeContent, AggregatedGraphVc}; -use lazy_static::lazy_static; use module_options::{ ModuleOptionsContextVc, ModuleOptionsVc, ModuleRuleEffect, ModuleType, ModuleTypeVc, }; @@ -34,14 +33,11 @@ use turbopack_core::{ asset::AssetVc, context::{AssetContext, AssetContextVc}, environment::EnvironmentVc, - issue::{unsupported_module::UnsupportedModuleIssue, Issue, IssueVc}, + issue::{Issue, IssueVc}, reference::all_referenced_assets, resolve::{ - options::ResolveOptionsVc, - origin::PlainResolveOriginVc, - parse::{Request, RequestVc}, - pattern::Pattern, - resolve, ResolveResultVc, + options::ResolveOptionsVc, origin::PlainResolveOriginVc, parse::RequestVc, resolve, + ResolveResultVc, }, }; @@ -62,15 +58,6 @@ use self::{ transition::{TransitionVc, TransitionsByNameVc}, }; -lazy_static! { - static ref UNSUPPORTED_PACKAGES: HashSet<String> = [\"@vercel/og\".to_owned()].into(); - static ref UNSUPPORTED_PACKAGE_PATHS: HashSet<(String, String)> = [ - (\"next\".to_owned(), \"/font\".to_owned()), - (\"next\".to_owned(), \"/head\".to_owned()) - ] - .into(); -} - #[turbo_tasks::value] struct ModuleIssue { path: FileSystemPathVc, @@ -305,8 +292,6 @@ impl AssetContext for ModuleAssetContext { request: RequestVc, resolve_options: ResolveOptionsVc, ) -> Result<ResolveResultVc> { - warn_on_unsupported_modules(request, origin_path).await?; - let context_path = origin_path.parent().resolve().await?; let result = resolve(context_path, request, resolve_options); @@ -535,40 +520,6 @@ async fn print_references(list: ReferencesListVc) -> Result<()> { Ok(()) } -async fn warn_on_unsupported_modules( - request: RequestVc, - origin_path: FileSystemPathVc, -) -> Result<()> { - if let Request::Module { module, path } = &*request.await? { - // Warn if the package is known not to be supported by Turbopack at the moment. - if UNSUPPORTED_PACKAGES.contains(module) { - UnsupportedModuleIssue { - context: origin_path, - package: module.into(), - package_path: None, - } - .cell() - .as_issue() - .emit(); - } - - if let Pattern::Constant(path) = path { - if UNSUPPORTED_PACKAGE_PATHS.contains(&(module.to_string(), path.to_owned())) { - UnsupportedModuleIssue { - context: origin_path, - package: module.into(), - package_path: Some(path.to_owned()), - } - .cell() - .as_issue() - .emit(); - } - } - } - - Ok(()) -} - pub fn register() { turbo_tasks::register(); turbo_tasks_fs::register(); ", "completion": "Warn on not-yet-supported module usage "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/Cargo.lock b/Cargo.lock index 14b81dcd..d66d4575 100644 --- a/Cargo.lock +++ b/Cargo.lock @@ -887,6 +887,12 @@ dependencies = [ \"syn 1.0.99\", ] +[[package]] +name = \"cty\" +version = \"0.2.2\" +source = \"registry+https://github.com/rust-lang/crates.io-index\" +checksum = \"b365fabc795046672053e29c954733ec3b05e4be654ab130fe8f1f94d7051f35\" + [[package]] name = \"darling\" version = \"0.13.4\" @@ -924,14 +930,13 @@ dependencies = [ [[package]] name = \"dashmap\" -version = \"5.4.0\" +version = \"5.3.4\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"907076dfda823b0b36d2a1bb5f90c96660a5bbcd7729e10727f07858f22c4edc\" +checksum = \"3495912c9c1ccf2e18976439f4443f3fee0fd61f424ff99fde6a66b15ecb448f\" dependencies = [ \"cfg-if 1.0.0\", \"hashbrown 0.12.3\", \"lock_api\", - \"once_cell\", \"parking_lot_core 0.9.3\", ] @@ -2003,20 +2008,11 @@ dependencies = [ \"winapi 0.3.9\", ] -[[package]] -name = \"libmimalloc-sys\" -version = \"0.1.26\" -source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"8fc093ab289b0bfda3aa1bdfab9c9542be29c7ef385cfcbe77f8c9813588eb48\" -dependencies = [ - \"cc\", -] - [[package]] name = \"lock_api\" -version = \"0.4.9\" +version = \"0.4.7\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"435011366fe56583b16cf956f9df0095b405b82d76425bc8981c0e22e60ec4df\" +checksum = \"327fa5b6a6940e4699ec49a9beae1ea4845c6bab9314e4f84ac68742139d8c53\" dependencies = [ \"autocfg\", \"scopeguard\", @@ -2117,12 +2113,23 @@ dependencies = [ ] [[package]] -name = \"mimalloc\" -version = \"0.1.30\" +name = \"mimalloc-rust\" +version = \"0.2.0\" +source = \"registry+https://github.com/rust-lang/crates.io-index\" +checksum = \"6973866e0bc6504c03a16b6817b7e70839cc8a1dbd5d6dab00c65d8034868d8b\" +dependencies = [ + \"cty\", + \"mimalloc-rust-sys\", +] + +[[package]] +name = \"mimalloc-rust-sys\" +version = \"1.7.6-source\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"76ce6a4b40d3bff9eb3ce9881ca0737a85072f9f975886082640cd46a75cdb35\" +checksum = \"7a50daf45336b979a202a19f53b4b382f2c4bd50f392a8dbdb4c6c56ba5dfa64\" dependencies = [ - \"libmimalloc-sys\", + \"cc\", + \"cty\", ] [[package]] @@ -2371,7 +2378,6 @@ dependencies = [ \"test-generator\", \"tokio\", \"tungstenite\", - \"turbo-malloc\", \"turbo-tasks\", \"turbo-tasks-build\", \"turbo-tasks-fs\", @@ -2575,9 +2581,9 @@ dependencies = [ [[package]] name = \"once_cell\" -version = \"1.15.0\" +version = \"1.13.0\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"e82dad04139b71a90c080c8463fe0dc7902db5192d939bd0950f074d014339e1\" +checksum = \"18a6dbe30758c9f83eb00cbea4ac95966305f5a7772f3f42ebfc7fc7eddbd8e1\" [[package]] name = \"oorandom\" @@ -5033,7 +5039,7 @@ dependencies = [ name = \"turbo-malloc\" version = \"0.1.0\" dependencies = [ - \"mimalloc\", + \"mimalloc-rust\", ] [[package]] @@ -5159,14 +5165,12 @@ dependencies = [ \"anyhow\", \"concurrent-queue\", \"criterion\", - \"dashmap\", \"event-listener\", \"flurry\", \"lazy_static\", \"nohash-hasher\", \"num_cpus\", \"parking_lot 0.12.1\", - \"rustc-hash\", \"serde\", \"tokio\", \"turbo-tasks\", @@ -5206,6 +5210,7 @@ dependencies = [ \"swc_core\", \"test-generator\", \"tokio\", + \"turbo-malloc\", \"turbo-tasks\", \"turbo-tasks-build\", \"turbo-tasks-env\", diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; diff --git a/crates/next-dev/Cargo.toml b/crates/next-dev/Cargo.toml index db27ee4d..a6d1a75d 100644 --- a/crates/next-dev/Cargo.toml +++ b/crates/next-dev/Cargo.toml @@ -37,7 +37,6 @@ portpicker = \"0.1.1\" serde = \"1.0.136\" serde_json = \"1.0.85\" tokio = { version = \"1.11.0\", features = [\"full\"] } -turbo-malloc = { path = \"../turbo-malloc\" } turbo-tasks = { path = \"../turbo-tasks\" } turbo-tasks-fs = { path = \"../turbo-tasks-fs\" } turbo-tasks-memory = { path = \"../turbo-tasks-memory\" } diff --git a/crates/next-dev/src/main.rs b/crates/next-dev/src/main.rs index 64c21bca..1b15cc85 100644 --- a/crates/next-dev/src/main.rs +++ b/crates/next-dev/src/main.rs @@ -18,9 +18,6 @@ use turbo_tasks_memory::MemoryBackend; use turbopack_cli_utils::issue::IssueSeverityCliOption; use turbopack_core::issue::IssueSeverity; -#[global_allocator] -static ALLOC: turbo_malloc::TurboMalloc = turbo_malloc::TurboMalloc; - #[derive(Parser, Debug)] #[clap(author, version, about, long_about = None)] struct Cli { diff --git a/crates/turbo-malloc/Cargo.toml b/crates/turbo-malloc/Cargo.toml index 9bd2a89b..f47d2743 100644 --- a/crates/turbo-malloc/Cargo.toml +++ b/crates/turbo-malloc/Cargo.toml @@ -9,5 +9,8 @@ autobenches = false [lib] bench = false -[dependencies] -mimalloc = { version = \"0.1.30\" } +[target.'cfg(not(target_os = \"linux\"))'.dependencies] +mimalloc-rust = { version = \"0.2\" } + +[target.'cfg(all(target_os = \"linux\", not(target_arch = \"aarch64\")))'.dependencies] +mimalloc-rust = { version = \"0.2\", features = [\"local-dynamic-tls\"] } diff --git a/crates/turbo-malloc/src/lib.rs b/crates/turbo-malloc/src/lib.rs index a4202130..f795c6fc 100644 --- a/crates/turbo-malloc/src/lib.rs +++ b/crates/turbo-malloc/src/lib.rs @@ -1,21 +1,3 @@ -use std::alloc::{GlobalAlloc, Layout}; - -pub struct TurboMalloc; - -unsafe impl GlobalAlloc for TurboMalloc { - unsafe fn alloc(&self, layout: Layout) -> *mut u8 { - mimalloc::MiMalloc.alloc(layout) - } - - unsafe fn dealloc(&self, ptr: *mut u8, layout: Layout) { - mimalloc::MiMalloc.dealloc(ptr, layout) - } - - unsafe fn alloc_zeroed(&self, layout: Layout) -> *mut u8 { - mimalloc::MiMalloc.alloc_zeroed(layout) - } - - unsafe fn realloc(&self, ptr: *mut u8, layout: Layout, new_size: usize) -> *mut u8 { - mimalloc::MiMalloc.realloc(ptr, layout, new_size) - } -} +#[cfg(not(all(target_os = \"linux\", target_arch = \"aarch64\")))] +#[global_allocator] +static ALLOC: mimalloc_rust::GlobalMiMalloc = mimalloc_rust::GlobalMiMalloc; diff --git a/crates/turbo-tasks-memory/Cargo.toml b/crates/turbo-tasks-memory/Cargo.toml index b4d81a04..3fe687de 100644 --- a/crates/turbo-tasks-memory/Cargo.toml +++ b/crates/turbo-tasks-memory/Cargo.toml @@ -12,14 +12,12 @@ bench = false [dependencies] anyhow = \"1.0.47\" concurrent-queue = \"1.2.2\" -dashmap = \"5.4.0\" event-listener = \"2.5.2\" flurry = \"0.4.0\" lazy_static = \"1.4.0\" nohash-hasher = \"0.2.0\" num_cpus = \"1.13.1\" parking_lot = \"0.12.1\" -rustc-hash = \"1.1.0\" tokio = \"1.11.0\" turbo-tasks = { path = \"../turbo-tasks\" } turbo-tasks-hash = { path = \"../turbo-tasks-hash\" } diff --git a/crates/turbo-tasks-memory/src/memory_backend.rs b/crates/turbo-tasks-memory/src/memory_backend.rs index 472f447d..8d1d280b 100644 --- a/crates/turbo-tasks-memory/src/memory_backend.rs +++ b/crates/turbo-tasks-memory/src/memory_backend.rs @@ -3,16 +3,14 @@ use std::{ cell::RefCell, collections::HashSet, future::Future, - hash::BuildHasherDefault, pin::Pin, sync::atomic::{AtomicUsize, Ordering}, time::Duration, }; use anyhow::{bail, Result}; -use dashmap::{mapref::entry::Entry, DashMap}; use event_listener::EventListener; -use rustc_hash::FxHasher; +use flurry::HashMap as FHashMap; use tokio::task::futures::TaskLocalFuture; use turbo_tasks::{ backend::{ @@ -39,7 +37,7 @@ pub struct MemoryBackend { pub(crate) initial_scope: TaskScopeId, backend_jobs: NoMoveVec<Job>, backend_job_id_factory: IdFactory<BackendJobId>, - task_cache: DashMap<PersistentTaskType, TaskId, BuildHasherDefault<FxHasher>>, + task_cache: FHashMap<PersistentTaskType, TaskId>, scope_generation: AtomicUsize, } @@ -64,7 +62,7 @@ impl MemoryBackend { initial_scope, backend_jobs: NoMoveVec::new(), backend_job_id_factory: IdFactory::new(), - task_cache: DashMap::default(), + task_cache: FHashMap::new(), scope_generation: AtomicUsize::new(0), } } @@ -102,7 +100,7 @@ impl MemoryBackend { } pub fn with_all_cached_tasks(&self, mut func: impl FnMut(TaskId)) { - for id in self.task_cache.clone().into_read_only().values() { + for id in self.task_cache.pin().values() { func(*id); } } @@ -443,13 +441,14 @@ impl Backend for MemoryBackend { parent_task: TaskId, turbo_tasks: &dyn TurboTasksBackendApi, ) -> TaskId { - let result = if let Some(task) = self.task_cache.get(&task_type) { + let map = self.task_cache.pin(); + let result = if let Some(task) = map.get(&task_type).copied() { // fast pass without creating a new task - self.connect_task_child(parent_task, *task, turbo_tasks); + self.connect_task_child(parent_task, task, turbo_tasks); // TODO maybe force (background) scheduling to avoid inactive tasks hanging in // \"in progress\" until they become active - xtask + task } else { // slow pass with key lock let id = turbo_tasks.get_fresh_task_id(); @@ -466,28 +465,30 @@ impl Backend for MemoryBackend { Task::new_resolve_trait(id, *trait_type, trait_fn_name.clone(), inputs.clone()) } }; - // Safety: We have a fresh task id that nobody knows about yet + // SAFETY: We have a fresh task id where nobody knows about yet unsafe { self.memory_tasks.insert(*id, task); } - let result_task = match self.task_cache.entry(task_type) { - Entry::Vacant(entry) => { + let result_task = match map.try_insert(task_type, id) { + Ok(_) => { // This is the most likely case - entry.insert(id); id } - Entry::Occupied(entry) => { - // Safety: We have a fresh task id that nobody knows about yet + Err(r) => { + // SAFETY: We have a fresh task id where nobody knows about yet unsafe { self.memory_tasks.remove(*id); turbo_tasks.reuse_task_id(id); } - *entry.get() + *r.current } }; self.connect_task_child(parent_task, result_task, turbo_tasks); result_task }; + // keep the guard alive over the whole function + // to avoid load on GC + drop(map); result } diff --git a/crates/turbopack/Cargo.toml b/crates/turbopack/Cargo.toml index 49ab7642..9e8da7e9 100644 --- a/crates/turbopack/Cargo.toml +++ b/crates/turbopack/Cargo.toml @@ -54,6 +54,7 @@ rstest = \"0.12.0\" rstest_reuse = \"0.3.0\" test-generator = \"0.3.0\" tokio = \"1.11.0\" +turbo-malloc = { path = \"../turbo-malloc\" } turbo-tasks-memory = { path = \"../turbo-tasks-memory\" } ", "completion": "Use FxHasher with Dashmap "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/Cargo.lock b/Cargo.lock index 20b6dc04..d66d4575 100644 --- a/Cargo.lock +++ b/Cargo.lock @@ -887,6 +887,12 @@ dependencies = [ \"syn 1.0.99\", ] +[[package]] +name = \"cty\" +version = \"0.2.2\" +source = \"registry+https://github.com/rust-lang/crates.io-index\" +checksum = \"b365fabc795046672053e29c954733ec3b05e4be654ab130fe8f1f94d7051f35\" + [[package]] name = \"darling\" version = \"0.13.4\" @@ -924,14 +930,13 @@ dependencies = [ [[package]] name = \"dashmap\" -version = \"5.4.0\" +version = \"5.3.4\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"907076dfda823b0b36d2a1bb5f90c96660a5bbcd7729e10727f07858f22c4edc\" +checksum = \"3495912c9c1ccf2e18976439f4443f3fee0fd61f424ff99fde6a66b15ecb448f\" dependencies = [ \"cfg-if 1.0.0\", \"hashbrown 0.12.3\", \"lock_api\", - \"once_cell\", \"parking_lot_core 0.9.3\", ] @@ -2003,20 +2008,11 @@ dependencies = [ \"winapi 0.3.9\", ] -[[package]] -name = \"libmimalloc-sys\" -version = \"0.1.26\" -source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"8fc093ab289b0bfda3aa1bdfab9c9542be29c7ef385cfcbe77f8c9813588eb48\" -dependencies = [ - \"cc\", -] - [[package]] name = \"lock_api\" -version = \"0.4.9\" +version = \"0.4.7\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"435011366fe56583b16cf956f9df0095b405b82d76425bc8981c0e22e60ec4df\" +checksum = \"327fa5b6a6940e4699ec49a9beae1ea4845c6bab9314e4f84ac68742139d8c53\" dependencies = [ \"autocfg\", \"scopeguard\", @@ -2117,12 +2113,23 @@ dependencies = [ ] [[package]] -name = \"mimalloc\" -version = \"0.1.30\" +name = \"mimalloc-rust\" +version = \"0.2.0\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"76ce6a4b40d3bff9eb3ce9881ca0737a85072f9f975886082640cd46a75cdb35\" +checksum = \"6973866e0bc6504c03a16b6817b7e70839cc8a1dbd5d6dab00c65d8034868d8b\" dependencies = [ - \"libmimalloc-sys\", + \"cty\", + \"mimalloc-rust-sys\", +] + +[[package]] +name = \"mimalloc-rust-sys\" +version = \"1.7.6-source\" +source = \"registry+https://github.com/rust-lang/crates.io-index\" +checksum = \"7a50daf45336b979a202a19f53b4b382f2c4bd50f392a8dbdb4c6c56ba5dfa64\" +dependencies = [ + \"cc\", + \"cty\", ] [[package]] @@ -2371,7 +2378,6 @@ dependencies = [ \"test-generator\", \"tokio\", \"tungstenite\", - \"turbo-malloc\", \"turbo-tasks\", \"turbo-tasks-build\", \"turbo-tasks-fs\", @@ -2575,9 +2581,9 @@ dependencies = [ [[package]] name = \"once_cell\" -version = \"1.15.0\" +version = \"1.13.0\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"e82dad04139b71a90c080c8463fe0dc7902db5192d939bd0950f074d014339e1\" +checksum = \"18a6dbe30758c9f83eb00cbea4ac95966305f5a7772f3f42ebfc7fc7eddbd8e1\" [[package]] name = \"oorandom\" @@ -5033,7 +5039,7 @@ dependencies = [ name = \"turbo-malloc\" version = \"0.1.0\" dependencies = [ - \"mimalloc\", + \"mimalloc-rust\", ] [[package]] @@ -5159,7 +5165,6 @@ dependencies = [ \"anyhow\", \"concurrent-queue\", \"criterion\", - \"dashmap\", \"event-listener\", \"flurry\", \"lazy_static\", @@ -5205,6 +5210,7 @@ dependencies = [ \"swc_core\", \"test-generator\", \"tokio\", + \"turbo-malloc\", \"turbo-tasks\", \"turbo-tasks-build\", \"turbo-tasks-env\", diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; diff --git a/crates/next-dev/Cargo.toml b/crates/next-dev/Cargo.toml index db27ee4d..a6d1a75d 100644 --- a/crates/next-dev/Cargo.toml +++ b/crates/next-dev/Cargo.toml @@ -37,7 +37,6 @@ portpicker = \"0.1.1\" serde = \"1.0.136\" serde_json = \"1.0.85\" tokio = { version = \"1.11.0\", features = [\"full\"] } -turbo-malloc = { path = \"../turbo-malloc\" } turbo-tasks = { path = \"../turbo-tasks\" } turbo-tasks-fs = { path = \"../turbo-tasks-fs\" } turbo-tasks-memory = { path = \"../turbo-tasks-memory\" } diff --git a/crates/next-dev/src/main.rs b/crates/next-dev/src/main.rs index 64c21bca..1b15cc85 100644 --- a/crates/next-dev/src/main.rs +++ b/crates/next-dev/src/main.rs @@ -18,9 +18,6 @@ use turbo_tasks_memory::MemoryBackend; use turbopack_cli_utils::issue::IssueSeverityCliOption; use turbopack_core::issue::IssueSeverity; -#[global_allocator] -static ALLOC: turbo_malloc::TurboMalloc = turbo_malloc::TurboMalloc; - #[derive(Parser, Debug)] #[clap(author, version, about, long_about = None)] struct Cli { diff --git a/crates/turbo-malloc/Cargo.toml b/crates/turbo-malloc/Cargo.toml index 9bd2a89b..f47d2743 100644 --- a/crates/turbo-malloc/Cargo.toml +++ b/crates/turbo-malloc/Cargo.toml @@ -9,5 +9,8 @@ autobenches = false [lib] bench = false -[dependencies] -mimalloc = { version = \"0.1.30\" } +[target.'cfg(not(target_os = \"linux\"))'.dependencies] +mimalloc-rust = { version = \"0.2\" } + +[target.'cfg(all(target_os = \"linux\", not(target_arch = \"aarch64\")))'.dependencies] +mimalloc-rust = { version = \"0.2\", features = [\"local-dynamic-tls\"] } diff --git a/crates/turbo-malloc/src/lib.rs b/crates/turbo-malloc/src/lib.rs index a4202130..f795c6fc 100644 --- a/crates/turbo-malloc/src/lib.rs +++ b/crates/turbo-malloc/src/lib.rs @@ -1,21 +1,3 @@ -use std::alloc::{GlobalAlloc, Layout}; - -pub struct TurboMalloc; - -unsafe impl GlobalAlloc for TurboMalloc { - unsafe fn alloc(&self, layout: Layout) -> *mut u8 { - mimalloc::MiMalloc.alloc(layout) - } - - unsafe fn dealloc(&self, ptr: *mut u8, layout: Layout) { - mimalloc::MiMalloc.dealloc(ptr, layout) - } - - unsafe fn alloc_zeroed(&self, layout: Layout) -> *mut u8 { - mimalloc::MiMalloc.alloc_zeroed(layout) - } - - unsafe fn realloc(&self, ptr: *mut u8, layout: Layout, new_size: usize) -> *mut u8 { - mimalloc::MiMalloc.realloc(ptr, layout, new_size) - } -} +#[cfg(not(all(target_os = \"linux\", target_arch = \"aarch64\")))] +#[global_allocator] +static ALLOC: mimalloc_rust::GlobalMiMalloc = mimalloc_rust::GlobalMiMalloc; diff --git a/crates/turbo-tasks-memory/Cargo.toml b/crates/turbo-tasks-memory/Cargo.toml index fc940779..3fe687de 100644 --- a/crates/turbo-tasks-memory/Cargo.toml +++ b/crates/turbo-tasks-memory/Cargo.toml @@ -12,7 +12,6 @@ bench = false [dependencies] anyhow = \"1.0.47\" concurrent-queue = \"1.2.2\" -dashmap = \"5.4.0\" event-listener = \"2.5.2\" flurry = \"0.4.0\" lazy_static = \"1.4.0\" diff --git a/crates/turbo-tasks-memory/src/memory_backend.rs b/crates/turbo-tasks-memory/src/memory_backend.rs index feb4e51d..8d1d280b 100644 --- a/crates/turbo-tasks-memory/src/memory_backend.rs +++ b/crates/turbo-tasks-memory/src/memory_backend.rs @@ -9,8 +9,8 @@ use std::{ }; use anyhow::{bail, Result}; -use dashmap::{mapref::entry::Entry, DashMap}; use event_listener::EventListener; +use flurry::HashMap as FHashMap; use tokio::task::futures::TaskLocalFuture; use turbo_tasks::{ backend::{ @@ -37,7 +37,7 @@ pub struct MemoryBackend { pub(crate) initial_scope: TaskScopeId, backend_jobs: NoMoveVec<Job>, backend_job_id_factory: IdFactory<BackendJobId>, - task_cache: DashMap<PersistentTaskType, TaskId>, + task_cache: FHashMap<PersistentTaskType, TaskId>, scope_generation: AtomicUsize, } @@ -62,7 +62,7 @@ impl MemoryBackend { initial_scope, backend_jobs: NoMoveVec::new(), backend_job_id_factory: IdFactory::new(), - task_cache: DashMap::default(), + task_cache: FHashMap::new(), scope_generation: AtomicUsize::new(0), } } @@ -100,7 +100,7 @@ impl MemoryBackend { } pub fn with_all_cached_tasks(&self, mut func: impl FnMut(TaskId)) { - for id in self.task_cache.clone().into_read_only().values() { + for id in self.task_cache.pin().values() { func(*id); } } @@ -441,13 +441,14 @@ impl Backend for MemoryBackend { parent_task: TaskId, turbo_tasks: &dyn TurboTasksBackendApi, ) -> TaskId { - let result = if let Some(task) = self.task_cache.get(&task_type) { + let map = self.task_cache.pin(); + let result = if let Some(task) = map.get(&task_type).copied() { // fast pass without creating a new task - self.connect_task_child(parent_task, *task, turbo_tasks); + self.connect_task_child(parent_task, task, turbo_tasks); // TODO maybe force (background) scheduling to avoid inactive tasks hanging in // \"in progress\" until they become active - xtask + task } else { // slow pass with key lock let id = turbo_tasks.get_fresh_task_id(); @@ -464,28 +465,30 @@ impl Backend for MemoryBackend { Task::new_resolve_trait(id, *trait_type, trait_fn_name.clone(), inputs.clone()) } }; - // Safety: We have a fresh task id that nobody knows about yet + // SAFETY: We have a fresh task id where nobody knows about yet unsafe { self.memory_tasks.insert(*id, task); } - let result_task = match self.task_cache.entry(task_type) { - Entry::Vacant(entry) => { + let result_task = match map.try_insert(task_type, id) { + Ok(_) => { // This is the most likely case - entry.insert(id); id } - Entry::Occupied(entry) => { - // Safety: We have a fresh task id that nobody knows about yet + Err(r) => { + // SAFETY: We have a fresh task id where nobody knows about yet unsafe { self.memory_tasks.remove(*id); turbo_tasks.reuse_task_id(id); } - *entry.get() + *r.current } }; self.connect_task_child(parent_task, result_task, turbo_tasks); result_task }; + // keep the guard alive over the whole function + // to avoid load on GC + drop(map); result } diff --git a/crates/turbopack/Cargo.toml b/crates/turbopack/Cargo.toml index 49ab7642..9e8da7e9 100644 --- a/crates/turbopack/Cargo.toml +++ b/crates/turbopack/Cargo.toml @@ -54,6 +54,7 @@ rstest = \"0.12.0\" rstest_reuse = \"0.3.0\" test-generator = \"0.3.0\" tokio = \"1.11.0\" +turbo-malloc = { path = \"../turbo-malloc\" } turbo-tasks-memory = { path = \"../turbo-tasks-memory\" } ", "completion": "Use mimalloc "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/Cargo.lock b/Cargo.lock index 05bdf9cd..d66d4575 100644 --- a/Cargo.lock +++ b/Cargo.lock @@ -930,14 +930,13 @@ dependencies = [ [[package]] name = \"dashmap\" -version = \"5.4.0\" +version = \"5.3.4\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"907076dfda823b0b36d2a1bb5f90c96660a5bbcd7729e10727f07858f22c4edc\" +checksum = \"3495912c9c1ccf2e18976439f4443f3fee0fd61f424ff99fde6a66b15ecb448f\" dependencies = [ \"cfg-if 1.0.0\", \"hashbrown 0.12.3\", \"lock_api\", - \"once_cell\", \"parking_lot_core 0.9.3\", ] @@ -2011,9 +2010,9 @@ dependencies = [ [[package]] name = \"lock_api\" -version = \"0.4.9\" +version = \"0.4.7\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"435011366fe56583b16cf956f9df0095b405b82d76425bc8981c0e22e60ec4df\" +checksum = \"327fa5b6a6940e4699ec49a9beae1ea4845c6bab9314e4f84ac68742139d8c53\" dependencies = [ \"autocfg\", \"scopeguard\", @@ -2582,9 +2581,9 @@ dependencies = [ [[package]] name = \"once_cell\" -version = \"1.15.0\" +version = \"1.13.0\" source = \"registry+https://github.com/rust-lang/crates.io-index\" -checksum = \"e82dad04139b71a90c080c8463fe0dc7902db5192d939bd0950f074d014339e1\" +checksum = \"18a6dbe30758c9f83eb00cbea4ac95966305f5a7772f3f42ebfc7fc7eddbd8e1\" [[package]] name = \"oorandom\" @@ -5166,7 +5165,6 @@ dependencies = [ \"anyhow\", \"concurrent-queue\", \"criterion\", - \"dashmap\", \"event-listener\", \"flurry\", \"lazy_static\", diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; diff --git a/crates/turbo-tasks-memory/Cargo.toml b/crates/turbo-tasks-memory/Cargo.toml index fc940779..3fe687de 100644 --- a/crates/turbo-tasks-memory/Cargo.toml +++ b/crates/turbo-tasks-memory/Cargo.toml @@ -12,7 +12,6 @@ bench = false [dependencies] anyhow = \"1.0.47\" concurrent-queue = \"1.2.2\" -dashmap = \"5.4.0\" event-listener = \"2.5.2\" flurry = \"0.4.0\" lazy_static = \"1.4.0\" diff --git a/crates/turbo-tasks-memory/src/memory_backend.rs b/crates/turbo-tasks-memory/src/memory_backend.rs index feb4e51d..8d1d280b 100644 --- a/crates/turbo-tasks-memory/src/memory_backend.rs +++ b/crates/turbo-tasks-memory/src/memory_backend.rs @@ -9,8 +9,8 @@ use std::{ }; use anyhow::{bail, Result}; -use dashmap::{mapref::entry::Entry, DashMap}; use event_listener::EventListener; +use flurry::HashMap as FHashMap; use tokio::task::futures::TaskLocalFuture; use turbo_tasks::{ backend::{ @@ -37,7 +37,7 @@ pub struct MemoryBackend { pub(crate) initial_scope: TaskScopeId, backend_jobs: NoMoveVec<Job>, backend_job_id_factory: IdFactory<BackendJobId>, - task_cache: DashMap<PersistentTaskType, TaskId>, + task_cache: FHashMap<PersistentTaskType, TaskId>, scope_generation: AtomicUsize, } @@ -62,7 +62,7 @@ impl MemoryBackend { initial_scope, backend_jobs: NoMoveVec::new(), backend_job_id_factory: IdFactory::new(), - task_cache: DashMap::default(), + task_cache: FHashMap::new(), scope_generation: AtomicUsize::new(0), } } @@ -100,7 +100,7 @@ impl MemoryBackend { } pub fn with_all_cached_tasks(&self, mut func: impl FnMut(TaskId)) { - for id in self.task_cache.clone().into_read_only().values() { + for id in self.task_cache.pin().values() { func(*id); } } @@ -441,13 +441,14 @@ impl Backend for MemoryBackend { parent_task: TaskId, turbo_tasks: &dyn TurboTasksBackendApi, ) -> TaskId { - let result = if let Some(task) = self.task_cache.get(&task_type) { + let map = self.task_cache.pin(); + let result = if let Some(task) = map.get(&task_type).copied() { // fast pass without creating a new task - self.connect_task_child(parent_task, *task, turbo_tasks); + self.connect_task_child(parent_task, task, turbo_tasks); // TODO maybe force (background) scheduling to avoid inactive tasks hanging in // \"in progress\" until they become active - xtask + task } else { // slow pass with key lock let id = turbo_tasks.get_fresh_task_id(); @@ -464,28 +465,30 @@ impl Backend for MemoryBackend { Task::new_resolve_trait(id, *trait_type, trait_fn_name.clone(), inputs.clone()) } }; - // Safety: We have a fresh task id that nobody knows about yet + // SAFETY: We have a fresh task id where nobody knows about yet unsafe { self.memory_tasks.insert(*id, task); } - let result_task = match self.task_cache.entry(task_type) { - Entry::Vacant(entry) => { + let result_task = match map.try_insert(task_type, id) { + Ok(_) => { // This is the most likely case - entry.insert(id); id } - Entry::Occupied(entry) => { - // Safety: We have a fresh task id that nobody knows about yet + Err(r) => { + // SAFETY: We have a fresh task id where nobody knows about yet unsafe { self.memory_tasks.remove(*id); turbo_tasks.reuse_task_id(id); } - *entry.get() + *r.current } }; self.connect_task_child(parent_task, result_task, turbo_tasks); result_task }; + // keep the guard alive over the whole function + // to avoid load on GC + drop(map); result } ", "completion": "Use dashmap instead of flurry "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/.github/workflows/bench-turborepo.yml b/.github/workflows/bench-turborepo.yml index 500b4dfc..a61f4617 100644 --- a/.github/workflows/bench-turborepo.yml +++ b/.github/workflows/bench-turborepo.yml @@ -56,7 +56,7 @@ jobs: - name: Deploy if: github.ref == 'refs/heads/main' - uses: JamesIves/github-pages-deploy-action@v4.4.1 + uses: JamesIves/github-pages-deploy-action@v4.4.0 with: token: ${{ secrets.GITHUB_TOKEN }} branch: gh-pages diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; ", "completion": "chore(deps): update jamesives/github-pages-deploy-action action to v4.4.1 "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; diff --git a/crates/turbo-tasks-rocksdb/Cargo.toml b/crates/turbo-tasks-rocksdb/Cargo.toml index 793061d9..708225a6 100644 --- a/crates/turbo-tasks-rocksdb/Cargo.toml +++ b/crates/turbo-tasks-rocksdb/Cargo.toml @@ -25,7 +25,7 @@ concurrent-queue = \"1.2.2\" flurry = \"0.4.0\" num_cpus = \"1.13.1\" owning_ref = \"0.4.1\" -rocksdb = { version = \"0.19.0\", default-features = false, features = [ +rocksdb = { version = \"0.18.0\", default-features = false, features = [ \"snappy\", \"lz4\", \"zstd\", ", "completion": "fix(deps): update rust crate rocksdb to 0.19.0 [security] "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; ", "completion": "Revert \"Revert \"Support comments in tsconfig.json\"\" (#2433) "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/Cargo.lock b/Cargo.lock index 617774c7..d66d4575 100644 --- a/Cargo.lock +++ b/Cargo.lock @@ -1888,6 +1888,15 @@ version = \"0.2.1\" source = \"registry+https://github.com/rust-lang/crates.io-index\" checksum = \"41ee439ee368ba4a77ac70d04f14015415af8600d6c894dc1f11bd79758c57d5\" +[[package]] +name = \"jsonc-parser\" +version = \"0.21.0\" +source = \"registry+https://github.com/rust-lang/crates.io-index\" +checksum = \"3a1853e40333206f9a685358046d13ab200169e3ee573019bddf0ede0dc29307\" +dependencies = [ + \"serde_json\", +] + [[package]] name = \"kernel32-sys\" version = \"0.2.2\" @@ -5100,6 +5109,7 @@ dependencies = [ \"futures\", \"futures-retry\", \"include_dir\", + \"jsonc-parser\", \"lazy_static\", \"mime\", \"notify\", diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; diff --git a/crates/turbo-tasks-fs/Cargo.toml b/crates/turbo-tasks-fs/Cargo.toml index 6003eb07..0356e596 100644 --- a/crates/turbo-tasks-fs/Cargo.toml +++ b/crates/turbo-tasks-fs/Cargo.toml @@ -15,6 +15,7 @@ concurrent-queue = \"1.2.2\" futures = \"0.3.24\" futures-retry = \"0.6.0\" include_dir = { version = \"0.7.2\", features = [\"nightly\"] } +jsonc-parser = { version = \"0.21.0\", features = [\"serde\"] } lazy_static = \"1.4.0\" mime = \"0.3.16\" notify = \"4.0.17\" diff --git a/crates/turbo-tasks-fs/src/lib.rs b/crates/turbo-tasks-fs/src/lib.rs index b27e4a06..9c3cd6bd 100644 --- a/crates/turbo-tasks-fs/src/lib.rs +++ b/crates/turbo-tasks-fs/src/lib.rs @@ -31,6 +31,7 @@ use anyhow::{anyhow, bail, Context, Result}; use bitflags::bitflags; use glob::GlobVc; use invalidator_map::InvalidatorMap; +use jsonc_parser::{parse_to_serde_value, ParseOptions}; use mime::Mime; use notify::{watcher, DebouncedEvent, RecommendedWatcher, RecursiveMode, Watcher}; use read_glob::read_glob; @@ -1358,8 +1359,18 @@ impl FileContent { pub fn parse_json_with_comments(&self) -> FileJsonContent { match self { FileContent::Content(file) => match std::str::from_utf8(&file.content) { - Ok(string) => match serde_json::from_str(&skip_json_comments(string)) { - Ok(data) => FileJsonContent::Content(data), + Ok(string) => match parse_to_serde_value( + string, + &ParseOptions { + allow_comments: true, + allow_trailing_commas: true, + allow_loose_object_property_names: false, + }, + ) { + Ok(data) => match data { + Some(value) => FileJsonContent::Content(value), + None => FileJsonContent::Unparseable, + }, Err(_) => FileJsonContent::Unparseable, }, Err(_) => FileJsonContent::Unparseable, @@ -1394,91 +1405,6 @@ impl FileContent { } } -fn skip_json_comments(input: &str) -> String { - enum Mode { - Normal, - NormalSlash, - String, - StringEscaped, - SingleLineComment, - MultiLineComment, - MultiLineCommentStar, - } - let mut o = String::with_capacity(input.len()); - let mut mode = Mode::Normal; - for c in input.chars() { - match mode { - Mode::Normal => match c { - '/' => { - mode = Mode::NormalSlash; - } - '\"' => { - mode = Mode::String; - } - _ => {} - }, - Mode::NormalSlash => match c { - '/' => { - mode = Mode::SingleLineComment; - o.pop(); - continue; - } - '*' => { - mode = Mode::MultiLineComment; - o.pop(); - continue; - } - '\"' => { - mode = Mode::String; - } - _ => {} - }, - Mode::String => match c { - '' => { - mode = Mode::StringEscaped; - } - '\"' => { - mode = Mode::Normal; - } - _ => {} - }, - Mode::StringEscaped => { - mode = Mode::String; - } - Mode::SingleLineComment => match c { - 'n' => { - mode = Mode::Normal; - continue; - } - _ => continue, - }, - Mode::MultiLineComment => match c { - '*' => { - mode = Mode::MultiLineCommentStar; - continue; - } - _ => continue, - }, - Mode::MultiLineCommentStar => match c { - '*' => { - mode = Mode::MultiLineCommentStar; - continue; - } - '/' => { - mode = Mode::Normal; - continue; - } - _ => { - mode = Mode::MultiLineComment; - continue; - } - }, - } - o.push(c); - } - o -} - #[turbo_tasks::value_impl] impl FileContentVc { #[turbo_tasks::function] diff --git a/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json b/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json index 05270745..04e82465 100644 --- a/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json +++ b/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json @@ -15,5 +15,5 @@ benchmark/ buildcontainer/ cli/ crates/ docs/ examples/ packages/ scripts/ shim/ xtask/ \"ts-node\": { \"require\": [\"tsconfig-paths/register\"] - } + }, // trailing comma } ", "completion": "Revert \"Support comments in tsconfig.json\" (#2432) "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; ", "completion": "Support comments in tsconfig.json (#2429) "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/Cargo.lock b/Cargo.lock index 617774c7..d66d4575 100644 --- a/Cargo.lock +++ b/Cargo.lock @@ -1888,6 +1888,15 @@ version = \"0.2.1\" source = \"registry+https://github.com/rust-lang/crates.io-index\" checksum = \"41ee439ee368ba4a77ac70d04f14015415af8600d6c894dc1f11bd79758c57d5\" +[[package]] +name = \"jsonc-parser\" +version = \"0.21.0\" +source = \"registry+https://github.com/rust-lang/crates.io-index\" +checksum = \"3a1853e40333206f9a685358046d13ab200169e3ee573019bddf0ede0dc29307\" +dependencies = [ + \"serde_json\", +] + [[package]] name = \"kernel32-sys\" version = \"0.2.2\" @@ -5100,6 +5109,7 @@ dependencies = [ \"futures\", \"futures-retry\", \"include_dir\", + \"jsonc-parser\", \"lazy_static\", \"mime\", \"notify\", diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; diff --git a/crates/turbo-tasks-fs/Cargo.toml b/crates/turbo-tasks-fs/Cargo.toml index 6003eb07..0356e596 100644 --- a/crates/turbo-tasks-fs/Cargo.toml +++ b/crates/turbo-tasks-fs/Cargo.toml @@ -15,6 +15,7 @@ concurrent-queue = \"1.2.2\" futures = \"0.3.24\" futures-retry = \"0.6.0\" include_dir = { version = \"0.7.2\", features = [\"nightly\"] } +jsonc-parser = { version = \"0.21.0\", features = [\"serde\"] } lazy_static = \"1.4.0\" mime = \"0.3.16\" notify = \"4.0.17\" diff --git a/crates/turbo-tasks-fs/src/lib.rs b/crates/turbo-tasks-fs/src/lib.rs index b27e4a06..9c3cd6bd 100644 --- a/crates/turbo-tasks-fs/src/lib.rs +++ b/crates/turbo-tasks-fs/src/lib.rs @@ -31,6 +31,7 @@ use anyhow::{anyhow, bail, Context, Result}; use bitflags::bitflags; use glob::GlobVc; use invalidator_map::InvalidatorMap; +use jsonc_parser::{parse_to_serde_value, ParseOptions}; use mime::Mime; use notify::{watcher, DebouncedEvent, RecommendedWatcher, RecursiveMode, Watcher}; use read_glob::read_glob; @@ -1358,8 +1359,18 @@ impl FileContent { pub fn parse_json_with_comments(&self) -> FileJsonContent { match self { FileContent::Content(file) => match std::str::from_utf8(&file.content) { - Ok(string) => match serde_json::from_str(&skip_json_comments(string)) { - Ok(data) => FileJsonContent::Content(data), + Ok(string) => match parse_to_serde_value( + string, + &ParseOptions { + allow_comments: true, + allow_trailing_commas: true, + allow_loose_object_property_names: false, + }, + ) { + Ok(data) => match data { + Some(value) => FileJsonContent::Content(value), + None => FileJsonContent::Unparseable, + }, Err(_) => FileJsonContent::Unparseable, }, Err(_) => FileJsonContent::Unparseable, @@ -1394,91 +1405,6 @@ impl FileContent { } } -fn skip_json_comments(input: &str) -> String { - enum Mode { - Normal, - NormalSlash, - String, - StringEscaped, - SingleLineComment, - MultiLineComment, - MultiLineCommentStar, - } - let mut o = String::with_capacity(input.len()); - let mut mode = Mode::Normal; - for c in input.chars() { - match mode { - Mode::Normal => match c { - '/' => { - mode = Mode::NormalSlash; - } - '\"' => { - mode = Mode::String; - } - _ => {} - }, - Mode::NormalSlash => match c { - '/' => { - mode = Mode::SingleLineComment; - o.pop(); - continue; - } - '*' => { - mode = Mode::MultiLineComment; - o.pop(); - continue; - } - '\"' => { - mode = Mode::String; - } - _ => {} - }, - Mode::String => match c { - '' => { - mode = Mode::StringEscaped; - } - '\"' => { - mode = Mode::Normal; - } - _ => {} - }, - Mode::StringEscaped => { - mode = Mode::String; - } - Mode::SingleLineComment => match c { - 'n' => { - mode = Mode::Normal; - continue; - } - _ => continue, - }, - Mode::MultiLineComment => match c { - '*' => { - mode = Mode::MultiLineCommentStar; - continue; - } - _ => continue, - }, - Mode::MultiLineCommentStar => match c { - '*' => { - mode = Mode::MultiLineCommentStar; - continue; - } - '/' => { - mode = Mode::Normal; - continue; - } - _ => { - mode = Mode::MultiLineComment; - continue; - } - }, - } - o.push(c); - } - o -} - #[turbo_tasks::value_impl] impl FileContentVc { #[turbo_tasks::function] diff --git a/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json b/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json index 05270745..04e82465 100644 --- a/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json +++ b/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json @@ -15,5 +15,5 @@ benchmark/ buildcontainer/ cli/ crates/ docs/ examples/ packages/ scripts/ shim/ xtask/ \"ts-node\": { \"require\": [\"tsconfig-paths/register\"] - } + }, // trailing comma } ", "completion": "chore(docs): improve description of `--force` and `--no-cache` (#2425) "}
{"prompt": "diff --git a/.github/CODEOWNERS b/.github/CODEOWNERS index f78e657f..2c442d7b 100644 --- a/.github/CODEOWNERS +++ b/.github/CODEOWNERS @@ -1,9 +1,8 @@ # Learn how to add code owners here: # https://help.github.com/en/articles/about-code-owners +/crates @vercel/web-tooling +/Cargo.lock @vercel/web-tooling +/Cargo.toml @vercel/web-tooling +/rust-toolchain @vercel/web-tooling CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask @vercel/turbo-oss -/crates -/Cargo.lock -/Cargo.toml -/rust-toolchain -/pnpm-lock.yaml diff --git a/Cargo.lock b/Cargo.lock index 617774c7..d66d4575 100644 --- a/Cargo.lock +++ b/Cargo.lock @@ -1888,6 +1888,15 @@ version = \"0.2.1\" source = \"registry+https://github.com/rust-lang/crates.io-index\" checksum = \"41ee439ee368ba4a77ac70d04f14015415af8600d6c894dc1f11bd79758c57d5\" +[[package]] +name = \"jsonc-parser\" +version = \"0.21.0\" +source = \"registry+https://github.com/rust-lang/crates.io-index\" +checksum = \"3a1853e40333206f9a685358046d13ab200169e3ee573019bddf0ede0dc29307\" +dependencies = [ + \"serde_json\", +] + [[package]] name = \"kernel32-sys\" version = \"0.2.2\" @@ -5100,6 +5109,7 @@ dependencies = [ \"futures\", \"futures-retry\", \"include_dir\", + \"jsonc-parser\", \"lazy_static\", \"mime\", \"notify\", diff --git a/crates/next-core/js/src/entry/app-renderer.tsx b/crates/next-core/js/src/entry/app-renderer.tsx index fd99d5e8..bc964bad 100644 --- a/crates/next-core/js/src/entry/app-renderer.tsx +++ b/crates/next-core/js/src/entry/app-renderer.tsx @@ -16,6 +16,7 @@ import type { } from \"next/dist/build/webpack/plugins/flight-manifest-plugin\"; import type { RenderData } from \"types/turbopack\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch\"; import \"next/dist/server/node-polyfill-web-streams\"; import { RenderOpts, renderToHTMLOrFlight } from \"next/dist/server/app-render\"; diff --git a/crates/next-core/js/src/entry/server-api.tsx b/crates/next-core/js/src/entry/server-api.tsx index 0252012d..f9be98fd 100644 --- a/crates/next-core/js/src/entry/server-api.tsx +++ b/crates/next-core/js/src/entry/server-api.tsx @@ -5,6 +5,7 @@ import http, { ServerResponse } from \"node:http\"; import type { AddressInfo, Socket } from \"node:net\"; import { Buffer } from \"node:buffer\"; +import 'next/dist/server/initialize-require-hook' import \"next/dist/server/node-polyfill-fetch.js\"; import CODE_OF_CONDUCT.md CONTRIBUTING.md Cargo.lock Cargo.toml LICENSE NOTICES.md README.md SECURITY.md architecture.md benchmark buildcontainer cli clippy.toml crates deny.toml docs examples package.json packages pnpm-lock.yaml pnpm-workspace.yaml release.md rust-toolchain scripts shim troubleshooting.md tsconfig.json tsconfig.project.json turbo.json turbow.js version.txt xtask as allExports from \".\"; diff --git a/crates/next-core/js/src/entry/server-renderer.tsx b/crates/next-core/js/src/entry/server-renderer.tsx index ac9f559c..393215c9 100644 --- a/crates/next-core/js/src/entry/server-renderer.tsx +++ b/crates/next-core/js/src/entry/server-renderer.tsx @@ -2,6 +2,7 @@ import IPC, { Ipc } from \"@vercel/turbopack-next/internal/ipc\"; import type { IncomingMessage, ServerResponse } from \"node:http\"; +import 'next/dist/server/initialize-require-hook' import \"@vercel/turbopack-next/internal/shims\"; import \"next/dist/server/node-polyfill-fetch.js\"; import { renderToHTML } from \"next/dist/server/render\"; diff --git a/crates/turbo-tasks-fs/Cargo.toml b/crates/turbo-tasks-fs/Cargo.toml index 6003eb07..0356e596 100644 --- a/crates/turbo-tasks-fs/Cargo.toml +++ b/crates/turbo-tasks-fs/Cargo.toml @@ -15,6 +15,7 @@ concurrent-queue = \"1.2.2\" futures = \"0.3.24\" futures-retry = \"0.6.0\" include_dir = { version = \"0.7.2\", features = [\"nightly\"] } +jsonc-parser = { version = \"0.21.0\", features = [\"serde\"] } lazy_static = \"1.4.0\" mime = \"0.3.16\" notify = \"4.0.17\" diff --git a/crates/turbo-tasks-fs/src/lib.rs b/crates/turbo-tasks-fs/src/lib.rs index b27e4a06..9c3cd6bd 100644 --- a/crates/turbo-tasks-fs/src/lib.rs +++ b/crates/turbo-tasks-fs/src/lib.rs @@ -31,6 +31,7 @@ use anyhow::{anyhow, bail, Context, Result}; use bitflags::bitflags; use glob::GlobVc; use invalidator_map::InvalidatorMap; +use jsonc_parser::{parse_to_serde_value, ParseOptions}; use mime::Mime; use notify::{watcher, DebouncedEvent, RecommendedWatcher, RecursiveMode, Watcher}; use read_glob::read_glob; @@ -1358,8 +1359,18 @@ impl FileContent { pub fn parse_json_with_comments(&self) -> FileJsonContent { match self { FileContent::Content(file) => match std::str::from_utf8(&file.content) { - Ok(string) => match serde_json::from_str(&skip_json_comments(string)) { - Ok(data) => FileJsonContent::Content(data), + Ok(string) => match parse_to_serde_value( + string, + &ParseOptions { + allow_comments: true, + allow_trailing_commas: true, + allow_loose_object_property_names: false, + }, + ) { + Ok(data) => match data { + Some(value) => FileJsonContent::Content(value), + None => FileJsonContent::Unparseable, + }, Err(_) => FileJsonContent::Unparseable, }, Err(_) => FileJsonContent::Unparseable, @@ -1394,91 +1405,6 @@ impl FileContent { } } -fn skip_json_comments(input: &str) -> String { - enum Mode { - Normal, - NormalSlash, - String, - StringEscaped, - SingleLineComment, - MultiLineComment, - MultiLineCommentStar, - } - let mut o = String::with_capacity(input.len()); - let mut mode = Mode::Normal; - for c in input.chars() { - match mode { - Mode::Normal => match c { - '/' => { - mode = Mode::NormalSlash; - } - '\"' => { - mode = Mode::String; - } - _ => {} - }, - Mode::NormalSlash => match c { - '/' => { - mode = Mode::SingleLineComment; - o.pop(); - continue; - } - '*' => { - mode = Mode::MultiLineComment; - o.pop(); - continue; - } - '\"' => { - mode = Mode::String; - } - _ => {} - }, - Mode::String => match c { - '' => { - mode = Mode::StringEscaped; - } - '\"' => { - mode = Mode::Normal; - } - _ => {} - }, - Mode::StringEscaped => { - mode = Mode::String; - } - Mode::SingleLineComment => match c { - 'n' => { - mode = Mode::Normal; - continue; - } - _ => continue, - }, - Mode::MultiLineComment => match c { - '*' => { - mode = Mode::MultiLineCommentStar; - continue; - } - _ => continue, - }, - Mode::MultiLineCommentStar => match c { - '*' => { - mode = Mode::MultiLineCommentStar; - continue; - } - '/' => { - mode = Mode::Normal; - continue; - } - _ => { - mode = Mode::MultiLineComment; - continue; - } - }, - } - o.push(c); - } - o -} - #[turbo_tasks::value_impl] impl FileContentVc { #[turbo_tasks::function] diff --git a/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json b/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json index 05270745..04e82465 100644 --- a/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json +++ b/crates/turbopack/tests/node-file-trace/integration/ts-package/tsconfig.json @@ -15,5 +15,5 @@ benchmark/ buildcontainer/ cli/ crates/ docs/ examples/ packages/ scripts/ shim/ xtask/ \"ts-node\": { \"require\": [\"tsconfig-paths/register\"] - } + }, // trailing comma } diff --git a/docs/pages/repo/docs/core-concepts/caching.mdx b/docs/pages/repo/docs/core-concepts/caching.mdx index 51a2d6c6..5f5b24e7 100644 --- a/docs/pages/repo/docs/core-concepts/caching.mdx +++ b/docs/pages/repo/docs/core-concepts/caching.mdx @@ -113,7 +113,7 @@ in the `src/` and `test/` subdirectories has changed since the last execution. ## Turn off caching -Sometimes you really don't need or want this cache behavior (e.g. when you're using [`next dev`](https://nextjs.org/docs/api-reference/cli#development) or `react-scripts start` for live reloading). To entirely disable caching, append `--no-cache` to any command: +Sometimes you really don't want to write the cache output (e.g. when you're using [`next dev`](https://nextjs.org/docs/api-reference/cli#development) or `react-scripts start` for live reloading). To disable cache writes, append `--no-cache` to any command: ```shell # Run `dev` npm script in all workspaces in parallel, @@ -121,6 +121,8 @@ Sometimes you really don't need or want this cache behavior (e.g. when you're us turbo run dev --parallel --no-cache ``` +Note that `--no-cache` disables cache writes but does not disable cache reads. If you want to disable cache reads, use the `--force` flag. + You can also disable caching on specific tasks by setting the [`pipeline.<task>.cache`](../reference/configuration#pipeline-1) configuration to `false`: ```json @@ -370,7 +372,7 @@ Be careful to ensure that all of your environment variables are configured prior ## Force overwrite cache -Conversely, if you want to force `turbo` to re-execute a previously cached task, add the `--force` flag: +Conversely, if you want to disable reading the cache and force `turbo` to re-execute a previously cached task, add the `--force` flag: ```shell # Run `build` npm script in all workspaces, @@ -378,6 +380,8 @@ Conversely, if you want to force `turbo` to re-execute a previously cached task, turbo run build --force ``` +Note that `--force` disables cache reads but does not disable cache writes. If you want to disable cache writes, use the `--no-cache` flag. + ## Logs Not only does `turbo` cache the output of your tasks, it also records the terminal output (i.e. combined `stdout` and `stderr`) to (`<package>/.turbo/run-<command>.log`). When `turbo` encounters a cached task, it will replay the output as if it happened again, but instantly, with the package name slightly dimmed. ", "completion": "tests(turbo): Rust CLI Tests (#2379) "}
{"prompt": "diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable ", "completion": "Merge pull request #5484 from heartcombo/ca-build Fix build "}
{"prompt": "diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable ", "completion": "Use new method to reset CSRF exposed via the request object This simplifies the logic considerably, as we don't need to reach out to what seems more internal-ish implementation of Rails with the interaction between the request and controller objects. https://github.com/rails/rails/commit/b925880914fa3dca8c9cd0f8e88fb18fc8ec180b "}
{"prompt": "diff --git a/lib/devise/hooks/csrf_cleaner.rb b/lib/devise/hooks/csrf_cleaner.rb index 211bcab8..4a647395 100644 --- a/lib/devise/hooks/csrf_cleaner.rb +++ b/lib/devise/hooks/csrf_cleaner.rb @@ -4,12 +4,11 @@ Warden::Manager.after_authentication do |record, warden, options| clean_up_for_winning_strategy = !warden.winning_strategy.respond_to?(:clean_up_csrf?) || warden.winning_strategy.clean_up_csrf? if Devise.clean_up_csrf_token_on_authentication && clean_up_for_winning_strategy - request = warden.request - if request.respond_to?(:controller_instance) && request.controller_instance.respond_to?(:reset_csrf_token) + if warden.request.respond_to?(:reset_csrf_token) # Rails 7.1+ - request.controller_instance.reset_csrf_token(request) + warden.request.reset_csrf_token else - request.session.try(:delete, :_csrf_token) + warden.request.session.try(:delete, :_csrf_token) end end end diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable ", "completion": "Fix csrf cleanup for Rails 7.1 (main) Rails implemented a CSRF token storage strategy to allow storing the CSRF tokens outside of the sessios (for example, in an encrypted cookie), and changed how the value is kept around during the request cycle, by using a request.env value. We still want to ensure the final session value is cleaned correctly in the test, but the implementation needed to change since we can't simply delete from the session anymore, we need to make sure we call the Rails methods for resetting the current storage strategy so it works with all of them. https://github.com/rails/rails/pull/44283 "}
{"prompt": "diff --git a/lib/devise/hooks/csrf_cleaner.rb b/lib/devise/hooks/csrf_cleaner.rb index d725fbc4..4a647395 100644 --- a/lib/devise/hooks/csrf_cleaner.rb +++ b/lib/devise/hooks/csrf_cleaner.rb @@ -4,6 +4,11 @@ Warden::Manager.after_authentication do |record, warden, options| clean_up_for_winning_strategy = !warden.winning_strategy.respond_to?(:clean_up_csrf?) || warden.winning_strategy.clean_up_csrf? if Devise.clean_up_csrf_token_on_authentication && clean_up_for_winning_strategy - warden.request.session.try(:delete, :_csrf_token) + if warden.request.respond_to?(:reset_csrf_token) + # Rails 7.1+ + warden.request.reset_csrf_token + else + warden.request.session.try(:delete, :_csrf_token) + end end end diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable diff --git a/test/integration/authenticatable_test.rb b/test/integration/authenticatable_test.rb index a1bf28da..6c3be3b5 100644 --- a/test/integration/authenticatable_test.rb +++ b/test/integration/authenticatable_test.rb @@ -346,10 +346,18 @@ class AuthenticationSessionTest < Devise::IntegrationTest test 'refreshes _csrf_token' do swap ApplicationController, allow_forgery_protection: true do get new_user_session_path - token = request.session[:_csrf_token] + token_from_session = request.session[:_csrf_token] + + if Devise::Test.rails71_and_up? + token_from_env = request.env[\"action_controller.csrf_token\"] + end sign_in_as_user - assert_not_equal request.session[:_csrf_token], token + assert_not_equal request.session[:_csrf_token], token_from_session + + if Devise::Test.rails71_and_up? + assert_not_equal request.env[\"action_controller.csrf_token\"], token_from_env + end end end ", "completion": "Check for empty response body on redirect with Rails main (future 7.1) Rails is no longer returning a message with the response body on redirects, just an empty body. https://github.com/rails/rails/pull/44554 "}
{"prompt": "diff --git a/lib/devise/hooks/csrf_cleaner.rb b/lib/devise/hooks/csrf_cleaner.rb index d725fbc4..4a647395 100644 --- a/lib/devise/hooks/csrf_cleaner.rb +++ b/lib/devise/hooks/csrf_cleaner.rb @@ -4,6 +4,11 @@ Warden::Manager.after_authentication do |record, warden, options| clean_up_for_winning_strategy = !warden.winning_strategy.respond_to?(:clean_up_csrf?) || warden.winning_strategy.clean_up_csrf? if Devise.clean_up_csrf_token_on_authentication && clean_up_for_winning_strategy - warden.request.session.try(:delete, :_csrf_token) + if warden.request.respond_to?(:reset_csrf_token) + # Rails 7.1+ + warden.request.reset_csrf_token + else + warden.request.session.try(:delete, :_csrf_token) + end end end diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable diff --git a/test/failure_app_test.rb b/test/failure_app_test.rb index df4107c0..883cf8b9 100644 --- a/test/failure_app_test.rb +++ b/test/failure_app_test.rb @@ -213,9 +213,13 @@ class FailureTest < ActiveSupport::TestCase test 'set up a default message' do call_failure - assert_match(/You are being/, @response.last.body) - assert_match(/redirected/, @response.last.body) - assert_match(/users/sign_in/, @response.last.body) + if Devise::Test.rails71_and_up? + assert_empty @response.last.body + else + assert_match(/You are being/, @response.last.body) + assert_match(/redirected/, @response.last.body) + assert_match(/users/sign_in/, @response.last.body) + end end test 'works for any navigational format' do diff --git a/test/integration/authenticatable_test.rb b/test/integration/authenticatable_test.rb index a1bf28da..6c3be3b5 100644 --- a/test/integration/authenticatable_test.rb +++ b/test/integration/authenticatable_test.rb @@ -346,10 +346,18 @@ class AuthenticationSessionTest < Devise::IntegrationTest test 'refreshes _csrf_token' do swap ApplicationController, allow_forgery_protection: true do get new_user_session_path - token = request.session[:_csrf_token] + token_from_session = request.session[:_csrf_token] + + if Devise::Test.rails71_and_up? + token_from_env = request.env[\"action_controller.csrf_token\"] + end sign_in_as_user - assert_not_equal request.session[:_csrf_token], token + assert_not_equal request.session[:_csrf_token], token_from_session + + if Devise::Test.rails71_and_up? + assert_not_equal request.env[\"action_controller.csrf_token\"], token_from_env + end end end diff --git a/test/rails_app/config/boot.rb b/test/rails_app/config/boot.rb index 524b5618..4c108cc8 100644 --- a/test/rails_app/config/boot.rb +++ b/test/rails_app/config/boot.rb @@ -8,6 +8,10 @@ module Devise module Test # Detection for minor differences between Rails versions in tests. + def self.rails71_and_up? + !rails70? && Rails::VERSION::MAJOR >= 7 + end + def self.rails70? Rails.version.start_with? '7.0' end diff --git a/test/test/controller_helpers_test.rb b/test/test/controller_helpers_test.rb index 6c5d24ad..c93ecf2e 100644 --- a/test/test/controller_helpers_test.rb +++ b/test/test/controller_helpers_test.rb @@ -97,7 +97,12 @@ class TestControllerHelpersTest < Devise::ControllerTestCase test \"returns the body of a failure app\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end test \"returns the content type of a failure app\" do @@ -203,6 +208,11 @@ class TestControllerHelpersForStreamingControllerTest < Devise::ControllerTestCa test \"doesn't hang when sending an authentication error response body\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end end ", "completion": "Only set property for Rails 7, it has been removed on master https://github.com/rails/rails/pull/44827 "}
{"prompt": "diff --git a/lib/devise/hooks/csrf_cleaner.rb b/lib/devise/hooks/csrf_cleaner.rb index d725fbc4..4a647395 100644 --- a/lib/devise/hooks/csrf_cleaner.rb +++ b/lib/devise/hooks/csrf_cleaner.rb @@ -4,6 +4,11 @@ Warden::Manager.after_authentication do |record, warden, options| clean_up_for_winning_strategy = !warden.winning_strategy.respond_to?(:clean_up_csrf?) || warden.winning_strategy.clean_up_csrf? if Devise.clean_up_csrf_token_on_authentication && clean_up_for_winning_strategy - warden.request.session.try(:delete, :_csrf_token) + if warden.request.respond_to?(:reset_csrf_token) + # Rails 7.1+ + warden.request.reset_csrf_token + else + warden.request.session.try(:delete, :_csrf_token) + end end end diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable diff --git a/test/failure_app_test.rb b/test/failure_app_test.rb index df4107c0..883cf8b9 100644 --- a/test/failure_app_test.rb +++ b/test/failure_app_test.rb @@ -213,9 +213,13 @@ class FailureTest < ActiveSupport::TestCase test 'set up a default message' do call_failure - assert_match(/You are being/, @response.last.body) - assert_match(/redirected/, @response.last.body) - assert_match(/users/sign_in/, @response.last.body) + if Devise::Test.rails71_and_up? + assert_empty @response.last.body + else + assert_match(/You are being/, @response.last.body) + assert_match(/redirected/, @response.last.body) + assert_match(/users/sign_in/, @response.last.body) + end end test 'works for any navigational format' do diff --git a/test/integration/authenticatable_test.rb b/test/integration/authenticatable_test.rb index a1bf28da..6c3be3b5 100644 --- a/test/integration/authenticatable_test.rb +++ b/test/integration/authenticatable_test.rb @@ -346,10 +346,18 @@ class AuthenticationSessionTest < Devise::IntegrationTest test 'refreshes _csrf_token' do swap ApplicationController, allow_forgery_protection: true do get new_user_session_path - token = request.session[:_csrf_token] + token_from_session = request.session[:_csrf_token] + + if Devise::Test.rails71_and_up? + token_from_env = request.env[\"action_controller.csrf_token\"] + end sign_in_as_user - assert_not_equal request.session[:_csrf_token], token + assert_not_equal request.session[:_csrf_token], token_from_session + + if Devise::Test.rails71_and_up? + assert_not_equal request.env[\"action_controller.csrf_token\"], token_from_env + end end end diff --git a/test/rails_app/config/application.rb b/test/rails_app/config/application.rb index 7d717db8..1f4fbddb 100644 --- a/test/rails_app/config/application.rb +++ b/test/rails_app/config/application.rb @@ -50,7 +50,7 @@ module RailsApp Rails.application.config.active_record.sqlite3.represent_boolean_as_integer = true end - if Devise::Test.rails7_and_up? + if Devise::Test.rails70? config.active_record.legacy_connection_handling = false end end diff --git a/test/rails_app/config/boot.rb b/test/rails_app/config/boot.rb index 65acdfec..4c108cc8 100644 --- a/test/rails_app/config/boot.rb +++ b/test/rails_app/config/boot.rb @@ -8,8 +8,12 @@ module Devise module Test # Detection for minor differences between Rails versions in tests. - def self.rails7_and_up? - Rails::VERSION::MAJOR >= 7 + def self.rails71_and_up? + !rails70? && Rails::VERSION::MAJOR >= 7 + end + + def self.rails70? + Rails.version.start_with? '7.0' end def self.rails6_and_up? diff --git a/test/test/controller_helpers_test.rb b/test/test/controller_helpers_test.rb index 6c5d24ad..c93ecf2e 100644 --- a/test/test/controller_helpers_test.rb +++ b/test/test/controller_helpers_test.rb @@ -97,7 +97,12 @@ class TestControllerHelpersTest < Devise::ControllerTestCase test \"returns the body of a failure app\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end test \"returns the content type of a failure app\" do @@ -203,6 +208,11 @@ class TestControllerHelpersForStreamingControllerTest < Devise::ControllerTestCa test \"doesn't hang when sending an authentication error response body\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end end ", "completion": "Use https source for github repos with Bundler 1.x GitHub no longer supports the git:// protocol, which was the default in Bundler 1.x. From the build: The unauthenticated git protocol on port 9418 is no longer supported. Please see https://github.blog/2021-09-01-improving-git-protocol-security-github/ for more information. "}
{"prompt": "diff --git a/gemfiles/Gemfile-rails-4-1 b/gemfiles/Gemfile-rails-4-1 index 44a1c98a..7bbabf9d 100644 --- a/gemfiles/Gemfile-rails-4-1 +++ b/gemfiles/Gemfile-rails-4-1 @@ -2,6 +2,11 @@ source \"https://rubygems.org\" +git_source(:github) do |repo_name| + repo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?('/') + \"https://github.com/#{repo_name}.git\" +end + gemspec path: \"..\" gem \"rails\", github: \"rails/rails\", branch: \"4-1-stable\" diff --git a/gemfiles/Gemfile-rails-4-2 b/gemfiles/Gemfile-rails-4-2 index bb35c5f2..6e106b5e 100644 --- a/gemfiles/Gemfile-rails-4-2 +++ b/gemfiles/Gemfile-rails-4-2 @@ -2,6 +2,11 @@ source \"https://rubygems.org\" +git_source(:github) do |repo_name| + repo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?('/') + \"https://github.com/#{repo_name}.git\" +end + gemspec path: \"..\" gem \"rails\", github: \"rails/rails\", branch: \"4-2-stable\" diff --git a/lib/devise/hooks/csrf_cleaner.rb b/lib/devise/hooks/csrf_cleaner.rb index d725fbc4..4a647395 100644 --- a/lib/devise/hooks/csrf_cleaner.rb +++ b/lib/devise/hooks/csrf_cleaner.rb @@ -4,6 +4,11 @@ Warden::Manager.after_authentication do |record, warden, options| clean_up_for_winning_strategy = !warden.winning_strategy.respond_to?(:clean_up_csrf?) || warden.winning_strategy.clean_up_csrf? if Devise.clean_up_csrf_token_on_authentication && clean_up_for_winning_strategy - warden.request.session.try(:delete, :_csrf_token) + if warden.request.respond_to?(:reset_csrf_token) + # Rails 7.1+ + warden.request.reset_csrf_token + else + warden.request.session.try(:delete, :_csrf_token) + end end end diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable diff --git a/test/failure_app_test.rb b/test/failure_app_test.rb index df4107c0..883cf8b9 100644 --- a/test/failure_app_test.rb +++ b/test/failure_app_test.rb @@ -213,9 +213,13 @@ class FailureTest < ActiveSupport::TestCase test 'set up a default message' do call_failure - assert_match(/You are being/, @response.last.body) - assert_match(/redirected/, @response.last.body) - assert_match(/users/sign_in/, @response.last.body) + if Devise::Test.rails71_and_up? + assert_empty @response.last.body + else + assert_match(/You are being/, @response.last.body) + assert_match(/redirected/, @response.last.body) + assert_match(/users/sign_in/, @response.last.body) + end end test 'works for any navigational format' do diff --git a/test/integration/authenticatable_test.rb b/test/integration/authenticatable_test.rb index a1bf28da..6c3be3b5 100644 --- a/test/integration/authenticatable_test.rb +++ b/test/integration/authenticatable_test.rb @@ -346,10 +346,18 @@ class AuthenticationSessionTest < Devise::IntegrationTest test 'refreshes _csrf_token' do swap ApplicationController, allow_forgery_protection: true do get new_user_session_path - token = request.session[:_csrf_token] + token_from_session = request.session[:_csrf_token] + + if Devise::Test.rails71_and_up? + token_from_env = request.env[\"action_controller.csrf_token\"] + end sign_in_as_user - assert_not_equal request.session[:_csrf_token], token + assert_not_equal request.session[:_csrf_token], token_from_session + + if Devise::Test.rails71_and_up? + assert_not_equal request.env[\"action_controller.csrf_token\"], token_from_env + end end end diff --git a/test/rails_app/config/application.rb b/test/rails_app/config/application.rb index 7d717db8..1f4fbddb 100644 --- a/test/rails_app/config/application.rb +++ b/test/rails_app/config/application.rb @@ -50,7 +50,7 @@ module RailsApp Rails.application.config.active_record.sqlite3.represent_boolean_as_integer = true end - if Devise::Test.rails7_and_up? + if Devise::Test.rails70? config.active_record.legacy_connection_handling = false end end diff --git a/test/rails_app/config/boot.rb b/test/rails_app/config/boot.rb index 65acdfec..4c108cc8 100644 --- a/test/rails_app/config/boot.rb +++ b/test/rails_app/config/boot.rb @@ -8,8 +8,12 @@ module Devise module Test # Detection for minor differences between Rails versions in tests. - def self.rails7_and_up? - Rails::VERSION::MAJOR >= 7 + def self.rails71_and_up? + !rails70? && Rails::VERSION::MAJOR >= 7 + end + + def self.rails70? + Rails.version.start_with? '7.0' end def self.rails6_and_up? diff --git a/test/test/controller_helpers_test.rb b/test/test/controller_helpers_test.rb index 6c5d24ad..c93ecf2e 100644 --- a/test/test/controller_helpers_test.rb +++ b/test/test/controller_helpers_test.rb @@ -97,7 +97,12 @@ class TestControllerHelpersTest < Devise::ControllerTestCase test \"returns the body of a failure app\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end test \"returns the content type of a failure app\" do @@ -203,6 +208,11 @@ class TestControllerHelpersForStreamingControllerTest < Devise::ControllerTestCa test \"doesn't hang when sending an authentication error response body\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end end ", "completion": "Update bundle "}
{"prompt": "diff --git a/Gemfile.lock b/Gemfile.lock index 82ddc272..be03532d 100644 --- a/Gemfile.lock +++ b/Gemfile.lock @@ -20,89 +20,88 @@ PATH GEM remote: https://rubygems.org/ specs: - actioncable (7.0.2.2) - actionpack (= 7.0.2.2) - activesupport (= 7.0.2.2) + actioncable (7.0.2.3) + actionpack (= 7.0.2.3) + activesupport (= 7.0.2.3) nio4r (~> 2.0) websocket-driver (>= 0.6.1) - actionmailbox (7.0.2.2) - actionpack (= 7.0.2.2) - activejob (= 7.0.2.2) - activerecord (= 7.0.2.2) - activestorage (= 7.0.2.2) - activesupport (= 7.0.2.2) + actionmailbox (7.0.2.3) + actionpack (= 7.0.2.3) + activejob (= 7.0.2.3) + activerecord (= 7.0.2.3) + activestorage (= 7.0.2.3) + activesupport (= 7.0.2.3) mail (>= 2.7.1) net-imap net-pop net-smtp - actionmailer (7.0.2.2) - actionpack (= 7.0.2.2) - actionview (= 7.0.2.2) - activejob (= 7.0.2.2) - activesupport (= 7.0.2.2) + actionmailer (7.0.2.3) + actionpack (= 7.0.2.3) + actionview (= 7.0.2.3) + activejob (= 7.0.2.3) + activesupport (= 7.0.2.3) mail (~> 2.5, >= 2.5.4) net-imap net-pop net-smtp rails-dom-testing (~> 2.0) - actionpack (7.0.2.2) - actionview (= 7.0.2.2) - activesupport (= 7.0.2.2) + actionpack (7.0.2.3) + actionview (= 7.0.2.3) + activesupport (= 7.0.2.3) rack (~> 2.0, >= 2.2.0) rack-test (>= 0.6.3) rails-dom-testing (~> 2.0) rails-html-sanitizer (~> 1.0, >= 1.2.0) - actiontext (7.0.2.2) - actionpack (= 7.0.2.2) - activerecord (= 7.0.2.2) - activestorage (= 7.0.2.2) - activesupport (= 7.0.2.2) + actiontext (7.0.2.3) + actionpack (= 7.0.2.3) + activerecord (= 7.0.2.3) + activestorage (= 7.0.2.3) + activesupport (= 7.0.2.3) globalid (>= 0.6.0) nokogiri (>= 1.8.5) - actionview (7.0.2.2) - activesupport (= 7.0.2.2) + actionview (7.0.2.3) + activesupport (= 7.0.2.3) builder (~> 3.1) erubi (~> 1.4) rails-dom-testing (~> 2.0) rails-html-sanitizer (~> 1.1, >= 1.2.0) - activejob (7.0.2.2) - activesupport (= 7.0.2.2) + activejob (7.0.2.3) + activesupport (= 7.0.2.3) globalid (>= 0.3.6) - activemodel (7.0.2.2) - activesupport (= 7.0.2.2) - activerecord (7.0.2.2) - activemodel (= 7.0.2.2) - activesupport (= 7.0.2.2) - activestorage (7.0.2.2) - actionpack (= 7.0.2.2) - activejob (= 7.0.2.2) - activerecord (= 7.0.2.2) - activesupport (= 7.0.2.2) + activemodel (7.0.2.3) + activesupport (= 7.0.2.3) + activerecord (7.0.2.3) + activemodel (= 7.0.2.3) + activesupport (= 7.0.2.3) + activestorage (7.0.2.3) + actionpack (= 7.0.2.3) + activejob (= 7.0.2.3) + activerecord (= 7.0.2.3) + activesupport (= 7.0.2.3) marcel (~> 1.0) mini_mime (>= 1.1.0) - activesupport (7.0.2.2) + activesupport (7.0.2.3) concurrent-ruby (~> 1.0, >= 1.0.2) i18n (>= 1.6, < 2) minitest (>= 5.1) tzinfo (~> 2.0) - bcrypt (3.1.16) + bcrypt (3.1.17) builder (3.2.4) - concurrent-ruby (1.1.9) + concurrent-ruby (1.1.10) crass (1.0.6) digest (3.1.0) erubi (1.10.0) faraday (2.2.0) faraday-net_http (~> 2.0) ruby2_keywords (>= 0.0.4) - faraday-net_http (2.0.1) + faraday-net_http (2.0.2) globalid (1.0.0) activesupport (>= 5.0) hashie (5.0.0) i18n (1.10.0) concurrent-ruby (~> 1.0) - io-wait (0.2.1) jwt (2.3.0) - loofah (2.14.0) + loofah (2.16.0) crass (~> 1.0.2) nokogiri (>= 1.5.9) mail (2.7.1) @@ -123,8 +122,7 @@ GEM digest net-protocol timeout - net-protocol (0.1.2) - io-wait + net-protocol (0.1.3) timeout net-smtp (0.3.1) digest @@ -140,9 +138,9 @@ GEM multi_json (~> 1.3) multi_xml (~> 0.5) rack (>= 1.2, < 3) - omniauth (2.0.4) + omniauth (2.1.0) hashie (>= 3.4.6) - rack (>= 1.6.2, < 3) + rack (>= 2.2.3) rack-protection omniauth-facebook (9.0.0) omniauth-oauth2 (~> 1.2) @@ -164,28 +162,28 @@ GEM rack rack-test (1.1.0) rack (>= 1.0, < 3) - rails (7.0.2.2) - actioncable (= 7.0.2.2) - actionmailbox (= 7.0.2.2) - actionmailer (= 7.0.2.2) - actionpack (= 7.0.2.2) - actiontext (= 7.0.2.2) - actionview (= 7.0.2.2) - activejob (= 7.0.2.2) - activemodel (= 7.0.2.2) - activerecord (= 7.0.2.2) - activestorage (= 7.0.2.2) - activesupport (= 7.0.2.2) + rails (7.0.2.3) + actioncable (= 7.0.2.3) + actionmailbox (= 7.0.2.3) + actionmailer (= 7.0.2.3) + actionpack (= 7.0.2.3) + actiontext (= 7.0.2.3) + actionview (= 7.0.2.3) + activejob (= 7.0.2.3) + activemodel (= 7.0.2.3) + activerecord (= 7.0.2.3) + activestorage (= 7.0.2.3) + activesupport (= 7.0.2.3) bundler (>= 1.15.0) - railties (= 7.0.2.2) + railties (= 7.0.2.3) rails-dom-testing (2.0.3) activesupport (>= 4.2.0) nokogiri (>= 1.6) rails-html-sanitizer (1.4.2) loofah (~> 2.3) - railties (7.0.2.2) - actionpack (= 7.0.2.2) - activesupport (= 7.0.2.2) + railties (7.0.2.3) + actionpack (= 7.0.2.3) + activesupport (= 7.0.2.3) method_source rake (>= 12.2) thor (~> 1.0) @@ -203,7 +201,7 @@ GEM stringio (3.0.1) strscan (3.0.1) thor (1.2.1) - timecop (0.9.4) + timecop (0.9.5) timeout (0.2.0) tzinfo (2.0.4) concurrent-ruby (~> 1.0) diff --git a/gemfiles/Gemfile-rails-4-1 b/gemfiles/Gemfile-rails-4-1 index 44a1c98a..7bbabf9d 100644 --- a/gemfiles/Gemfile-rails-4-1 +++ b/gemfiles/Gemfile-rails-4-1 @@ -2,6 +2,11 @@ source \"https://rubygems.org\" +git_source(:github) do |repo_name| + repo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?('/') + \"https://github.com/#{repo_name}.git\" +end + gemspec path: \"..\" gem \"rails\", github: \"rails/rails\", branch: \"4-1-stable\" diff --git a/gemfiles/Gemfile-rails-4-2 b/gemfiles/Gemfile-rails-4-2 index bb35c5f2..6e106b5e 100644 --- a/gemfiles/Gemfile-rails-4-2 +++ b/gemfiles/Gemfile-rails-4-2 @@ -2,6 +2,11 @@ source \"https://rubygems.org\" +git_source(:github) do |repo_name| + repo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?('/') + \"https://github.com/#{repo_name}.git\" +end + gemspec path: \"..\" gem \"rails\", github: \"rails/rails\", branch: \"4-2-stable\" diff --git a/lib/devise/hooks/csrf_cleaner.rb b/lib/devise/hooks/csrf_cleaner.rb index d725fbc4..4a647395 100644 --- a/lib/devise/hooks/csrf_cleaner.rb +++ b/lib/devise/hooks/csrf_cleaner.rb @@ -4,6 +4,11 @@ Warden::Manager.after_authentication do |record, warden, options| clean_up_for_winning_strategy = !warden.winning_strategy.respond_to?(:clean_up_csrf?) || warden.winning_strategy.clean_up_csrf? if Devise.clean_up_csrf_token_on_authentication && clean_up_for_winning_strategy - warden.request.session.try(:delete, :_csrf_token) + if warden.request.respond_to?(:reset_csrf_token) + # Rails 7.1+ + warden.request.reset_csrf_token + else + warden.request.session.try(:delete, :_csrf_token) + end end end diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable diff --git a/test/failure_app_test.rb b/test/failure_app_test.rb index df4107c0..883cf8b9 100644 --- a/test/failure_app_test.rb +++ b/test/failure_app_test.rb @@ -213,9 +213,13 @@ class FailureTest < ActiveSupport::TestCase test 'set up a default message' do call_failure - assert_match(/You are being/, @response.last.body) - assert_match(/redirected/, @response.last.body) - assert_match(/users/sign_in/, @response.last.body) + if Devise::Test.rails71_and_up? + assert_empty @response.last.body + else + assert_match(/You are being/, @response.last.body) + assert_match(/redirected/, @response.last.body) + assert_match(/users/sign_in/, @response.last.body) + end end test 'works for any navigational format' do diff --git a/test/integration/authenticatable_test.rb b/test/integration/authenticatable_test.rb index a1bf28da..6c3be3b5 100644 --- a/test/integration/authenticatable_test.rb +++ b/test/integration/authenticatable_test.rb @@ -346,10 +346,18 @@ class AuthenticationSessionTest < Devise::IntegrationTest test 'refreshes _csrf_token' do swap ApplicationController, allow_forgery_protection: true do get new_user_session_path - token = request.session[:_csrf_token] + token_from_session = request.session[:_csrf_token] + + if Devise::Test.rails71_and_up? + token_from_env = request.env[\"action_controller.csrf_token\"] + end sign_in_as_user - assert_not_equal request.session[:_csrf_token], token + assert_not_equal request.session[:_csrf_token], token_from_session + + if Devise::Test.rails71_and_up? + assert_not_equal request.env[\"action_controller.csrf_token\"], token_from_env + end end end diff --git a/test/rails_app/config/application.rb b/test/rails_app/config/application.rb index 7d717db8..1f4fbddb 100644 --- a/test/rails_app/config/application.rb +++ b/test/rails_app/config/application.rb @@ -50,7 +50,7 @@ module RailsApp Rails.application.config.active_record.sqlite3.represent_boolean_as_integer = true end - if Devise::Test.rails7_and_up? + if Devise::Test.rails70? config.active_record.legacy_connection_handling = false end end diff --git a/test/rails_app/config/boot.rb b/test/rails_app/config/boot.rb index 65acdfec..4c108cc8 100644 --- a/test/rails_app/config/boot.rb +++ b/test/rails_app/config/boot.rb @@ -8,8 +8,12 @@ module Devise module Test # Detection for minor differences between Rails versions in tests. - def self.rails7_and_up? - Rails::VERSION::MAJOR >= 7 + def self.rails71_and_up? + !rails70? && Rails::VERSION::MAJOR >= 7 + end + + def self.rails70? + Rails.version.start_with? '7.0' end def self.rails6_and_up? diff --git a/test/test/controller_helpers_test.rb b/test/test/controller_helpers_test.rb index 6c5d24ad..c93ecf2e 100644 --- a/test/test/controller_helpers_test.rb +++ b/test/test/controller_helpers_test.rb @@ -97,7 +97,12 @@ class TestControllerHelpersTest < Devise::ControllerTestCase test \"returns the body of a failure app\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end test \"returns the content type of a failure app\" do @@ -203,6 +208,11 @@ class TestControllerHelpersForStreamingControllerTest < Devise::ControllerTestCa test \"doesn't hang when sending an authentication error response body\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end end ", "completion": "Merge pull request #5483 from yysaki/feature/main_branch_url Update the urls which refer nonexistent master branch name in documentations "}
{"prompt": "diff --git a/Gemfile.lock b/Gemfile.lock index 82ddc272..be03532d 100644 --- a/Gemfile.lock +++ b/Gemfile.lock @@ -20,89 +20,88 @@ PATH GEM remote: https://rubygems.org/ specs: - actioncable (7.0.2.2) - actionpack (= 7.0.2.2) - activesupport (= 7.0.2.2) + actioncable (7.0.2.3) + actionpack (= 7.0.2.3) + activesupport (= 7.0.2.3) nio4r (~> 2.0) websocket-driver (>= 0.6.1) - actionmailbox (7.0.2.2) - actionpack (= 7.0.2.2) - activejob (= 7.0.2.2) - activerecord (= 7.0.2.2) - activestorage (= 7.0.2.2) - activesupport (= 7.0.2.2) + actionmailbox (7.0.2.3) + actionpack (= 7.0.2.3) + activejob (= 7.0.2.3) + activerecord (= 7.0.2.3) + activestorage (= 7.0.2.3) + activesupport (= 7.0.2.3) mail (>= 2.7.1) net-imap net-pop net-smtp - actionmailer (7.0.2.2) - actionpack (= 7.0.2.2) - actionview (= 7.0.2.2) - activejob (= 7.0.2.2) - activesupport (= 7.0.2.2) + actionmailer (7.0.2.3) + actionpack (= 7.0.2.3) + actionview (= 7.0.2.3) + activejob (= 7.0.2.3) + activesupport (= 7.0.2.3) mail (~> 2.5, >= 2.5.4) net-imap net-pop net-smtp rails-dom-testing (~> 2.0) - actionpack (7.0.2.2) - actionview (= 7.0.2.2) - activesupport (= 7.0.2.2) + actionpack (7.0.2.3) + actionview (= 7.0.2.3) + activesupport (= 7.0.2.3) rack (~> 2.0, >= 2.2.0) rack-test (>= 0.6.3) rails-dom-testing (~> 2.0) rails-html-sanitizer (~> 1.0, >= 1.2.0) - actiontext (7.0.2.2) - actionpack (= 7.0.2.2) - activerecord (= 7.0.2.2) - activestorage (= 7.0.2.2) - activesupport (= 7.0.2.2) + actiontext (7.0.2.3) + actionpack (= 7.0.2.3) + activerecord (= 7.0.2.3) + activestorage (= 7.0.2.3) + activesupport (= 7.0.2.3) globalid (>= 0.6.0) nokogiri (>= 1.8.5) - actionview (7.0.2.2) - activesupport (= 7.0.2.2) + actionview (7.0.2.3) + activesupport (= 7.0.2.3) builder (~> 3.1) erubi (~> 1.4) rails-dom-testing (~> 2.0) rails-html-sanitizer (~> 1.1, >= 1.2.0) - activejob (7.0.2.2) - activesupport (= 7.0.2.2) + activejob (7.0.2.3) + activesupport (= 7.0.2.3) globalid (>= 0.3.6) - activemodel (7.0.2.2) - activesupport (= 7.0.2.2) - activerecord (7.0.2.2) - activemodel (= 7.0.2.2) - activesupport (= 7.0.2.2) - activestorage (7.0.2.2) - actionpack (= 7.0.2.2) - activejob (= 7.0.2.2) - activerecord (= 7.0.2.2) - activesupport (= 7.0.2.2) + activemodel (7.0.2.3) + activesupport (= 7.0.2.3) + activerecord (7.0.2.3) + activemodel (= 7.0.2.3) + activesupport (= 7.0.2.3) + activestorage (7.0.2.3) + actionpack (= 7.0.2.3) + activejob (= 7.0.2.3) + activerecord (= 7.0.2.3) + activesupport (= 7.0.2.3) marcel (~> 1.0) mini_mime (>= 1.1.0) - activesupport (7.0.2.2) + activesupport (7.0.2.3) concurrent-ruby (~> 1.0, >= 1.0.2) i18n (>= 1.6, < 2) minitest (>= 5.1) tzinfo (~> 2.0) - bcrypt (3.1.16) + bcrypt (3.1.17) builder (3.2.4) - concurrent-ruby (1.1.9) + concurrent-ruby (1.1.10) crass (1.0.6) digest (3.1.0) erubi (1.10.0) faraday (2.2.0) faraday-net_http (~> 2.0) ruby2_keywords (>= 0.0.4) - faraday-net_http (2.0.1) + faraday-net_http (2.0.2) globalid (1.0.0) activesupport (>= 5.0) hashie (5.0.0) i18n (1.10.0) concurrent-ruby (~> 1.0) - io-wait (0.2.1) jwt (2.3.0) - loofah (2.14.0) + loofah (2.16.0) crass (~> 1.0.2) nokogiri (>= 1.5.9) mail (2.7.1) @@ -123,8 +122,7 @@ GEM digest net-protocol timeout - net-protocol (0.1.2) - io-wait + net-protocol (0.1.3) timeout net-smtp (0.3.1) digest @@ -140,9 +138,9 @@ GEM multi_json (~> 1.3) multi_xml (~> 0.5) rack (>= 1.2, < 3) - omniauth (2.0.4) + omniauth (2.1.0) hashie (>= 3.4.6) - rack (>= 1.6.2, < 3) + rack (>= 2.2.3) rack-protection omniauth-facebook (9.0.0) omniauth-oauth2 (~> 1.2) @@ -164,28 +162,28 @@ GEM rack rack-test (1.1.0) rack (>= 1.0, < 3) - rails (7.0.2.2) - actioncable (= 7.0.2.2) - actionmailbox (= 7.0.2.2) - actionmailer (= 7.0.2.2) - actionpack (= 7.0.2.2) - actiontext (= 7.0.2.2) - actionview (= 7.0.2.2) - activejob (= 7.0.2.2) - activemodel (= 7.0.2.2) - activerecord (= 7.0.2.2) - activestorage (= 7.0.2.2) - activesupport (= 7.0.2.2) + rails (7.0.2.3) + actioncable (= 7.0.2.3) + actionmailbox (= 7.0.2.3) + actionmailer (= 7.0.2.3) + actionpack (= 7.0.2.3) + actiontext (= 7.0.2.3) + actionview (= 7.0.2.3) + activejob (= 7.0.2.3) + activemodel (= 7.0.2.3) + activerecord (= 7.0.2.3) + activestorage (= 7.0.2.3) + activesupport (= 7.0.2.3) bundler (>= 1.15.0) - railties (= 7.0.2.2) + railties (= 7.0.2.3) rails-dom-testing (2.0.3) activesupport (>= 4.2.0) nokogiri (>= 1.6) rails-html-sanitizer (1.4.2) loofah (~> 2.3) - railties (7.0.2.2) - actionpack (= 7.0.2.2) - activesupport (= 7.0.2.2) + railties (7.0.2.3) + actionpack (= 7.0.2.3) + activesupport (= 7.0.2.3) method_source rake (>= 12.2) thor (~> 1.0) @@ -203,7 +201,7 @@ GEM stringio (3.0.1) strscan (3.0.1) thor (1.2.1) - timecop (0.9.4) + timecop (0.9.5) timeout (0.2.0) tzinfo (2.0.4) concurrent-ruby (~> 1.0) diff --git a/gemfiles/Gemfile-rails-4-1 b/gemfiles/Gemfile-rails-4-1 index 44a1c98a..7bbabf9d 100644 --- a/gemfiles/Gemfile-rails-4-1 +++ b/gemfiles/Gemfile-rails-4-1 @@ -2,6 +2,11 @@ source \"https://rubygems.org\" +git_source(:github) do |repo_name| + repo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?('/') + \"https://github.com/#{repo_name}.git\" +end + gemspec path: \"..\" gem \"rails\", github: \"rails/rails\", branch: \"4-1-stable\" diff --git a/gemfiles/Gemfile-rails-4-2 b/gemfiles/Gemfile-rails-4-2 index bb35c5f2..6e106b5e 100644 --- a/gemfiles/Gemfile-rails-4-2 +++ b/gemfiles/Gemfile-rails-4-2 @@ -2,6 +2,11 @@ source \"https://rubygems.org\" +git_source(:github) do |repo_name| + repo_name = \"#{repo_name}/#{repo_name}\" unless repo_name.include?('/') + \"https://github.com/#{repo_name}.git\" +end + gemspec path: \"..\" gem \"rails\", github: \"rails/rails\", branch: \"4-2-stable\" diff --git a/lib/devise/hooks/csrf_cleaner.rb b/lib/devise/hooks/csrf_cleaner.rb index d725fbc4..4a647395 100644 --- a/lib/devise/hooks/csrf_cleaner.rb +++ b/lib/devise/hooks/csrf_cleaner.rb @@ -4,6 +4,11 @@ Warden::Manager.after_authentication do |record, warden, options| clean_up_for_winning_strategy = !warden.winning_strategy.respond_to?(:clean_up_csrf?) || warden.winning_strategy.clean_up_csrf? if Devise.clean_up_csrf_token_on_authentication && clean_up_for_winning_strategy - warden.request.session.try(:delete, :_csrf_token) + if warden.request.respond_to?(:reset_csrf_token) + # Rails 7.1+ + warden.request.reset_csrf_token + else + warden.request.session.try(:delete, :_csrf_token) + end end end diff --git a/lib/devise/models/lockable.rb b/lib/devise/models/lockable.rb index ce9e3e57..65bb400d 100644 --- a/lib/devise/models/lockable.rb +++ b/lib/devise/models/lockable.rb @@ -18,7 +18,7 @@ module Devise # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +maximum_attempts+: how many attempts should be accepted before blocking the user. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +lock_strategy+: lock the user account by :failed_attempts or :none. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_strategy+: unlock the user account by :time, :email, :both or :none. - # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to lock the user after to lock happens. Only available when unlock_strategy is :time or :both. + # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_in+: the time you want to unlock the user after lock happens. Only available when unlock_strategy is :time or :both. # CHANGELOG.md CODE_OF_CONDUCT.md CONTRIBUTING.md Gemfile Gemfile.lock ISSUE_TEMPLATE.md MIT-LICENSE README.md Rakefile app bin config devise.gemspec devise.png gemfiles guides lib test +unlock_keys+: the keys you want to use when locking and unlocking an account # module Lockable diff --git a/test/failure_app_test.rb b/test/failure_app_test.rb index df4107c0..883cf8b9 100644 --- a/test/failure_app_test.rb +++ b/test/failure_app_test.rb @@ -213,9 +213,13 @@ class FailureTest < ActiveSupport::TestCase test 'set up a default message' do call_failure - assert_match(/You are being/, @response.last.body) - assert_match(/redirected/, @response.last.body) - assert_match(/users/sign_in/, @response.last.body) + if Devise::Test.rails71_and_up? + assert_empty @response.last.body + else + assert_match(/You are being/, @response.last.body) + assert_match(/redirected/, @response.last.body) + assert_match(/users/sign_in/, @response.last.body) + end end test 'works for any navigational format' do diff --git a/test/integration/authenticatable_test.rb b/test/integration/authenticatable_test.rb index a1bf28da..6c3be3b5 100644 --- a/test/integration/authenticatable_test.rb +++ b/test/integration/authenticatable_test.rb @@ -346,10 +346,18 @@ class AuthenticationSessionTest < Devise::IntegrationTest test 'refreshes _csrf_token' do swap ApplicationController, allow_forgery_protection: true do get new_user_session_path - token = request.session[:_csrf_token] + token_from_session = request.session[:_csrf_token] + + if Devise::Test.rails71_and_up? + token_from_env = request.env[\"action_controller.csrf_token\"] + end sign_in_as_user - assert_not_equal request.session[:_csrf_token], token + assert_not_equal request.session[:_csrf_token], token_from_session + + if Devise::Test.rails71_and_up? + assert_not_equal request.env[\"action_controller.csrf_token\"], token_from_env + end end end diff --git a/test/rails_app/config/application.rb b/test/rails_app/config/application.rb index 7d717db8..1f4fbddb 100644 --- a/test/rails_app/config/application.rb +++ b/test/rails_app/config/application.rb @@ -50,7 +50,7 @@ module RailsApp Rails.application.config.active_record.sqlite3.represent_boolean_as_integer = true end - if Devise::Test.rails7_and_up? + if Devise::Test.rails70? config.active_record.legacy_connection_handling = false end end diff --git a/test/rails_app/config/boot.rb b/test/rails_app/config/boot.rb index 65acdfec..4c108cc8 100644 --- a/test/rails_app/config/boot.rb +++ b/test/rails_app/config/boot.rb @@ -8,8 +8,12 @@ module Devise module Test # Detection for minor differences between Rails versions in tests. - def self.rails7_and_up? - Rails::VERSION::MAJOR >= 7 + def self.rails71_and_up? + !rails70? && Rails::VERSION::MAJOR >= 7 + end + + def self.rails70? + Rails.version.start_with? '7.0' end def self.rails6_and_up? diff --git a/test/test/controller_helpers_test.rb b/test/test/controller_helpers_test.rb index 6c5d24ad..c93ecf2e 100644 --- a/test/test/controller_helpers_test.rb +++ b/test/test/controller_helpers_test.rb @@ -97,7 +97,12 @@ class TestControllerHelpersTest < Devise::ControllerTestCase test \"returns the body of a failure app\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end test \"returns the content type of a failure app\" do @@ -203,6 +208,11 @@ class TestControllerHelpersForStreamingControllerTest < Devise::ControllerTestCa test \"doesn't hang when sending an authentication error response body\" do get :index - assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + + if Devise::Test.rails71_and_up? + assert_empty response.body + else + assert_equal \"<html><body>You are being <a href=\"http://test.host/users/sign_in\">redirected</a>.</body></html>\", response.body + end end end ", "completion": "Update the urls which refer nonexistent master branch name in documentations "}
{"prompt": "diff --git a/meetings/working-groups/params-improvements/PI-2022-10-25.md b/meetings/working-groups/params-improvements/PI-2022-10-25.md new file mode 100644 index 0000000..6605f3a --- /dev/null +++ b/meetings/working-groups/params-improvements/PI-2022-10-25.md @@ -0,0 +1,64 @@ +# Params Improvements Working Group Meeting for October 25, 2022 +This was the first meeting of the _`params` improvements_ working group. +We discussed extending `params` support to collection types other than arrays. + +## Agenda +1. `params IEnumerable<T>`, `IList<T>`, etc. +1. `params List<T>`, `ImmutableArray<T>`, etc. +1. `params Span<T>`, `ReadOnlySpan<T>` +1. Overload resolution and backward compatibility + +## Discussion + +### Interfaces and collection types: `params IEnumerable<T>`, `List<T>`, etc. + +Perhaps the most common request is support for `params IEnumerable<T>`. + +This is potentially useful for scenarios where the `params` method simply iterates over the collection, and where callers might have an `IEnumerable<T>` instance rather than a `T[]` and are calling the method with _normal form_. +However, when callers use _expanded form_, a `params IEnumerable<T>` may not provide any advantage over `params T[]` to the caller or callee. + +If we extend `params` to support `IEnumerable<T>`, we should consider extending `params` support to other interface types and concrete collection types as well. +If so, what are the requirements of supported types? + +The [_collection literals working group_](https://github.com/dotnet/csharplang/tree/main/meetings/working-groups/collection-literals) is already defining similar requirements for _constructible collection types_. Those types can be `interface` types or concrete `class`, `struct`, and `ref struct` types. +The _collection literals_ proposal specifies how the corresponding collection instances for _constructible collection types_ are constructed and populated. + +Any additional `params` types should match the _collection literals_ approach. +That is, for any particular `params` type, the code generated for `WriteLine(fmt, a, b, c)` should be equivalent to the code generated for `WriteLine(fmt, [a, b, c])`. + +That said, the difference between an _expanded form_ call (with implicit collection) and a call using a _collection literal_ is just two characters, `[]`, so the advantage of `params` over _collection literals_ seems small. +Given that, we concluded we _should not extend `params`_ to arbitrary interfaces or collection types. + +### Spans: `params ReadOnlySpan<T>`, `Span<T>` + +`ReadOnlySpan<T>` has a couple of advantages over other potential `params` types. +1. With runtime support, the compiler could create spans at call sites without allocating an underlying array on the heap. +1. `T[]` and `Span<T>` are implicitly convertible to `ReadOnlySpan<T>`. + +That means `params ReadOnlySpan<T>` is a reasonable alternative to `params T[]` in new APIs. +And for existing APIs, adding a `params ReadOnlySpan<T>` overload could reduce allocations for current callers of a `params T[]` overload without changing the calling code. + +The potential perf benefit, and the opportunity to replace `params T[]` with `params ReadOnlySpan<T>` seem sufficiently important that we should support `params ReadOnlySpan<T>` even if _collection literals_ provide similar optimizations for span literals - that is, even if the difference between using `params` and using a _collection literal_ is simply `[]`. + +`Span<T>` has the same benefits as `ReadOnlySpan<T>`, but `Span<T>` is only preferable to `ReadOnlySpan<T>` if the `params` method modifies the span. +But modifying a `params` span is not a pattern we should encourage - in part because modifications are not visible to callers where the compiler generated the `Span<T>` instance. +In short, we concluded we should support `params ReadOnlySpan<T>` but not `params Span<T>`. + +`params ReadOnlySpan<T>` should be implicitly `scoped` so the compiler can reuse the implicitly generated `ReadOnlySpan<T>` instance across multiple calls in the calling method. + +Should we also support `params scoped T[]`, to allowing sharing the array across callers? + +### Overload resolution and backward compatibility + +Overload resolution should prefer an overload with `params ReadOnlySpan<T>` over an overload with `params T[]`, to ensure call sites get benefit from reduced allocations. + +That means adding a `params ReadOnlySpan<T>` overload to an API with a `params T[]` overload is a source breaking change. + +### Conclusions +Extend `params` support to `ReadOnlySpan<T>` only. + +`params ReadOnlySpan<T>` parameters should be implicitly `scoped`. + +Overload resolution should prefer `params ReadOnlySpan<T>` over `params T[]`. + +Consider support for `params scoped T[]` as an open question. ", "completion": "Create null-conditional-assignment.md "}
{"prompt": "diff --git a/meetings/working-groups/params-improvements/PI-2022-10-25.md b/meetings/working-groups/params-improvements/PI-2022-10-25.md new file mode 100644 index 0000000..6605f3a --- /dev/null +++ b/meetings/working-groups/params-improvements/PI-2022-10-25.md @@ -0,0 +1,64 @@ +# Params Improvements Working Group Meeting for October 25, 2022 +This was the first meeting of the _`params` improvements_ working group. +We discussed extending `params` support to collection types other than arrays. + +## Agenda +1. `params IEnumerable<T>`, `IList<T>`, etc. +1. `params List<T>`, `ImmutableArray<T>`, etc. +1. `params Span<T>`, `ReadOnlySpan<T>` +1. Overload resolution and backward compatibility + +## Discussion + +### Interfaces and collection types: `params IEnumerable<T>`, `List<T>`, etc. + +Perhaps the most common request is support for `params IEnumerable<T>`. + +This is potentially useful for scenarios where the `params` method simply iterates over the collection, and where callers might have an `IEnumerable<T>` instance rather than a `T[]` and are calling the method with _normal form_. +However, when callers use _expanded form_, a `params IEnumerable<T>` may not provide any advantage over `params T[]` to the caller or callee. + +If we extend `params` to support `IEnumerable<T>`, we should consider extending `params` support to other interface types and concrete collection types as well. +If so, what are the requirements of supported types? + +The [_collection literals working group_](https://github.com/dotnet/csharplang/tree/main/meetings/working-groups/collection-literals) is already defining similar requirements for _constructible collection types_. Those types can be `interface` types or concrete `class`, `struct`, and `ref struct` types. +The _collection literals_ proposal specifies how the corresponding collection instances for _constructible collection types_ are constructed and populated. + +Any additional `params` types should match the _collection literals_ approach. +That is, for any particular `params` type, the code generated for `WriteLine(fmt, a, b, c)` should be equivalent to the code generated for `WriteLine(fmt, [a, b, c])`. + +That said, the difference between an _expanded form_ call (with implicit collection) and a call using a _collection literal_ is just two characters, `[]`, so the advantage of `params` over _collection literals_ seems small. +Given that, we concluded we _should not extend `params`_ to arbitrary interfaces or collection types. + +### Spans: `params ReadOnlySpan<T>`, `Span<T>` + +`ReadOnlySpan<T>` has a couple of advantages over other potential `params` types. +1. With runtime support, the compiler could create spans at call sites without allocating an underlying array on the heap. +1. `T[]` and `Span<T>` are implicitly convertible to `ReadOnlySpan<T>`. + +That means `params ReadOnlySpan<T>` is a reasonable alternative to `params T[]` in new APIs. +And for existing APIs, adding a `params ReadOnlySpan<T>` overload could reduce allocations for current callers of a `params T[]` overload without changing the calling code. + +The potential perf benefit, and the opportunity to replace `params T[]` with `params ReadOnlySpan<T>` seem sufficiently important that we should support `params ReadOnlySpan<T>` even if _collection literals_ provide similar optimizations for span literals - that is, even if the difference between using `params` and using a _collection literal_ is simply `[]`. + +`Span<T>` has the same benefits as `ReadOnlySpan<T>`, but `Span<T>` is only preferable to `ReadOnlySpan<T>` if the `params` method modifies the span. +But modifying a `params` span is not a pattern we should encourage - in part because modifications are not visible to callers where the compiler generated the `Span<T>` instance. +In short, we concluded we should support `params ReadOnlySpan<T>` but not `params Span<T>`. + +`params ReadOnlySpan<T>` should be implicitly `scoped` so the compiler can reuse the implicitly generated `ReadOnlySpan<T>` instance across multiple calls in the calling method. + +Should we also support `params scoped T[]`, to allowing sharing the array across callers? + +### Overload resolution and backward compatibility + +Overload resolution should prefer an overload with `params ReadOnlySpan<T>` over an overload with `params T[]`, to ensure call sites get benefit from reduced allocations. + +That means adding a `params ReadOnlySpan<T>` overload to an API with a `params T[]` overload is a source breaking change. + +### Conclusions +Extend `params` support to `ReadOnlySpan<T>` only. + +`params ReadOnlySpan<T>` parameters should be implicitly `scoped`. + +Overload resolution should prefer `params ReadOnlySpan<T>` over `params T[]`. + +Consider support for `params scoped T[]` as an open question. diff --git a/proposals/null-conditional-assignment.md b/proposals/null-conditional-assignment.md new file mode 100644 index 0000000..45aba96 --- /dev/null +++ b/proposals/null-conditional-assignment.md @@ -0,0 +1,204 @@ +# Null-conditional assignment + +## Summary +[summary]: #summary + +Permits assignment to occur conditionally within a `a?.b` or `a?[b]` expression. + +```cs +using System; + +class C +{ + public object obj; +} + +void M(C? c) +{ + c?.obj = new object(); +} +``` + +```cs +using System; + +class C +{ + public event Action E; +} + +void M(C? c) +{ + c?.E += () => { Console.WriteLine(\"handled event E\"); }; +} +``` + +```cs +void M(object[]? arr) +{ + arr?[42] = new object(); +} + +``` +## Motivation +[motivation]: #motivation + +A variety of motivating use cases can be found in the championed issue. Major motivations include: +1. Parity between properties and `Set()` methods. +2. Attaching event handlers in UI code. + +## Detailed design +[design]: #detailed-design + +- The right side of the assignment is only evaluated when the receiver of the conditional access is non-null. +```cs +// M() is only executed if 'a' is non-null. +// note: the value of 'a.b' doesn't affect whether things are evaluated here. +a?.b = M(); +``` + +- All forms of compound assignment are allowed. +```cs +a?.b -= M(); // ok +a?.b += M(); // ok +// etc. +``` + +- If the result of the expression is used, the expression's type must be known to be of a value type or a reference type. This is consistent with existing behaviors on conditional accesses. +```cs +class C<T> +{ + public T? field; +} + +void M1<T>(C<T>? c, T t) +{ + (c?.field = t).ToString(); // error: 'T' cannot be made nullable. + c?.field = t; // ok +} +``` + +- Conditional access expressions are still not lvalues, and it's still not allowed to e.g. take a `ref` to them. +```cs +M(ref a?.b); // error +``` + +- It is not allowed to ref-assign to a conditional access. The main reason for this is that the only way you would conditionally access a ref variable is a ref field, and ref structs are forbidden from being used in nullable value types. If a valid scenario for a conditional ref-assignment came up in the future, we could add support at that time. +```cs +ref struct RS +{ + public ref int b; +} + +void M(RS a, ref int x) +{ + a?.b = ref x; // error: Operator '?' can't be applied to operand of type 'C'. +} +``` + +- It's not possible to e.g. assign to conditional accesses through deconstruction assignment. We anticipate it will be rare for people to want to do this, and not a significant drawback to need to do it over multiple separate assignment expressions instead. +```cs +(a?.b, c?.d) = (x, y); // error +``` + +### Specification +The *null conditional assignment* grammar is defined as follows: + +```antlr +null_conditional_assignment + : null_conditional_member_access assignment_operator expression + : null_conditional_element_access assignment_operator expression +``` +See [§11.7.7](https://github.com/dotnet/csharpstandard/blob/draft-v6/standard/expressions.md#1177-null-conditional-member-access) and [§11.7.11](https://github.com/dotnet/csharpstandard/blob/draft-v6/standard/expressions.md#11711-null-conditional-element-access) for reference. + +When the *null conditional assignment* appears in an expression-statement, its semantics are as follows: +- `P?.A = B` is equivalent to `if (P is not null) P.A = B;`, except that `P` is only evaluated once. +- `P?[A] = B` is equivalent to `if (P is not null) P[A] = B`, except that `P` is only evaluated once. + +Otherwise, its semantics are as follows: +- `P?.A = B` with result type `T` is equivalent to `(P is null) ? (T?)null : (P.A = B)`, except that `P` is only evaluated once. +- `P?[A] = B` with result type `T` is equivalent to `(P is null) ? (T?)null : (P[A] = B)`, except that `P` is only evaluated once. + +### Implementation +The grammar in the standard currently doesn't correspond strongly to the syntax design used in the implementation. We expect that to remain the case after this feature is implemented. The syntax design in the [implementation](https://github.com/dotnet/roslyn/blob/09408ab8a29e03caddfb11f29328c05169ac7cde/src/Compilers/CSharp/Portable/Syntax/Syntax.xml#L583-L607) isn't expected to actually change--only the way it is used will change. For example: + +```mermaid +graph TD; +subgraph ConditionalAccessExpression + whole[a?.b = c] +end +subgraph + direction LR; + subgraph Expression + whole-->a; + end + subgraph OperatorToken + whole-->?; + end + subgraph WhenNotNull + whole-->whenNotNull[.b = c]; + whenNotNull-->.b; + whenNotNull-->=; + whenNotNull-->c; + end +end +``` + +### Complex examples +```cs +class C +{ + ref int M() => /*...*/; +} + +void M(C? c) +{ + c?.M() = 42; // equivalent to: + if (c is not null) + c.M() = 42; +} +``` + +```cs +M(a?.b?.c = d); // equivalent to: +M(a is null + ? null + : (a.b is null + ? null + : (a.b.c = d)); +``` + +```cs +a?.b = c?.d = e?.f; // equivalent to: +a?.b = (c?.d = e?.f); +``` + +```cs +a?.b ??= c; // equivalent to: +if (a is not null) +{ + if (a.b is null) + { + a.b = c; + } +} +``` + +## Drawbacks +[drawbacks]: #drawbacks + +The choice to keep the assignment within the conditional access introduces some additional work for the IDE, which has many code paths which need to work backwards from an assignment to identifying the thing being assigned. + +## Alternatives +[alternatives]: #alternatives + +We could instead make the `?.` syntactically a child of the `=`. This makes it so any handling of `=` expressions needs to become aware of the conditionality of the right side in the presence of `?.` on the left. It also makes it so the structure of the syntax doesn't correspond as strongly to the semantics. + +## Unresolved questions +[unresolved]: #unresolved-questions + +## Design meetings + +* https://github.com/dotnet/csharplang/blob/main/meetings/2022/LDM-2022-04-27.md#null-conditional-assignment +* https://github.com/dotnet/csharplang/blob/main/meetings/2022/LDM-2022-08-31.md#null-conditional-assignment +* https://github.com/dotnet/csharplang/blob/main/meetings/2022/LDM-2022-10-26.md#null-conditional-assignment ", "completion": "Added notes from the first two DU working group meetings. "}
{"prompt": "diff --git a/meetings/working-groups/discriminated-unions/DU-2022-10-19.md b/meetings/working-groups/discriminated-unions/DU-2022-10-19.md new file mode 100644 index 0000000..7784439 --- /dev/null +++ b/meetings/working-groups/discriminated-unions/DU-2022-10-19.md @@ -0,0 +1,118 @@ +## Notes for October 19th, 2022 + +The theme of our first meeting was collecting scenarios that we think can be improved by discriminated unions, so we have an idea of what problems we're trying +to solve. + +### PageState + +```cs +public enum PageState +{ + NotLoaded, + Loading, + Loaded, + Errored +} + +public class Page { + PageState state; + + // used when state is Loaded + PageData data; + + // used when state is Errored + string errorMessage; + + + public View Render() { + switch (this.state) + { + case PageState.NotLoaded: + return ShowLoadButton(); + case PageState.Loading: + return ShowLoadingSpinner(); + case PageState.Loaded: + return ShowData(this.data!); + case PageState.Errored: + return ShowErrorMessage(this.errorMessage); + default: + throw Unreachable; + } + } +} + +class PageData { } + +class View { } +``` + +* UI App scenario +* Different page states - state machine transition +* Has some state fields that are only applicable when in a particular state + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Could be represented as a type hierarchy as well +* Should be able to remove `throw Unreachable;` +* Would you be able to define a `PageState.Show()`? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec This is the OO fashion, we're really talking more functional. + +### Web APIs + +```cs +[HttpGet(Name = \"GetWeatherForecast\")] +public IActionResult Get(int id) +{ + return id % 2 == 0 + ? Ok(Enumerable.Range(1, 5).Select(index => new WeatherForecast + { + Date = DateOnly.FromDateTime(DateTime.Now.AddDays(index)), + TemperatureC = Random.Shared.Next(-20, 55), + Summary = Summaries[Random.Shared.Next(Summaries.Length)] + }).ToArray()) + : NotFound(); +} + +app.MapGet(\"/minimal-dus/{id}\", Results<Ok<string>, ProblemHttpResult> (int id) => { + return id % 2 == 0 + ? TypedResults.Ok(\"Valid ID\") + : TypedResults.Problem(\"Invalid Id\"); +}); +``` + +* `IActionResult` is very common in MVC + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Worked around in minimal APIs by using `Results<TypeA, TypeB, ... TypeN>` (lots of versions of this, like ValueTuple) + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec All Results are `IResult`s + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Does it matter if it's anonymous in some fashion or explicitly declared by the user? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec What about subsets of the full union? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Just Ok or NotFound? +* Error recovery: `Optional` or `Result<TOk, TErr>` + +### IDE APIs + +* IDE: message passing where something could be a subset of a larger group of possibilities + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Heterogeneous data - not a subset of a larger type hierarchy. + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Painful and not checked today: can only be one of the tuple elements, but we have to pass around and check these in a non-straightforward fashion + +### Optional + +* Could we have semantics such that we can have a `Optional<T>` in the BCL +* Maybe an syntactic shortcut for this? +* Result type would be useful for type metadata decoding: currently we throw exceptions. +* Some sort of syntax help for short-circuiting these would be nice, a-la `?` in Rust. + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Would hopefully be able to apply not just to Ok/Result monads, but other kinds as well. + +### Type Hierarchy subsets + +https://github.com/dotnet/roslyn/blob/7b6fc9baa013ceb935973144543bcc422b8234d2/src/Compilers/CSharp/Portable/Binder/LockOrUsingBinder.cs#L44-L45 + +* More of an anonymous scenario +* Subset of a larger union - homogenous data +* Large DUs, such as SyntaxNode or BoundNode, are almost never useful as those large subsets. Smaller subsets, often defined ad-hoc, are usually what we want to work with. +* Large unions might be hard to add to existing projects without large refactorings. Some projects might be able to do this, but many won't. The BCL won't for their public APIs. + +### Generalized semantics + +* Are there advantages to targeting existing scenarios, and then having syntax that can make it easier to do? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Likely yes: will have wide compatibility with existing code. + +### Next meeting + +For next time, we will look at the commonalities in these scenarios and start looking at strategies for representing them. diff --git a/meetings/working-groups/discriminated-unions/DU-2022-10-24.md b/meetings/working-groups/discriminated-unions/DU-2022-10-24.md new file mode 100644 index 0000000..277ae2f --- /dev/null +++ b/meetings/working-groups/discriminated-unions/DU-2022-10-24.md @@ -0,0 +1,70 @@ +## Notes for October 24th, 2022 + +This meeting distilled the previous use case discussions to a few broad concepts of unions, and we talked about some basic features and tenants that we want to see in unions. + +### Concepts + +* `Result<TResult, TError>`/`Option<T>` + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Very interested in syntactic shortcuts here. + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Monads over the `T` inside + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Forces users handle errors up front + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Is short declaration of these types of unions necessary? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Maybe not? Maybe if the BCL ships Result/Option itself, people may not actually need to declare many of their own versions of these. +* Internal State with associated data + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec UI States + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec `BoundNode` + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Subsets of these are often useful: State machines only transitioning from X -> Y, not Z -> Y, or only accepting certain types of expressions. + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Anonymous definition of these might be useful. `(BoundLiteral | BoundMethodGroup)` inline, for example + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Simplifies handling of state and state transitions, potentially enforces explicit handling of cases. +* `OneOf<T1, ..., Tn>` + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Passing heterogeneous data around + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Anonymous defintion might also be useful + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec How would this reconcile with a homogeneous subset? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Potentially easier to integrate into existing codebases + +### Union versioning and compat + +* What's our compat strategy for public APIs with this type of union in them? +* Matters particularly in the same areas as variance: what happens when public apis start returning a new result? +* Or stop accepting a result variant? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Maybe this one doesn't matter as much? +* Source compatability in an return position is not guaranteed when reving a union type +* Binary compatability in a input position? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Historically, we've cared about this + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec If my public function accepts a new case, all existing code should still work + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec On the other hand, if I add a new input to some interface a consumer is implementing, they may get a case they weren't expecting +* In general, we're not worried about maintaining binary compatibility. We just want to make sure that API authors can be intentional about when they + want to make a breaking change and make it obvious that they did. +* Do we want to _ensure_ that binary breaks happen when users encounter new cases? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec No. If it falls out then it falls out, similar to required members. + +### Opaque unions + +* F# has these: +```fs +type C = + private // or internal + | Case1 of int +``` + + These create an interchange type that appears as a union to the file or assembly that created them, but is opaque to consumers. Do we need this? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec We think this is probably just existing base types/interfaces in C# + +### Exhaustiveness + +* List all valid subtypes in the base type? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Compiler error when adding a new type? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec This is Java's approach in JEP 409 - Sealed Classes +* For sufficiently large hierarchies, maybe exhaustiveness isn't always as useful as hoped? + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec May often be working on subsets, and forcing handling of all unexpected values might erode desired errors when adding new expected cases. + +### Conclusions + +* Subsets of larger unions keep coming up in our discussions, though we need to make sure we're not being overly colored by roslyn. + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Subsets of unions may call for an anonymous union syntax. + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Having different implementation details for sets of homogeneous data and sets of heterogeneous data would likely be confusing for users. A singular lowering + for subsets is likely needed. +* Compatability with existing forms is important. Users should not have to perform large refactorings to take advantage of any improvements we come up with here. + CODE-OF-CONDUCT.md Communities.md Language-Version-History.md README.md meetings proposals spec Importantly, we're not looking to deprecate existing forms of creating hierarchies. +* Experiencing source breaks when adding or removing new cases to unions is likely both unavoidable and desirable. We're ok with binary breaks as well, but won't + be attemping to _ensure_ that they occur. diff --git a/meetings/working-groups/params-improvements/PI-2022-10-25.md b/meetings/working-groups/params-improvements/PI-2022-10-25.md new file mode 100644 index 0000000..6605f3a --- /dev/null +++ b/meetings/working-groups/params-improvements/PI-2022-10-25.md @@ -0,0 +1,64 @@ +# Params Improvements Working Group Meeting for October 25, 2022 +This was the first meeting of the _`params` improvements_ working group. +We discussed extending `params` support to collection types other than arrays. + +## Agenda +1. `params IEnumerable<T>`, `IList<T>`, etc. +1. `params List<T>`, `ImmutableArray<T>`, etc. +1. `params Span<T>`, `ReadOnlySpan<T>` +1. Overload resolution and backward compatibility + +## Discussion + +### Interfaces and collection types: `params IEnumerable<T>`, `List<T>`, etc. + +Perhaps the most common request is support for `params IEnumerable<T>`. + +This is potentially useful for scenarios where the `params` method simply iterates over the collection, and where callers might have an `IEnumerable<T>` instance rather than a `T[]` and are calling the method with _normal form_. +However, when callers use _expanded form_, a `params IEnumerable<T>` may not provide any advantage over `params T[]` to the caller or callee. + +If we extend `params` to support `IEnumerable<T>`, we should consider extending `params` support to other interface types and concrete collection types as well. +If so, what are the requirements of supported types? + +The [_collection literals working group_](https://github.com/dotnet/csharplang/tree/main/meetings/working-groups/collection-literals) is already defining similar requirements for _constructible collection types_. Those types can be `interface` types or concrete `class`, `struct`, and `ref struct` types. +The _collection literals_ proposal specifies how the corresponding collection instances for _constructible collection types_ are constructed and populated. + +Any additional `params` types should match the _collection literals_ approach. +That is, for any particular `params` type, the code generated for `WriteLine(fmt, a, b, c)` should be equivalent to the code generated for `WriteLine(fmt, [a, b, c])`. + +That said, the difference between an _expanded form_ call (with implicit collection) and a call using a _collection literal_ is just two characters, `[]`, so the advantage of `params` over _collection literals_ seems small. +Given that, we concluded we _should not extend `params`_ to arbitrary interfaces or collection types. + +### Spans: `params ReadOnlySpan<T>`, `Span<T>` + +`ReadOnlySpan<T>` has a couple of advantages over other potential `params` types. +1. With runtime support, the compiler could create spans at call sites without allocating an underlying array on the heap. +1. `T[]` and `Span<T>` are implicitly convertible to `ReadOnlySpan<T>`. + +That means `params ReadOnlySpan<T>` is a reasonable alternative to `params T[]` in new APIs. +And for existing APIs, adding a `params ReadOnlySpan<T>` overload could reduce allocations for current callers of a `params T[]` overload without changing the calling code. + +The potential perf benefit, and the opportunity to replace `params T[]` with `params ReadOnlySpan<T>` seem sufficiently important that we should support `params ReadOnlySpan<T>` even if _collection literals_ provide similar optimizations for span literals - that is, even if the difference between using `params` and using a _collection literal_ is simply `[]`. + +`Span<T>` has the same benefits as `ReadOnlySpan<T>`, but `Span<T>` is only preferable to `ReadOnlySpan<T>` if the `params` method modifies the span. +But modifying a `params` span is not a pattern we should encourage - in part because modifications are not visible to callers where the compiler generated the `Span<T>` instance. +In short, we concluded we should support `params ReadOnlySpan<T>` but not `params Span<T>`. + +`params ReadOnlySpan<T>` should be implicitly `scoped` so the compiler can reuse the implicitly generated `ReadOnlySpan<T>` instance across multiple calls in the calling method. + +Should we also support `params scoped T[]`, to allowing sharing the array across callers? + +### Overload resolution and backward compatibility + +Overload resolution should prefer an overload with `params ReadOnlySpan<T>` over an overload with `params T[]`, to ensure call sites get benefit from reduced allocations. + +That means adding a `params ReadOnlySpan<T>` overload to an API with a `params T[]` overload is a source breaking change. + +### Conclusions +Extend `params` support to `ReadOnlySpan<T>` only. + +`params ReadOnlySpan<T>` parameters should be implicitly `scoped`. + +Overload resolution should prefer `params ReadOnlySpan<T>` over `params T[]`. + +Consider support for `params scoped T[]` as an open question. diff --git a/proposals/null-conditional-assignment.md b/proposals/null-conditional-assignment.md new file mode 100644 index 0000000..45aba96 --- /dev/null +++ b/proposals/null-conditional-assignment.md @@ -0,0 +1,204 @@ +# Null-conditional assignment + +## Summary +[summary]: #summary + +Permits assignment to occur conditionally within a `a?.b` or `a?[b]` expression. + +```cs +using System; + +class C +{ + public object obj; +} + +void M(C? c) +{ + c?.obj = new object(); +} +``` + +```cs +using System; + +class C +{ + public event Action E; +} + +void M(C? c) +{ + c?.E += () => { Console.WriteLine(\"handled event E\"); }; +} +``` + +```cs +void M(object[]? arr) +{ + arr?[42] = new object(); +} + +``` +## Motivation +[motivation]: #motivation + +A variety of motivating use cases can be found in the championed issue. Major motivations include: +1. Parity between properties and `Set()` methods. +2. Attaching event handlers in UI code. + +## Detailed design +[design]: #detailed-design + +- The right side of the assignment is only evaluated when the receiver of the conditional access is non-null. +```cs +// M() is only executed if 'a' is non-null. +// note: the value of 'a.b' doesn't affect whether things are evaluated here. +a?.b = M(); +``` + +- All forms of compound assignment are allowed. +```cs +a?.b -= M(); // ok +a?.b += M(); // ok +// etc. +``` + +- If the result of the expression is used, the expression's type must be known to be of a value type or a reference type. This is consistent with existing behaviors on conditional accesses. +```cs +class C<T> +{ + public T? field; +} + +void M1<T>(C<T>? c, T t) +{ + (c?.field = t).ToString(); // error: 'T' cannot be made nullable. + c?.field = t; // ok +} +``` + +- Conditional access expressions are still not lvalues, and it's still not allowed to e.g. take a `ref` to them. +```cs +M(ref a?.b); // error +``` + +- It is not allowed to ref-assign to a conditional access. The main reason for this is that the only way you would conditionally access a ref variable is a ref field, and ref structs are forbidden from being used in nullable value types. If a valid scenario for a conditional ref-assignment came up in the future, we could add support at that time. +```cs +ref struct RS +{ + public ref int b; +} + +void M(RS a, ref int x) +{ + a?.b = ref x; // error: Operator '?' can't be applied to operand of type 'C'. +} +``` + +- It's not possible to e.g. assign to conditional accesses through deconstruction assignment. We anticipate it will be rare for people to want to do this, and not a significant drawback to need to do it over multiple separate assignment expressions instead. +```cs +(a?.b, c?.d) = (x, y); // error +``` + +### Specification +The *null conditional assignment* grammar is defined as follows: + +```antlr +null_conditional_assignment + : null_conditional_member_access assignment_operator expression + : null_conditional_element_access assignment_operator expression +``` +See [§11.7.7](https://github.com/dotnet/csharpstandard/blob/draft-v6/standard/expressions.md#1177-null-conditional-member-access) and [§11.7.11](https://github.com/dotnet/csharpstandard/blob/draft-v6/standard/expressions.md#11711-null-conditional-element-access) for reference. + +When the *null conditional assignment* appears in an expression-statement, its semantics are as follows: +- `P?.A = B` is equivalent to `if (P is not null) P.A = B;`, except that `P` is only evaluated once. +- `P?[A] = B` is equivalent to `if (P is not null) P[A] = B`, except that `P` is only evaluated once. + +Otherwise, its semantics are as follows: +- `P?.A = B` with result type `T` is equivalent to `(P is null) ? (T?)null : (P.A = B)`, except that `P` is only evaluated once. +- `P?[A] = B` with result type `T` is equivalent to `(P is null) ? (T?)null : (P[A] = B)`, except that `P` is only evaluated once. + +### Implementation +The grammar in the standard currently doesn't correspond strongly to the syntax design used in the implementation. We expect that to remain the case after this feature is implemented. The syntax design in the [implementation](https://github.com/dotnet/roslyn/blob/09408ab8a29e03caddfb11f29328c05169ac7cde/src/Compilers/CSharp/Portable/Syntax/Syntax.xml#L583-L607) isn't expected to actually change--only the way it is used will change. For example: + +```mermaid +graph TD; +subgraph ConditionalAccessExpression + whole[a?.b = c] +end +subgraph + direction LR; + subgraph Expression + whole-->a; + end + subgraph OperatorToken + whole-->?; + end + subgraph WhenNotNull + whole-->whenNotNull[.b = c]; + whenNotNull-->.b; + whenNotNull-->=; + whenNotNull-->c; + end +end +``` + +### Complex examples +```cs +class C +{ + ref int M() => /*...*/; +} + +void M(C? c) +{ + c?.M() = 42; // equivalent to: + if (c is not null) + c.M() = 42; +} +``` + +```cs +M(a?.b?.c = d); // equivalent to: +M(a is null + ? null + : (a.b is null + ? null + : (a.b.c = d)); +``` + +```cs +a?.b = c?.d = e?.f; // equivalent to: +a?.b = (c?.d = e?.f); +``` + +```cs +a?.b ??= c; // equivalent to: +if (a is not null) +{ + if (a.b is null) + { + a.b = c; + } +} +``` + +## Drawbacks +[drawbacks]: #drawbacks + +The choice to keep the assignment within the conditional access introduces some additional work for the IDE, which has many code paths which need to work backwards from an assignment to identifying the thing being assigned. + +## Alternatives +[alternatives]: #alternatives + +We could instead make the `?.` syntactically a child of the `=`. This makes it so any handling of `=` expressions needs to become aware of the conditionality of the right side in the presence of `?.` on the left. It also makes it so the structure of the syntax doesn't correspond as strongly to the semantics. + +## Unresolved questions +[unresolved]: #unresolved-questions + +## Design meetings + +* https://github.com/dotnet/csharplang/blob/main/meetings/2022/LDM-2022-04-27.md#null-conditional-assignment +* https://github.com/dotnet/csharplang/blob/main/meetings/2022/LDM-2022-08-31.md#null-conditional-assignment +* https://github.com/dotnet/csharplang/blob/main/meetings/2022/LDM-2022-10-26.md#null-conditional-assignment ", "completion": "Another wording fix. "}
{"prompt": "diff --git a/readme.md b/readme.md index e6461fbfb..f8c848a76 100644 --- a/readme.md +++ b/readme.md @@ -311,7 +311,7 @@ The following fonts are available via [AUR packages](https://aur.archlinux.org/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_cn.md b/readme_cn.md index 2c76bba5b..b4dc6cd8d 100644 --- a/readme_cn.md +++ b/readme_cn.md @@ -337,7 +337,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_es.md b/readme_es.md index be7559072..13eae4f47 100644 --- a/readme_es.md +++ b/readme_es.md @@ -284,7 +284,7 @@ las siguientes fuentes están disponibles como [paquetes AUR](https://aur.archli 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_fr.md b/readme_fr.md index 85c9b4cb9..51dffc443 100644 --- a/readme_fr.md +++ b/readme_fr.md @@ -362,7 +362,7 @@ Les polices suivantes sont disponibles via [AUR packages](https://aur.archlinux. 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_hi.md b/readme_hi.md index 22d2bf44d..a4152ed89 100644 --- a/readme_hi.md +++ b/readme_hi.md @@ -308,7 +308,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_it.md b/readme_it.md index 644f4893a..a3983caa9 100644 --- a/readme_it.md +++ b/readme_it.md @@ -285,7 +285,7 @@ I seguenti font sono disponibili attraverso i [pacchetti AUR](https://aur.archli 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ja.md b/readme_ja.md index da60cffeb..2a5169ac5 100644 --- a/readme_ja.md +++ b/readme_ja.md @@ -281,7 +281,7 @@ Arch Linux 上の [AUR packages](https://aur.archlinux.org/) で以下のフォ 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ko.md b/readme_ko.md index 6681d887a..d461e95a8 100644 --- a/readme_ko.md +++ b/readme_ko.md @@ -283,7 +283,7 @@ Arch Linux의 [AUR packages](https://aur.archlinux.org/)를 통해 아래 폰트 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_pl.md b/readme_pl.md index 63af6539a..424d0b6da 100644 --- a/readme_pl.md +++ b/readme_pl.md @@ -357,7 +357,7 @@ Następujące czcionki są dostępne za pośrednictwem [Pakietów AUR](https://a 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_pt-pt.md b/readme_pt-pt.md index 1ee36a789..530c163c9 100644 --- a/readme_pt-pt.md +++ b/readme_pt-pt.md @@ -281,7 +281,7 @@ Os seguintes tipos de letra estão disponíveis nos [pacotes do AUR](https://aur 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ru.md b/readme_ru.md index a925984e6..092e48f55 100644 --- a/readme_ru.md +++ b/readme_ru.md @@ -337,7 +337,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_tw.md b/readme_tw.md index 076730571..887fc08d4 100644 --- a/readme_tw.md +++ b/readme_tw.md @@ -310,7 +310,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet - [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) - [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) - [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -- [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +- [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) - [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) - [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) - [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_uk.md b/readme_uk.md index b396d68f6..8c7291fd3 100644 --- a/readme_uk.md +++ b/readme_uk.md @@ -283,7 +283,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) ", "completion": "Merge pull request #981 from ryanoasis/bugfix/licenses-in-archives Bugfix licenses in archives "}
{"prompt": "diff --git a/license-audit.md b/license-audit.md index aeeb9eef3..079703dd5 100644 --- a/license-audit.md +++ b/license-audit.md @@ -32,6 +32,7 @@ All files created such as `font-patcher` and any `ph` or `sh` script/source file | Project | License | | ------------------------------------------------ | ----------------| +| Codicons | CC BY 4.0 | | Devicons | MIT | | Font Awesome | SIL OFL 1.1 | | Font Awesome Extension | MIT | diff --git a/readme.md b/readme.md index e6461fbfb..f8c848a76 100644 --- a/readme.md +++ b/readme.md @@ -311,7 +311,7 @@ The following fonts are available via [AUR packages](https://aur.archlinux.org/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_cn.md b/readme_cn.md index 2c76bba5b..b4dc6cd8d 100644 --- a/readme_cn.md +++ b/readme_cn.md @@ -337,7 +337,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_es.md b/readme_es.md index be7559072..13eae4f47 100644 --- a/readme_es.md +++ b/readme_es.md @@ -284,7 +284,7 @@ las siguientes fuentes están disponibles como [paquetes AUR](https://aur.archli 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_fr.md b/readme_fr.md index 85c9b4cb9..51dffc443 100644 --- a/readme_fr.md +++ b/readme_fr.md @@ -362,7 +362,7 @@ Les polices suivantes sont disponibles via [AUR packages](https://aur.archlinux. 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_hi.md b/readme_hi.md index 22d2bf44d..a4152ed89 100644 --- a/readme_hi.md +++ b/readme_hi.md @@ -308,7 +308,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_it.md b/readme_it.md index 644f4893a..a3983caa9 100644 --- a/readme_it.md +++ b/readme_it.md @@ -285,7 +285,7 @@ I seguenti font sono disponibili attraverso i [pacchetti AUR](https://aur.archli 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ja.md b/readme_ja.md index da60cffeb..2a5169ac5 100644 --- a/readme_ja.md +++ b/readme_ja.md @@ -281,7 +281,7 @@ Arch Linux 上の [AUR packages](https://aur.archlinux.org/) で以下のフォ 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ko.md b/readme_ko.md index 6681d887a..d461e95a8 100644 --- a/readme_ko.md +++ b/readme_ko.md @@ -283,7 +283,7 @@ Arch Linux의 [AUR packages](https://aur.archlinux.org/)를 통해 아래 폰트 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_pl.md b/readme_pl.md index 63af6539a..424d0b6da 100644 --- a/readme_pl.md +++ b/readme_pl.md @@ -357,7 +357,7 @@ Następujące czcionki są dostępne za pośrednictwem [Pakietów AUR](https://a 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_pt-pt.md b/readme_pt-pt.md index 1ee36a789..530c163c9 100644 --- a/readme_pt-pt.md +++ b/readme_pt-pt.md @@ -281,7 +281,7 @@ Os seguintes tipos de letra estão disponíveis nos [pacotes do AUR](https://aur 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ru.md b/readme_ru.md index a925984e6..092e48f55 100644 --- a/readme_ru.md +++ b/readme_ru.md @@ -337,7 +337,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_tw.md b/readme_tw.md index 076730571..887fc08d4 100644 --- a/readme_tw.md +++ b/readme_tw.md @@ -310,7 +310,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet - [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) - [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) - [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -- [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +- [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) - [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) - [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) - [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_uk.md b/readme_uk.md index b396d68f6..8c7291fd3 100644 --- a/readme_uk.md +++ b/readme_uk.md @@ -283,7 +283,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) ", "completion": "patch-em-all: Purge old license files [why] Old (renamed) license files are not cleaned up automatically. The new files will be put into the patched-fonts dir, but old ones not removed. [how] With commit afd7ba10 patch-em-all: Purge destination dirs if possible the script purges old font files from the patched-fonts directory to get rid of renamed font files. This has been deliberately limited to ttf and otf files. But as all license files are automatically copied over we can also remove them. This (finally) remove the possibility to manually put any files in those directories. This can be good or bad. Signed-off-by: Fini Jastrow <ulf.fini.jastrow@desy.de> "}
{"prompt": "diff --git a/bin/scripts/gotta-patch-em-all-font-patcher!.sh b/bin/scripts/gotta-patch-em-all-font-patcher!.sh index 4fda09ff1..9e8a6b92e 100755 --- a/bin/scripts/gotta-patch-em-all-font-patcher!.sh +++ b/bin/scripts/gotta-patch-em-all-font-patcher!.sh @@ -92,7 +92,7 @@ function patch_font { if [ -n ${purge} -a -d \"${patched_font_dir}complete\" ] then echo \"Purging patched font dir ${patched_font_dir}complete\" - rm ${patched_font_dir}complete/*.[to]tf + rm ${patched_font_dir}complete/* fi config_parent_dir=$( cd \"$( dirname \"$f\" )\" && cd \"..\" && pwd) diff --git a/license-audit.md b/license-audit.md index aeeb9eef3..079703dd5 100644 --- a/license-audit.md +++ b/license-audit.md @@ -32,6 +32,7 @@ All files created such as `font-patcher` and any `ph` or `sh` script/source file | Project | License | | ------------------------------------------------ | ----------------| +| Codicons | CC BY 4.0 | | Devicons | MIT | | Font Awesome | SIL OFL 1.1 | | Font Awesome Extension | MIT | diff --git a/readme.md b/readme.md index e6461fbfb..f8c848a76 100644 --- a/readme.md +++ b/readme.md @@ -311,7 +311,7 @@ The following fonts are available via [AUR packages](https://aur.archlinux.org/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_cn.md b/readme_cn.md index 2c76bba5b..b4dc6cd8d 100644 --- a/readme_cn.md +++ b/readme_cn.md @@ -337,7 +337,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_es.md b/readme_es.md index be7559072..13eae4f47 100644 --- a/readme_es.md +++ b/readme_es.md @@ -284,7 +284,7 @@ las siguientes fuentes están disponibles como [paquetes AUR](https://aur.archli 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_fr.md b/readme_fr.md index 85c9b4cb9..51dffc443 100644 --- a/readme_fr.md +++ b/readme_fr.md @@ -362,7 +362,7 @@ Les polices suivantes sont disponibles via [AUR packages](https://aur.archlinux. 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_hi.md b/readme_hi.md index 22d2bf44d..a4152ed89 100644 --- a/readme_hi.md +++ b/readme_hi.md @@ -308,7 +308,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_it.md b/readme_it.md index 644f4893a..a3983caa9 100644 --- a/readme_it.md +++ b/readme_it.md @@ -285,7 +285,7 @@ I seguenti font sono disponibili attraverso i [pacchetti AUR](https://aur.archli 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ja.md b/readme_ja.md index da60cffeb..2a5169ac5 100644 --- a/readme_ja.md +++ b/readme_ja.md @@ -281,7 +281,7 @@ Arch Linux 上の [AUR packages](https://aur.archlinux.org/) で以下のフォ 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ko.md b/readme_ko.md index 6681d887a..d461e95a8 100644 --- a/readme_ko.md +++ b/readme_ko.md @@ -283,7 +283,7 @@ Arch Linux의 [AUR packages](https://aur.archlinux.org/)를 통해 아래 폰트 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_pl.md b/readme_pl.md index 63af6539a..424d0b6da 100644 --- a/readme_pl.md +++ b/readme_pl.md @@ -357,7 +357,7 @@ Następujące czcionki są dostępne za pośrednictwem [Pakietów AUR](https://a 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_pt-pt.md b/readme_pt-pt.md index 1ee36a789..530c163c9 100644 --- a/readme_pt-pt.md +++ b/readme_pt-pt.md @@ -281,7 +281,7 @@ Os seguintes tipos de letra estão disponíveis nos [pacotes do AUR](https://aur 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_ru.md b/readme_ru.md index a925984e6..092e48f55 100644 --- a/readme_ru.md +++ b/readme_ru.md @@ -337,7 +337,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_tw.md b/readme_tw.md index 076730571..887fc08d4 100644 --- a/readme_tw.md +++ b/readme_tw.md @@ -310,7 +310,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet - [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) - [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) - [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -- [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +- [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) - [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) - [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) - [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) diff --git a/readme_uk.md b/readme_uk.md index b396d68f6..8c7291fd3 100644 --- a/readme_uk.md +++ b/readme_uk.md @@ -283,7 +283,7 @@ cd ~/Library/Fonts && curl -fLo \"Droid Sans Mono for Powerline Nerd Font Complet 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts DejaVu Complete](https://aur.archlinux.org/packages/nerd-fonts-dejavu-complete/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Fira Code](https://aur.archlinux.org/packages/nerd-fonts-fira-code/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Go Mono](https://aur.archlinux.org/packages/nerd-fonts-go-mono/) -* [Nerd Fonts Hack](https://aur.archlinux.org/packages/nerd-fonts-hack/) +* [Nerd Fonts Hack](https://archlinux.org/packages/community/any/ttf-hack-nerd/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Inconsolata](https://aur.archlinux.org/packages/nerd-fonts-inconsolata/) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Jetbrains Mono](https://aur.archlinux.org/packages/nerd-fonts-jetbrains-mono) 10-nerd-font-symbols.conf CONTRIBUTORS.md Dockerfile LICENSE backers.md bin changelog.md chocolatey code_of_conduct.md contributing.md css font-patcher images install.ps1 install.sh license-audit.md package.json patched-fonts readme.md readme_cn.md readme_es.md readme_fr.md readme_hi.md readme_it.md readme_ja.md readme_ko.md readme_pl.md readme_pt-pt.md readme_ru.md readme_tw.md readme_uk.md src [Nerd Fonts Liberation Mono](https://aur.archlinux.org/packages/nerd-fonts-liberation-mono/) ", "completion": "Add missing LICENSE files (simulate CI) In fact these would/will be recreated on a gotta-patch-em-all-font-patcher!.sh run. Signed-off-by: Fini Jastrow <ulf.fini.jastrow@desy.de> "}
{"prompt": "diff --git a/README.md b/README.md index e5b3295..47956ff 100644 --- a/README.md +++ b/README.md @@ -8,7 +8,7 @@ EasyExcel [QQ2群(已满): 1097936804](https://jq.qq.com/?_wv=1027&k=j5zEy6Xl) [QQ3群(已满): 453928496](https://qm.qq.com/cgi-bin/qm/qr?k=e2ULsA5A0GldhV2CXJ8sIbAyu9I6qqs7&jump_from=webapi) [QQ4群(已满): 496594404](https://qm.qq.com/cgi-bin/qm/qr?k=e_aVG1Q7gi0PJUBkbrUGAgbeO3kUEInK&jump_from=webapi) -[QQ5群: 203228638](https://jq.qq.com/?_wv=1027&k=m9kqpoV6) +[QQ5群: 451925680](https://jq.qq.com/?_wv=1027&k=BbLBIo9P) [钉钉1群（已满）: 21960511](https://qr.dingtalk.com/action/joingroup?code=v1,k1,cchz6k12ci9B08NNqhNRFGXocNVHrZtW0kaOtTKg/Rk=&_dt_no_comment=1&origin=11) [钉钉2群（已满）: 32796397](https://qr.dingtalk.com/action/joingroup?code=v1,k1,jyU9GtEuNU5S0QTyklqYcYJ8qDZtUuTPMM7uPZTS8Hs=&_dt_no_comment=1&origin=11) [钉钉3群（已满）: 33797247](https://qr.dingtalk.com/action/joingroup?code=v1,k1,3UGlEScTGQaHpW2cIRo+gkxJ9EVZ5fz26M6nW3uFP30=&_dt_no_comment=1&origin=11) ", "completion": "Update README.md 新增群聊 "}
{"prompt": "diff --git a/README.md b/README.md index 69ef6c8..47956ff 100644 --- a/README.md +++ b/README.md @@ -8,14 +8,15 @@ EasyExcel [QQ2群(已满): 1097936804](https://jq.qq.com/?_wv=1027&k=j5zEy6Xl) [QQ3群(已满): 453928496](https://qm.qq.com/cgi-bin/qm/qr?k=e2ULsA5A0GldhV2CXJ8sIbAyu9I6qqs7&jump_from=webapi) [QQ4群(已满): 496594404](https://qm.qq.com/cgi-bin/qm/qr?k=e_aVG1Q7gi0PJUBkbrUGAgbeO3kUEInK&jump_from=webapi) -[QQ5群: 203228638](https://jq.qq.com/?_wv=1027&k=m9kqpoV6) +[QQ5群: 451925680](https://jq.qq.com/?_wv=1027&k=BbLBIo9P) [钉钉1群（已满）: 21960511](https://qr.dingtalk.com/action/joingroup?code=v1,k1,cchz6k12ci9B08NNqhNRFGXocNVHrZtW0kaOtTKg/Rk=&_dt_no_comment=1&origin=11) [钉钉2群（已满）: 32796397](https://qr.dingtalk.com/action/joingroup?code=v1,k1,jyU9GtEuNU5S0QTyklqYcYJ8qDZtUuTPMM7uPZTS8Hs=&_dt_no_comment=1&origin=11) [钉钉3群（已满）: 33797247](https://qr.dingtalk.com/action/joingroup?code=v1,k1,3UGlEScTGQaHpW2cIRo+gkxJ9EVZ5fz26M6nW3uFP30=&_dt_no_comment=1&origin=11) [钉钉4群（已满）: 33491624](https://qr.dingtalk.com/action/joingroup?code=v1,k1,V14Pb65Too70rQkEaJ9ohb6lZBZbtp6jIL/q9EWh9vA=&_dt_no_comment=1&origin=11) [钉钉5群（已满）: 32134498](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingb9fa1325d9dccc3ecac589edd02f1650&5233a=71a83&cbdbhh=qwertyuiop) [钉钉6群（已满）: 34707941](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingcf68008a1d443ac012d5427bdb061b7a&6ae36c3d-0c80-4=22398493-6c2a-4&cbdbhh=qwertyuiop) -[钉钉7群: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉7群（已满）: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉8群: 44752220](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingea96808beee421693fd4ba7542d6e5da&0380092a-fa46=a6a40905-7951&cbdbhh=qwertyuiop) [官方网站: https://easyexcel.opensource.alibaba.com/](https://easyexcel.opensource.alibaba.com/) ", "completion": "修改pom name "}
{"prompt": "diff --git a/README.md b/README.md index 69ef6c8..47956ff 100644 --- a/README.md +++ b/README.md @@ -8,14 +8,15 @@ EasyExcel [QQ2群(已满): 1097936804](https://jq.qq.com/?_wv=1027&k=j5zEy6Xl) [QQ3群(已满): 453928496](https://qm.qq.com/cgi-bin/qm/qr?k=e2ULsA5A0GldhV2CXJ8sIbAyu9I6qqs7&jump_from=webapi) [QQ4群(已满): 496594404](https://qm.qq.com/cgi-bin/qm/qr?k=e_aVG1Q7gi0PJUBkbrUGAgbeO3kUEInK&jump_from=webapi) -[QQ5群: 203228638](https://jq.qq.com/?_wv=1027&k=m9kqpoV6) +[QQ5群: 451925680](https://jq.qq.com/?_wv=1027&k=BbLBIo9P) [钉钉1群（已满）: 21960511](https://qr.dingtalk.com/action/joingroup?code=v1,k1,cchz6k12ci9B08NNqhNRFGXocNVHrZtW0kaOtTKg/Rk=&_dt_no_comment=1&origin=11) [钉钉2群（已满）: 32796397](https://qr.dingtalk.com/action/joingroup?code=v1,k1,jyU9GtEuNU5S0QTyklqYcYJ8qDZtUuTPMM7uPZTS8Hs=&_dt_no_comment=1&origin=11) [钉钉3群（已满）: 33797247](https://qr.dingtalk.com/action/joingroup?code=v1,k1,3UGlEScTGQaHpW2cIRo+gkxJ9EVZ5fz26M6nW3uFP30=&_dt_no_comment=1&origin=11) [钉钉4群（已满）: 33491624](https://qr.dingtalk.com/action/joingroup?code=v1,k1,V14Pb65Too70rQkEaJ9ohb6lZBZbtp6jIL/q9EWh9vA=&_dt_no_comment=1&origin=11) [钉钉5群（已满）: 32134498](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingb9fa1325d9dccc3ecac589edd02f1650&5233a=71a83&cbdbhh=qwertyuiop) [钉钉6群（已满）: 34707941](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingcf68008a1d443ac012d5427bdb061b7a&6ae36c3d-0c80-4=22398493-6c2a-4&cbdbhh=qwertyuiop) -[钉钉7群: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉7群（已满）: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉8群: 44752220](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingea96808beee421693fd4ba7542d6e5da&0380092a-fa46=a6a40905-7951&cbdbhh=qwertyuiop) [官方网站: https://easyexcel.opensource.alibaba.com/](https://easyexcel.opensource.alibaba.com/) diff --git a/easyexcel-core/pom.xml b/easyexcel-core/pom.xml index 4f03d71..d6e5800 100644 --- a/easyexcel-core/pom.xml +++ b/easyexcel-core/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel-core</artifactId> + <name>easyexcel-core</name> <dependencies> <dependency> diff --git a/easyexcel-support/pom.xml b/easyexcel-support/pom.xml index d15b0d7..db2dbd3 100644 --- a/easyexcel-support/pom.xml +++ b/easyexcel-support/pom.xml @@ -13,6 +13,8 @@ <packaging>jar</packaging> <artifactId>easyexcel-support</artifactId> + <name>easyexcel-support</name> + <dependencies> <dependency> diff --git a/easyexcel-test/pom.xml b/easyexcel-test/pom.xml index f802f24..80821db 100644 --- a/easyexcel-test/pom.xml +++ b/easyexcel-test/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel-test</artifactId> + <name>easyexcel-test</name> <properties> <maven.deploy.skip>true</maven.deploy.skip> diff --git a/easyexcel/pom.xml b/easyexcel/pom.xml index 303f79a..495552c 100644 --- a/easyexcel/pom.xml +++ b/easyexcel/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel</artifactId> + <name>easyexcel</name> <dependencies> ", "completion": "Merge pull request #2533 from alibaba/developing Developing "}
{"prompt": "diff --git a/README.md b/README.md index 69ef6c8..47956ff 100644 --- a/README.md +++ b/README.md @@ -8,14 +8,15 @@ EasyExcel [QQ2群(已满): 1097936804](https://jq.qq.com/?_wv=1027&k=j5zEy6Xl) [QQ3群(已满): 453928496](https://qm.qq.com/cgi-bin/qm/qr?k=e2ULsA5A0GldhV2CXJ8sIbAyu9I6qqs7&jump_from=webapi) [QQ4群(已满): 496594404](https://qm.qq.com/cgi-bin/qm/qr?k=e_aVG1Q7gi0PJUBkbrUGAgbeO3kUEInK&jump_from=webapi) -[QQ5群: 203228638](https://jq.qq.com/?_wv=1027&k=m9kqpoV6) +[QQ5群: 451925680](https://jq.qq.com/?_wv=1027&k=BbLBIo9P) [钉钉1群（已满）: 21960511](https://qr.dingtalk.com/action/joingroup?code=v1,k1,cchz6k12ci9B08NNqhNRFGXocNVHrZtW0kaOtTKg/Rk=&_dt_no_comment=1&origin=11) [钉钉2群（已满）: 32796397](https://qr.dingtalk.com/action/joingroup?code=v1,k1,jyU9GtEuNU5S0QTyklqYcYJ8qDZtUuTPMM7uPZTS8Hs=&_dt_no_comment=1&origin=11) [钉钉3群（已满）: 33797247](https://qr.dingtalk.com/action/joingroup?code=v1,k1,3UGlEScTGQaHpW2cIRo+gkxJ9EVZ5fz26M6nW3uFP30=&_dt_no_comment=1&origin=11) [钉钉4群（已满）: 33491624](https://qr.dingtalk.com/action/joingroup?code=v1,k1,V14Pb65Too70rQkEaJ9ohb6lZBZbtp6jIL/q9EWh9vA=&_dt_no_comment=1&origin=11) [钉钉5群（已满）: 32134498](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingb9fa1325d9dccc3ecac589edd02f1650&5233a=71a83&cbdbhh=qwertyuiop) [钉钉6群（已满）: 34707941](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingcf68008a1d443ac012d5427bdb061b7a&6ae36c3d-0c80-4=22398493-6c2a-4&cbdbhh=qwertyuiop) -[钉钉7群: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉7群（已满）: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉8群: 44752220](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingea96808beee421693fd4ba7542d6e5da&0380092a-fa46=a6a40905-7951&cbdbhh=qwertyuiop) [官方网站: https://easyexcel.opensource.alibaba.com/](https://easyexcel.opensource.alibaba.com/) diff --git a/easyexcel-core/pom.xml b/easyexcel-core/pom.xml index 4f03d71..d6e5800 100644 --- a/easyexcel-core/pom.xml +++ b/easyexcel-core/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel-core</artifactId> + <name>easyexcel-core</name> <dependencies> <dependency> diff --git a/easyexcel-support/pom.xml b/easyexcel-support/pom.xml index d15b0d7..db2dbd3 100644 --- a/easyexcel-support/pom.xml +++ b/easyexcel-support/pom.xml @@ -13,6 +13,8 @@ <packaging>jar</packaging> <artifactId>easyexcel-support</artifactId> + <name>easyexcel-support</name> + <dependencies> <dependency> diff --git a/easyexcel-test/pom.xml b/easyexcel-test/pom.xml index f802f24..80821db 100644 --- a/easyexcel-test/pom.xml +++ b/easyexcel-test/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel-test</artifactId> + <name>easyexcel-test</name> <properties> <maven.deploy.skip>true</maven.deploy.skip> diff --git a/easyexcel/pom.xml b/easyexcel/pom.xml index 303f79a..495552c 100644 --- a/easyexcel/pom.xml +++ b/easyexcel/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel</artifactId> + <name>easyexcel</name> <dependencies> ", "completion": "修改readme "}
{"prompt": "diff --git a/README.md b/README.md index 0dff1ea..47956ff 100644 --- a/README.md +++ b/README.md @@ -8,14 +8,15 @@ EasyExcel [QQ2群(已满): 1097936804](https://jq.qq.com/?_wv=1027&k=j5zEy6Xl) [QQ3群(已满): 453928496](https://qm.qq.com/cgi-bin/qm/qr?k=e2ULsA5A0GldhV2CXJ8sIbAyu9I6qqs7&jump_from=webapi) [QQ4群(已满): 496594404](https://qm.qq.com/cgi-bin/qm/qr?k=e_aVG1Q7gi0PJUBkbrUGAgbeO3kUEInK&jump_from=webapi) -[QQ5群: 203228638](https://jq.qq.com/?_wv=1027&k=m9kqpoV6) +[QQ5群: 451925680](https://jq.qq.com/?_wv=1027&k=BbLBIo9P) [钉钉1群（已满）: 21960511](https://qr.dingtalk.com/action/joingroup?code=v1,k1,cchz6k12ci9B08NNqhNRFGXocNVHrZtW0kaOtTKg/Rk=&_dt_no_comment=1&origin=11) [钉钉2群（已满）: 32796397](https://qr.dingtalk.com/action/joingroup?code=v1,k1,jyU9GtEuNU5S0QTyklqYcYJ8qDZtUuTPMM7uPZTS8Hs=&_dt_no_comment=1&origin=11) [钉钉3群（已满）: 33797247](https://qr.dingtalk.com/action/joingroup?code=v1,k1,3UGlEScTGQaHpW2cIRo+gkxJ9EVZ5fz26M6nW3uFP30=&_dt_no_comment=1&origin=11) [钉钉4群（已满）: 33491624](https://qr.dingtalk.com/action/joingroup?code=v1,k1,V14Pb65Too70rQkEaJ9ohb6lZBZbtp6jIL/q9EWh9vA=&_dt_no_comment=1&origin=11) [钉钉5群（已满）: 32134498](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingb9fa1325d9dccc3ecac589edd02f1650&5233a=71a83&cbdbhh=qwertyuiop) [钉钉6群（已满）: 34707941](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingcf68008a1d443ac012d5427bdb061b7a&6ae36c3d-0c80-4=22398493-6c2a-4&cbdbhh=qwertyuiop) -[钉钉7群: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉7群（已满）: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉8群: 44752220](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingea96808beee421693fd4ba7542d6e5da&0380092a-fa46=a6a40905-7951&cbdbhh=qwertyuiop) [官方网站: https://easyexcel.opensource.alibaba.com/](https://easyexcel.opensource.alibaba.com/) @@ -29,63 +30,19 @@ Java解析、生成Excel比较有名的框架有Apache poi、jxl。但他们都 当然还有[极速模式](https://easyexcel.opensource.alibaba.com/qa/read#%E5%BC%80%E5%90%AF%E6%80%A5%E9%80%9F%E6%A8%A1%E5%BC%8F)能更快，但是内存占用会在100M多一点 ![img](img/readme/large.png) -## 关于版本选择 -如果项目中没有使用过poi,且jdk版本在8-17之间，直接使用最新版本，别犹豫。以下表格适用于不满足以上2个情况的。 - -| 版本 | poi依赖版本 (支持范围) | jdk版本支持范围 | 备注 | -|--------------------|-----------------------|--------------|---------------------------------------------| -| 3.1.0+ | 4.1.2 (4.1.2 - 5.2.2) | jkd8 - jdk17 | 推荐使用，会更新的版本 | -| 3.0.0-beta1 - 3.0.5 | 4.1.2 (4.1.2 - 5.2.2) | jkd8 - jdk11 | 不推荐项目新引入此版本，除非超级严重bug,否则不再更新 | -| 2.0.0-beta1-2.2.11 | 3.17 (3.17 - 4.1.2) | jdk6 - jdk11 | 不推荐项目新引入此版本，除非是jdk6否则不推荐使用，除非超级严重bug,否则不再更新 | -| 1+版本 | 3.17 (3.17 - 4.1.2) | jdk6 - jdk11 | 不推荐项目新引入此版本，超级严重bug,也不再更新 | - -注意： 3+版本的的easyexcel，使用poi 5+版本时，需要手动排除：poi-ooxml-schemas，例如： -```xml - <dependency> - <groupId>com.alibaba</groupId> - <artifactId>easyexcel</artifactId> - <version>3.1.1</version> - <exclusions> - <exclusion> - <artifactId>poi-ooxml-schemas</artifactId> - <groupId>org.apache.poi</groupId> - </exclusion> - </exclusions> -</dependency> -``` - -### 关于版本升级 -* 不建议跨大版本升级 尤其跨2个大版本 -* 2+ 升级到 3+ 一些不兼容的地方 - CONTRIBUTING.md LICENSE README.md README_EN.md docs easyexcel easyexcel-core easyexcel-support easyexcel-test easyexcel_en.md img lombok.config mvnw mvnw.cmd pom.xml quickstart.md src style update.md 使用了自定义拦截器去修改样式的会出问题（不会编译报错） - CONTRIBUTING.md LICENSE README.md README_EN.md docs easyexcel easyexcel-core easyexcel-support easyexcel-test easyexcel_en.md img lombok.config mvnw mvnw.cmd pom.xml quickstart.md src style update.md 读的时候`invoke`里面抛出异常，不会再额外封装一层`ExcelAnalysisException` （不会编译报错） - CONTRIBUTING.md LICENSE README.md README_EN.md docs easyexcel easyexcel-core easyexcel-support easyexcel-test easyexcel_en.md img lombok.config mvnw mvnw.cmd pom.xml quickstart.md src style update.md 样式等注解涉及到 `boolean` or 一些枚举 值的 有变动，新增默认值（会编译报错，注解改就行） -* 大版本升级后建议相关内容重新测试下 - ### 最新版本 ```xml <dependency> <groupId>com.alibaba</groupId> <artifactId>easyexcel</artifactId> - <version>3.1.0</version> + <version>3.1.1</version> </dependency> ``` -### easyexcel人员招募 -由于工作较忙,有意愿做开源的同学可以报名,主要负责群里回答&issue处理，当然也可以做一些PR. -由于开源没有任何物质回报，然后现在的维护同学也是课余时间维护的，所以想加入的同学需要持之以恒，而不是一时兴起. -要求如下： -* 有一定java编码能力 & 良好的编码习惯 -* 了解easyexcel 读&写的原理 -* 热爱开源项目 -* 能长期坚持的去做 -* 相对工作没那么忙 - ## 相关文档 -* [快速开始](https://www.yuque.com/easyexcel/doc/easyexcel) -* [关于软件](/abouteasyexcel.md) +* [快速开始](https://easyexcel.opensource.alibaba.com/docs/current/) CONTRIBUTING.md LICENSE README.md README_EN.md docs easyexcel easyexcel-core easyexcel-support easyexcel-test easyexcel_en.md img lombok.config mvnw mvnw.cmd pom.xml quickstart.md src style update.md [更新记事](/update.md) -* [贡献代码](https://www.yuque.com/easyexcel/doc/contribute) +* [贡献代码](https://easyexcel.opensource.alibaba.com/community/contribute) ## 维护者 姬朋飞（玉霄)、庄家钜、怀宇 diff --git a/abouteasyexcel.md b/abouteasyexcel.md deleted file mode 100644 index 54a4e1f..0000000 --- a/abouteasyexcel.md +++ /dev/null @@ -1,53 +0,0 @@ -# easyexcel要去解决的问题 - -## Excel读写时候内存溢出 - -虽然POI是目前使用最多的用来做excel解析的框架，但这个框架并不那么完美。大部分使用POI都是使用他的userModel模式。userModel的好处是上手容易使用简单，随便拷贝个代码跑一下，剩下就是写业务转换了，虽然转换也要写上百行代码，相对比较好理解。然而userModel模式最大的问题是在于非常大的内存消耗，一个几兆的文件解析要用掉上百兆的内存。现在很多应用采用这种模式，之所以还正常在跑一定是并发不大，并发上来后一定会OOM或者频繁的full gc。 - -## 其他开源框架使用复杂 - -对POI有过深入了解的估计才知道原来POI还有SAX模式。但SAX模式相对比较复杂，excel有03和07两种版本，两个版本数据存储方式截然不同，sax解析方式也各不一样。想要了解清楚这两种解析方式，才去写代码测试，估计两天时间是需要的。再加上即使解析完，要转换到自己业务模型还要很多繁琐的代码。总体下来感觉至少需要三天，由于代码复杂，后续维护成本巨大。 - -## 其他开源框架存在一些BUG修复不及时 - -由于我们的系统大多数都是大并发的情况下运行的，在大并发情况下，我们会发现poi存在一些bug,如果让POI团队修复估计遥遥无期了。所以我们在easyexcel对这些bug做了规避。 -如下一段报错就是在大并发情况下poi抛的一个异常。 -``` -Caused by: java.io.IOException: Could not create temporary directory '/home/admin/dio2o/.default/temp/poifiles' - at org.apache.poi.util.DefaultTempFileCreationStrategy.createTempDirectory(DefaultTempFileCreationStrategy.java:93) ~[poi-3.15.jar:3.15] - at org.apache.poi.util.DefaultTempFileCreationStrategy.createPOIFilesDirectory(DefaultTempFileCreationStrategy.java:82) ~[poi-3.15.jar:3.15] -``` -报错地方poi源码如下 -``` - private void createTempDirectory(File directory) throws IOException { - if (!(directory.exists() || directory.mkdirs()) || !directory.isDirectory()) { - throw new IOException(\"Could not create temporary directory '\" + directory + \"'\"); - } - } -``` -仔细看代码容易明白如果在并发情况下，如果2个线程同时判断directory.exists()都 为false,但执行directory.mkdirs()如果一些线程优先执行完，另外一个线程就会返回false。最终 throw new IOException(\"Could not create temporary directory '\" + directory + \"'\")。针对这个问题easyexcel在写文件时候首先创建了该临时目录，避免poi在并发创建时候引起不该有的报错。 - -## Excel格式分析格式分析 - -- xls是Microsoft Excel2007前excel的文件存储格式，实现原理是基于微软的ole db是微软com组件的一种实现，本质上也是一个微型数据库，由于微软的东西很多不开源，另外也已经被淘汰，了解它的细节意义不大，底层的编程都是基于微软的com组件去开发的。 -- xlsx是Microsoft Excel2007后excel的文件存储格式，实现是基于openXml和zip技术。这种存储简单，安全传输方便，同时处理数据也变的简单。 -- csv 我们可以理解为纯文本文件，可以被excel打开。他的格式非常简单，解析起来和解析文本文件一样。 - -## 核心原理 - -写有大量数据的xlsx文件时，POI为我们提供了SXSSFWorkBook类来处理，这个类的处理机制是当内存中的数据条数达到一个极限数量的时候就flush这部分数据，再依次处理余下的数据，这个在大多数场景能够满足需求。 -读有大量数据的文件时，使用WorkBook处理就不行了，因为POI对文件是先将文件中的cell读入内存，生成一个树的结构（针对Excel中的每个sheet，使用TreeMap存储sheet中的行）。如果数据量比较大，则同样会产生java.lang.OutOfMemoryError: Java heap space错误。POI官方推荐使用“XSSF and SAX（event API）”方式来解决。 -分析清楚POI后要解决OOM有3个关键。 - -### 1、文件解压文件读取通过文件形式 - -![屏幕快照 2018-01-22 上午8.52.08.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/e3a3500014c95f7118d8c200a51acab4.png) - -### 2、避免将全部全部数据一次加载到内存 - -采用sax模式一行一行解析，并将一行的解析结果以观察者的模式通知处理。 -![基础模板1 (2).png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/82bb195ac62532963b2364d2e4da23e5.png) - -### 3、抛弃不重要的数据 - -Excel解析时候会包含样式，字体，宽度等数据，但这些数据是我们不关心的，如果将这部分数据抛弃可以大大降低内存使用。Excel中数据如下Style占了相当大的空间。 No newline at end of file diff --git a/easyexcel-core/pom.xml b/easyexcel-core/pom.xml index 4f03d71..d6e5800 100644 --- a/easyexcel-core/pom.xml +++ b/easyexcel-core/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel-core</artifactId> + <name>easyexcel-core</name> <dependencies> <dependency> diff --git a/easyexcel-support/pom.xml b/easyexcel-support/pom.xml index d15b0d7..db2dbd3 100644 --- a/easyexcel-support/pom.xml +++ b/easyexcel-support/pom.xml @@ -13,6 +13,8 @@ <packaging>jar</packaging> <artifactId>easyexcel-support</artifactId> + <name>easyexcel-support</name> + <dependencies> <dependency> diff --git a/easyexcel-test/pom.xml b/easyexcel-test/pom.xml index f802f24..80821db 100644 --- a/easyexcel-test/pom.xml +++ b/easyexcel-test/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel-test</artifactId> + <name>easyexcel-test</name> <properties> <maven.deploy.skip>true</maven.deploy.skip> diff --git a/easyexcel/pom.xml b/easyexcel/pom.xml index 303f79a..495552c 100644 --- a/easyexcel/pom.xml +++ b/easyexcel/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel</artifactId> + <name>easyexcel</name> <dependencies> ", "completion": "Merge branch 'master' into developing "}
{"prompt": "diff --git a/.github/ISSUE_TEMPLATE/bug.md b/.github/ISSUE_TEMPLATE/bug.md index 4ea8cee..fde1de8 100644 --- a/.github/ISSUE_TEMPLATE/bug.md +++ b/.github/ISSUE_TEMPLATE/bug.md @@ -8,7 +8,7 @@ assignees: zhuangjiaju --- **建议先去看文档** -[快速开始](https://www.yuque.com/easyexcel/doc/easyexcel) 、[常见问题](https://www.yuque.com/easyexcel/faq) +[快速开始](https://easyexcel.opensource.alibaba.com/docs/current/) 、[常见问题](https://easyexcel.opensource.alibaba.com/qa/) **触发场景描述** **触发Bug的代码** diff --git a/.github/ISSUE_TEMPLATE/question.md b/.github/ISSUE_TEMPLATE/question.md index 51cea2b..78b4cf2 100644 --- a/.github/ISSUE_TEMPLATE/question.md +++ b/.github/ISSUE_TEMPLATE/question.md @@ -8,7 +8,7 @@ assignees: '' --- **建议先去看文档** -[快速开始](https://www.yuque.com/easyexcel/doc/easyexcel) 、[常见问题](https://www.yuque.com/easyexcel/faq) +[快速开始](https://easyexcel.opensource.alibaba.com/docs/current/) 、[常见问题](https://easyexcel.opensource.alibaba.com/qa/) **异常代码** ```java 这里写你的代码 diff --git a/.github/ISSUE_TEMPLATE/suggest.md b/.github/ISSUE_TEMPLATE/suggest.md index 1aeecd8..6b7402d 100644 --- a/.github/ISSUE_TEMPLATE/suggest.md +++ b/.github/ISSUE_TEMPLATE/suggest.md @@ -8,5 +8,5 @@ assignees: '' --- **建议先去看文档** -[快速开始](https://www.yuque.com/easyexcel/doc/easyexcel) 、[常见问题](https://www.yuque.com/easyexcel/faq) +[快速开始](https://easyexcel.opensource.alibaba.com/docs/current/) 、[常见问题](https://easyexcel.opensource.alibaba.com/qa/) **建议描述** diff --git a/README.md b/README.md index 649a114..47956ff 100644 --- a/README.md +++ b/README.md @@ -7,17 +7,20 @@ EasyExcel [QQ1群(已满): 662022184](https://jq.qq.com/?_wv=1027&k=1T21jJxh) [QQ2群(已满): 1097936804](https://jq.qq.com/?_wv=1027&k=j5zEy6Xl) [QQ3群(已满): 453928496](https://qm.qq.com/cgi-bin/qm/qr?k=e2ULsA5A0GldhV2CXJ8sIbAyu9I6qqs7&jump_from=webapi) -[QQ4群: 496594404](https://qm.qq.com/cgi-bin/qm/qr?k=e_aVG1Q7gi0PJUBkbrUGAgbeO3kUEInK&jump_from=webapi) +[QQ4群(已满): 496594404](https://qm.qq.com/cgi-bin/qm/qr?k=e_aVG1Q7gi0PJUBkbrUGAgbeO3kUEInK&jump_from=webapi) +[QQ5群: 451925680](https://jq.qq.com/?_wv=1027&k=BbLBIo9P) [钉钉1群（已满）: 21960511](https://qr.dingtalk.com/action/joingroup?code=v1,k1,cchz6k12ci9B08NNqhNRFGXocNVHrZtW0kaOtTKg/Rk=&_dt_no_comment=1&origin=11) [钉钉2群（已满）: 32796397](https://qr.dingtalk.com/action/joingroup?code=v1,k1,jyU9GtEuNU5S0QTyklqYcYJ8qDZtUuTPMM7uPZTS8Hs=&_dt_no_comment=1&origin=11) [钉钉3群（已满）: 33797247](https://qr.dingtalk.com/action/joingroup?code=v1,k1,3UGlEScTGQaHpW2cIRo+gkxJ9EVZ5fz26M6nW3uFP30=&_dt_no_comment=1&origin=11) [钉钉4群（已满）: 33491624](https://qr.dingtalk.com/action/joingroup?code=v1,k1,V14Pb65Too70rQkEaJ9ohb6lZBZbtp6jIL/q9EWh9vA=&_dt_no_comment=1&origin=11) [钉钉5群（已满）: 32134498](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingb9fa1325d9dccc3ecac589edd02f1650&5233a=71a83&cbdbhh=qwertyuiop) [钉钉6群（已满）: 34707941](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingcf68008a1d443ac012d5427bdb061b7a&6ae36c3d-0c80-4=22398493-6c2a-4&cbdbhh=qwertyuiop) -[钉钉7群: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) -[官方网站: https://yuque.com/easyexcel](https://www.yuque.com/easyexcel/doc/easyexcel) +[钉钉7群（已满）: 35235427](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=ding532b9018c06c7fc8660273c4b78e6440&167fb=ed003&cbdbhh=qwertyuiop) +[钉钉8群: 44752220](https://h5.dingtalk.com/circle/healthCheckin.html?dtaction=os&corpId=dingea96808beee421693fd4ba7542d6e5da&0380092a-fa46=a6a40905-7951&cbdbhh=qwertyuiop) -[常见问题](https://www.yuque.com/easyexcel/faq) +[官方网站: https://easyexcel.opensource.alibaba.com/](https://easyexcel.opensource.alibaba.com/) + +[常见问题](https://easyexcel.opensource.alibaba.com/qa/) #### 因为公司不方便用QQ，所以建议加钉钉群 # JAVA解析Excel工具EasyExcel @@ -27,63 +30,19 @@ Java解析、生成Excel比较有名的框架有Apache poi、jxl。但他们都 当然还有[极速模式](https://easyexcel.opensource.alibaba.com/qa/read#%E5%BC%80%E5%90%AF%E6%80%A5%E9%80%9F%E6%A8%A1%E5%BC%8F)能更快，但是内存占用会在100M多一点 ![img](img/readme/large.png) -## 关于版本选择 -如果项目中没有使用过poi,且jdk版本在8-17之间，直接使用最新版本，别犹豫。以下表格适用于不满足以上2个情况的。 - -| 版本 | poi依赖版本 (支持范围) | jdk版本支持范围 | 备注 | -|--------------------|-----------------------|--------------|---------------------------------------------| -| 3.1.0+ | 4.1.2 (4.1.2 - 5.2.2) | jkd8 - jdk17 | 推荐使用，会更新的版本 | -| 3.0.0-beta1 - 3.0.5 | 4.1.2 (4.1.2 - 5.2.2) | jkd8 - jdk11 | 不推荐项目新引入此版本，除非超级严重bug,否则不再更新 | -| 2.0.0-beta1-2.2.11 | 3.17 (3.17 - 4.1.2) | jdk6 - jdk11 | 不推荐项目新引入此版本，除非是jdk6否则不推荐使用，除非超级严重bug,否则不再更新 | -| 1+版本 | 3.17 (3.17 - 4.1.2) | jdk6 - jdk11 | 不推荐项目新引入此版本，超级严重bug,也不再更新 | - -注意： 3+版本的的easyexcel，使用poi 5+版本时，需要手动排除：poi-ooxml-schemas，例如： -```xml - <dependency> - <groupId>com.alibaba</groupId> - <artifactId>easyexcel</artifactId> - <version>3.1.1</version> - <exclusions> - <exclusion> - <artifactId>poi-ooxml-schemas</artifactId> - <groupId>org.apache.poi</groupId> - </exclusion> - </exclusions> -</dependency> -``` - -### 关于版本升级 -* 不建议跨大版本升级 尤其跨2个大版本 -* 2+ 升级到 3+ 一些不兼容的地方 - CONTRIBUTING.md LICENSE README.md README_EN.md docs easyexcel easyexcel-core easyexcel-support easyexcel-test easyexcel_en.md img lombok.config mvnw mvnw.cmd pom.xml quickstart.md src style update.md 使用了自定义拦截器去修改样式的会出问题（不会编译报错） - CONTRIBUTING.md LICENSE README.md README_EN.md docs easyexcel easyexcel-core easyexcel-support easyexcel-test easyexcel_en.md img lombok.config mvnw mvnw.cmd pom.xml quickstart.md src style update.md 读的时候`invoke`里面抛出异常，不会再额外封装一层`ExcelAnalysisException` （不会编译报错） - CONTRIBUTING.md LICENSE README.md README_EN.md docs easyexcel easyexcel-core easyexcel-support easyexcel-test easyexcel_en.md img lombok.config mvnw mvnw.cmd pom.xml quickstart.md src style update.md 样式等注解涉及到 `boolean` or 一些枚举 值的 有变动，新增默认值（会编译报错，注解改就行） -* 大版本升级后建议相关内容重新测试下 - ### 最新版本 ```xml <dependency> <groupId>com.alibaba</groupId> <artifactId>easyexcel</artifactId> - <version>3.1.0</version> + <version>3.1.1</version> </dependency> ``` -### easyexcel人员招募 -由于工作较忙,有意愿做开源的同学可以报名,主要负责群里回答&issue处理，当然也可以做一些PR. -由于开源没有任何物质回报，然后现在的维护同学也是课余时间维护的，所以想加入的同学需要持之以恒，而不是一时兴起. -要求如下： -* 有一定java编码能力 & 良好的编码习惯 -* 了解easyexcel 读&写的原理 -* 热爱开源项目 -* 能长期坚持的去做 -* 相对工作没那么忙 - ## 相关文档 -* [快速开始](https://www.yuque.com/easyexcel/doc/easyexcel) -* [关于软件](/abouteasyexcel.md) +* [快速开始](https://easyexcel.opensource.alibaba.com/docs/current/) CONTRIBUTING.md LICENSE README.md README_EN.md docs easyexcel easyexcel-core easyexcel-support easyexcel-test easyexcel_en.md img lombok.config mvnw mvnw.cmd pom.xml quickstart.md src style update.md [更新记事](/update.md) -* [贡献代码](https://www.yuque.com/easyexcel/doc/contribute) +* [贡献代码](https://easyexcel.opensource.alibaba.com/community/contribute) ## 维护者 姬朋飞（玉霄)、庄家钜、怀宇 diff --git a/abouteasyexcel.md b/abouteasyexcel.md deleted file mode 100644 index 54a4e1f..0000000 --- a/abouteasyexcel.md +++ /dev/null @@ -1,53 +0,0 @@ -# easyexcel要去解决的问题 - -## Excel读写时候内存溢出 - -虽然POI是目前使用最多的用来做excel解析的框架，但这个框架并不那么完美。大部分使用POI都是使用他的userModel模式。userModel的好处是上手容易使用简单，随便拷贝个代码跑一下，剩下就是写业务转换了，虽然转换也要写上百行代码，相对比较好理解。然而userModel模式最大的问题是在于非常大的内存消耗，一个几兆的文件解析要用掉上百兆的内存。现在很多应用采用这种模式，之所以还正常在跑一定是并发不大，并发上来后一定会OOM或者频繁的full gc。 - -## 其他开源框架使用复杂 - -对POI有过深入了解的估计才知道原来POI还有SAX模式。但SAX模式相对比较复杂，excel有03和07两种版本，两个版本数据存储方式截然不同，sax解析方式也各不一样。想要了解清楚这两种解析方式，才去写代码测试，估计两天时间是需要的。再加上即使解析完，要转换到自己业务模型还要很多繁琐的代码。总体下来感觉至少需要三天，由于代码复杂，后续维护成本巨大。 - -## 其他开源框架存在一些BUG修复不及时 - -由于我们的系统大多数都是大并发的情况下运行的，在大并发情况下，我们会发现poi存在一些bug,如果让POI团队修复估计遥遥无期了。所以我们在easyexcel对这些bug做了规避。 -如下一段报错就是在大并发情况下poi抛的一个异常。 -``` -Caused by: java.io.IOException: Could not create temporary directory '/home/admin/dio2o/.default/temp/poifiles' - at org.apache.poi.util.DefaultTempFileCreationStrategy.createTempDirectory(DefaultTempFileCreationStrategy.java:93) ~[poi-3.15.jar:3.15] - at org.apache.poi.util.DefaultTempFileCreationStrategy.createPOIFilesDirectory(DefaultTempFileCreationStrategy.java:82) ~[poi-3.15.jar:3.15] -``` -报错地方poi源码如下 -``` - private void createTempDirectory(File directory) throws IOException { - if (!(directory.exists() || directory.mkdirs()) || !directory.isDirectory()) { - throw new IOException(\"Could not create temporary directory '\" + directory + \"'\"); - } - } -``` -仔细看代码容易明白如果在并发情况下，如果2个线程同时判断directory.exists()都 为false,但执行directory.mkdirs()如果一些线程优先执行完，另外一个线程就会返回false。最终 throw new IOException(\"Could not create temporary directory '\" + directory + \"'\")。针对这个问题easyexcel在写文件时候首先创建了该临时目录，避免poi在并发创建时候引起不该有的报错。 - -## Excel格式分析格式分析 - -- xls是Microsoft Excel2007前excel的文件存储格式，实现原理是基于微软的ole db是微软com组件的一种实现，本质上也是一个微型数据库，由于微软的东西很多不开源，另外也已经被淘汰，了解它的细节意义不大，底层的编程都是基于微软的com组件去开发的。 -- xlsx是Microsoft Excel2007后excel的文件存储格式，实现是基于openXml和zip技术。这种存储简单，安全传输方便，同时处理数据也变的简单。 -- csv 我们可以理解为纯文本文件，可以被excel打开。他的格式非常简单，解析起来和解析文本文件一样。 - -## 核心原理 - -写有大量数据的xlsx文件时，POI为我们提供了SXSSFWorkBook类来处理，这个类的处理机制是当内存中的数据条数达到一个极限数量的时候就flush这部分数据，再依次处理余下的数据，这个在大多数场景能够满足需求。 -读有大量数据的文件时，使用WorkBook处理就不行了，因为POI对文件是先将文件中的cell读入内存，生成一个树的结构（针对Excel中的每个sheet，使用TreeMap存储sheet中的行）。如果数据量比较大，则同样会产生java.lang.OutOfMemoryError: Java heap space错误。POI官方推荐使用“XSSF and SAX（event API）”方式来解决。 -分析清楚POI后要解决OOM有3个关键。 - -### 1、文件解压文件读取通过文件形式 - -![屏幕快照 2018-01-22 上午8.52.08.png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/e3a3500014c95f7118d8c200a51acab4.png) - -### 2、避免将全部全部数据一次加载到内存 - -采用sax模式一行一行解析，并将一行的解析结果以观察者的模式通知处理。 -![基础模板1 (2).png](http://ata2-img.cn-hangzhou.img-pub.aliyun-inc.com/82bb195ac62532963b2364d2e4da23e5.png) - -### 3、抛弃不重要的数据 - -Excel解析时候会包含样式，字体，宽度等数据，但这些数据是我们不关心的，如果将这部分数据抛弃可以大大降低内存使用。Excel中数据如下Style占了相当大的空间。 No newline at end of file diff --git a/easyexcel-core/pom.xml b/easyexcel-core/pom.xml index 4f03d71..d6e5800 100644 --- a/easyexcel-core/pom.xml +++ b/easyexcel-core/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel-core</artifactId> + <name>easyexcel-core</name> <dependencies> <dependency> diff --git a/easyexcel-support/pom.xml b/easyexcel-support/pom.xml index d15b0d7..db2dbd3 100644 --- a/easyexcel-support/pom.xml +++ b/easyexcel-support/pom.xml @@ -13,6 +13,8 @@ <packaging>jar</packaging> <artifactId>easyexcel-support</artifactId> + <name>easyexcel-support</name> + <dependencies> <dependency> diff --git a/easyexcel-test/pom.xml b/easyexcel-test/pom.xml index f802f24..80821db 100644 --- a/easyexcel-test/pom.xml +++ b/easyexcel-test/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel-test</artifactId> + <name>easyexcel-test</name> <properties> <maven.deploy.skip>true</maven.deploy.skip> diff --git a/easyexcel/pom.xml b/easyexcel/pom.xml index 303f79a..495552c 100644 --- a/easyexcel/pom.xml +++ b/easyexcel/pom.xml @@ -13,6 +13,7 @@ <packaging>jar</packaging> <artifactId>easyexcel</artifactId> + <name>easyexcel</name> <dependencies> ", "completion": "* 修复部分xlsx无法读取超链接的bug "}
{"prompt": "diff --git a/doc/pgBadger.pod b/doc/pgBadger.pod index f40a74a..abf13f9 100644 --- a/doc/pgBadger.pod +++ b/doc/pgBadger.pod @@ -330,7 +330,7 @@ but pgBadger can parse both formats. To create a cumulative report over a month use command: - pgbadger --month-report 2919-05 /path/to/incremental/reports/ + pgbadger --month-report 2019-05 /path/to/incremental/reports/ this will add a link to the month name into the calendar view in incremental reports to look at report for month 2019 May. @@ -699,7 +699,7 @@ By default, pgBadger in incremental mode only computes daily and weekly reports. If you want monthly cumulative reports, you will have to use a separate command to specify the report to build. For example, to build a report for August 2019: - pgbadger -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -X --month-report 2019-08 /var/www/pg_reports/ this will add a link to the month name into the calendar view of incremental reports to look at monthly report. The report for a current month can be run @@ -709,7 +709,7 @@ default because it could take a lot of time following the amount of data. If reports were built with the per-database option ( -E | --explode ), it must be used too when calling pgbadger to build monthly report: - pgbadger -E -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -E -X --month-report 2019-08 /var/www/pg_reports/ This is the same when using the rebuild option ( -R | --rebuild ). ", "completion": "Change ChangeLog since revert of commit 7b8b28a. "}
{"prompt": "diff --git a/ChangeLog b/ChangeLog index c8ef966..5b49f57 100644 --- a/ChangeLog +++ b/ChangeLog @@ -6,32 +6,27 @@ past five months. As usual there is also new features and improvements: CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove support to Tsung output. CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Improve pgbadger performances when there are hundred of bind parameters to replace. - CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Fix detection of new log entries in local file when multiprocess was not - used. - CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove option -n | --nohighlight which is no more uses since upgrade to + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove option -n | --nohighlight which is no more used since upgrade to pgFormatter 4. CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Use POST method to send auto_explain plan to explain.depesz.com to avoid GET length parameter limit. CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Apply --exclude-query and --include-query to bind/parse traces. - CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Add link to pgBadger reportsexamples to documentation. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Add link to pgBadger report examples to documentation. Here is the complete list of changes and acknowledgments: - - Remove autovacuum and autoanalyze from session count, even if technically - they use a session. In these cases the session is always seen open by - pgbadger which is not the case. Thanks to vitalca for the report. - Fix monthly reports that was failing on \"log file ... must exists\". Thanks to Jaume Sabater for the report. - Fix pgbouncer start parsing debug message when input is stdin. Thanks to aleszeleny for the report. - Remove support to Tsung output. - Drastically improve pgbadger performances for bind parameters - replacemeent that could make pgbadger run infinitely when there was + replacement that could make pgbadger run infinitely when there was hundred of parameters. Thanks to Monty Mobile for the report. - Fix documentation about pgBadger return codes and also some wrong return code at some places. Thanks to Jaume Sabater for the report. - Fix several typo. Thanks to David Gilman for the patch. - - Remove option -n | --nohighlight which is no more uses since upgrade to + - Remove option -n | --nohighlight which is no more used since upgrade to pgFormatter 4. Thanks to Elena Indrupskaya for the report. - Lot of pgbadger documentation fixes. Thanks to Elena Indrupskay from Postgres Pro for the patch. diff --git a/doc/pgBadger.pod b/doc/pgBadger.pod index f40a74a..abf13f9 100644 --- a/doc/pgBadger.pod +++ b/doc/pgBadger.pod @@ -330,7 +330,7 @@ but pgBadger can parse both formats. To create a cumulative report over a month use command: - pgbadger --month-report 2919-05 /path/to/incremental/reports/ + pgbadger --month-report 2019-05 /path/to/incremental/reports/ this will add a link to the month name into the calendar view in incremental reports to look at report for month 2019 May. @@ -699,7 +699,7 @@ By default, pgBadger in incremental mode only computes daily and weekly reports. If you want monthly cumulative reports, you will have to use a separate command to specify the report to build. For example, to build a report for August 2019: - pgbadger -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -X --month-report 2019-08 /var/www/pg_reports/ this will add a link to the month name into the calendar view of incremental reports to look at monthly report. The report for a current month can be run @@ -709,7 +709,7 @@ default because it could take a lot of time following the amount of data. If reports were built with the per-database option ( -E | --explode ), it must be used too when calling pgbadger to build monthly report: - pgbadger -E -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -E -X --month-report 2019-08 /var/www/pg_reports/ This is the same when using the rebuild option ( -R | --rebuild ). ", "completion": "Revert \"Remove autovacuum and autoanalyze from session count, even if technically they use a session. In these cases the session is seen always open by pgbadger which is not the case. Thanks to vitalca for the report.\" This reverts commit 7b8b28a8f6c82324e546343bf806af711c67f25a. "}
{"prompt": "diff --git a/ChangeLog b/ChangeLog index c8ef966..5b49f57 100644 --- a/ChangeLog +++ b/ChangeLog @@ -6,32 +6,27 @@ past five months. As usual there is also new features and improvements: CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove support to Tsung output. CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Improve pgbadger performances when there are hundred of bind parameters to replace. - CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Fix detection of new log entries in local file when multiprocess was not - used. - CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove option -n | --nohighlight which is no more uses since upgrade to + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove option -n | --nohighlight which is no more used since upgrade to pgFormatter 4. CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Use POST method to send auto_explain plan to explain.depesz.com to avoid GET length parameter limit. CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Apply --exclude-query and --include-query to bind/parse traces. - CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Add link to pgBadger reportsexamples to documentation. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Add link to pgBadger report examples to documentation. Here is the complete list of changes and acknowledgments: - - Remove autovacuum and autoanalyze from session count, even if technically - they use a session. In these cases the session is always seen open by - pgbadger which is not the case. Thanks to vitalca for the report. - Fix monthly reports that was failing on \"log file ... must exists\". Thanks to Jaume Sabater for the report. - Fix pgbouncer start parsing debug message when input is stdin. Thanks to aleszeleny for the report. - Remove support to Tsung output. - Drastically improve pgbadger performances for bind parameters - replacemeent that could make pgbadger run infinitely when there was + replacement that could make pgbadger run infinitely when there was hundred of parameters. Thanks to Monty Mobile for the report. - Fix documentation about pgBadger return codes and also some wrong return code at some places. Thanks to Jaume Sabater for the report. - Fix several typo. Thanks to David Gilman for the patch. - - Remove option -n | --nohighlight which is no more uses since upgrade to + - Remove option -n | --nohighlight which is no more used since upgrade to pgFormatter 4. Thanks to Elena Indrupskaya for the report. - Lot of pgbadger documentation fixes. Thanks to Elena Indrupskay from Postgres Pro for the patch. diff --git a/doc/pgBadger.pod b/doc/pgBadger.pod index f40a74a..abf13f9 100644 --- a/doc/pgBadger.pod +++ b/doc/pgBadger.pod @@ -330,7 +330,7 @@ but pgBadger can parse both formats. To create a cumulative report over a month use command: - pgbadger --month-report 2919-05 /path/to/incremental/reports/ + pgbadger --month-report 2019-05 /path/to/incremental/reports/ this will add a link to the month name into the calendar view in incremental reports to look at report for month 2019 May. @@ -699,7 +699,7 @@ By default, pgBadger in incremental mode only computes daily and weekly reports. If you want monthly cumulative reports, you will have to use a separate command to specify the report to build. For example, to build a report for August 2019: - pgbadger -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -X --month-report 2019-08 /var/www/pg_reports/ this will add a link to the month name into the calendar view of incremental reports to look at monthly report. The report for a current month can be run @@ -709,7 +709,7 @@ default because it could take a lot of time following the amount of data. If reports were built with the per-database option ( -E | --explode ), it must be used too when calling pgbadger to build monthly report: - pgbadger -E -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -E -X --month-report 2019-08 /var/www/pg_reports/ This is the same when using the rebuild option ( -R | --rebuild ). diff --git a/pgbadger b/pgbadger index 009d2d6..c8612d0 100755 --- a/pgbadger +++ b/pgbadger @@ -16248,7 +16248,6 @@ sub parse_query ) ) { - delete $session_info{$curdb} if (exists $session_info{$curdb}); return if ($disable_autovacuum); $cur_info{$t_pid}{vacuum} = $3; @@ -16321,7 +16320,6 @@ sub parse_query && ($prefix_vars{'t_query'} =~ /automatic analyze of table \"([^s]+)\"/) ) { - delete $session_info{$curdb} if (exists $session_info{$curdb}); return if ($disable_autovacuum); my $table = $1; $table =~ /^([^.]+)./; ", "completion": "Update ChangeLog and version to 12.0 "}
{"prompt": "diff --git a/ChangeLog b/ChangeLog index 931723c..5b49f57 100644 --- a/ChangeLog +++ b/ChangeLog @@ -1,3 +1,55 @@ +2022-09-13 - v12.0 + +This major release of pgBadger fixes some issues reported by users since +past five months. As usual there is also new features and improvements: + + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove support to Tsung output. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Improve pgbadger performances when there are hundred of bind parameters + to replace. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove option -n | --nohighlight which is no more used since upgrade to + pgFormatter 4. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Use POST method to send auto_explain plan to explain.depesz.com to avoid + GET length parameter limit. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Apply --exclude-query and --include-query to bind/parse traces. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Add link to pgBadger report examples to documentation. + +Here is the complete list of changes and acknowledgments: + + - Fix monthly reports that was failing on \"log file ... must exists\". Thanks + to Jaume Sabater for the report. + - Fix pgbouncer start parsing debug message when input is stdin. Thanks to + aleszeleny for the report. + - Remove support to Tsung output. + - Drastically improve pgbadger performances for bind parameters + replacement that could make pgbadger run infinitely when there was + hundred of parameters. Thanks to Monty Mobile for the report. + - Fix documentation about pgBadger return codes and also some wrong return + code at some places. Thanks to Jaume Sabater for the report. + - Fix several typo. Thanks to David Gilman for the patch. + - Remove option -n | --nohighlight which is no more used since upgrade to + pgFormatter 4. Thanks to Elena Indrupskaya for the report. + - Lot of pgbadger documentation fixes. Thanks to Elena Indrupskay from + Postgres Pro for the patch. + - Allow half hour in --log-timezone and --timezone, value can be an integer, + ex: 2 or a float, ex: 2.5. Thanks to Mujjamil-K for the feature request. + - Allow use of regexp for --exclude-app and --exclude-client. Thanks to + rdnkrkmz for the feature request. + - Allow use of --explain-url with previous commit and restore the limitation + to explain text format. + - Use POST method to send auto_explain plan to explain.depesz.com to avoid + GET length parameter limit. Thanks to hvisage for the report. + - Apply --exclude-query and --include-query to bind/parse traces. Thanks to + Alec Lazarescu for the report. + - Fix parsing of autovacuum stats from RDS logs. Thanks to David Gilman for + the report. + - Fix passing of log format when parsing remote log. Thanks to spookypeanut + the report. + - Add link to pgBadger report examples to documentation. + - Fix Session per user reports. Thanks to vitalca for the report. + - Fix jsonlog parsing from PG15 ouput + - Fix text-based error/events reporting. Thanks to Michael Banck for the patch + - Fix regexp typo in normalize_error(). Thanks to Michael Banck for the patch. + 2022-04-08 - v11.8 This release of pgBadger fix some issues reported by users since past diff --git a/META.yml b/META.yml index 5bc00ae..32280d9 100644 --- a/META.yml +++ b/META.yml @@ -1,5 +1,5 @@ name: pgBadger -version: 11.8 +version: 12.0 version_from: pgbadger installdirs: site recommends: diff --git a/doc/pgBadger.pod b/doc/pgBadger.pod index f40a74a..abf13f9 100644 --- a/doc/pgBadger.pod +++ b/doc/pgBadger.pod @@ -330,7 +330,7 @@ but pgBadger can parse both formats. To create a cumulative report over a month use command: - pgbadger --month-report 2919-05 /path/to/incremental/reports/ + pgbadger --month-report 2019-05 /path/to/incremental/reports/ this will add a link to the month name into the calendar view in incremental reports to look at report for month 2019 May. @@ -699,7 +699,7 @@ By default, pgBadger in incremental mode only computes daily and weekly reports. If you want monthly cumulative reports, you will have to use a separate command to specify the report to build. For example, to build a report for August 2019: - pgbadger -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -X --month-report 2019-08 /var/www/pg_reports/ this will add a link to the month name into the calendar view of incremental reports to look at monthly report. The report for a current month can be run @@ -709,7 +709,7 @@ default because it could take a lot of time following the amount of data. If reports were built with the per-database option ( -E | --explode ), it must be used too when calling pgbadger to build monthly report: - pgbadger -E -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -E -X --month-report 2019-08 /var/www/pg_reports/ This is the same when using the rebuild option ( -R | --rebuild ). diff --git a/pgbadger b/pgbadger index 70c2907..c8612d0 100755 --- a/pgbadger +++ b/pgbadger @@ -52,7 +52,7 @@ use Socket; use constant EBCDIC => \"t\" ne \"011\"; use Encode qw(encode decode); -$VERSION = '11.8'; +$VERSION = '12.0'; $SIG{'CHLD'} = 'DEFAULT'; @@ -16248,7 +16248,6 @@ sub parse_query ) ) { - delete $session_info{$curdb} if (exists $session_info{$curdb}); return if ($disable_autovacuum); $cur_info{$t_pid}{vacuum} = $3; @@ -16321,7 +16320,6 @@ sub parse_query && ($prefix_vars{'t_query'} =~ /automatic analyze of table \"([^s]+)\"/) ) { - delete $session_info{$curdb} if (exists $session_info{$curdb}); return if ($disable_autovacuum); my $table = $1; $table =~ /^([^.]+)./; ", "completion": "Remove autovacuum and autoanalyze from session count, even if technically they use a session. In these cases the session is seen always open by pgbadger which is not the case. Thanks to vitalca for the report. "}
{"prompt": "diff --git a/ChangeLog b/ChangeLog index 931723c..5b49f57 100644 --- a/ChangeLog +++ b/ChangeLog @@ -1,3 +1,55 @@ +2022-09-13 - v12.0 + +This major release of pgBadger fixes some issues reported by users since +past five months. As usual there is also new features and improvements: + + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove support to Tsung output. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Improve pgbadger performances when there are hundred of bind parameters + to replace. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove option -n | --nohighlight which is no more used since upgrade to + pgFormatter 4. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Use POST method to send auto_explain plan to explain.depesz.com to avoid + GET length parameter limit. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Apply --exclude-query and --include-query to bind/parse traces. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Add link to pgBadger report examples to documentation. + +Here is the complete list of changes and acknowledgments: + + - Fix monthly reports that was failing on \"log file ... must exists\". Thanks + to Jaume Sabater for the report. + - Fix pgbouncer start parsing debug message when input is stdin. Thanks to + aleszeleny for the report. + - Remove support to Tsung output. + - Drastically improve pgbadger performances for bind parameters + replacement that could make pgbadger run infinitely when there was + hundred of parameters. Thanks to Monty Mobile for the report. + - Fix documentation about pgBadger return codes and also some wrong return + code at some places. Thanks to Jaume Sabater for the report. + - Fix several typo. Thanks to David Gilman for the patch. + - Remove option -n | --nohighlight which is no more used since upgrade to + pgFormatter 4. Thanks to Elena Indrupskaya for the report. + - Lot of pgbadger documentation fixes. Thanks to Elena Indrupskay from + Postgres Pro for the patch. + - Allow half hour in --log-timezone and --timezone, value can be an integer, + ex: 2 or a float, ex: 2.5. Thanks to Mujjamil-K for the feature request. + - Allow use of regexp for --exclude-app and --exclude-client. Thanks to + rdnkrkmz for the feature request. + - Allow use of --explain-url with previous commit and restore the limitation + to explain text format. + - Use POST method to send auto_explain plan to explain.depesz.com to avoid + GET length parameter limit. Thanks to hvisage for the report. + - Apply --exclude-query and --include-query to bind/parse traces. Thanks to + Alec Lazarescu for the report. + - Fix parsing of autovacuum stats from RDS logs. Thanks to David Gilman for + the report. + - Fix passing of log format when parsing remote log. Thanks to spookypeanut + the report. + - Add link to pgBadger report examples to documentation. + - Fix Session per user reports. Thanks to vitalca for the report. + - Fix jsonlog parsing from PG15 ouput + - Fix text-based error/events reporting. Thanks to Michael Banck for the patch + - Fix regexp typo in normalize_error(). Thanks to Michael Banck for the patch. + 2022-04-08 - v11.8 This release of pgBadger fix some issues reported by users since past diff --git a/META.yml b/META.yml index 5bc00ae..32280d9 100644 --- a/META.yml +++ b/META.yml @@ -1,5 +1,5 @@ name: pgBadger -version: 11.8 +version: 12.0 version_from: pgbadger installdirs: site recommends: diff --git a/doc/pgBadger.pod b/doc/pgBadger.pod index f40a74a..abf13f9 100644 --- a/doc/pgBadger.pod +++ b/doc/pgBadger.pod @@ -330,7 +330,7 @@ but pgBadger can parse both formats. To create a cumulative report over a month use command: - pgbadger --month-report 2919-05 /path/to/incremental/reports/ + pgbadger --month-report 2019-05 /path/to/incremental/reports/ this will add a link to the month name into the calendar view in incremental reports to look at report for month 2019 May. @@ -699,7 +699,7 @@ By default, pgBadger in incremental mode only computes daily and weekly reports. If you want monthly cumulative reports, you will have to use a separate command to specify the report to build. For example, to build a report for August 2019: - pgbadger -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -X --month-report 2019-08 /var/www/pg_reports/ this will add a link to the month name into the calendar view of incremental reports to look at monthly report. The report for a current month can be run @@ -709,7 +709,7 @@ default because it could take a lot of time following the amount of data. If reports were built with the per-database option ( -E | --explode ), it must be used too when calling pgbadger to build monthly report: - pgbadger -E -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -E -X --month-report 2019-08 /var/www/pg_reports/ This is the same when using the rebuild option ( -R | --rebuild ). diff --git a/pgbadger b/pgbadger index d792fc3..c8612d0 100755 --- a/pgbadger +++ b/pgbadger @@ -52,7 +52,7 @@ use Socket; use constant EBCDIC => \"t\" ne \"011\"; use Encode qw(encode decode); -$VERSION = '11.8'; +$VERSION = '12.0'; $SIG{'CHLD'} = 'DEFAULT'; ", "completion": "Fix monthly reports that was failing on \"log file ... must exists\". Thanks to Jaume Sabater for the report. "}
{"prompt": "diff --git a/ChangeLog b/ChangeLog index 931723c..5b49f57 100644 --- a/ChangeLog +++ b/ChangeLog @@ -1,3 +1,55 @@ +2022-09-13 - v12.0 + +This major release of pgBadger fixes some issues reported by users since +past five months. As usual there is also new features and improvements: + + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove support to Tsung output. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Improve pgbadger performances when there are hundred of bind parameters + to replace. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove option -n | --nohighlight which is no more used since upgrade to + pgFormatter 4. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Use POST method to send auto_explain plan to explain.depesz.com to avoid + GET length parameter limit. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Apply --exclude-query and --include-query to bind/parse traces. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Add link to pgBadger report examples to documentation. + +Here is the complete list of changes and acknowledgments: + + - Fix monthly reports that was failing on \"log file ... must exists\". Thanks + to Jaume Sabater for the report. + - Fix pgbouncer start parsing debug message when input is stdin. Thanks to + aleszeleny for the report. + - Remove support to Tsung output. + - Drastically improve pgbadger performances for bind parameters + replacement that could make pgbadger run infinitely when there was + hundred of parameters. Thanks to Monty Mobile for the report. + - Fix documentation about pgBadger return codes and also some wrong return + code at some places. Thanks to Jaume Sabater for the report. + - Fix several typo. Thanks to David Gilman for the patch. + - Remove option -n | --nohighlight which is no more used since upgrade to + pgFormatter 4. Thanks to Elena Indrupskaya for the report. + - Lot of pgbadger documentation fixes. Thanks to Elena Indrupskay from + Postgres Pro for the patch. + - Allow half hour in --log-timezone and --timezone, value can be an integer, + ex: 2 or a float, ex: 2.5. Thanks to Mujjamil-K for the feature request. + - Allow use of regexp for --exclude-app and --exclude-client. Thanks to + rdnkrkmz for the feature request. + - Allow use of --explain-url with previous commit and restore the limitation + to explain text format. + - Use POST method to send auto_explain plan to explain.depesz.com to avoid + GET length parameter limit. Thanks to hvisage for the report. + - Apply --exclude-query and --include-query to bind/parse traces. Thanks to + Alec Lazarescu for the report. + - Fix parsing of autovacuum stats from RDS logs. Thanks to David Gilman for + the report. + - Fix passing of log format when parsing remote log. Thanks to spookypeanut + the report. + - Add link to pgBadger report examples to documentation. + - Fix Session per user reports. Thanks to vitalca for the report. + - Fix jsonlog parsing from PG15 ouput + - Fix text-based error/events reporting. Thanks to Michael Banck for the patch + - Fix regexp typo in normalize_error(). Thanks to Michael Banck for the patch. + 2022-04-08 - v11.8 This release of pgBadger fix some issues reported by users since past diff --git a/META.yml b/META.yml index 5bc00ae..32280d9 100644 --- a/META.yml +++ b/META.yml @@ -1,5 +1,5 @@ name: pgBadger -version: 11.8 +version: 12.0 version_from: pgbadger installdirs: site recommends: diff --git a/doc/pgBadger.pod b/doc/pgBadger.pod index f40a74a..abf13f9 100644 --- a/doc/pgBadger.pod +++ b/doc/pgBadger.pod @@ -330,7 +330,7 @@ but pgBadger can parse both formats. To create a cumulative report over a month use command: - pgbadger --month-report 2919-05 /path/to/incremental/reports/ + pgbadger --month-report 2019-05 /path/to/incremental/reports/ this will add a link to the month name into the calendar view in incremental reports to look at report for month 2019 May. @@ -699,7 +699,7 @@ By default, pgBadger in incremental mode only computes daily and weekly reports. If you want monthly cumulative reports, you will have to use a separate command to specify the report to build. For example, to build a report for August 2019: - pgbadger -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -X --month-report 2019-08 /var/www/pg_reports/ this will add a link to the month name into the calendar view of incremental reports to look at monthly report. The report for a current month can be run @@ -709,7 +709,7 @@ default because it could take a lot of time following the amount of data. If reports were built with the per-database option ( -E | --explode ), it must be used too when calling pgbadger to build monthly report: - pgbadger -E -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -E -X --month-report 2019-08 /var/www/pg_reports/ This is the same when using the rebuild option ( -R | --rebuild ). diff --git a/pgbadger b/pgbadger index 1672daf..c8612d0 100755 --- a/pgbadger +++ b/pgbadger @@ -52,7 +52,7 @@ use Socket; use constant EBCDIC => \"t\" ne \"011\"; use Encode qw(encode decode); -$VERSION = '11.8'; +$VERSION = '12.0'; $SIG{'CHLD'} = 'DEFAULT'; @@ -660,8 +660,12 @@ if ($log_command) my $empty_files = 1; if ($#ARGV >= 0) { - foreach my $file (@ARGV) { - push(@log_files, &set_file_list($file)); + if (!$month_report) { + foreach my $file (@ARGV) { + push(@log_files, &set_file_list($file)); + } + } elsif (!$outdir) { + $outdir = $ARGV[0]; } } @@ -1094,7 +1098,7 @@ if ($incremental) # Ensure this is not a relative path if ($outdir && dirname($outdir) eq '.') { - localdie(\"FATAL: output directory ($outdir) is not an absolute path.n\"); + localdie(\"FATAL3: output directory ($outdir) is not an absolute path.n\"); } if ($html_outdir && dirname($html_outdir) eq '.') { ", "completion": "Fix pgbouncer start parsing debug message when input is stdin. Thanks to aleszeleny for the report. "}
{"prompt": "diff --git a/ChangeLog b/ChangeLog index 931723c..5b49f57 100644 --- a/ChangeLog +++ b/ChangeLog @@ -1,3 +1,55 @@ +2022-09-13 - v12.0 + +This major release of pgBadger fixes some issues reported by users since +past five months. As usual there is also new features and improvements: + + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove support to Tsung output. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Improve pgbadger performances when there are hundred of bind parameters + to replace. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Remove option -n | --nohighlight which is no more used since upgrade to + pgFormatter 4. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Use POST method to send auto_explain plan to explain.depesz.com to avoid + GET length parameter limit. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Apply --exclude-query and --include-query to bind/parse traces. + CONTRIBUTING.md ChangeLog HACKING.md LICENSE MANIFEST META.yml Makefile.PL README README.md doc pgbadger resources t tools Add link to pgBadger report examples to documentation. + +Here is the complete list of changes and acknowledgments: + + - Fix monthly reports that was failing on \"log file ... must exists\". Thanks + to Jaume Sabater for the report. + - Fix pgbouncer start parsing debug message when input is stdin. Thanks to + aleszeleny for the report. + - Remove support to Tsung output. + - Drastically improve pgbadger performances for bind parameters + replacement that could make pgbadger run infinitely when there was + hundred of parameters. Thanks to Monty Mobile for the report. + - Fix documentation about pgBadger return codes and also some wrong return + code at some places. Thanks to Jaume Sabater for the report. + - Fix several typo. Thanks to David Gilman for the patch. + - Remove option -n | --nohighlight which is no more used since upgrade to + pgFormatter 4. Thanks to Elena Indrupskaya for the report. + - Lot of pgbadger documentation fixes. Thanks to Elena Indrupskay from + Postgres Pro for the patch. + - Allow half hour in --log-timezone and --timezone, value can be an integer, + ex: 2 or a float, ex: 2.5. Thanks to Mujjamil-K for the feature request. + - Allow use of regexp for --exclude-app and --exclude-client. Thanks to + rdnkrkmz for the feature request. + - Allow use of --explain-url with previous commit and restore the limitation + to explain text format. + - Use POST method to send auto_explain plan to explain.depesz.com to avoid + GET length parameter limit. Thanks to hvisage for the report. + - Apply --exclude-query and --include-query to bind/parse traces. Thanks to + Alec Lazarescu for the report. + - Fix parsing of autovacuum stats from RDS logs. Thanks to David Gilman for + the report. + - Fix passing of log format when parsing remote log. Thanks to spookypeanut + the report. + - Add link to pgBadger report examples to documentation. + - Fix Session per user reports. Thanks to vitalca for the report. + - Fix jsonlog parsing from PG15 ouput + - Fix text-based error/events reporting. Thanks to Michael Banck for the patch + - Fix regexp typo in normalize_error(). Thanks to Michael Banck for the patch. + 2022-04-08 - v11.8 This release of pgBadger fix some issues reported by users since past diff --git a/META.yml b/META.yml index 5bc00ae..32280d9 100644 --- a/META.yml +++ b/META.yml @@ -1,5 +1,5 @@ name: pgBadger -version: 11.8 +version: 12.0 version_from: pgbadger installdirs: site recommends: diff --git a/doc/pgBadger.pod b/doc/pgBadger.pod index f40a74a..abf13f9 100644 --- a/doc/pgBadger.pod +++ b/doc/pgBadger.pod @@ -330,7 +330,7 @@ but pgBadger can parse both formats. To create a cumulative report over a month use command: - pgbadger --month-report 2919-05 /path/to/incremental/reports/ + pgbadger --month-report 2019-05 /path/to/incremental/reports/ this will add a link to the month name into the calendar view in incremental reports to look at report for month 2019 May. @@ -699,7 +699,7 @@ By default, pgBadger in incremental mode only computes daily and weekly reports. If you want monthly cumulative reports, you will have to use a separate command to specify the report to build. For example, to build a report for August 2019: - pgbadger -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -X --month-report 2019-08 /var/www/pg_reports/ this will add a link to the month name into the calendar view of incremental reports to look at monthly report. The report for a current month can be run @@ -709,7 +709,7 @@ default because it could take a lot of time following the amount of data. If reports were built with the per-database option ( -E | --explode ), it must be used too when calling pgbadger to build monthly report: - pgbadger -E -X --month-report 2919-08 /var/www/pg_reports/ + pgbadger -E -X --month-report 2019-08 /var/www/pg_reports/ This is the same when using the rebuild option ( -R | --rebuild ). diff --git a/pgbadger b/pgbadger index bbba332..c8612d0 100755 --- a/pgbadger +++ b/pgbadger @@ -52,7 +52,7 @@ use Socket; use constant EBCDIC => \"t\" ne \"011\"; use Encode qw(encode decode); -$VERSION = '11.8'; +$VERSION = '12.0'; $SIG{'CHLD'} = 'DEFAULT'; @@ -660,8 +660,12 @@ if ($log_command) my $empty_files = 1; if ($#ARGV >= 0) { - foreach my $file (@ARGV) { - push(@log_files, &set_file_list($file)); + if (!$month_report) { + foreach my $file (@ARGV) { + push(@log_files, &set_file_list($file)); + } + } elsif (!$outdir) { + $outdir = $ARGV[0]; } } @@ -1094,7 +1098,7 @@ if ($incremental) # Ensure this is not a relative path if ($outdir && dirname($outdir) eq '.') { - localdie(\"FATAL: output directory ($outdir) is not an absolute path.n\"); + localdie(\"FATAL3: output directory ($outdir) is not an absolute path.n\"); } if ($html_outdir && dirname($html_outdir) eq '.') { @@ -3528,7 +3532,9 @@ sub process_file { $has_exclusion = 1; } - &logmsg('DEBUG', \"Start parsing pgbouncer log at offset $start_offset of file $logfile to \" . ($stop_offset || $totalsize)); + &logmsg('DEBUG', \"Start parsing pgbouncer log at offset $start_offset of \" . + ( ($logfile ne '-') t \" file $logfile\" : \"stdin\" ) . \" to \" . + ($stop_offset || ( ($totalsize > 0) t $totalsize : 'end' ) )); if ($start_offset) { # Move to the starting offset position in file ", "completion": "Remove support to Tsung output. "}
